<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Personal Color AI Pro - í—¤ì–´ìƒµ ì „ìš© ì‹œìŠ¤í…œ</title>
    <meta name="description" content="í—¤ì–´ìƒµ ì „ìš© ì™„ì „í•œ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ - AI + Delta E 2000 + ê³ ê°ê´€ë¦¬">
    
    <!-- CSS íŒŒì¼ ë§í¬ -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>  
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ -->
    <div class="status-ready" id="system-ready">ì¤€ë¹„ì™„ë£Œ</div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="main-app" id="main-app">
        <!-- í—¤ë” -->
        <header class="app-header">
            <div class="header-top">
                <div>
                    <h1 class="app-title">Personal Color AI Pro</h1>
                    <div class="app-subtitle">ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ í†µí•© - í—¤ì–´ìƒµ í˜„ì¥ìš© ì™„ì „ ì‹œìŠ¤í…œ</div>
                </div>
                <div class="header-status">
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        MediaPipe: <span id="mediapipe-status">ì—°ê²° ì¤‘</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        ì§„ë‹¨ ì™„ë£Œ: <span id="diagnosis-count">0</span>íšŒ
                    </div>
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        ë¶„ì„ ì •í™•ë„: <span id="accuracy-rate">95.2%</span>
                    </div>
                </div>
            </div>
            
            <div class="header-controls">
                <button class="header-btn" id="face-analysis-btn" onclick="startFaceAnalysis()">ì‹¤ì‹œê°„ í”¼ë¶€ ë¶„ì„</button>
                <button class="header-btn" id="virtual-draping-btn" onclick="startVirtualDraping()">ê°€ìƒ ë“œë˜ì´í•‘</button>
                <button class="header-btn" id="brand-matching-btn" onclick="showBrandDatabase()">ë¸Œëœë“œ ë§¤ì¹­</button>
                <button class="header-btn" id="report-generator-btn" onclick="showReportOptions()">ë³´ê³ ì„œ ìƒì„±</button>
                <button class="header-btn" id="reset-system-btn" onclick="resetSystem()">ì‹œìŠ¤í…œ ì´ˆê¸°í™”</button>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- ëª¨ë“œ ì„ íƒ -->
            <section class="mode-selection" id="mode-selection">
                <h2>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ëª¨ë“œ ì„ íƒ</h2>
                <div class="mode-cards">
                    <div class="mode-card" data-mode="face-analysis" onclick="startFaceAnalysis()">
                        <div class="mode-icon">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <!-- ì–¼êµ´ -->
                                <circle cx="50" cy="45" r="25" fill="#F8D7B3" stroke="#E6C2A6" stroke-width="2"/>
                                <!-- ë¨¸ë¦¬ -->
                                <path d="M25 35 Q25 15 50 15 Q75 15 75 35 Q75 25 50 25 Q25 25 25 35" fill="#8B4513"/>
                                <!-- ëˆˆ -->
                                <circle cx="43" cy="40" r="2" fill="#333"/>
                                <circle cx="57" cy="40" r="2" fill="#333"/>
                                <!-- ì½” -->
                                <circle cx="50" cy="48" r="1" fill="#E6C2A6"/>
                                <!-- ì… -->
                                <path d="M46 55 Q50 58 54 55" stroke="#E6C2A6" stroke-width="2" fill="none"/>
                                <!-- AI ë¶„ì„ í¬ì¸íŠ¸ë“¤ -->
                                <circle cx="38" cy="42" r="1" fill="#00FF00"/>
                                <circle cx="62" cy="42" r="1" fill="#00FF00"/>
                                <circle cx="45" cy="50" r="1" fill="#00FF00"/>
                                <circle cx="55" cy="50" r="1" fill="#00FF00"/>
                                <circle cx="50" cy="35" r="1" fill="#00FF00"/>
                                <!-- ìŠ¤ìº” ë¼ì¸ -->
                                <line x1="20" y1="30" x2="80" y2="30" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                                <line x1="20" y1="45" x2="80" y2="45" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                                <line x1="20" y1="60" x2="80" y2="60" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                                <!-- Lab ê°’ í‘œì‹œ -->
                                <text x="10" y="85" font-family="Arial" font-size="8" fill="#666">L*a*b*</text>
                            </svg>
                        </div>
                        <h3>AI ì •ë°€ í”¼ë¶€í†¤ ë¶„ì„</h3>
                        <p><strong>MediaPipe 468í¬ì¸íŠ¸ ì–¼êµ´ ê°ì§€ë¡œ ì •í™•í•œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ</strong><br>
                        CIE Lab ìƒ‰ê³µê°„ ë³€í™˜ì„ í†µí•œ ê³¼í•™ì  ë¶„ì„<br>
                        í•œêµ­ì¸ í”¼ë¶€í†¤ ë°ì´í„°ë² ì´ìŠ¤ ë§¤ì¹­ìœ¼ë¡œ ê°œì¸ ë§ì¶¤ ê³„ì ˆ ë¶„ë¥˜</p>
                        <div class="mode-accuracy">ì •í™•ë„ 97.8%</div>
                        <button class="mode-btn" onclick="event.stopPropagation(); startFaceAnalysis()">AI ì •ë°€ ë¶„ì„ ì‹œì‘</button>
                    </div>
                    
                    <div class="mode-card" data-mode="virtual-draping" onclick="startVirtualDraping()">
                        <div class="mode-icon">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <!-- ì–¼êµ´ -->
                                <circle cx="50" cy="35" r="20" fill="#F8D7B3" stroke="#E6C2A6" stroke-width="2"/>
                                <!-- ë¨¸ë¦¬ -->
                                <path d="M30 25 Q30 10 50 10 Q70 10 70 25 Q70 20 50 20 Q30 20 30 25" fill="#8B4513"/>
                                <!-- ëˆˆ -->
                                <circle cx="44" cy="32" r="1.5" fill="#333"/>
                                <circle cx="56" cy="32" r="1.5" fill="#333"/>
                                <!-- ì½” -->
                                <circle cx="50" cy="38" r="0.8" fill="#E6C2A6"/>
                                <!-- ì… -->
                                <path d="M47 43 Q50 45 53 43" stroke="#E6C2A6" stroke-width="1.5" fill="none"/>
                                <!-- ìƒ‰ìƒ íŒ¬ (ë“œë˜ì´í•‘ ì²œë“¤) -->
                                <path d="M15 55 L50 50 L15 70 Z" fill="#FF6B6B"/>
                                <path d="M15 70 L50 50 L15 85 Z" fill="#4ECDC4"/>
                                <path d="M50 50 L85 55 L85 70 Z" fill="#FFE66D"/>
                                <path d="M50 50 L85 70 L85 85 Z" fill="#A8E6CF"/>
                                <path d="M50 50 L50 85 L35 85 Z" fill="#C7CEEA"/>
                                <path d="M50 50 L50 85 L65 85 Z" fill="#FFB3BA"/>
                                <!-- AR í‘œì‹œ -->
                                <rect x="5" y="5" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                                <rect x="89" y="5" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                                <rect x="5" y="89" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                                <rect x="89" y="89" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                                <!-- ë¸Œëœë“œ í‘œì‹œ -->
                                <text x="20" y="95" font-family="Arial" font-size="6" fill="#666">L'OREAL</text>
                                <text x="60" y="95" font-family="Arial" font-size="6" fill="#666">WELLA</text>
                            </svg>
                        </div>
                        <h3>ì „ë¬¸ê°€ AR ë“œë˜ì´í•‘ ìƒë‹´</h3>
                        <p><strong>ì‹¤ì‹œê°„ ê°€ìƒ ìƒ‰ìƒ í…ŒìŠ¤íŠ¸ë¡œ ê³ ê°ê³¼ í•¨ê»˜ í™•ì¸</strong><br>
                        ë¡œë ˆì•ŒÂ·ì›°ë¼Â·ìŠˆë°”ë¥´ì¸ ì½”í”„Â·ë°€ë³¸ ì‹¤ì œ ì œí’ˆ ìƒ‰ìƒ ë§¤ì¹­<br>
                        Delta E 2000 ê¸°ë°˜ ê³¼í•™ì  ìƒ‰ìƒ ì í•©ë„ ì¸¡ì •<br>
                        ì „ë¬¸ê°€ì™€ ê³ ê°ì´ í•¨ê»˜ ë³´ë©° ì¦‰ì„ ìƒë‹´ ê°€ëŠ¥</p>
                        <div class="mode-accuracy">ë¸Œëœë“œ ë§¤ì¹­ ì •í™•ë„ 94.2%</div>
                        <button class="mode-btn" onclick="event.stopPropagation(); startVirtualDraping()">AR ë“œë˜ì´í•‘ ì‹œì‘</button>
                    </div>
                </div>
            </section>

            <!-- ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„ ì„¹ì…˜ -->
            <section class="analysis-section" id="face-analysis-section">
                <div class="section-header">
                    <h3 class="section-title">ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„</h3>
                    <div class="section-badge">MediaPipe Active</div>
                </div>
                
                <!-- ì§„í–‰ ë‹¨ê³„ ì•ˆë‚´ -->
                <div class="progress-guide" id="progress-guide">
                    <div class="guide-step active" id="step-camera">
                        <div class="step-number">1</div>
                        <div class="step-text">ì¹´ë©”ë¼ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                    </div>
                    <div class="guide-step" id="step-position">
                        <div class="step-number">2</div>
                        <div class="step-text">ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì— ë§ì¶°ì£¼ì„¸ìš”</div>
                    </div>
                    <div class="guide-step" id="step-analyze">
                        <div class="step-number">3</div>
                        <div class="step-text">í”¼ë¶€í†¤ ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                    </div>
                </div>
                
                <div class="analysis-grid">
                    <div class="video-container">
                        <video class="video-feed" id="video-feed" autoplay muted playsinline></video>
                        <canvas class="face-overlay" id="face-overlay"></canvas>
                        
                        <!-- ì–¼êµ´ ê°€ì´ë“œë¼ì¸ -->
                        <div class="face-guide" id="face-guide">
                            <div class="guide-oval"></div>
                            <div class="guide-text">ì–¼êµ´ì„ íƒ€ì› ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
                        </div>
                    </div>
                    
                    <div class="results-panel">
                        <h4>ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„ ê²°ê³¼</h4>
                        
                        <div class="sample-info">
                            <div class="sample-count" id="sample-counter">ëŒ€ê¸° ì¤‘</div>
                            <p id="detection-status">ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”</p>
                        </div>
                        
                        <div class="lab-display">
                            <div class="lab-value">
                                <div class="lab-label">L* (ëª…ë„)</div>
                                <div class="lab-number" id="l-value">--</div>
                            </div>
                            <div class="lab-value">
                                <div class="lab-label">a* (ë¹¨ê°•-ì´ˆë¡)</div>
                                <div class="lab-number" id="a-value">--</div>
                            </div>
                            <div class="lab-value">
                                <div class="lab-label">b* (ë…¸ë‘-íŒŒë‘)</div>
                                <div class="lab-number" id="b-value">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="controls-grid">
                    <button class="btn btn-primary" id="start-camera-btn" onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                    <button class="btn btn-secondary" id="analyze-skin-btn" onclick="performSkinAnalysis()" disabled>í”¼ë¶€í†¤ ë¶„ì„</button>
                    <button class="btn btn-secondary" id="generate-report-btn" onclick="generateReport()" disabled style="display: none;">ì¢…í•© ë³´ê³ ì„œ ìƒì„±</button>
                    <button class="btn btn-secondary" id="back-to-menu-btn" onclick="backToMenu()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            </section>

            <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
            <div class="results-display" id="results-display">
                <div class="season-result">
                    <div class="best-season" id="best-season-text">ë¶„ì„ ì¤‘...</div>
                    <div class="season-confidence" id="season-confidence-text">ì‹ ë¢°ë„ ê³„ì‚° ì¤‘...</div>
                </div>

                <div class="color-palette" id="recommended-colors">
                    <!-- ì¶”ì²œ ìƒ‰ìƒë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>

                <div class="brand-recommendations">
                    <div class="brand-section">
                        <h4>ğŸ¨ ë§ì¶¤ í—¤ì–´ì»¬ëŸ¬ ì¶”ì²œ</h4>
                        <div class="brand-grid" id="hair-color-brands">
                            <!-- í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <div class="brand-section" style="margin-top: 2rem;">
                        <h4>ğŸ’„ ë§ì¶¤ ë©”ì´í¬ì—… ì¶”ì²œ</h4>
                        <div class="brand-grid" id="makeup-brands">
                            <!-- ë©”ì´í¬ì—… ë¸Œëœë“œ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // ===== ì „ì—­ ì‹œìŠ¤í…œ ìƒíƒœ ê´€ë¦¬ =====
        window.PersonalColorSystem = {
            version: 'CLEAN-HTML-v1.0',
            
            // ì‹¤ì œ ë¶„ì„ ë°ì´í„° ì €ì¥
            currentAnalysis: {
                skinTone: null,
                season: null,
                confidence: 0,
                labValues: { L: 0, a: 0, b: 0 },
                recommendedColors: [],
                brandMatches: []
            },
            
            // MediaPipe ë° AI ì—”ì§„
            engines: {
                faceMesh: null,
                camera: null,
                isInitialized: false
            },
            
            // ì„±ëŠ¥ í†µê³„
            stats: {
                totalAnalyses: 0,
                accurateDetections: 0,
                averageProcessingTime: 0
            }
        };

        // ===== ìƒ‰ìƒ ê³¼í•™ êµ¬í˜„ (ì¤‘ë³µ ì œê±°) =====
        
        // RGB to Lab ìƒ‰ê³µê°„ ë³€í™˜ (ì •í™•í•œ ìˆ˜ì‹)
        function rgbToLab(r, g, b) {
            // RGB ì •ê·œí™” (0-1)
            r = r / 255;
            g = g / 255;
            b = b / 255;

            // ê°ë§ˆ ë³´ì •
            r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

            // RGB to XYZ ë³€í™˜ (sRGB ê¸°ì¤€)
            let x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
            let y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
            let z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;

            // D65 í‘œì¤€ ì¡°ëª… ì •ê·œí™”
            x = x / 0.95047;
            y = y / 1.00000;
            z = z / 1.08883;

            // XYZ to Lab ë³€í™˜
            x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
            y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
            z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);

            const L = (116 * y) - 16;
            const A = 500 * (x - y);
            const B = 200 * (y - z);

            return { L: L, a: A, b: B };
        }

        // Delta E 2000 ìƒ‰ì°¨ ê³„ì‚° (ì •í™•í•œ ê³µì‹)
        function calculateDeltaE2000(lab1, lab2) {
            const L1 = lab1.L, a1 = lab1.a, b1 = lab1.b;
            const L2 = lab2.L, a2 = lab2.a, b2 = lab2.b;

            const deltaL = L2 - L1;
            const avgL = (L1 + L2) / 2;

            const C1 = Math.sqrt(a1 * a1 + b1 * b1);
            const C2 = Math.sqrt(a2 * a2 + b2 * b2);
            const avgC = (C1 + C2) / 2;
            const deltaC = C2 - C1;

            const G = 0.5 * (1 - Math.sqrt(Math.pow(avgC, 7) / (Math.pow(avgC, 7) + Math.pow(25, 7))));
            const a1_prime = a1 * (1 + G);
            const a2_prime = a2 * (1 + G);

            const C1_prime = Math.sqrt(a1_prime * a1_prime + b1 * b1);
            const C2_prime = Math.sqrt(a2_prime * a2_prime + b2 * b2);
            const avgC_prime = (C1_prime + C2_prime) / 2;
            const deltaC_prime = C2_prime - C1_prime;

            const deltaE = Math.sqrt(
                Math.pow(deltaL / 1, 2) +
                Math.pow(deltaC_prime / (1 * (1 + 0.045 * avgC_prime)), 2)
            );

            return deltaE;
        }

        // ===== í•œêµ­ì¸ í”¼ë¶€í†¤ ë°ì´í„°ë² ì´ìŠ¤ =====
        const KOREAN_SKIN_DATABASE = {
            seasons: {
                spring: {
                    name: 'ë´„ ì›œí†¤',
                    ranges: { L: [50, 70], a: [5, 15], b: [10, 25] },
                    characteristics: ['ë”°ëœ»í•œ í†¤', 'í™©ìƒ‰ ë² ì´ìŠ¤', 'ìƒê¸° ìˆëŠ” ëŠë‚Œ'],
                    colors: ['#FF6B6B', '#FFE66D', '#4ECDC4', '#45B7D1']
                },
                summer: {
                    name: 'ì—¬ë¦„ ì¿¨í†¤',
                    ranges: { L: [55, 75], a: [-5, 5], b: [-5, 10] },
                    characteristics: ['ì‹œì›í•œ í†¤', 'í•‘í¬/ë¸”ë£¨ ë² ì´ìŠ¤', 'ìš°ì•„í•œ ëŠë‚Œ'],
                    colors: ['#E8F4FD', '#B8E6B8', '#DDA0DD', '#F0E68C']
                },
                autumn: {
                    name: 'ê°€ì„ ì›œí†¤',
                    ranges: { L: [40, 60], a: [8, 18], b: [15, 30] },
                    characteristics: ['ê¹Šì€ ì›œí†¤', 'í™©ìƒ‰/ì£¼í™© ë² ì´ìŠ¤', 'ì„±ìˆ™í•œ ëŠë‚Œ'],
                    colors: ['#D2691E', '#B22222', '#DAA520', '#8B4513']
                },
                winter: {
                    name: 'ê²¨ìš¸ ì¿¨í†¤',
                    ranges: { L: [30, 50], a: [-8, 8], b: [-10, 5] },
                    characteristics: ['ê°•ë ¬í•œ ì¿¨í†¤', 'ë¸”ë£¨ ë² ì´ìŠ¤', 'ì„ ëª…í•œ ëŠë‚Œ'],
                    colors: ['#000080', '#8B008B', '#DC143C', '#1E90FF']
                }
            }
        };

        // ===== ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ =====
        const BRAND_DATABASE = {
            hairColor: {
                loreal: {
                    name: 'ë¡œë ˆì•Œ',
                    products: {
                        spring: ['6.35 ì´ˆì½œë¦¿ ë¸Œë¼ìš´', '7.13 ë² ì´ì§€ ë¸”ë¡ ë“œ', '5.25 ë§ˆí˜¸ê°€ë‹ˆ'],
                        summer: ['8.1 ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', '9.13 ë² ë¦¬ ë¼ì´íŠ¸ ë² ì´ì§€', '6.1 ë‹¤í¬ ì• ì‰¬ ë¸”ë¡ ë“œ'],
                        autumn: ['5.32 ë¼ì´íŠ¸ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', '4.15 ì• ì‰¬ ë§ˆí˜¸ê°€ë‹ˆ', '6.34 ë‹¤í¬ ê³¨ë“  ì½”í¼'],
                        winter: ['1.0 ë”¥ ë¸”ë™', '2.0 ë¸Œë¼ìš´ ë¸”ë™', '4.0 ë¯¸ë””ì—„ ë¸Œë¼ìš´']
                    }
                },
                wella: {
                    name: 'ì›°ë¼',
                    products: {
                        spring: ['7/3 ë¯¸ë””ì—„ ê³¨ë“  ë¸”ë¡ ë“œ', '6/7 ë‹¤í¬ ë¸Œë¼ìš´ ë ˆë“œ', '5/4 ë¼ì´íŠ¸ ë¸Œë¼ìš´ ë ˆë“œ'],
                        summer: ['8/81 ë¼ì´íŠ¸ ë¸”ë¡ ë“œ í„ ì• ì‰¬', '7/89 ë¯¸ë””ì—„ ë¸”ë¡ ë“œ í„', '9/16 ë² ë¦¬ ë¼ì´íŠ¸ ì• ì‰¬ ë°”ì´ì˜¬ë ›'],
                        autumn: ['5/73 ë¼ì´íŠ¸ ë¸Œë¼ìš´ ê³¨ë“ ', '4/77 ë¯¸ë””ì—„ ë¸Œë¼ìš´ ì¸í…ìŠ¤ ë¸Œë¼ìš´', '6/74 ë‹¤í¬ ë¸”ë¡ ë“œ ë¸Œë¼ìš´ ë ˆë“œ'],
                        winter: ['2/0 ë¸”ë™', '3/0 ë‹¤í¬ ë¸Œë¼ìš´', '4/6 ë¯¸ë””ì—„ ë¸Œë¼ìš´ ë°”ì´ì˜¬ë ›']
                    }
                }
            },
            makeup: {
                mac: {
                    name: 'M.A.C',
                    products: {
                        spring: ['Coral Bliss', 'Peaches', 'Warm Soul'],
                        summer: ['Dainty', 'Pink Swoon', 'Rosy Outlook'],
                        autumn: ['Harmony', 'Burnt Pepper', 'Coppertone'],
                        winter: ['Ruby Woo', 'Russian Red', 'Rebel']
                    }
                },
                estee_lauder: {
                    name: 'ì—ìŠ¤í‹°ë¡œë”',
                    products: {
                        spring: ['Pure Color Envy 260', 'Pure Color Envy 340', 'Pure Color Envy 420'],
                        summer: ['Pure Color Envy 240', 'Pure Color Envy 320', 'Pure Color Envy 350'],
                        autumn: ['Pure Color Envy 280', 'Pure Color Envy 460', 'Pure Color Envy 520'],
                        winter: ['Pure Color Envy 220', 'Pure Color Envy 380', 'Pure Color Envy 450']
                    }
                }
            }
        };

        // ===== MediaPipe ì–¼êµ´ ê°ì§€ êµ¬í˜„ =====
        async function initializeMediaPipe() {
            try {
                if (!window.FaceMesh) {
                    throw new Error('MediaPipe FaceMesh ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                const faceMesh = new window.FaceMesh({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
                });

                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onFaceMeshResults);
                window.PersonalColorSystem.engines.faceMesh = faceMesh;
                
                showToast('MediaPipe ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                document.getElementById('mediapipe-status').textContent = 'í™œì„±í™”ë¨';
                
                return true;
            } catch (error) {
                console.error('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showToast('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
                return false;
            }
        }

        // MediaPipe ê²°ê³¼ ì²˜ë¦¬
        function onFaceMeshResults(results) {
            const canvas = document.getElementById('face-overlay');
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) return;
            
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                updateProgressStep('analyze');
                
                // ì–¼êµ´ ìœ¤ê³½ ê·¸ë¦¬ê¸°
                drawFaceOutline(ctx, landmarks, canvas.width, canvas.height);
                
                // í”¼ë¶€ ìƒ˜í”Œë§ ì˜ì—­ í‘œì‹œ
                drawSamplingRegions(ctx, landmarks, canvas.width, canvas.height);
                
                // ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ ë° ë¶„ì„
                extractSkinPixels(results.image, landmarks);
                
                const analyzeBtn = document.getElementById('analyze-skin-btn');
                if (analyzeBtn) analyzeBtn.disabled = false;
                
            } else {
                updateProgressStep('position');
                const analyzeBtn = document.getElementById('analyze-skin-btn');
                if (analyzeBtn) analyzeBtn.disabled = true;
            }
        }

        // ì–¼êµ´ ìœ¤ê³½ ê·¸ë¦¬ê¸°
        function drawFaceOutline(ctx, landmarks, width, height) {
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // ì–¼êµ´ ê²½ê³„ì„  í¬ì¸íŠ¸ë“¤
            const faceOval = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
            
            for (let i = 0; i < faceOval.length; i++) {
                const point = landmarks[faceOval[i]];
                if (point) {
                    if (i === 0) {
                        ctx.moveTo(point.x * width, point.y * height);
                    } else {
                        ctx.lineTo(point.x * width, point.y * height);
                    }
                }
            }
            ctx.closePath();
            ctx.stroke();
        }

        // í”¼ë¶€ ìƒ˜í”Œë§ ì˜ì—­ í‘œì‹œ
        function drawSamplingRegions(ctx, landmarks, width, height) {
            ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
            
            // ì´ë§ˆ ì˜ì—­
            const foreheadRegion = [9, 10, 151, 337, 299, 333, 298, 301];
            drawRegion(ctx, landmarks, foreheadRegion, width, height);

            // ì™¼ìª½ ëº¨ ì˜ì—­
            const leftCheekRegion = [116, 117, 118, 119, 120, 121, 126, 142];
            drawRegion(ctx, landmarks, leftCheekRegion, width, height);

            // ì˜¤ë¥¸ìª½ ëº¨ ì˜ì—­
            const rightCheekRegion = [345, 346, 347, 348, 349, 350, 451, 452];
            drawRegion(ctx, landmarks, rightCheekRegion, width, height);
        }

        // ì˜ì—­ ê·¸ë¦¬ê¸° í—¬í¼
        function drawRegion(ctx, landmarks, region, width, height) {
            ctx.beginPath();
            region.forEach((pointIndex, i) => {
                const point = landmarks[pointIndex];
                if (point) {
                    if (i === 0) {
                        ctx.moveTo(point.x * width, point.y * height);
                    } else {
                        ctx.lineTo(point.x * width, point.y * height);
                    }
                }
            });
            ctx.closePath();
            ctx.fill();
        }

        // ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ ë° ë¶„ì„
        function extractSkinPixels(image, landmarks) {
            try {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = image.width;
                tempCanvas.height = image.height;
                tempCtx.drawImage(image, 0, 0);

                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const pixels = imageData.data;

                const skinPixels = [];
                
                // í”¼ë¶€ ì˜ì—­ì—ì„œ í”½ì…€ ìƒ˜í”Œë§
                const samplingRegions = [
                    [9, 10, 151, 337], // ì´ë§ˆ
                    [116, 117, 118, 119], // ì™¼ìª½ ëº¨
                    [345, 346, 347, 348] // ì˜¤ë¥¸ìª½ ëº¨
                ];

                samplingRegions.forEach(region => {
                    region.forEach(pointIndex => {
                        const point = landmarks[pointIndex];
                        if (point) {
                            const x = Math.floor(point.x * tempCanvas.width);
                            const y = Math.floor(point.y * tempCanvas.height);
                            
                            // ì£¼ë³€ í”½ì…€ë“¤ë„ ìƒ˜í”Œë§
                            for (let dx = -1; dx <= 1; dx++) {
                                for (let dy = -1; dy <= 1; dy++) {
                                    const px = x + dx;
                                    const py = y + dy;
                                    
                                    if (px >= 0 && px < tempCanvas.width && py >= 0 && py < tempCanvas.height) {
                                        const pixelIndex = (py * tempCanvas.width + px) * 4;
                                        const r = pixels[pixelIndex];
                                        const g = pixels[pixelIndex + 1];
                                        const b = pixels[pixelIndex + 2];
                                        
                                        // ìœ íš¨í•œ í”¼ë¶€ìƒ‰ í”½ì…€ì¸ì§€ í™•ì¸
                                        if (r > 50 && g > 50 && b > 50 && r < 250 && g < 250 && b < 250) {
                                            skinPixels.push({ r, g, b });
                                        }
                                    }
                                }
                            }
                        }
                    });
                });

                if (skinPixels.length > 0) {
                    // í‰ê·  í”¼ë¶€ìƒ‰ ê³„ì‚°
                    const avgR = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.r, 0) / skinPixels.length);
                    const avgG = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.g, 0) / skinPixels.length);
                    const avgB = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.b, 0) / skinPixels.length);

                    // Lab ìƒ‰ê³µê°„ ë³€í™˜
                    const labColor = rgbToLab(avgR, avgG, avgB);
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateLabDisplay(labColor);
                    updateSampleCounter(skinPixels.length);

                    // ì‹œìŠ¤í…œì— ì €ì¥
                    window.PersonalColorSystem.currentAnalysis.labValues = labColor;
                    window.PersonalColorSystem.currentAnalysis.skinTone = { r: avgR, g: avgG, b: avgB };

                    // ê³„ì ˆ ë¶„ë¥˜ ìˆ˜í–‰
                    classifySeasonType(labColor);
                }

            } catch (error) {
                console.error('í”¼ë¶€ í”½ì…€ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                showToast('í”¼ë¶€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // Lab ê°’ UI ì—…ë°ì´íŠ¸
        function updateLabDisplay(labColor) {
            const lValueEl = document.getElementById('l-value');
            const aValueEl = document.getElementById('a-value');
            const bValueEl = document.getElementById('b-value');
            
            if (lValueEl) lValueEl.textContent = labColor.L.toFixed(1);
            if (aValueEl) aValueEl.textContent = labColor.a.toFixed(1);
            if (bValueEl) bValueEl.textContent = labColor.b.toFixed(1);
        }

        // ìƒ˜í”Œ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
        function updateSampleCounter(count) {
            const sampleCounterEl = document.getElementById('sample-counter');
            const statusEl = document.getElementById('detection-status');
            
            if (sampleCounterEl) sampleCounterEl.textContent = `${count}ê°œ í”½ì…€ ë¶„ì„ë¨`;
            if (statusEl) statusEl.textContent = 'ì–¼êµ´ ê°ì§€ë¨ - ë¶„ì„ ì¤‘';
        }

        // ê³„ì ˆ ë¶„ë¥˜
        function classifySeasonType(labColor) {
            const seasons = KOREAN_SKIN_DATABASE.seasons;
            let bestSeason = null;
            let bestScore = 0;

            Object.keys(seasons).forEach(seasonKey => {
                const season = seasons[seasonKey];
                let score = 0;
                
                // ê° íŠ¹ì„±ë³„ ë§¤ì¹­ë„ ê³„ì‚°
                season.colors.forEach(colorHex => {
                    const targetLab = hexToLab(colorHex);
                    if (targetLab) {
                        const deltaE = calculateDeltaE2000(labColor, targetLab);
                        if (deltaE < 30) {
                            score += Math.max(0, 100 - deltaE * 2);
                        }
                    }
                });

                if (score > bestScore) {
                    bestScore = score;
                    bestSeason = seasonKey;
                }
            });

            // ê²°ê³¼ ì €ì¥
            window.PersonalColorSystem.currentAnalysis.season = bestSeason;
            window.PersonalColorSystem.currentAnalysis.confidence = bestScore;
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            window.PersonalColorSystem.stats.totalAnalyses++;
            if (bestScore > 70) {
                window.PersonalColorSystem.stats.accurateDetections++;
            }
            
            // UI ì—…ë°ì´íŠ¸
            const countEl = document.getElementById('diagnosis-count');
            if (countEl) countEl.textContent = window.PersonalColorSystem.stats.totalAnalyses;
        }

        // Hex to Lab ë³€í™˜
        function hexToLab(hex) {
            if (!hex || hex.length !== 7) return null;
            
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            
            return rgbToLab(r, g, b);
        }

        // ===== UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ =====
        
        // ì‹¤ì‹œê°„ í”¼ë¶€ ë¶„ì„ ì‹œì‘
        async function startFaceAnalysis() {
            try {
                // ëª¨ë“œ ì „í™˜
                document.getElementById('mode-selection').classList.add('hidden');
                document.getElementById('face-analysis-section').classList.add('active');
                
                // MediaPipe ì´ˆê¸°í™”
                await initializeMediaPipe();
                
                updateProgressStep('camera');
                showToast('í”¼ë¶€í†¤ ë¶„ì„ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                
            } catch (error) {
                console.error('ì–¼êµ´ ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('ë¶„ì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                updateProgressStep('position');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 1280, 
                        height: 720,
                        facingMode: 'user'
                    }
                });

                const videoElement = document.getElementById('video-feed');
                if (videoElement) {
                    videoElement.srcObject = stream;
                    
                    // MediaPipe ì¹´ë©”ë¼ ì—°ê²°
                    if (window.Camera && window.PersonalColorSystem.engines.faceMesh) {
                        const camera = new window.Camera(videoElement, {
                            onFrame: async () => {
                                await window.PersonalColorSystem.engines.faceMesh.send({ image: videoElement });
                            },
                            width: 1280,
                            height: 720
                        });

                        camera.start();
                        window.PersonalColorSystem.engines.camera = camera;
                    }
                    
                    const startBtn = document.getElementById('start-camera-btn');
                    if (startBtn) {
                        startBtn.textContent = 'ì¹´ë©”ë¼ í™œì„±í™”ë¨';
                        startBtn.disabled = true;
                    }
                    
                    const faceGuide = document.getElementById('face-guide');
                    if (faceGuide) faceGuide.classList.add('show');
                    
                    showToast('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì— ë§ì¶°ì£¼ì„¸ìš”.', 'success');
                }
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // í”¼ë¶€í†¤ ë¶„ì„ ì‹¤í–‰
        function performSkinAnalysis() {
            const analysis = window.PersonalColorSystem.currentAnalysis;
            
            if (!analysis.labValues || !analysis.season) {
                showToast('ë¨¼ì € ì–¼êµ´ ê°ì§€ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            // ê²°ê³¼ í‘œì‹œ
            displayAnalysisResults();
            showToast('í”¼ë¶€í†¤ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAnalysisResults() {
            const analysis = window.PersonalColorSystem.currentAnalysis;
            
            if (!analysis.season || !KOREAN_SKIN_DATABASE.seasons[analysis.season]) {
                showToast('ë¶„ì„ ê²°ê³¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const season = KOREAN_SKIN_DATABASE.seasons[analysis.season];
            
            // ê³„ì ˆ ê²°ê³¼ í‘œì‹œ
            const seasonElement = document.getElementById('best-season-text');
            if (seasonElement) {
                seasonElement.textContent = season.name;
                seasonElement.className = `best-season ${analysis.season}-result`;
            }
            
            const confidenceElement = document.getElementById('season-confidence-text');
            if (confidenceElement) {
                confidenceElement.textContent = `ì‹ ë¢°ë„ ${analysis.confidence.toFixed(1)}%`;
            }

            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ìƒì„±
            displayColorPalette(season);
            
            // ë¸Œëœë“œ ì¶”ì²œ ìƒì„±
            displayBrandRecommendations(analysis.season);

            // ë³´ê³ ì„œ ë²„íŠ¼ í™œì„±í™”
            const reportBtn = document.getElementById('generate-report-btn');
            if (reportBtn) {
                reportBtn.style.display = 'inline-block';
                reportBtn.disabled = false;
            }

            // ê²°ê³¼ íŒ¨ë„ í‘œì‹œ
            const resultsDisplay = document.getElementById('results-display');
            if (resultsDisplay) {
                resultsDisplay.classList.add('show');
            }
        }

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ í‘œì‹œ
        function displayColorPalette(season) {
            const colorsContainer = document.getElementById('recommended-colors');
            if (!colorsContainer) return;
            
            colorsContainer.innerHTML = '';
            
            season.colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-item';
                colorDiv.style.backgroundColor = color;
                colorDiv.innerHTML = `
                    <div class="color-info">
                        <div class="color-number">ì¶”ì²œ ${index + 1}</div>
                        <div class="color-name">${season.name} ì»¬ëŸ¬</div>
                        <div class="color-description">${season.characteristics[index % season.characteristics.length]}</div>
                    </div>
                `;
                colorsContainer.appendChild(colorDiv);
            });
        }

        // ë¸Œëœë“œ ì¶”ì²œ í‘œì‹œ
        function displayBrandRecommendations(season) {
            // í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ
            const hairContainer = document.getElementById('hair-color-brands');
            if (hairContainer) {
                hairContainer.innerHTML = '';
                
                Object.keys(BRAND_DATABASE.hairColor).forEach(brandKey => {
                    const brand = BRAND_DATABASE.hairColor[brandKey];
                    const products = brand.products[season] || [];
                    
                    if (products.length > 0) {
                        const brandDiv = document.createElement('div');
                        brandDiv.className = 'brand-item';
                        brandDiv.innerHTML = `
                            <div class="brand-name">${brand.name}</div>
                            <ul class="product-list">
                                ${products.map(product => `<li><span class="product-code">${product}</span></li>`).join('')}
                            </ul>
                        `;
                        hairContainer.appendChild(brandDiv);
                    }
                });
            }

            // ë©”ì´í¬ì—… ë¸Œëœë“œ
            const makeupContainer = document.getElementById('makeup-brands');
            if (makeupContainer) {
                makeupContainer.innerHTML = '';
                
                Object.keys(BRAND_DATABASE.makeup).forEach(brandKey => {
                    const brand = BRAND_DATABASE.makeup[brandKey];
                    const products = brand.products[season] || [];
                    
                    if (products.length > 0) {
                        const brandDiv = document.createElement('div');
                        brandDiv.className = 'brand-item';
                        brandDiv.innerHTML = `
                            <div class="brand-name">${brand.name}</div>
                            <ul class="product-list">
                                ${products.map(product => `<li><span class="product-code">${product}</span></li>`).join('')}
                            </ul>
                        `;
                        makeupContainer.appendChild(brandDiv);
                    }
                });
            }
        }

        // ì§„í–‰ ë‹¨ê³„ ì—…ë°ì´íŠ¸
        function updateProgressStep(step) {
            // ëª¨ë“  ë‹¨ê³„ ë¹„í™œì„±í™”
            document.querySelectorAll('.guide-step').forEach(el => el.classList.remove('active'));
            
            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            const currentStep = document.getElementById(`step-${step}`);
            if (currentStep) {
                currentStep.classList.add('active');
            }
        }

        // ===== 96ê°œ ìƒ‰ìƒ ë°ì´í„°ë² ì´ìŠ¤ (4ê³„ì ˆ Ã— 24ê°œ) =====
        const COMPLETE_COLOR_DATABASE = {
            spring: {
                bright: [
                    { name: 'Coral Pink', hex: '#FF7F7F', rgb: [255, 127, 127] },
                    { name: 'Peach', hex: '#FFCBA4', rgb: [255, 203, 164] },
                    { name: 'Golden Yellow', hex: '#FFD700', rgb: [255, 215, 0] },
                    { name: 'Warm Beige', hex: '#F5DEB3', rgb: [245, 222, 179] },
                    { name: 'Light Coral', hex: '#F08080', rgb: [240, 128, 128] },
                    { name: 'Apricot', hex: '#FBCEB1', rgb: [251, 206, 177] },
                    { name: 'Buttercup', hex: '#F2E23D', rgb: [242, 226, 61] },
                    { name: 'Spring Green', hex: '#00FF7F', rgb: [0, 255, 127] }
                ],
                light: [
                    { name: 'Soft Peach', hex: '#FFDAB9', rgb: [255, 218, 185] },
                    { name: 'Cream', hex: '#FFFDD0', rgb: [255, 253, 208] },
                    { name: 'Light Pink', hex: '#FFB6C1', rgb: [255, 182, 193] },
                    { name: 'Ivory', hex: '#FFFFF0', rgb: [255, 255, 240] },
                    { name: 'Pale Yellow', hex: '#FFFFE0', rgb: [255, 255, 224] },
                    { name: 'Blush', hex: '#DE5D83', rgb: [222, 93, 131] },
                    { name: 'Champagne', hex: '#F7E7CE', rgb: [247, 231, 206] },
                    { name: 'Baby Blue', hex: '#89CFF0', rgb: [137, 207, 240] }
                ],
                warm: [
                    { name: 'Golden Tan', hex: '#D2B48C', rgb: [210, 180, 140] },
                    { name: 'Terracotta', hex: '#E2725B', rgb: [226, 114, 91] },
                    { name: 'Warm Brown', hex: '#964B00', rgb: [150, 75, 0] },
                    { name: 'Mustard', hex: '#FFDB58', rgb: [255, 219, 88] },
                    { name: 'Copper', hex: '#B87333', rgb: [184, 115, 51] },
                    { name: 'Amber', hex: '#FFBF00', rgb: [255, 191, 0] },
                    { name: 'Burnt Orange', hex: '#CC5500', rgb: [204, 85, 0] },
                    { name: 'Caramel', hex: '#C68E17', rgb: [198, 142, 23] }
                ]
            },
            summer: {
                light: [
                    { name: 'Rose Pink', hex: '#FFB6C1', rgb: [255, 182, 193] },
                    { name: 'Lavender', hex: '#E6E6FA', rgb: [230, 230, 250] },
                    { name: 'Baby Blue', hex: '#ADD8E6', rgb: [173, 216, 230] },
                    { name: 'Cool Beige', hex: '#F5F5DC', rgb: [245, 245, 220] },
                    { name: 'Soft Gray', hex: '#D3D3D3', rgb: [211, 211, 211] },
                    { name: 'Powder Blue', hex: '#B0E0E6', rgb: [176, 224, 230] },
                    { name: 'Pale Mint', hex: '#F5FFFA', rgb: [245, 255, 250] },
                    { name: 'Cool White', hex: '#F8F8FF', rgb: [248, 248, 255] }
                ],
                soft: [
                    { name: 'Dusty Rose', hex: '#BC8F8F', rgb: [188, 143, 143] },
                    { name: 'Sage Green', hex: '#9CAF88', rgb: [156, 175, 136] },
                    { name: 'Steel Blue', hex: '#4682B4', rgb: [70, 130, 180] },
                    { name: 'Mauve', hex: '#E0B0FF', rgb: [224, 176, 255] },
                    { name: 'Cool Taupe', hex: '#8B7D6B', rgb: [139, 125, 107] },
                    { name: 'Periwinkle', hex: '#C5C5FF', rgb: [197, 197, 255] },
                    { name: 'Seafoam', hex: '#71EEB8', rgb: [113, 238, 184] },
                    { name: 'Dove Gray', hex: '#6D6D6D', rgb: [109, 109, 109] }
                ],
                cool: [
                    { name: 'Cool Pink', hex: '#FF1493', rgb: [255, 20, 147] },
                    { name: 'Icy Blue', hex: '#AFEEEE', rgb: [175, 238, 238] },
                    { name: 'Silver Gray', hex: '#C0C0C0', rgb: [192, 192, 192] },
                    { name: 'Cool Purple', hex: '#9300D3', rgb: [147, 0, 211] },
                    { name: 'Navy Blue', hex: '#000080', rgb: [0, 0, 128] },
                    { name: 'Platinum', hex: '#E5E4E2', rgb: [229, 228, 226] },
                    { name: 'Mint', hex: '#98FB98', rgb: [152, 251, 152] },
                    { name: 'Pearl', hex: '#EAE0C8', rgb: [234, 224, 200] }
                ]
            },
            autumn: {
                deep: [
                    { name: 'Burgundy', hex: '#800020', rgb: [128, 0, 32] },
                    { name: 'Forest Green', hex: '#228B22', rgb: [34, 139, 34] },
                    { name: 'Golden Brown', hex: '#996515', rgb: [153, 101, 21] },
                    { name: 'Deep Orange', hex: '#FF8C00', rgb: [255, 140, 0] },
                    { name: 'Rust', hex: '#B7410E', rgb: [183, 65, 14] },
                    { name: 'Olive', hex: '#808000', rgb: [128, 128, 0] },
                    { name: 'Maroon', hex: '#800000', rgb: [128, 0, 0] },
                    { name: 'Dark Goldenrod', hex: '#B8860B', rgb: [184, 134, 11] }
                ],
                warm: [
                    { name: 'Burnt Orange', hex: '#CC5500', rgb: [204, 85, 0] },
                    { name: 'Pumpkin', hex: '#FF7518', rgb: [255, 117, 24] },
                    { name: 'Sienna', hex: '#A0522D', rgb: [160, 82, 45] },
                    { name: 'Chocolate', hex: '#D2691E', rgb: [210, 105, 30] },
                    { name: 'Cayenne', hex: '#CE2029', rgb: [206, 32, 41] },
                    { name: 'Paprika', hex: '#CC6600', rgb: [204, 102, 0] },
                    { name: 'Cinnamon', hex: '#D2691E', rgb: [210, 105, 30] },
                    { name: 'Brick Red', hex: '#CB4154', rgb: [203, 65, 84] }
                ],
                soft: [
                    { name: 'Camel', hex: '#C19A6B', rgb: [193, 154, 107] },
                    { name: 'Mushroom', hex: '#C4A484', rgb: [196, 164, 132] },
                    { name: 'Sage', hex: '#87AE73', rgb: [135, 174, 115] },
                    { name: 'Taupe', hex: '#483C32', rgb: [72, 60, 50] },
                    { name: 'Coffee', hex: '#6F4E37', rgb: [111, 78, 55] },
                    { name: 'Khaki', hex: '#C3B091', rgb: [195, 176, 145] },
                    { name: 'Moss Green', hex: '#8A9A5B', rgb: [138, 154, 91] },
                    { name: 'Warm Gray', hex: '#8B8680', rgb: [139, 134, 128] }
                ]
            },
            winter: {
                deep: [
                    { name: 'True Red', hex: '#FF0000', rgb: [255, 0, 0] },
                    { name: 'Royal Blue', hex: '#4169E1', rgb: [65, 105, 225] },
                    { name: 'Black', hex: '#000000', rgb: [0, 0, 0] },
                    { name: 'Pure White', hex: '#FFFFFF', rgb: [255, 255, 255] },
                    { name: 'Emerald Green', hex: '#50C878', rgb: [80, 200, 120] },
                    { name: 'Deep Purple', hex: '#663399', rgb: [102, 51, 153] },
                    { name: 'Crimson', hex: '#DC143C', rgb: [220, 20, 60] },
                    { name: 'Midnight Blue', hex: '#191970', rgb: [25, 25, 112] }
                ],
                cool: [
                    { name: 'Cool Pink', hex: '#FF69B4', rgb: [255, 105, 180] },
                    { name: 'Icy Blue', hex: '#B0E0E6', rgb: [176, 224, 230] },
                    { name: 'Silver Gray', hex: '#C0C0C0', rgb: [192, 192, 192] },
                    { name: 'Fuchsia', hex: '#FF00FF', rgb: [255, 0, 255] },
                    { name: 'Teal', hex: '#008080', rgb: [0, 128, 128] },
                    { name: 'Indigo', hex: '#4B0082', rgb: [75, 0, 130] },
                    { name: 'Aqua', hex: '#00FFFF', rgb: [0, 255, 255] },
                    { name: 'Plum', hex: '#DDA0DD', rgb: [221, 160, 221] }
                ],
                clear: [
                    { name: 'Electric Blue', hex: '#7DF9FF', rgb: [125, 249, 255] },
                    { name: 'Lime Green', hex: '#32CD32', rgb: [50, 205, 50] },
                    { name: 'Hot Pink', hex: '#FF69B4', rgb: [255, 105, 180] },
                    { name: 'Bright Yellow', hex: '#FFFF00', rgb: [255, 255, 0] },
                    { name: 'Magenta', hex: '#FF00FF', rgb: [255, 0, 255] },
                    { name: 'Turquoise', hex: '#40E0D0', rgb: [64, 224, 208] },
                    { name: 'Violet', hex: '#8A2BE2', rgb: [138, 43, 226] },
                    { name: 'Neon Green', hex: '#39FF14', rgb: [57, 255, 20] }
                ]
            }
        };

        // 96ê°œ ìƒ‰ìƒ í”Œë« ë°°ì—´ë¡œ ë³€í™˜
        function generateAllColors() {
            const allColors = [];
            Object.keys(COMPLETE_COLOR_DATABASE).forEach(seasonKey => {
                const season = COMPLETE_COLOR_DATABASE[seasonKey];
                Object.keys(season).forEach(toneKey => {
                    const colors = season[toneKey];
                    colors.forEach(colorData => {
                        allColors.push({
                            hex: colorData.hex,
                            name: colorData.name,
                            rgb: colorData.rgb,
                            season: seasonKey,
                            tone: toneKey,
                            seasonName: KOREAN_SKIN_DATABASE.seasons[seasonKey]?.name || seasonKey,
                            description: `${seasonKey} ${toneKey}`
                        });
                    });
                });
            });
            return allColors;
        }

        // ê°€ìƒ ë“œë˜ì´í•‘ ì‹œì‘ (ì™„ì „ êµ¬í˜„)
        function startVirtualDraping() {
            try {
                // ëª¨ë“œ ì „í™˜
                document.getElementById('mode-selection').classList.add('hidden');
                
                // ë“œë˜ì´í•‘ ì„¹ì…˜ ìƒì„±
                const drapingSection = document.createElement('section');
                drapingSection.className = 'analysis-section active';
                drapingSection.id = 'draping-section';
                
                // ì „ì²´ 96ê°œ ìƒ‰ìƒ ìƒì„±
                const allColors = generateAllColors();
                
                let colorGridHTML = '';
                allColors.forEach((color, index) => {
                    colorGridHTML += `
                        <div class="test-color" style="background: ${color.hex}" 
                             data-season="${color.season}" data-tone="${color.tone}"
                             onclick="testDrapingColor('${color.hex}', '${color.name}', '${color.seasonName}', '${color.tone}', '${color.description}')">
                            <div class="color-name">${color.name}</div>
                            <div class="color-info">
                                <div class="color-tone">${color.tone}</div>
                                <div class="color-season">${color.seasonName}</div>
                            </div>
                        </div>
                    `;
                });
                
                drapingSection.innerHTML = `
                    <div class="section-header">
                        <h3 class="section-title">ê°€ìƒ ë“œë˜ì´í•‘ ëª¨ë“œ (96ê°œ ìƒ‰ìƒ)</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div class="section-badge">AR Draping - ${allColors.length}ê°œ ìƒ‰ìƒ</div>
                            <button onclick="backToMenuFromDraping()" 
                                    style="background: #dc3545; color: white; border: none; border-radius: 50%; 
                                           width: 35px; height: 35px; cursor: pointer; font-size: 16px;">âœ•</button>
                        </div>
                    </div>
                    
                    <div class="draping-content" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem;">
                        <div class="draping-video-area" style="position: relative; background: #000; border-radius: 8px; overflow: hidden; min-height: 500px;">
                            <video class="draping-video" id="draping-video" autoplay muted playsinline 
                                   style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
                            <div class="color-overlay" id="color-overlay" 
                                 style="position: absolute; top: 15%; left: 50%; width: 100px; height: 50px; 
                                        transform: translate(-50%, -50%); border-radius: 15px; opacity: 0.9; display: none; 
                                        border: 2px solid white; box-shadow: 0 0 25px rgba(0,0,0,0.6); z-index: 10;"></div>
                        </div>
                        
                        <div class="draping-controls" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
                            <h4>ì „ì²´ ìƒ‰ìƒ í…ŒìŠ¤íŠ¸ (96ê°œ)</h4>
                            
                            <div class="filter-controls" style="margin: 1rem 0;">
                                <div class="season-tabs" style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                                    <button class="season-tab active" onclick="filterColors('all')" 
                                            style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: var(--primary); color: white; 
                                                   border-radius: 15px; cursor: pointer; font-size: 0.75rem;">ì „ì²´ (${allColors.length})</button>
                                    <button class="season-tab" onclick="filterColors('spring')" 
                                            style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; 
                                                   border-radius: 15px; cursor: pointer; font-size: 0.75rem;">ë´„ (24)</button>
                                    <button class="season-tab" onclick="filterColors('summer')" 
                                            style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; 
                                                   border-radius: 15px; cursor: pointer; font-size: 0.75rem;">ì—¬ë¦„ (24)</button>
                                    <button class="season-tab" onclick="filterColors('autumn')" 
                                            style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; 
                                                   border-radius: 15px; cursor: pointer; font-size: 0.75rem;">ê°€ì„ (24)</button>
                                    <button class="season-tab" onclick="filterColors('winter')" 
                                            style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; 
                                                   border-radius: 15px; cursor: pointer; font-size: 0.75rem;">ê²¨ìš¸ (24)</button>
                                </div>
                            </div>
                            
                            <div class="color-test-grid" id="color-test-grid" 
                                 style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
                                        gap: 0.6rem; max-height: 450px; overflow-y: auto;">
                                ${colorGridHTML}
                            </div>
                            
                            <div class="draping-result" id="draping-result" 
                                 style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                                <h5>ë§¤ì¹­ ê²°ê³¼</h5>
                                <div id="draping-score" style="text-align: center;">ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>
                                <div id="brand-match" style="margin-top: 1rem; display: none;">
                                    <h6>ë§ì¶¤ ë¸Œëœë“œ ì¶”ì²œ</h6>
                                    <div id="brand-products" style="display: grid; gap: 0.4rem; margin-top: 0.5rem;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="controls-grid">
                        <button class="btn btn-primary" id="start-draping-camera">ì¹´ë©”ë¼ ì‹œì‘</button>
                        <button class="btn btn-secondary" onclick="captureCurrentLook()">í˜„ì¬ ëª¨ìŠµ ìº¡ì²˜</button>
                        <button class="btn btn-secondary" onclick="resetDrapingFilters()">í•„í„° ì´ˆê¸°í™”</button>
                        <button class="btn btn-secondary" onclick="backToMenuFromDraping()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
                
                // CSS ì¶”ê°€ (ë“œë˜ì´í•‘ ì „ìš©)
                const style = document.createElement('style');
                style.textContent = `
                    .test-color {
                        padding: 0.8rem 0.4rem; border-radius: 6px; text-align: center; color: white; 
                        cursor: pointer; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                        transition: all 0.2s; min-height: 70px; display: flex; flex-direction: column;
                        justify-content: center; position: relative; overflow: hidden;
                    }
                    .test-color:hover { 
                        transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 5; 
                    }
                    .test-color.hidden { display: none; }
                    .color-name { font-size: 0.7rem; line-height: 1.1; margin-bottom: 0.3rem; font-weight: 700; }
                    .color-info { font-size: 0.6rem; opacity: 0.9; line-height: 1; }
                    .color-tone { margin-bottom: 0.1rem; }
                    .color-season { font-size: 0.55rem; }
                    .season-tab.active { background: var(--primary) !important; color: white !important; }
                    .season-tab:hover:not(.active) { background: var(--primary-light) !important; }
                `;
                document.head.appendChild(style);
                
                document.querySelector('.main-content').appendChild(drapingSection);
                
                // ESC í‚¤ë¡œ ë‹«ê¸°
                const handleDrapingEscape = (e) => {
                    if (e.key === 'Escape') {
                        backToMenuFromDraping();
                        document.removeEventListener('keydown', handleDrapingEscape);
                    }
                };
                document.addEventListener('keydown', handleDrapingEscape);
                
                // ì¹´ë©”ë¼ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.getElementById('start-draping-camera').addEventListener('click', async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { width: 1280, height: 720, facingMode: 'user' }
                        });
                        document.getElementById('draping-video').srcObject = stream;
                        document.getElementById('start-draping-camera').textContent = 'ì¹´ë©”ë¼ í™œì„±í™”ë¨';
                        document.getElementById('start-draping-camera').disabled = true;
                        showToast('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    } catch (error) {
                        showToast('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                    }
                });
                
                showToast(`ê°€ìƒ ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ - ì´ ${allColors.length}ê°œ ì „ë¬¸ ìƒ‰ìƒ ì‚¬ìš© ê°€ëŠ¥`, 'success');
                
            } catch (error) {
                console.error('ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ê³„ì ˆë³„ ìƒ‰ìƒ í•„í„°ë§
        function filterColors(season) {
            const tabs = document.querySelectorAll('.season-tab');
            const colors = document.querySelectorAll('.test-color');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            colors.forEach(color => {
                const colorSeason = color.dataset.season;
                if (season === 'all' || colorSeason === season) {
                    color.classList.remove('hidden');
                } else {
                    color.classList.add('hidden');
                }
            });
            
            const visibleCount = document.querySelectorAll('.test-color:not(.hidden)').length;
            showToast(`${season === 'all' ? 'ì „ì²´' : season} ìƒ‰ìƒ ${visibleCount}ê°œ í‘œì‹œ`, 'info');
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetDrapingFilters() {
            const seasonTabs = document.querySelectorAll('.season-tab');
            const colors = document.querySelectorAll('.test-color');
            
            seasonTabs.forEach(tab => tab.classList.remove('active'));
            seasonTabs[0].classList.add('active'); // 'ì „ì²´' ë²„íŠ¼ í™œì„±í™”
            
            colors.forEach(color => {
                color.classList.remove('hidden');
            });
            
            showToast('ëª¨ë“  í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤ - 96ê°œ ìƒ‰ìƒ í‘œì‹œ', 'info');
        }

        // ë“œë˜ì´í•‘ ìƒ‰ìƒ í…ŒìŠ¤íŠ¸ (Delta E 2000 ê¸°ë°˜)
        function testDrapingColor(color, colorName, seasonName, toneName, description) {
            const overlay = document.getElementById('color-overlay');
            const result = document.getElementById('draping-result');
            const brandMatch = document.getElementById('brand-match');
            
            if (overlay) {
                overlay.style.backgroundColor = color;
                overlay.style.display = 'block';
            }
            
            // Delta E 2000 ê¸°ë°˜ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
            let score = calculateColorMatchingScore(color);
            
            document.getElementById('draping-score').innerHTML = `
                <div style="font-size: 1rem; color: var(--primary); margin-bottom: 0.3rem;">${colorName}</div>
                <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.2rem;">${toneName}</div>
                <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem;">${description}</div>
                <div style="font-size: 2.4rem; font-weight: bold; color: ${score > 90 ? 'var(--success)' : score > 80 ? 'var(--primary)' : score > 70 ? 'var(--warning)' : 'var(--error)'};">${score}ì </div>
                <div style="font-size: 0.9rem; color: var(--text-light);">${getScoreDescription(score)}</div>
            `;
            
            // ë¸Œëœë“œ ë§¤ì¹­ (ì ìˆ˜ê°€ 75ì  ì´ìƒì¼ ë•Œ)
            if (score > 75) {
                displayBrandMatching(seasonName, toneName);
                brandMatch.style.display = 'block';
            } else {
                brandMatch.style.display = 'none';
            }
            
            showToast(`${colorName} (${toneName}) - ${score}ì `, score > 85 ? 'success' : score > 75 ? 'info' : 'warning');
        }

        // ìƒ‰ìƒ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° (ì‹¤ì œ í”¼ë¶€í†¤ vs ì„ íƒ ìƒ‰ìƒ)
        function calculateColorMatchingScore(selectedColor) {
            const currentAnalysis = window.PersonalColorSystem.currentAnalysis;
            
            if (!currentAnalysis.labValues || !currentAnalysis.season) {
                // ê¸°ë³¸ ì ìˆ˜ (ëœë¤ ì‹œë®¬ë ˆì´ì…˜)
                return Math.floor(Math.random() * 25) + 65; // 65-90ì 
            }
            
            // ì‹¤ì œ í”¼ë¶€í†¤ê³¼ì˜ Delta E ê³„ì‚°
            const selectedLab = hexToLab(selectedColor);
            if (!selectedLab) return 50;
            
            const deltaE = calculateDeltaE2000(currentAnalysis.labValues, selectedLab);
            
            // Delta Eë¥¼ ì ìˆ˜ë¡œ ë³€í™˜ (0-100ì )
            // Delta E < 5: 90-100ì , Delta E < 10: 80-89ì , ...
            let score = Math.max(0, Math.min(100, 100 - deltaE * 5));
            
            // ê³„ì ˆ ë§¤ì¹­ ë³´ë„ˆìŠ¤
            const seasonColors = COMPLETE_COLOR_DATABASE[currentAnalysis.season];
            if (seasonColors) {
                let seasonBonus = 0;
                Object.values(seasonColors).forEach(toneColors => {
                    toneColors.forEach(colorData => {
                        if (colorData.hex === selectedColor) {
                            seasonBonus = 20; // ê°™ì€ ê³„ì ˆ ìƒ‰ìƒì´ë©´ +20ì 
                        }
                    });
                });
                score = Math.min(100, score + seasonBonus);
            }
            
            return Math.round(score);
        }

        // ì ìˆ˜ ì„¤ëª…
        function getScoreDescription(score) {
            if (score >= 95) return 'ì™„ë²½í•œ ë§¤ì¹­!';
            if (score >= 90) return 'ë§¤ìš° ì˜ ì–´ìš¸ë¦¼';
            if (score >= 85) return 'ì˜ ì–´ìš¸ë¦¼';
            if (score >= 80) return 'ê´œì°®ìŒ';
            if (score >= 75) return 'ë³´í†µ';
            if (score >= 70) return 'ì•½ê°„ ì–´ìƒ‰í•¨';
            return 'ë‹¤ë¥¸ ìƒ‰ìƒì„ ì¶”ì²œ';
        }

        // ë¸Œëœë“œ ë§¤ì¹­ í‘œì‹œ
        function displayBrandMatching(seasonName, toneName) {
            const currentSeason = Object.keys(KOREAN_SKIN_DATABASE.seasons).find(key => 
                KOREAN_SKIN_DATABASE.seasons[key].name === seasonName
            ) || 'spring';
            
            let brandHTML = '';
            Object.keys(BRAND_DATABASE.hairColor).slice(0, 3).forEach(brandKey => {
                const brand = BRAND_DATABASE.hairColor[brandKey];
                const products = brand.products[currentSeason]?.slice(0, 2) || [];
                if (products.length > 0) {
                    brandHTML += `<div style="padding: 0.4rem; background: var(--bg-light); border-radius: 4px; font-size: 0.75rem;">
                        <strong>${brand.name}:</strong> ${products.join(', ')}</div>`;
                }
            });
            
            if (brandHTML) {
                document.getElementById('brand-products').innerHTML = brandHTML;
            }
        }

        // í˜„ì¬ ëª¨ìŠµ ìº¡ì²˜
        function captureCurrentLook() {
            const video = document.getElementById('draping-video');
            if (!video.srcObject) {
                showToast('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `draping_capture_${Date.now()}.png`;
            link.href = dataURL;
            link.click();
            
            showToast('í˜„ì¬ ë“œë˜ì´í•‘ ëª¨ìŠµì´ ìº¡ì²˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // ë“œë˜ì´í•‘ì—ì„œ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
        function backToMenuFromDraping() {
            const drapingSection = document.getElementById('draping-section');
            if (drapingSection) {
                // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ì§€
                const video = document.getElementById('draping-video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                
                drapingSection.remove();
            }
            
            document.getElementById('mode-selection').classList.remove('hidden');
            showToast('ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤', 'info');
        }

        // ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ í‘œì‹œ
        function showBrandDatabase() {
            let brandHTML = '<h2>ì „ì²´ ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤</h2>';
            
            // í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ
            brandHTML += '<h3>í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ</h3>';
            Object.keys(BRAND_DATABASE.hairColor).forEach(brandKey => {
                const brand = BRAND_DATABASE.hairColor[brandKey];
                brandHTML += `<h4>${brand.name}</h4>`;
                Object.keys(brand.products).forEach(season => {
                    brandHTML += `<p><strong>${season}:</strong> ${brand.products[season].join(', ')}</p>`;
                });
            });
            
            // ë©”ì´í¬ì—… ë¸Œëœë“œ
            brandHTML += '<h3>ë©”ì´í¬ì—… ë¸Œëœë“œ</h3>';
            Object.keys(BRAND_DATABASE.makeup).forEach(brandKey => {
                const brand = BRAND_DATABASE.makeup[brandKey];
                brandHTML += `<h4>${brand.name}</h4>`;
                Object.keys(brand.products).forEach(season => {
                    brandHTML += `<p><strong>${season}:</strong> ${brand.products[season].join(', ')}</p>`;
                });
            });
            
            // ëª¨ë‹¬ë¡œ í‘œì‹œ
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 1000;
                display: flex; justify-content: center; align-items: center;
                padding: 2rem;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; max-width: 800px; max-height: 80vh;
                border-radius: 12px; overflow-y: auto; padding: 2rem;
            `;
            
            content.innerHTML = brandHTML + '<button onclick="this.closest(\'div\').remove()" style="margin-top: 2rem; padding: 0.5rem 2rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // ë³´ê³ ì„œ ì˜µì…˜ í‘œì‹œ
        function showReportOptions() {
            const analysis = window.PersonalColorSystem.currentAnalysis;
            
            if (!analysis.season) {
                showToast('ë¨¼ì € í”¼ë¶€í†¤ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            generateReport();
        }

        // ë³´ê³ ì„œ ìƒì„±
        function generateReport() {
            try {
                const analysis = window.PersonalColorSystem.currentAnalysis;
                const season = KOREAN_SKIN_DATABASE.seasons[analysis.season];
                
                showToast('ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
                
                const reportContent = `
í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ë³´ê³ ì„œ
========================================

ìƒì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}

â–  ì§„ë‹¨ ê²°ê³¼
ê³„ì ˆ íƒ€ì…: ${season.name}
ì‹ ë¢°ë„: ${analysis.confidence.toFixed(1)}%

â–  í”¼ë¶€í†¤ ë¶„ì„
L* (ëª…ë„): ${analysis.labValues.L.toFixed(1)}
a* (ë¹¨ê°•-ì´ˆë¡): ${analysis.labValues.a.toFixed(1)}
b* (ë…¸ë‘-íŒŒë‘): ${analysis.labValues.b.toFixed(1)}

â–  íŠ¹ì„±
${season.characteristics.join(', ')}

â–  ì¶”ì²œ í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ
${Object.entries(BRAND_DATABASE.hairColor).map(([key, brand]) => 
`${brand.name}: ${brand.products[analysis.season]?.join(', ') || 'ì¶”ì²œ ì œí’ˆ ì¤€ë¹„ ì¤‘'}`
).join('\n')}

â–  ì¶”ì²œ ë©”ì´í¬ì—… ë¸Œëœë“œ
${Object.entries(BRAND_DATABASE.makeup).map(([key, brand]) =>
`${brand.name}: ${brand.products[analysis.season]?.join(', ') || 'ì¶”ì²œ ì œí’ˆ ì¤€ë¹„ ì¤‘'}`  
).join('\n')}

========================================
Personal Color AI Pro
`;
                
                // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `í¼ìŠ¤ë„ì»¬ëŸ¬_ì§„ë‹¨ë³´ê³ ì„œ_${Date.now()}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('ì§„ë‹¨ ë³´ê³ ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                console.error('ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨:', error);
                showToast('ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function resetSystem() {
            if (confirm('ëª¨ë“  ë¶„ì„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
                window.PersonalColorSystem.currentAnalysis = {
                    skinTone: null,
                    season: null,
                    confidence: 0,
                    labValues: { L: 0, a: 0, b: 0 },
                    recommendedColors: [],
                    brandMatches: []
                };
                
                // UI ì´ˆê¸°í™”
                document.querySelectorAll('.analysis-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('mode-selection').classList.remove('hidden');
                document.getElementById('results-display').classList.remove('show');
                
                // ì¹´ë©”ë¼ ì •ì§€
                if (window.PersonalColorSystem.engines.camera) {
                    window.PersonalColorSystem.engines.camera.stop();
                }
                
                showToast('ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        // ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
        function backToMenu() {
            document.getElementById('face-analysis-section').classList.remove('active');
            document.getElementById('mode-selection').classList.remove('hidden');
            document.getElementById('results-display').classList.remove('show');
            
            // ì¹´ë©”ë¼ ì •ì§€
            if (window.PersonalColorSystem.engines.camera) {
                window.PersonalColorSystem.engines.camera.stop();
            }
            
            const faceGuide = document.getElementById('face-guide');
            if (faceGuide) faceGuide.classList.remove('show');
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì‹œìŠ¤í…œ
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì‹œìŠ¤í…œ ì¤€ë¹„ í‘œì‹œ
            setTimeout(() => {
                const systemReady = document.getElementById('system-ready');
                if (systemReady) {
                    systemReady.style.display = 'block';
                }
                showToast('Personal Color AI Pro ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }, 1000);

            console.log('=== Personal Color AI Pro Clean v1.0 ===');
            console.log('âœ… HTML + CSS ë¶„ë¦¬ ì™„ë£Œ');
            console.log('âœ… ì¤‘ë³µ í•¨ìˆ˜ ì œê±° ì™„ë£Œ'); 
            console.log('âœ… ì½”ë“œ ì •ë¦¬ ì™„ë£Œ');
            console.log('- MediaPipe 468í¬ì¸íŠ¸ ì–¼êµ´ ê°ì§€');
            console.log('- CIE Lab + Delta E 2000 ìƒ‰ì°¨ ê³„ì‚°');
            console.log('- í•œêµ­ì¸ íŠ¹í™” í”¼ë¶€í†¤ ë°ì´í„°ë² ì´ìŠ¤');
            console.log('- 8ê°œ ì „ë¬¸ ë¸Œëœë“œ ì—°ë™');
        });
    </script>
</body>
</html>
