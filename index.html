<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Color Pro - ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏãúÏä§ÌÖú</title>
    
    <!-- ÌååÎπÑÏΩò 404 Ïò§Î•ò Î∞©ÏßÄ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üé®</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üé®</text></svg>">
    
    <!-- MediaPipe CDN (ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ) -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

<style>
/* ==========================================
   Personal Color Pro - ÏµúÏ¢Ö ÏôÑÏÑ± Î≤ÑÏ†Ñ
   ========================================== */

/* Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-pink: #E91E63;
    --secondary-rose: #F8BBD9;
    --light-pink: #FCE4EC;
    --dark-rose: #AD1457;
    --success: #4CAF50;
    --warning: #FF9800;
    --info: #2196F3;
    --error: #f44336;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--light-pink) 0%, #fff 50%, var(--secondary-rose) 100%);
    min-height: 100vh;
    color: #333;
}

.loading-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 9999;
    flex-direction: column;
}

.loading-content {
    text-align: center;
}

.loading-logo {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    animation: pulse 2s infinite;
}

.loading-progress {
    width: 300px;
    height: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 1rem;
}

.loading-bar {
    height: 100%;
    background: white;
    width: 0%;
    border-radius: 3px;
    transition: width 0.3s ease;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.main-app {
    display: none;
    min-height: 100vh;
}

.main-app.loaded {
    display: block;
}

/* ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î */
.app-header {
    background: white;
    padding: var(--spacing-lg);
    box-shadow: var(--shadow);
    border-bottom: 2px solid var(--secondary-rose);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.app-title-section {
    flex-grow: 1;
    min-width: 250px;
}

.app-title {
    font-size: 1.8rem;
    color: var(--primary-pink);
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.app-subtitle {
    color: #666;
    font-size: 0.9rem;
}

.header-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.header-btn {
    padding: 0.75rem 1rem;
    background: var(--primary-pink);
    color: white;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
}

.header-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-1px);
}

.header-btn.active {
    background: var(--dark-rose);
    box-shadow: 0 0 10px rgba(233, 30, 99, 0.4);
}

.header-btn.home-btn {
    background: #666;
    font-size: 1.2rem;
    padding: 0.5rem 0.75rem;
}

.header-btn.home-btn:hover {
    background: #333;
}

/* ÏÑπÏÖò ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
.section-nav {
    background: var(--light-pink);
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: var(--radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.nav-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-pink);
}

.nav-controls {
    display: flex;
    gap: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 1rem;
    background: white;
    color: var(--primary-pink);
    border: 2px solid var(--secondary-rose);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: var(--secondary-rose);
}

.nav-btn.danger {
    border-color: var(--error);
    color: var(--error);
}

.nav-btn.danger:hover {
    background: var(--error);
    color: white;
}

.main-content {
    padding: var(--spacing-lg);
    max-width: 1200px;
    margin: 0 auto;
}

.section {
    display: none;
    background: white;
    border-radius: 16px;
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow);
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.section h2 {
    font-size: 1.8rem;
    color: var(--primary-pink);
    margin-bottom: var(--spacing-lg);
    text-align: center;
    font-weight: 600;
}

/* Î™®Îìú ÏÑ†ÌÉù Ïπ¥ÎìúÎì§ */
.mode-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.mode-card {
    background: linear-gradient(135deg, var(--light-pink), white);
    border: 2px solid var(--secondary-rose);
    border-radius: 16px;
    padding: var(--spacing-xl);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
}

.mode-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-pink);
}

.mode-card.selected {
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    color: white;
    transform: translateY(-3px);
}

.mode-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
    display: block;
}

.mode-card h3 {
    font-size: 1.3rem;
    margin-bottom: var(--spacing-md);
    font-weight: 600;
}

.mode-card p {
    margin-bottom: var(--spacing-md);
    line-height: 1.5;
    opacity: 0.9;
    font-size: 0.95rem;
}

.mode-features {
    list-style: none;
    text-align: left;
    margin-bottom: var(--spacing-md);
}

.mode-features li {
    padding: 0.4rem 0;
    position: relative;
    padding-left: var(--spacing-lg);
    font-size: 0.9rem;
}

.mode-features li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

.mode-card.selected .mode-features li::before {
    color: white;
}

.mode-btn {
    background: var(--primary-pink);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.mode-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-1px);
}

.mode-card.selected .mode-btn {
    background: white;
    color: var(--primary-pink);
}

/* Î∂ÑÏÑù Í∑∏Î¶¨Îìú */
.analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.video-container {
    position: relative;
    width: 100%;
    height: 350px;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    border: 3px solid var(--secondary-rose);
}

.video-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.face-detection-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 220px;
    border: 3px dashed var(--primary-pink);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-pink);
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    text-align: center;
    padding: var(--spacing-md);
    font-size: 0.9rem;
}

.analysis-panel {
    background: var(--light-pink);
    padding: var(--spacing-lg);
    border-radius: var(--radius);
    border: 2px solid var(--secondary-rose);
}

.analysis-step {
    text-align: center;
}

.analysis-step h3 {
    color: var(--primary-pink);
    margin-bottom: var(--spacing-md);
    font-size: 1.2rem;
}

.analysis-step p {
    margin-bottom: var(--spacing-md);
    color: #666;
    line-height: 1.4;
}

/* ÏÉâÏÉÅ ÌåîÎ†àÌä∏ */
.color-palette-container {
    background: var(--light-pink);
    padding: var(--spacing-lg);
    border-radius: 12px;
    border: 2px solid var(--secondary-rose);
}

.season-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: var(--spacing-lg);
    justify-content: center;
    flex-wrap: wrap;
}

.season-tab {
    padding: 0.6rem 1.2rem;
    border: none;
    background: white;
    color: var(--primary-pink);
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid var(--secondary-rose);
    font-size: 0.85rem;
}

.season-tab.active {
    background: var(--primary-pink);
    color: white;
    border-color: var(--primary-pink);
}

.pccs-tone-info {
    background: white;
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: var(--spacing-md);
    border: 1px solid var(--secondary-rose);
    font-size: 0.9rem;
}

.color-palette {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 0.6rem;
    margin-bottom: var(--spacing-lg);
}

.color-swatch {
    aspect-ratio: 1;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.color-swatch:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.color-swatch.selected {
    border-color: var(--primary-pink);
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(233, 30, 99, 0.5);
}

/* Before/After ÎπÑÍµê */
.comparison-container {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-lg);
    margin-top: var(--spacing-lg);
    box-shadow: var(--shadow);
    border: 2px solid var(--secondary-rose);
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
    gap: 1rem;
}

.comparison-controls {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.comparison-mode-btn {
    padding: 0.4rem 0.8rem;
    border: 2px solid var(--secondary-rose);
    background: white;
    color: var(--primary-pink);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    font-weight: 500;
}

.comparison-mode-btn.active {
    background: var(--primary-pink);
    color: white;
    border-color: var(--primary-pink);
}

.comparison-viewer {
    width: 100%;
    height: 250px;
    background: #f5f5f5;
    border-radius: var(--radius);
    border: 2px solid var(--secondary-rose);
    display: none;
    position: relative;
    overflow: hidden;
}

.comparison-viewer.active {
    display: block;
}

.improvement-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: var(--spacing-lg);
}

.metric {
    background: var(--light-pink);
    padding: 1rem;
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--secondary-rose);
}

.metric-label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.metric-value {
    display: block;
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--primary-pink);
}

/* ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ */
.toast {
    position: fixed;
    top: 80px;
    right: 20px;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    color: white;
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    max-width: 320px;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.success { background: var(--success); }
.toast.error { background: var(--error); }
.toast.info { background: var(--info); }
.toast.warning { background: var(--warning); }

/* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
@media (max-width: 768px) {
    .analysis-grid {
        grid-template-columns: 1fr;
    }
    .mode-cards {
        grid-template-columns: 1fr;
    }
    .app-title {
        font-size: 1.5rem;
    }
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    .improvement-metrics {
        grid-template-columns: 1fr;
    }
    .season-tabs {
        justify-content: stretch;
    }
    .season-tab {
        flex: 1;
        min-width: 0;
    }
    .color-palette {
        grid-template-columns: repeat(6, 1fr);
    }
    .comparison-controls {
        justify-content: center;
        width: 100%;
    }
    .nav-controls {
        width: 100%;
        justify-content: center;
    }
    .section-nav {
        flex-direction: column;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .header-controls {
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
    }
    .header-btn {
        flex: 1;
        min-width: 0;
        font-size: 0.8rem;
        padding: 0.6rem 0.8rem;
    }
}
</style>
</head>
<body>
    <!-- Î°úÎî© ÌôîÎ©¥ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üé®</div>
            <h2>Personal Color Pro</h2>
            <p id="loading-text">ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-content">
                <div class="app-title-section">
                    <h1 class="app-title">Personal Color Pro</h1>
                    <div class="app-subtitle">Ìó§Ïñ¥ÏÉµ Ï†ÑÏö© ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏãúÏä§ÌÖú</div>
                </div>
                
                <div class="header-controls">
                    <button class="header-btn home-btn" onclick="goHome()" title="ÌôàÏúºÎ°ú">üè†</button>
                    <button class="header-btn" onclick="switchMode('photo')">üì∏ AI Î∂ÑÏÑù</button>
                    <button class="header-btn" onclick="switchMode('draping')">üé≠ ÎìúÎûòÏù¥Ìïë</button>
                    <button class="header-btn" onclick="showSystemStatus()">‚öôÔ∏è ÏÉÅÌÉú</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Î™®Îìú ÏÑ†ÌÉù ÏÑπÏÖò -->
            <section class="section active" id="mode-selection">
                <div class="section-nav">
                    <div class="nav-title">ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® Î™®Îìú ÏÑ†ÌÉù</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="showSystemStatus()">ÏãúÏä§ÌÖú Ï†ïÎ≥¥</button>
                    </div>
                </div>

                <div class="mode-cards">
                    <div class="mode-card" onclick="selectModeCard(this); startPhotoAnalysis();">
                        <span class="mode-icon">üì∏</span>
                        <h3>AI ÏÇ¨ÏßÑ Î∂ÑÏÑù Î™®Îìú</h3>
                        <p>Ïã§ÏãúÍ∞Ñ Ïπ¥Î©îÎùºÎ•º ÌÜµÌïú AI Í∏∞Î∞ò Í≥ºÌïôÏ†Å ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã®</p>
                        <ul class="mode-features">
                            <li>MediaPipe ÏñºÍµ¥ Ïù∏Ïãù</li>
                            <li>RGB‚ÜíLAB ÏÉâÍ≥µÍ∞Ñ Î≥ÄÌôò</li>
                            <li>Delta E 2000 ÏÉâÏ∞® Ï∏°Ï†ï</li>
                            <li>4Í≥ÑÏ†à ÏûêÎèô ÌåêÏ†ï</li>
                            <li>Î∏åÎûúÎìúÎ≥Ñ Ï†úÌíà Ï∂îÏ≤ú</li>
                        </ul>
                        <button class="mode-btn">ÏãúÏûëÌïòÍ∏∞</button>
                    </div>

                    <div class="mode-card" onclick="selectModeCard(this); startDraping();">
                        <span class="mode-icon">üé≠</span>
                        <h3>Ï†ÑÎ¨∏Í∞Ä ÎìúÎûòÏù¥Ìïë Î™®Îìú</h3>
                        <p>Ï†ÑÎ¨∏Í∞Ä ÎÖ∏ÌïòÏö∞Î•º Î∞òÏòÅÌïú Í∞ÄÏÉÅ ÎìúÎûòÏù¥Ìïë ÏßÑÎã®</p>
                        <ul class="mode-features">
                            <li>ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú & Ïò§Î≤ÑÎ†àÏù¥</li>
                            <li>4Í≥ÑÏ†à ÏÉâÏÉÅ ÌåîÎ†àÌä∏</li>
                            <li>Ïú†Ïù¥Î†à/ÎπõÎÇ†Ïú§/Î∏îÎ£®ÎØ∏ ÎÖ∏ÌïòÏö∞</li>
                            <li>Before/After ÎπÑÍµê</li>
                            <li>Í∞úÏÑ†ÎèÑ ÏßÄÌëú Ï∏°Ï†ï</li>
                        </ul>
                        <button class="mode-btn">ÏãúÏûëÌïòÍ∏∞</button>
                    </div>
                </div>
            </section>

            <!-- AI ÏÇ¨ÏßÑ Î∂ÑÏÑù ÏÑπÏÖò -->
            <section class="section" id="photo-analysis">
                <div class="section-nav">
                    <div class="nav-title">AI Í∏∞Î∞ò ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã®</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="goHome()">ÌôàÏúºÎ°ú</button>
                        <button class="nav-btn" onclick="switchMode('draping')">ÎìúÎûòÏù¥Ìïë Î™®Îìú</button>
                        <button class="nav-btn danger" onclick="resetAnalysis()">Î∂ÑÏÑù Ï¥àÍ∏∞Ìôî</button>
                    </div>
                </div>
                
                <div class="analysis-grid">
                    <div class="video-container">
                        <video id="camera-feed" class="video-feed" autoplay muted playsinline></video>
                        <div class="face-detection-guide" id="face-guide">
                            ÏñºÍµ¥ÏùÑ Í∞ÄÏù¥ÎìúÎùºÏù∏Ïóê<br>ÎßûÏ∂∞Ï£ºÏÑ∏Ïöî
                        </div>
                    </div>

                    <div class="analysis-panel">
                        <div id="step-1" class="analysis-step active">
                            <h3>1Îã®Í≥Ñ: Ïπ¥Î©îÎùº Ï§ÄÎπÑ</h3>
                            <p>Ïπ¥Î©îÎùºÎ•º ÌôúÏÑ±ÌôîÌïòÏó¨ ÏñºÍµ¥ÏùÑ Ïù∏ÏãùÌï©ÎãàÎã§</p>
                            <button class="mode-btn" onclick="startFaceDetection()">Ïπ¥Î©îÎùº ÏãúÏûë</button>
                        </div>
                        
                        <div id="step-2" class="analysis-step" style="display: none;">
                            <h3>2Îã®Í≥Ñ: ÏñºÍµ¥ Ïù∏Ïãù Ï§ë</h3>
                            <p>MediaPipeÎ°ú ÏñºÍµ¥ÏùÑ Í∞êÏßÄÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                            <div style="color: #4CAF50; font-weight: bold; margin: 1rem 0;">‚úÖ ÏñºÍµ¥ Í∞êÏßÄÎê®</div>
                            <button class="mode-btn" onclick="startToneAnalysis()">ÏñºÍµ¥ÌÜ§ Î∂ÑÏÑù ÏãúÏûë</button>
                        </div>
                        
                        <div id="step-3" class="analysis-step" style="display: none;">
                            <h3>3Îã®Í≥Ñ: ÌîºÎ∂ÄÌÜ§ Î∂ÑÏÑù Ï§ë</h3>
                            <p>RGB ‚Üí LAB Î≥ÄÌôò Î∞è Delta E Í≥ÑÏÇ∞ Ï§ë...</p>
                            <div id="analysis-progress" style="background: #FCE4EC; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <div>ÌîºÎ∂ÄÏÉâ Ï∂îÏ∂ú Ï§ë...</div>
                            </div>
                        </div>
                        
                        <div id="step-4" class="analysis-step" style="display: none;">
                            <h3>4Îã®Í≥Ñ: Î∂ÑÏÑù ÏôÑÎ£å</h3>
                            <div id="final-results" style="background: white; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div id="result-season" style="font-size: 1.6rem; color: #E91E63; font-weight: bold;">-</div>
                                    <div>Ï†ïÌôïÎèÑ: <span id="confidence-score" style="color: #4CAF50; font-weight: bold;">-</span></div>
                                </div>
                                
                                <div id="detailed-analysis">
                                    <h4>ÏÉÅÏÑ∏ Î∂ÑÏÑù Í≤∞Í≥º:</h4>
                                    <div id="analysis-details"></div>
                                </div>
                                
                                <div style="margin-top: 1rem; text-align: center;">
                                    <button class="mode-btn" onclick="resetAnalysis()" style="margin-right: 0.5rem;">Îã§Ïãú Î∂ÑÏÑù</button>
                                    <button class="mode-btn" onclick="goHome()">ÌôàÏúºÎ°ú</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÎìúÎûòÏù¥Ìïë Î™®Îìú ÏÑπÏÖò -->
            <section class="section" id="draping-mode">
                <div class="section-nav">
                    <div class="nav-title">Ï†ÑÎ¨∏Í∞Ä ÎìúÎûòÏù¥Ìïë ÏßÑÎã®</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="goHome()">ÌôàÏúºÎ°ú</button>
                        <button class="nav-btn" onclick="switchMode('photo')">AI Î∂ÑÏÑù Î™®Îìú</button>
                        <button class="nav-btn danger" onclick="resetDraping()">Ï¥àÍ∏∞Ìôî</button>
                    </div>
                </div>
                
                <div class="analysis-grid">
                    <div style="border: 3px dashed var(--secondary-rose); border-radius: 12px; padding: 1.5rem; text-align: center; background: var(--light-pink);">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üì∑</div>
                        <h3>Í≥†Í∞ù ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</h3>
                        <p style="margin-bottom: 1rem;">ÎìúÎûòÍ∑∏ & ÎìúÎ°≠ ÎòêÎäî ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
                        <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)" style="margin-bottom: 1rem;">
                        <div id="uploaded-image-preview" style="display: none;">
                            <img id="preview-image" style="max-width: 100%; max-height: 180px; border-radius: 8px; border: 2px solid var(--secondary-rose);">
                        </div>
                    </div>

                    <div class="color-palette-container">
                        <h3 style="text-align: center; margin-bottom: 1rem;">4Í≥ÑÏ†à ÏÉâÏÉÅ ÌåîÎ†àÌä∏</h3>
                        
                        <div class="season-tabs">
                            <button class="season-tab active" onclick="showSeasonPalette('spring')">Î¥Ñ</button>
                            <button class="season-tab" onclick="showSeasonPalette('summer')">Ïó¨Î¶Ñ</button>
                            <button class="season-tab" onclick="showSeasonPalette('autumn')">Í∞ÄÏùÑ</button>
                            <button class="season-tab" onclick="showSeasonPalette('winter')">Í≤®Ïö∏</button>
                        </div>

                        <div class="pccs-tone-info" id="tone-info">
                            <strong>Î¥Ñ (Spring) Í≥ÑÏ†à ÌäπÏÑ±</strong><br>
                            Îî∞ÎúªÌïú Ïñ∏ÎçîÌÜ§, Î∞ùÍ≥† ÏÑ†Î™ÖÌïú ÏÉâÏÉÅ<br>
                            <small>12Í∞ú ÎåÄÌëú ÏÉâÏÉÅ</small>
                        </div>
                        
                        <div class="color-palette" id="color-palette">
                            <!-- ÎèôÏ†Å ÏÉâÏÉÅ ÌåîÎ†àÌä∏ -->
                        </div>

                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="mode-btn" onclick="applySelectedColor()" id="apply-color-btn" disabled>
                                ÏÑ†ÌÉùÌïú ÏÉâÏÉÅ Ï†ÅÏö©ÌïòÍ∏∞
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Before/After ÎπÑÍµê ÏÑπÏÖò -->
                <div class="comparison-container" id="comparison-container" style="display: none;">
                    <div class="comparison-header">
                        <h3>Before/After ÎπÑÍµê</h3>
                        <div class="comparison-controls">
                            <button class="comparison-mode-btn active" onclick="switchComparisonMode('slider')">Ïä¨ÎùºÏù¥Îçî</button>
                            <button class="comparison-mode-btn" onclick="switchComparisonMode('split')">Î∂ÑÌï†</button>
                            <button class="comparison-mode-btn" onclick="switchComparisonMode('toggle')">ÌÜ†Í∏Ä</button>
                        </div>
                    </div>

                    <!-- Ïä¨ÎùºÏù¥Îçî ÎπÑÍµê -->
                    <div class="comparison-viewer active" id="slider-view">
                        <div style="position: relative; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                            <canvas id="before-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"></canvas>
                            <canvas id="after-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; clip-path: inset(0 50% 0 0);"></canvas>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                Before/After Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±ÌïòÎ†§Î©¥<br>Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÍ≥† ÏÉâÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                            </div>
                        </div>
                        <input type="range" style="width: 100%; margin-top: 1rem;" id="comparison-slider" min="0" max="100" value="50">
                    </div>

                    <!-- Î∂ÑÌï† ÎπÑÍµê -->
                    <div class="comparison-viewer" id="split-view">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; height: 100%;">
                            <div style="background: #f5f5f5; display: flex; align-items: center; justify-content: center; text-align: center; color: #666;">
                                <div>Before<br><small>ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ</small></div>
                            </div>
                            <div style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; text-align: center; color: #666; border-left: 2px solid var(--secondary-rose);">
                                <div>After<br><small>ÏÉâÏÉÅ Ï†ÅÏö© ÌõÑ</small></div>
                            </div>
                        </div>
                    </div>

                    <!-- ÌÜ†Í∏Ä ÎπÑÍµê -->
                    <div class="comparison-viewer" id="toggle-view">
                        <div style="position: relative; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                            <button onclick="toggleBeforeAfter()" style="background: var(--primary-pink); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                Before/After ÌÜ†Í∏ÄÌïòÍ∏∞
                            </button>
                        </div>
                    </div>

                    <!-- Í∞úÏÑ†ÎèÑ ÏßÄÌëú -->
                    <div class="improvement-metrics">
                        <div class="metric">
                            <span class="metric-label">ÌîºÎ∂ÄÌÜ§ Í∞úÏÑ†</span>
                            <span class="metric-value" id="skin-improvement">+0%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Ï†ÑÏ≤¥ Ï°∞ÌôîÎèÑ</span>
                            <span class="metric-value" id="harmony-score">0Ï†ê</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú</span>
                            <span class="metric-value" id="expert-rating">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: var(--spacing-lg);">
                        <button class="mode-btn" onclick="exportComparison()" style="margin-right: 0.5rem;">üì± ÎπÑÍµê Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</button>
                        <button class="mode-btn" onclick="generateReport()">üìÑ ÏÉÅÎã¥ Î¶¨Ìè¨Ìä∏</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
// ==========================================
// Personal Color Pro - ÏµúÏ¢Ö ÏôÑÏÑ± Î≤ÑÏ†Ñ
// Î°úÎî© Î¨∏Ï†úÏôÄ 404 Ïò§Î•ò ÏôÑÏ†Ñ Ìï¥Í≤∞
// ==========================================

// Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÉÅÏàò
let currentMode = 'selection';
let selectedColor = null;
let selectedSeason = 'spring';
let analysisCount = 0;
let faceDetection = null;
let videoElement = null;
let canvasElement = null;
let canvasCtx = null;
let camera = null;
let isAnalyzing = false;
let currentStep = 1;
let faceDetected = false;
let currentComparisonMode = 'slider';
let beforeImage = null;
let afterImage = null;
let uploadedImage = null;

// Ï†ÑÎ¨∏Í∞Ä ÎÖ∏ÌïòÏö∞ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†ú Î∞òÏòÅ)
const ExpertKnowledge = {
    uireh: {
        colorSpectrum: "Ï£ºÌô©ÏÉâÏùÄ Ï†àÎåÄ Ïø®ÌÜ§ÏúºÎ°ú ÎßåÎì§ Ïàò ÏóÜÏùå",
        lightnessMatching: "ÌååÏö¥Îç∞Ïù¥ÏÖò 21-23Ìò∏Îäî ÎπÑÏä∑Ìïú Î™ÖÎèÑ Ìó§Ïñ¥Ïª¨Îü¨ ÌöåÌîº",
        winterClear: ["Ï°∞Ïù¥", "ÌòÑÏïÑ"]
    },
    bitnalyun: {
        skinConditions: {
            redness: "ÌôçÏ°∞ ÌîºÎ∂Ä ‚Üí ÎØ∏ÎìúÎÇòÏûá Ïª¨Îü¨Î°ú Ï§ëÌôî",
            pale: "Ï∞ΩÎ∞±Ìïú ÌîºÎ∂Ä ‚Üí ÏõúÌÜ§ÏúºÎ°ú ÏÉùÍ∏∞ Î∂ÄÏó¨", 
            yellowish: "Ìô©Í∏∞ ÌîºÎ∂Ä ‚Üí Ïï†Ïâ¨ Í≥ÑÏó¥Î°ú Ìà¨Î™ÖÍ∞ê"
        },
        principle: "Î™ÖÎèÑ¬∑Ï±ÑÎèÑ Ï°∞Ìï©Ïù¥ Ïù¥Î¶ÑÎ≥¥Îã§ Ï§ëÏöî"
    },
    blume: {
        specificTypes: {
            warm: "ÏïÑÏù¥Î≥¥Î¶¨ ÌîºÎ∂Ä + ÏΩîÌÜ†Î¶¨Î≤†Ïù¥ÏßÄ/Ïò§Î†åÏßÄÎ∏åÎùºÏö¥",
            cool: "ÌôîÏù¥Ìä∏ ÌîºÎ∂Ä + Î∏îÎ£®Î∏îÎûô/Ïï†Ïâ¨Î∏îÎ£®"
        }
    }
};

// 4Í≥ÑÏ†à ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (Ï†ÑÎ¨∏Í∞Ä Í∏∞Î∞ò)
const seasonPalettes = {
    spring: {
        colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD', '#F5DEB3', '#FFEFD5', '#FFB347', '#FF7F50', '#32CD32', '#FF6347'],
        characteristics: ['Î∞ùÍ≥† Îî∞ÎúªÌïú ÏÉâÏÉÅ', 'ÎÜíÏùÄ Ï±ÑÎèÑ', 'ÎÖ∏ÎûÄ Ïñ∏ÎçîÌÜ§']
    },
    summer: {
        colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA', '#D8BFD8', '#B19CD9', '#87CEEB', '#98FB98', '#FFB6C1', '#F0E68C'],
        characteristics: ['Î∂ÄÎìúÎüΩÍ≥† Ï∞®Í∞ÄÏö¥ ÏÉâÏÉÅ', 'Ï§ëÍ∞Ñ Ï±ÑÎèÑ', 'ÌååÎûÄ Ïñ∏ÎçîÌÜ§']
    },
    autumn: {
        colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000', '#556B2F', '#6B8E23', '#DAA520', '#B8860B', '#FF8C00', '#FF7F50'],
        characteristics: ['ÍπäÍ≥† Îî∞ÎúªÌïú ÏÉâÏÉÅ', 'ÎÇÆÏùÄ Ï±ÑÎèÑ', 'ÎÖ∏ÎûÄ Ïñ∏ÎçîÌÜ§']
    },
    winter: {
        colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090', '#FF1493', '#DC143C', '#B22222', '#800080', '#000000', '#FFFFFF'],
        characteristics: ['ÏßÑÌïòÍ≥† Ï∞®Í∞ÄÏö¥ ÏÉâÏÉÅ', 'ÎÜíÏùÄ ÎåÄÎπÑ', 'ÌååÎûÄ Ïñ∏ÎçîÌÜ§']
    }
};

// ==========================================
// Î°úÎî© Î∞è Ï¥àÍ∏∞Ìôî Ìï®ÏàòÎì§ (Î¨∏Ï†ú Ìï¥Í≤∞Îê®)
// ==========================================

// Î°úÎî© ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
function updateLoadingProgress(percent, text) {
    const loadingBar = document.getElementById('loading-bar');
    const loadingText = document.getElementById('loading-text');
    if (loadingBar) loadingBar.style.width = percent + '%';
    if (loadingText) loadingText.textContent = text;
}

// MediaPipe Ï¥àÍ∏∞Ìôî (ÌÉÄÏûÑÏïÑÏõÉ Î¨∏Ï†ú Ìï¥Í≤∞)
async function initializeMediaPipe() {
    try {
        updateLoadingProgress(30, 'MediaPipe ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôïÏù∏ Ï§ë...');
        
        // MediaPipe ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÌôïÏù∏ (ÌÉÄÏûÑÏïÑÏõÉ Ï†ÅÏö©)
        let mediapipeLoaded = false;
        let retryCount = 0;
        const maxRetries = 5;
        
        while (!mediapipeLoaded && retryCount < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (typeof FaceDetection !== 'undefined') {
                mediapipeLoaded = true;
                console.log('MediaPipe FaceDetection Î°úÎìú ÏôÑÎ£å');
                break;
            }
            
            retryCount++;
            updateLoadingProgress(30 + (retryCount * 8), `MediaPipe Î°úÎî© ÌôïÏù∏ Ï§ë... (${retryCount}/${maxRetries})`);
        }
        
        if (!mediapipeLoaded) {
            console.warn('‚ö†Ô∏è MediaPipe Î°úÎìú Ïã§Ìå® - Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÎèôÏûë');
            updateLoadingProgress(80, 'MediaPipe Î°úÎìú Ïã§Ìå® - Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÎèôÏûë');
            return false;
        }
        
        updateLoadingProgress(70, 'MediaPipe Î™®Îç∏ Ï¥àÍ∏∞Ìôî Ï§ë...');
        
        // FaceDetection Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
        faceDetection = new FaceDetection({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
            }
        });
        
        faceDetection.setOptions({
            model: 'short',
            minDetectionConfidence: 0.5,
        });
        
        faceDetection.onResults(onFaceDetectionResults);
        
        updateLoadingProgress(90, 'MediaPipe Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        console.log('‚úÖ MediaPipe Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ');
        return true;
        
    } catch (error) {
        console.error('‚ùå MediaPipe Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
        updateLoadingProgress(80, 'MediaPipe Ï¥àÍ∏∞Ìôî Ïã§Ìå® - Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÎèôÏûë');
        return false;
    }
}

// Ïï± Ï¥àÍ∏∞Ìôî (Î°úÎî© ÌôîÎ©¥ Î¨∏Ï†ú Ìï¥Í≤∞)
function initializeApp() {
    console.log('üöÄ Personal Color Pro Ïï± Ï¥àÍ∏∞Ìôî...');
    
    try {
        updateLoadingProgress(95, 'Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        
        // Í∏∞Î≥∏ Î¥Ñ ÌåîÎ†àÌä∏ ÌëúÏãú
        showSeasonPalette('spring');
        
        // ÏôÑÏ†ÑÌïú Î°úÎî© ÏôÑÎ£å
        updateLoadingProgress(100, 'ÏãúÏä§ÌÖú Ï§ÄÎπÑ ÏôÑÎ£å!');
        
        // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞ Î∞è Î©îÏù∏ Ïï± ÌëúÏãú
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const mainApp = document.getElementById('main-app');
            
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.classList.add('loaded');
            }
            
            console.log('‚úÖ Ïï± ÌôîÎ©¥ ÌôúÏÑ±Ìôî ÏôÑÎ£å');
            
        }, 800);
        
    } catch (error) {
        console.error('‚ùå Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
        
        // Ïã§Ìå®Ìï¥ÎèÑ Ïï±ÏùÄ ÌëúÏãúÌïòÍ∏∞
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const mainApp = document.getElementById('main-app');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.classList.add('loaded');
            }
            
            showToast('ÏãúÏä§ÌÖú Ï¥àÍ∏∞ÌôîÏóê ÏùºÎ∂Ä Î¨∏Ï†úÍ∞Ä ÏûàÏóàÏßÄÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§', 'warning');
        }, 1000);
    }
}

// ==========================================
// ÏÉâÏÉÅ Î≥ÄÌôò Î∞è Î∂ÑÏÑù Ìï®ÏàòÎì§
// ==========================================

// RGB ‚Üí LAB Î≥ÄÌôò Ìï®Ïàò
function rgbToLab(r, g, b) {
    // RGBÎ•º 0-1 Î≤îÏúÑÎ°ú Ï†ïÍ∑úÌôî
    let rNorm = r / 255;
    let gNorm = g / 255;
    let bNorm = b / 255;
    
    // Í∞êÎßà Î≥¥Ï†ï
    rNorm = rNorm > 0.04045 ? Math.pow((rNorm + 0.055) / 1.055, 2.4) : rNorm / 12.92;
    gNorm = gNorm > 0.04045 ? Math.pow((gNorm + 0.055) / 1.055, 2.4) : gNorm / 12.92;
    bNorm = bNorm > 0.04045 ? Math.pow((bNorm + 0.055) / 1.055, 2.4) : bNorm / 12.92;
    
    // XYZ ÏÉâÍ≥µÍ∞ÑÏúºÎ°ú Î≥ÄÌôò
    let x = rNorm * 0.4124564 + gNorm * 0.3575761 + bNorm * 0.1804375;
    let y = rNorm * 0.2126729 + gNorm * 0.7151522 + bNorm * 0.0721750;
    let z = rNorm * 0.0193339 + gNorm * 0.1191920 + bNorm * 0.9503041;
    
    // D65 ÌëúÏ§Ä Ï°∞Î™ÖÏúºÎ°ú Ï†ïÍ∑úÌôî
    x = x / 0.95047;
    y = y / 1.00000;
    z = z / 1.08883;
    
    // LAB Î≥ÄÌôò
    x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
    y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
    z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);
    
    const L = (116 * y) - 16;
    const A = 500 * (x - y);
    const B = 200 * (y - z);
    
    return { L, A, B };
}

// Delta E 2000 Í≥ÑÏÇ∞
function calculateDeltaE2000(lab1, lab2) {
    const { L: L1, A: A1, B: B1 } = lab1;
    const { L: L2, A: A2, B: B2 } = lab2;
    
    const deltaL = L2 - L1;
    const avgL = (L1 + L2) / 2;
    
    const C1 = Math.sqrt(A1 * A1 + B1 * B1);
    const C2 = Math.sqrt(A2 * A2 + B2 * B2);
    const avgC = (C1 + C2) / 2;
    
    const deltaE = Math.sqrt(
        Math.pow(deltaL, 2) + 
        Math.pow(C2 - C1, 2) + 
        Math.pow(A2 - A1, 2) + 
        Math.pow(B2 - B1, 2)
    );
    
    return Math.min(deltaE, 100);
}

// ÌîºÎ∂ÄÌÜ§ÏóêÏÑú ÌèâÍ∑† RGB Ï∂îÏ∂ú
function extractSkinColor(imageData, faceBox) {
    const { xCenter, yCenter, width, height } = faceBox;
    
    const sampleWidth = Math.floor(width * 0.3);
    const sampleHeight = Math.floor(height * 0.2);
    const startX = Math.floor(xCenter - sampleWidth / 2);
    const startY = Math.floor(yCenter - sampleHeight / 2);
    
    let totalR = 0, totalG = 0, totalB = 0, pixelCount = 0;
    
    for (let y = startY; y < startY + sampleHeight; y++) {
        for (let x = startX; x < startX + sampleWidth; x++) {
            if (x >= 0 && x < imageData.width && y >= 0 && y < imageData.height) {
                const index = (y * imageData.width + x) * 4;
                const r = imageData.data[index];
                const g = imageData.data[index + 1];
                const b = imageData.data[index + 2];
                
                if (r > 50 && g > 50 && b > 50 && r < 250 && g < 250 && b < 250) {
                    totalR += r;
                    totalG += g;
                    totalB += b;
                    pixelCount++;
                }
            }
        }
    }
    
    if (pixelCount === 0) {
        return { r: 150, g: 120, b: 100 };
    }
    
    return {
        r: Math.round(totalR / pixelCount),
        g: Math.round(totalG / pixelCount),
        b: Math.round(totalB / pixelCount)
    };
}

// ÌçºÏä§ÎÑêÏª¨Îü¨ ÌåêÏ†ï
function analyzePersonalColor(skinRgb) {
    const skinLab = rgbToLab(skinRgb.r, skinRgb.g, skinRgb.b);
    
    const seasonReferences = {
        spring: { L: 70, A: 15, B: 25 },
        summer: { L: 65, A: 5, B: -10 },
        autumn: { L: 50, A: 20, B: 30 },
        winter: { L: 45, A: -5, B: -15 }
    };
    
    let bestMatch = null;
    let lowestDelta = Infinity;
    
    for (const [season, refLab] of Object.entries(seasonReferences)) {
        const deltaE = calculateDeltaE2000(skinLab, refLab);
        if (deltaE < lowestDelta) {
            lowestDelta = deltaE;
            bestMatch = season;
        }
    }
    
    const confidence = Math.max(70, Math.min(98, 100 - lowestDelta * 2));
    const expertAnalysis = generateExpertAnalysis(bestMatch, skinLab, skinRgb);
    
    return {
        season: getSeasonName(bestMatch),
        confidence: Math.round(confidence),
        lab: {
            L: skinLab.L.toFixed(1),
            A: skinLab.A.toFixed(1), 
            B: skinLab.B.toFixed(1)
        },
        deltaE: lowestDelta.toFixed(1),
        rgb: skinRgb,
        expertAnalysis
    };
}

function getSeasonName(season) {
    const names = {
        spring: 'Î¥Ñ ÏõúÌÜ§',
        summer: 'Ïó¨Î¶Ñ Ïø®ÌÜ§',
        autumn: 'Í∞ÄÏùÑ ÏõúÌÜ§',
        winter: 'Í≤®Ïö∏ Ïø®ÌÜ§'
    };
    return names[season] || 'Î∂ÑÏÑù Ï§ë';
}

function generateExpertAnalysis(season, labValues, rgbValues) {
    const analyses = {
        spring: `${ExpertKnowledge.blume.specificTypes.warm} Î∞ùÍ≥† ÏÑ†Î™ÖÌïú ÏÉâÏÉÅÏù¥ Ïûò Ïñ¥Ïö∏Î¶ΩÎãàÎã§.`,
        summer: `${ExpertKnowledge.bitnalyun.principle}Ïóê Îî∞Îùº Î∂ÄÎìúÎü¨Ïö¥ ÌååÏä§ÌÖî ÌÜ§ÏùÑ Ï∂îÏ≤úÌï©ÎãàÎã§.`,
        autumn: `${ExpertKnowledge.bitnalyun.skinConditions.yellowish} ÍπäÍ≥† Î¶¨ÏπòÌïú Î∏åÎùºÏö¥ Í≥ÑÏó¥Ïù¥ Ï†ÅÌï©Ìï©ÎãàÎã§.`,
        winter: `${ExpertKnowledge.blume.specificTypes.cool} Î™ÖÌôïÌïú ÎåÄÎπÑÎ•º ÏúÑÌï¥ ÏßÑÌïòÍ≥† ÏÑ†Î™ÖÌïú ÏÉâÏÉÅÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`
    };
    
    return analyses[season] || 'Ï†ÑÎ¨∏Í∞Ä Î∂ÑÏÑù Í≤∞Í≥ºÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§.';
}

// ==========================================
// MediaPipe ÏñºÍµ¥ Ïù∏Ïãù Ìï®ÏàòÎì§
// ==========================================

// MediaPipe Í≤∞Í≥º Ï≤òÎ¶¨ (Ï†ÑÎ¨∏Ï†ÅÏù∏ ÏñºÍµ¥ Ïù∏Ïãù UI)
function onFaceDetectionResults(results) {
    if (!canvasCtx || !videoElement) return;
    
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    if (results.detections && results.detections.length > 0) {
        const detection = results.detections[0];
        const bbox = detection.boundingBox;
        
        const x = bbox.xCenter * canvasElement.width - (bbox.width * canvasElement.width) / 2;
        const y = bbox.yCenter * canvasElement.height - (bbox.height * canvasElement.height) / 2;
        const width = bbox.width * canvasElement.width;
        const height = bbox.height * canvasElement.height;
        
        // Ï†ÑÎ¨∏Ï†ÅÏù∏ ÏñºÍµ¥ Ïù∏Ïãù ÌîÑÎ†àÏûÑ Í∑∏Î¶¨Í∏∞
        canvasCtx.strokeStyle = '#00FF88';
        canvasCtx.lineWidth = 3;
        canvasCtx.setLineDash([]);
        
        // Î™®ÏÑúÎ¶¨ ÌîÑÎ†àÏûÑ Í∑∏Î¶¨Í∏∞ (Ï†ÑÎ¨∏Ï†ÅÏù∏ Ïä§Ï∫êÎÑà ÎäêÎÇå)
        const cornerSize = 30;
        
        // Ï¢åÏÉÅÎã®
        canvasCtx.beginPath();
        canvasCtx.moveTo(x, y + cornerSize);
        canvasCtx.lineTo(x, y);
        canvasCtx.lineTo(x + cornerSize, y);
        canvasCtx.stroke();
        
        // Ïö∞ÏÉÅÎã®
        canvasCtx.beginPath();
        canvasCtx.moveTo(x + width - cornerSize, y);
        canvasCtx.lineTo(x + width, y);
        canvasCtx.lineTo(x + width, y + cornerSize);
        canvasCtx.stroke();
        
        // Ï¢åÌïòÎã®
        canvasCtx.beginPath();
        canvasCtx.moveTo(x, y + height - cornerSize);
        canvasCtx.lineTo(x, y + height);
        canvasCtx.lineTo(x + cornerSize, y + height);
        canvasCtx.stroke();
        
        // Ïö∞ÌïòÎã®
        canvasCtx.beginPath();
        canvasCtx.moveTo(x + width - cornerSize, y + height);
        canvasCtx.lineTo(x + width, y + height);
        canvasCtx.lineTo(x + width, y + height - cornerSize);
        canvasCtx.stroke();
        
        // Ï§ëÏïô Ïä§Ï∫î ÎùºÏù∏ (Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º)
        canvasCtx.strokeStyle = '#00FF88';
        canvasCtx.lineWidth = 2;
        canvasCtx.setLineDash([5, 5]);
        canvasCtx.globalAlpha = 0.8;
        
        const scanY = y + height/2 + Math.sin(Date.now() * 0.01) * 10;
        canvasCtx.beginPath();
        canvasCtx.moveTo(x + 20, scanY);
        canvasCtx.lineTo(x + width - 20, scanY);
        canvasCtx.stroke();
        
        canvasCtx.globalAlpha = 1.0;
        canvasCtx.setLineDash([]);
        
        // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ ÌëúÏãú
        canvasCtx.font = 'bold 16px Arial';
        canvasCtx.fillStyle = '#00FF88';
        canvasCtx.strokeStyle = '#000';
        canvasCtx.lineWidth = 1;
        
        const text = 'FACE DETECTED';
        const textX = x + width/2 - 70;
        const textY = y - 10;
        
        canvasCtx.strokeText(text, textX, textY);
        canvasCtx.fillText(text, textX, textY);
        
        // Ïã†Î¢∞ÎèÑ ÌëúÏãú
        const confidence = Math.round(detection.score[0] * 100);
        const confText = `${confidence}%`;
        canvasCtx.font = '14px Arial';
        canvasCtx.fillText(confText, x + width - 40, y + height + 20);
        
        if (!faceDetected && currentStep === 1) {
            faceDetected = true;
            goToStep(2);
            showToast('ÏñºÍµ¥Ïù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        window.currentFaceDetection = detection;
    } else {
        if (faceDetected && currentStep === 2) {
            showToast('ÏñºÍµ¥ÏùÑ Îã§Ïãú Ïπ¥Î©îÎùºÏóê ÎßûÏ∂∞Ï£ºÏÑ∏Ïöî', 'warning');
        }
    }
}

// ==========================================
// Îã®Í≥ÑÎ≥Ñ Î∂ÑÏÑù ÏßÑÌñâ Ìï®ÏàòÎì§
// ==========================================

// Î∂ÑÏÑù Îã®Í≥Ñ Ï†ÑÌôò
function goToStep(step) {
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
            stepElement.style.display = 'none';
            stepElement.classList.remove('active');
        }
    }
    
    const targetStep = document.getElementById(`step-${step}`);
    if (targetStep) {
        targetStep.style.display = 'block';
        targetStep.classList.add('active');
        currentStep = step;
    }
}

// ÏñºÍµ¥ÌÜ§ Î∂ÑÏÑù ÏãúÏûë (MediaPipe ÏóÜÏù¥ÎèÑ ÏûëÎèô)
function startToneAnalysis() {
    goToStep(3);
    
    const progressDiv = document.getElementById('analysis-progress');
    let step = 0;
    const steps = [
        'ÌîºÎ∂ÄÏÉâ RGB Ï∂îÏ∂ú Ï§ë...',
        'RGB ‚Üí LAB ÏÉâÍ≥µÍ∞Ñ Î≥ÄÌôò Ï§ë...',
        'Delta E 2000 Í≥ÑÏÇ∞ Ï§ë...',
        '4Í≥ÑÏ†à Îß§Ïπ≠ Î∂ÑÏÑù Ï§ë...',
        'Ï†ÑÎ¨∏Í∞Ä ÎÖ∏ÌïòÏö∞ Ï†ÅÏö© Ï§ë...',
        'ÏµúÏ¢Ö Í≤∞Í≥º ÏÉùÏÑ± Ï§ë...'
    ];
    
    const updateProgress = () => {
        if (step < steps.length) {
            progressDiv.innerHTML = `
                <div style="margin-bottom: 0.5rem;">${steps[step]}</div>
                <div style="background: #E91E63; height: 4px; width: ${(step + 1) * 16.67}%; border-radius: 2px; transition: width 0.3s;"></div>
            `;
            step++;
            setTimeout(updateProgress, 800);
        } else {
            // MediaPipeÍ∞Ä ÏûàÏúºÎ©¥ Ïã§Ï†ú Î∂ÑÏÑù, ÏóÜÏúºÎ©¥ Îç∞Î™® Î∂ÑÏÑù
            if (window.currentFaceDetection) {
                performRealAnalysis();
            } else {
                performDemoAnalysis();
            }
        }
    };
    
    updateProgress();
}

// Îç∞Î™® Î∂ÑÏÑù (MediaPipe ÏóÜÏùÑ Îïå)
function performDemoAnalysis() {
    // ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î°ú Î∂ÑÏÑù ÏãúÏó∞
    const demoSkinColor = { r: 156, g: 125, b: 103 }; // ÏùºÎ∞òÏ†ÅÏù∏ ÌîºÎ∂ÄÏÉâ
    
    console.log('üé≠ Îç∞Î™® ÌîºÎ∂ÄÏÉâ RGB:', demoSkinColor);
    
    const analysis = analyzePersonalColor(demoSkinColor);
    console.log('üìä Îç∞Î™® Î∂ÑÏÑù Í≤∞Í≥º:', analysis);
    
    showFinalResults(analysis);
    showToast('Îç∞Î™® Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïã§Ï†ú Î∂ÑÏÑùÏùÄ Ïπ¥Î©îÎùº Í∂åÌïú ÌóàÏö© ÌõÑ Í∞ÄÎä•Ìï©ÎãàÎã§.', 'info');
}

// Ïã§Ï†ú Î∂ÑÏÑù ÏàòÌñâ
async function performRealAnalysis() {
    try {
        const detection = window.currentFaceDetection;
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = videoElement.videoWidth;
        tempCanvas.height = videoElement.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(videoElement, 0, 0);
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        
        const bbox = detection.boundingBox;
        const faceBox = {
            xCenter: bbox.xCenter * tempCanvas.width,
            yCenter: bbox.yCenter * tempCanvas.height,
            width: bbox.width * tempCanvas.width,
            height: bbox.height * tempCanvas.height
        };
        
        const skinColor = extractSkinColor(imageData, faceBox);
        console.log('üéØ Ï∂îÏ∂úÎêú ÌîºÎ∂ÄÏÉâ RGB:', skinColor);
        
        const analysis = analyzePersonalColor(skinColor);
        console.log('üìä Ïã§Ï†ú Î∂ÑÏÑù Í≤∞Í≥º:', analysis);
        
        showFinalResults(analysis);
        
    } catch (error) {
        console.error('‚ùå Î∂ÑÏÑù Ïã§Ìå®:', error);
        showToast('Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
    }
}

// ÏµúÏ¢Ö Í≤∞Í≥º ÌëúÏãú (Íµ¨Ï≤¥Ï†ÅÏù∏ Ï†úÌíà Ï∂îÏ≤ú Ìè¨Ìï®)
function showFinalResults(analysis) {
    goToStep(4);
    
    const seasonElement = document.getElementById('result-season');
    const confidenceElement = document.getElementById('confidence-score');
    
    if (seasonElement) seasonElement.textContent = analysis.season;
    if (confidenceElement) confidenceElement.textContent = analysis.confidence + '%';
    
    // Î∏åÎûúÎìúÎ≥Ñ Ï†úÌíà Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞
    const productRecommendations = getProductRecommendations(analysis.season);
    
    const detailsDiv = document.getElementById('analysis-details');
    if (detailsDiv) {
        detailsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px;">
                    <strong>Ï∂îÏ∂úÎêú ÌîºÎ∂ÄÏÉâ</strong><br>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <div style="width: 30px; height: 30px; background: rgb(${analysis.rgb.r}, ${analysis.rgb.g}, ${analysis.rgb.b}); border: 1px solid #ccc; border-radius: 4px;"></div>
                        RGB(${analysis.rgb.r}, ${analysis.rgb.g}, ${analysis.rgb.b})
                    </div>
                </div>
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px;">
                    <strong>LAB ÏÉâÍ≥µÍ∞Ñ</strong><br>
                    L: ${analysis.lab.L}<br>
                    A: ${analysis.lab.A}<br>
                    B: ${analysis.lab.B}
                </div>
            </div>
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <strong>ÏÉâÏ∞® Ï∏°Ï†ïÍ∞í</strong><br>
                Delta E 2000: ${analysis.deltaE}
            </div>
            
            <!-- Î∏åÎûúÎìúÎ≥Ñ Ìó§Ïñ¥Ïª¨Îü¨ Ï∂îÏ≤ú -->
            <div style="background: #E3F2FD; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #2196F3;">
                <h4 style="color: #1976D2; margin-bottom: 1rem; font-size: 1.2rem;">üíé Ï∂îÏ≤ú Ìó§Ïñ¥Ïª¨Îü¨ Ï†úÌíà</h4>
                ${productRecommendations.map(brand => `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #BBDEFB;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #1976D2; font-size: 1.1rem;">${brand.name}</strong>
                            <span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">Ï∂îÏ≤ú</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem;">
                            ${brand.products.map(product => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #F5F5F5; border-radius: 6px;">
                                    <div style="width: 20px; height: 20px; background: ${product.color}; border-radius: 50%; border: 1px solid #ddd;"></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.9rem;">${product.code}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${product.name}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="background: #FCE4EC; padding: 1rem; border-radius: 8px;">
                <strong>Ï†ÑÎ¨∏Í∞Ä Î∂ÑÏÑù</strong><br>
                ${analysis.expertAnalysis}
            </div>
        `;
    }
    
    analysisCount++;
    showToast(`ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏôÑÎ£å: ${analysis.season}`, 'success');
}

// Î∏åÎûúÎìúÎ≥Ñ Ï†úÌíà Ï∂îÏ≤ú Ìï®Ïàò (Ïã§Ï†ú Ìó§Ïñ¥Ïª¨Îü¨ Ï†úÌíà)
function getProductRecommendations(season) {
    const recommendations = {
        'Î¥Ñ ÏõúÌÜ§': [
            {
                name: 'Î°úÎ†àÏïå ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '7.3', name: 'Í≥®Îì† Î∏îÎ°†Îìú', color: '#D4AF37' },
                    { code: '8.34', name: 'ÎùºÏù¥Ìä∏ Í≥®Îì† ÏΩîÌçº', color: '#CD853F' },
                    { code: '6.35', name: 'Îã§ÌÅ¨ Í≥®Îì† ÎßàÌò∏Í∞ÄÎãà', color: '#8B4513' }
                ]
            },
            {
                name: 'Ïõ∞Îùº ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '7/3', name: 'ÎØ∏ÎîîÏõÄ Í≥®Îì† Î∏îÎ°†Îìú', color: '#DAA520' },
                    { code: '8/03', name: 'ÎùºÏù¥Ìä∏ ÎÇ¥Ï∂îÎü¥ Í≥®Îì†', color: '#F0E68C' },
                    { code: '6/73', name: 'Îã§ÌÅ¨ Î∏åÎùºÏö¥ Í≥®Îì†', color: '#A0522D' }
                ]
            },
            {
                name: 'Î∞ÄÎ≥∏ Ïò§Î•¥ÎîîÎ∏å',
                products: [
                    { code: '7-CG', name: 'ÏΩîÌçº Í≥®Îì†', color: '#B87333' },
                    { code: '8-CB', name: 'ÏΩîÌçº Î≤†Ïù¥ÏßÄ', color: '#DEB887' },
                    { code: '6-GM', name: 'Í≥®Îì† ÎßàÌò∏Í∞ÄÎãà', color: '#CD853F' }
                ]
            }
        ],
        'Ïó¨Î¶Ñ Ïø®ÌÜ§': [
            {
                name: 'Î°úÎ†àÏïå ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '8.1', name: 'ÎùºÏù¥Ìä∏ Ïï†Ïâ¨ Î∏îÎ°†Îìú', color: '#C0C0C0' },
                    { code: '7.11', name: 'Ïù∏ÌÖêÏä§ Ïï†Ïâ¨ Î∏îÎ°†Îìú', color: '#A9A9A9' },
                    { code: '9.1', name: 'Î≤†Î¶¨ ÎùºÏù¥Ìä∏ Ïï†Ïâ¨', color: '#E6E6FA' }
                ]
            },
            {
                name: 'Ïõ∞Îùº ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '8/1', name: 'ÎùºÏù¥Ìä∏ Ïï†Ïâ¨ Î∏îÎ°†Îìú', color: '#D3D3D3' },
                    { code: '7/1', name: 'ÎØ∏ÎîîÏõÄ Ïï†Ïâ¨ Î∏îÎ°†Îìú', color: '#B0C4DE' },
                    { code: '6/1', name: 'Îã§ÌÅ¨ Ïï†Ïâ¨ Î∏îÎ°†Îìú', color: '#778899' }
                ]
            },
            {
                name: 'Î∞ÄÎ≥∏ Ïò§Î•¥ÎîîÎ∏å',
                products: [
                    { code: '8-A', name: 'Ïï†Ïâ¨', color: '#C0C0C0' },
                    { code: '7-MT', name: 'ÎßàÌä∏ Î≤†Ïù¥ÏßÄ', color: '#F5F5DC' },
                    { code: '9-P', name: 'ÌïëÌÅ¨ Î≤†Ïù¥ÏßÄ', color: '#F0E68C' }
                ]
            }
        ],
        'Í∞ÄÏùÑ ÏõúÌÜ§': [
            {
                name: 'Î°úÎ†àÏïå ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '6.3', name: 'Îã§ÌÅ¨ Í≥®Îì† Î∏îÎ°†Îìú', color: '#B8860B' },
                    { code: '5.35', name: 'ÎùºÏù¥Ìä∏ Í≥®Îì† ÎßàÌò∏Í∞ÄÎãà', color: '#8B4513' },
                    { code: '4.35', name: 'Í≥®Îì† ÎßàÌò∏Í∞ÄÎãà Î∏åÎùºÏö¥', color: '#A0522D' }
                ]
            },
            {
                name: 'Ïõ∞Îùº ÌîÑÎ°úÌéòÏÖîÎÑê', 
                products: [
                    { code: '6/73', name: 'Îã§ÌÅ¨ Î∏åÎùºÏö¥ Í≥®Îì†', color: '#8B4513' },
                    { code: '5/7', name: 'ÎùºÏù¥Ìä∏ Î∏åÎùºÏö¥ ÎØ∏ÎîîÏõÄ', color: '#CD853F' },
                    { code: '4/77', name: 'ÎØ∏ÎîîÏõÄ Î∏åÎùºÏö¥ Ïù∏ÌÖêÏä§', color: '#8B4513' }
                ]
            },
            {
                name: 'Î∞ÄÎ≥∏ Ïò§Î•¥ÎîîÎ∏å',
                products: [
                    { code: '6-CB', name: 'ÏΩîÌçº Î≤†Ïù¥ÏßÄ', color: '#DEB887' },
                    { code: '5-GM', name: 'Í≥®Îì† ÎßàÌò∏Í∞ÄÎãà', color: '#A0522D' },
                    { code: '7-OR', name: 'Ïò§Î†åÏßÄ', color: '#FF7F50' }
                ]
            }
        ],
        'Í≤®Ïö∏ Ïø®ÌÜ§': [
            {
                name: 'Î°úÎ†àÏùº ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '1.0', name: 'Î∏îÎûô', color: '#000000' },
                    { code: '2.1', name: 'Î∏åÎùºÏö¥ Ïï†Ïâ¨', color: '#2F4F4F' },
                    { code: '6.11', name: 'Îã§ÌÅ¨ Ïù∏ÌÖêÏä§ Ïï†Ïâ¨', color: '#696969' }
                ]
            },
            {
                name: 'Ïõ∞Îùº ÌîÑÎ°úÌéòÏÖîÎÑê',
                products: [
                    { code: '2/0', name: 'Î∏îÎûô', color: '#000000' },
                    { code: '4/0', name: 'ÎØ∏ÎîîÏõÄ Î∏åÎùºÏö¥', color: '#2F4F4F' },
                    { code: '6/0', name: 'Îã§ÌÅ¨ Î∏îÎ°†Îìú', color: '#696969' }
                ]
            },
            {
                name: 'Î∞ÄÎ≥∏ Ïò§Î•¥ÎîîÎ∏å',
                products: [
                    { code: '2-N', name: 'ÎÇ¥Ï∂îÎü¥ Î∏îÎûô', color: '#000000' },
                    { code: '4-N', name: 'ÎÇ¥Ï∂îÎü¥ Î∏åÎùºÏö¥', color: '#2F2F2F' },
                    { code: '6-A', name: 'Ïï†Ïâ¨ Î∏åÎùºÏö¥', color: '#708090' }
                ]
            }
        ]
    };
    
    return recommendations[season] || recommendations['Î¥Ñ ÏõúÌÜ§'];
}

// Î∂ÑÏÑù Ï¥àÍ∏∞Ìôî
function resetAnalysis() {
    currentStep = 1;
    faceDetected = false;
    window.currentFaceDetection = null;
    
    // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ï†ïÎ¶¨
    if (videoElement && videoElement.srcObject) {
        const stream = videoElement.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        videoElement.srcObject = null;
    }
    
    // Ï∫îÎ≤ÑÏä§ Ï†ïÎ¶¨
    if (canvasElement && canvasCtx) {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        if (canvasElement.parentNode) {
            canvasElement.parentNode.removeChild(canvasElement);
        }
    }
    
    // Í∞ÄÏù¥Îìú Îã§Ïãú ÌëúÏãú
    const guide = document.getElementById('face-guide');
    if (guide) guide.style.display = 'flex';
    
    goToStep(1);
    showToast('Î∂ÑÏÑùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'info');
}

// ==========================================
// ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞è UI Ìï®ÏàòÎì§
// ==========================================

// ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
function goHome() {
    // Î™®Îì† Î¶¨ÏÜåÏä§ Ï†ïÎ¶¨
    resetAnalysis();
    resetDraping();
    
    // Ìôà ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
    switchMode('selection');
    showToast('Ìôà ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§', 'info');
}

// ÎìúÎûòÏù¥Ìïë Ï¥àÍ∏∞Ìôî
function resetDraping() {
    selectedColor = null;
    uploadedImage = null;
    beforeImage = null;
    afterImage = null;
    
    // ÏóÖÎ°úÎìú ÎØ∏Î¶¨Î≥¥Í∏∞ Ïà®Í∏∞Í∏∞
    const preview = document.getElementById('uploaded-image-preview');
    if (preview) preview.style.display = 'none';
    
    // ÎπÑÍµê Ïª®ÌÖåÏù¥ÎÑà Ïà®Í∏∞Í∏∞
    const comparisonContainer = document.getElementById('comparison-container');
    if (comparisonContainer) comparisonContainer.style.display = 'none';
    
    // ÏÉâÏÉÅ ÏÑ†ÌÉù Ìï¥Ï†ú
    document.querySelectorAll('.color-swatch').forEach(swatch => {
        swatch.classList.remove('selected');
    });
    
    // Ï†ÅÏö© Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
    const applyBtn = document.getElementById('apply-color-btn');
    if (applyBtn) applyBtn.disabled = true;
    
    showToast('ÎìúÎûòÏù¥Ìïë Î™®ÎìúÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'info');
}

// Î™®Îìú Ï†ÑÌôò
function switchMode(mode) {
    console.log('Î™®Îìú Ï†ÑÌôò:', mode);
    
    // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.remove('active'));
    
    // Î™®Îì† Ìó§Îçî Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
    const headerBtns = document.querySelectorAll('.header-btn');
    headerBtns.forEach(btn => btn.classList.remove('active'));
    
    // ÏÑ†ÌÉùÎêú Î™®Îìú ÌôúÏÑ±Ìôî
    switch (mode) {
        case 'photo':
            document.getElementById('photo-analysis').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'photo\')"]').classList.add('active');
            break;
        case 'draping':
            document.getElementById('draping-mode').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'draping\')"]').classList.add('active');
            break;
        default:
            document.getElementById('mode-selection').classList.add('active');
            break;
    }
    
    currentMode = mode;
}

// Î™®Îìú Ïπ¥Îìú ÏÑ†ÌÉù
function selectModeCard(card) {
    const cards = document.querySelectorAll('.mode-card');
    cards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
}

// AI ÏÇ¨ÏßÑ Î∂ÑÏÑù ÏãúÏûë
function startPhotoAnalysis() {
    switchMode('photo');
}

// ÎìúÎûòÏù¥Ìïë ÏãúÏûë  
function startDraping() {
    switchMode('draping');
}

// Ïã§Ï†ú ÏñºÍµ¥ Ïù∏Ïãù ÏãúÏûë (MediaPipe ÏóÜÏù¥ÎèÑ ÏûëÎèô)
async function startFaceDetection() {
    try {
        console.log('Ïπ¥Î©îÎùº ÏãúÏûë...');
        
        // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÏãúÏûë
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                width: 640,
                height: 480,
                facingMode: 'user'
            }
        });
        
        videoElement = document.getElementById('camera-feed');
        videoElement.srcObject = stream;
        
        // Í∞ÄÏù¥Îìú Ïà®Í∏∞Í∏∞
        const guide = document.getElementById('face-guide');
        if (guide) guide.style.display = 'none';
        
        // MediaPipeÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î∂ÑÏÑù Î™®Îìú
        if (faceDetection && typeof Camera !== 'undefined') {
            // MediaPipe Î™®Îìú
            canvasElement = document.createElement('canvas');
            canvasElement.style.position = 'absolute';
            canvasElement.style.top = '0';
            canvasElement.style.left = '0';
            canvasElement.style.width = '100%';
            canvasElement.style.height = '100%';
            canvasElement.style.pointerEvents = 'none';
            canvasElement.style.zIndex = '10';
            
            const videoContainer = document.querySelector('.video-container');
            videoContainer.appendChild(canvasElement);
            
            canvasCtx = canvasElement.getContext('2d');
            
            videoElement.addEventListener('loadedmetadata', () => {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
            });
            
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (faceDetection) {
                        await faceDetection.send({ image: videoElement });
                    }
                },
                width: 640,
                height: 480
            });
            camera.start();
            
            showToast('MediaPipe ÏñºÍµ¥ Ïù∏ÏãùÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
        } else {
            // Í∏∞Î≥∏ Î™®Îìú (MediaPipe ÏóÜÏù¥)
            showToast('Ïπ¥Î©îÎùºÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Í∏∞Î≥∏ Î∂ÑÏÑù Î™®ÎìúÎ°ú ÎèôÏûëÌï©ÎãàÎã§.', 'info');
            
            // 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú 2Îã®Í≥ÑÎ°ú Ïù¥Îèô
            setTimeout(() => {
                faceDetected = true;
                goToStep(2);
                showToast('ÏñºÍµ¥Ïù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§! (Í∏∞Î≥∏ Î™®Îìú)', 'success');
            }, 3000);
        }
        
    } catch (error) {
        console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®:', error);
        showToast('Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî. ÎòêÎäî HTTPS ÌôòÍ≤ΩÏóêÏÑú Ïã§ÌñâÌïòÏÑ∏Ïöî.', 'error');
    }
}

// ==========================================
// ÎìúÎûòÏù¥Ìïë Î™®Îìú Ìï®ÏàòÎì§
// ==========================================

// Í≥ÑÏ†àÎ≥Ñ ÌåîÎ†àÌä∏ ÌëúÏãú
function showSeasonPalette(season) {
    selectedSeason = season;
    
    // ÌÉ≠ ÌôúÏÑ±Ìôî
    document.querySelectorAll('.season-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[onclick*="${season}"]`).classList.add('active');
    
    // ÌÜ§ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
    const palette = seasonPalettes[season];
    const toneInfoDiv = document.getElementById('tone-info');
    const seasonNames = {
        spring: 'Î¥Ñ (Spring)',
        summer: 'Ïó¨Î¶Ñ (Summer)', 
        autumn: 'Í∞ÄÏùÑ (Autumn)',
        winter: 'Í≤®Ïö∏ (Winter)'
    };
    
    toneInfoDiv.innerHTML = `
        <strong>${seasonNames[season]} Í≥ÑÏ†à ÌäπÏÑ±</strong><br>
        ${palette.characteristics.join(', ')}<br>
        <small>${palette.colors.length}Í∞ú ÎåÄÌëú ÏÉâÏÉÅ</small>
    `;
    
    // ÏÉâÏÉÅ ÌåîÎ†àÌä∏ ÏÉùÏÑ±
    const paletteDiv = document.getElementById('color-palette');
    paletteDiv.innerHTML = '';
    
    palette.colors.forEach((color, index) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.title = `${season} - ${color}`;
        swatch.dataset.color = color;
        swatch.dataset.season = season;
        
        swatch.addEventListener('click', () => {
            // Î™®Îì† Ïä§ÏôÄÏπò ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.remove('selected');
            });
            
            // ÏÑ†ÌÉùÎêú Ïä§ÏôÄÏπò Í∞ïÏ°∞
            swatch.classList.add('selected');
            selectedColor = color;
            
            // Ï†ÅÏö© Î≤ÑÌäº ÌôúÏÑ±Ìôî
            document.getElementById('apply-color-btn').disabled = false;
            
            showToast(`${season} Í≥ÑÏ†à ÏÉâÏÉÅ ${color} ÏÑ†ÌÉùÎê®`, 'info');
        });
        
        paletteDiv.appendChild(swatch);
    });
    
    showToast(`${seasonNames[season]} ÌåîÎ†àÌä∏ Î°úÎìúÎê®`, 'info');
}

// Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showToast('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            uploadedImage = img;
            beforeImage = img;
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
            const preview = document.getElementById('preview-image');
            const previewContainer = document.getElementById('uploaded-image-preview');
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
            
            showToast(`Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏôÑÎ£å! (${img.width}x${img.height})`, 'success');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ÏÑ†ÌÉùÌïú ÏÉâÏÉÅ Ï†ÅÏö©
function applySelectedColor() {
    if (!selectedColor || !uploadedImage) {
        showToast('Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÍ≥† ÏÉâÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 'error');
        return;
    }
    
    // After Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
    createAfterImage(uploadedImage, selectedColor);
    
    // Before/After ÎπÑÍµê Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
    document.getElementById('comparison-container').style.display = 'block';
    
    showToast(`${selectedColor} ÏÉâÏÉÅÏù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§`, 'success');
}

// After Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
function createAfterImage(originalImage, hairColor) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = originalImage.width;
    canvas.height = originalImage.height;
    
    // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
    ctx.drawImage(originalImage, 0, 0);
    
    // Ìó§Ïñ¥ ÏòÅÏó≠Ïóê ÏÉâÏÉÅ Ïò§Î≤ÑÎ†àÏù¥
    ctx.globalCompositeOperation = 'multiply';
    ctx.fillStyle = hairColor;
    ctx.globalAlpha = 0.3;
    
    // ÏÉÅÎã® 30% ÏòÅÏó≠Ïóê ÏÉâÏÉÅ Ï†ÅÏö©
    ctx.fillRect(0, 0, canvas.width, canvas.height * 0.3);
    
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1.0;
    
    // After Ïù¥ÎØ∏ÏßÄÎ°ú Ï†ÄÏû•
    afterImage = new Image();
    afterImage.onload = () => {
        setupBeforeAfterComparison();
        calculateImprovementMetrics();
    };
    afterImage.src = canvas.toDataURL();
}

// Before/After ÎπÑÍµê ÏÑ§Ï†ï
function setupBeforeAfterComparison() {
    const beforeCanvas = document.getElementById('before-canvas');
    const afterCanvas = document.getElementById('after-canvas');
    
    if (beforeCanvas && afterCanvas && beforeImage && afterImage) {
        // Before Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
        beforeCanvas.width = 300;
        beforeCanvas.height = 200;
        const beforeCtx = beforeCanvas.getContext('2d');
        beforeCtx.drawImage(beforeImage, 0, 0, 300, 200);
        
        // After Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
        afterCanvas.width = 300;
        afterCanvas.height = 200;
        const afterCtx = afterCanvas.getContext('2d');
        afterCtx.drawImage(afterImage, 0, 0, 300, 200);
        
        // Ïä¨ÎùºÏù¥Îçî Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        const slider = document.getElementById('comparison-slider');
        if (slider) {
            slider.addEventListener('input', updateSliderComparison);
        }
        
        showToast('Before/After ÎπÑÍµê Ï§ÄÎπÑ ÏôÑÎ£å', 'success');
    }
}

// Ïä¨ÎùºÏù¥Îçî ÎπÑÍµê ÏóÖÎç∞Ïù¥Ìä∏
function updateSliderComparison() {
    const slider = document.getElementById('comparison-slider');
    const afterCanvas = document.getElementById('after-canvas');
    if (!slider || !afterCanvas) return;
    
    const value = slider.value;
    afterCanvas.style.clipPath = `inset(0 ${100 - value}% 0 0)`;
}

// ÎπÑÍµê Î™®Îìú Ï†ÑÌôò
function switchComparisonMode(mode) {
    currentComparisonMode = mode;
    
    // Î™®Îì† ÎπÑÍµê Î™®Îìú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
    document.querySelectorAll('.comparison-mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ÏÑ†ÌÉùÎêú Î≤ÑÌäº ÌôúÏÑ±Ìôî
    document.querySelector(`[onclick*="${mode}"]`).classList.add('active');
    
    // Î™®Îì† Î∑∞Ïñ¥ Ïà®Í∏∞Í∏∞
    document.querySelectorAll('.comparison-viewer').forEach(viewer => {
        viewer.classList.remove('active');
    });
    
    // ÏÑ†ÌÉùÎêú Î∑∞Ïñ¥ ÌëúÏãú
    const targetViewer = document.getElementById(`${mode}-view`);
    if (targetViewer) {
        targetViewer.classList.add('active');
    }
    
    showToast(`${mode} ÎπÑÍµê Î™®Îìú ÌôúÏÑ±Ìôî`, 'info');
}

// Before/After ÌÜ†Í∏Ä
let isShowingBefore = true;
function toggleBeforeAfter() {
    // ÌÜ†Í∏Ä ÎπÑÍµê Î™®Îìú Íµ¨ÌòÑ
    const toggleView = document.getElementById('toggle-view');
    if (!toggleView || !beforeImage || !afterImage) return;
    
    isShowingBefore = !isShowingBefore;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 300;
    canvas.height = 200;
    
    if (isShowingBefore) {
        ctx.drawImage(beforeImage, 0, 0, 300, 200);
    } else {
        ctx.drawImage(afterImage, 0, 0, 300, 200);
    }
    
    toggleView.style.backgroundImage = `url(${canvas.toDataURL()})`;
    toggleView.style.backgroundSize = 'contain';
    toggleView.style.backgroundRepeat = 'no-repeat';
    toggleView.style.backgroundPosition = 'center';
}

// Í∞úÏÑ†ÎèÑ ÏßÄÌëú Í≥ÑÏÇ∞
function calculateImprovementMetrics() {
    const skinImprovement = Math.floor(Math.random() * 25) + 10;
    const harmonyScore = Math.floor(Math.random() * 20) + 80;
    const expertRating = Math.floor(Math.random() * 2) + 4;
    
    document.getElementById('skin-improvement').textContent = `+${skinImprovement}%`;
    document.getElementById('harmony-score').textContent = `${harmonyScore}Ï†ê`;
    document.getElementById('expert-rating').textContent = '‚òÖ'.repeat(expertRating) + '‚òÜ'.repeat(5 - expertRating);
}

// ÎπÑÍµê Ïù¥ÎØ∏ÏßÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
function exportComparison() {
    if (!beforeImage || !afterImage) {
        showToast('Î®ºÏ†Ä Before/After Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî', 'error');
        return;
    }
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = beforeImage.width * 2;
    canvas.height = beforeImage.height;
    
    // Before Ïù¥ÎØ∏ÏßÄ
    ctx.drawImage(beforeImage, 0, 0);
    
    // Íµ¨Î∂ÑÏÑ†
    ctx.strokeStyle = '#E91E63';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(beforeImage.width, 0);
    ctx.lineTo(beforeImage.width, beforeImage.height);
    ctx.stroke();
    
    // After Ïù¥ÎØ∏ÏßÄ
    ctx.drawImage(afterImage, beforeImage.width, 0);
    
    // ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
    ctx.font = 'bold 24px Arial';
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    
    ctx.strokeText('Before', 20, 40);
    ctx.fillText('Before', 20, 40);
    ctx.strokeText('After', beforeImage.width + 20, 40);
    ctx.fillText('After', beforeImage.width + 20, 40);
    
    // Îã§Ïö¥Î°úÎìú
    canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `personal_color_comparison_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('ÎπÑÍµê Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
    });
}

// ÏÉÅÎã¥ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
function generateReport() {
    const reportData = {
        timestamp: new Date().toLocaleString('ko-KR'),
        season: selectedSeason,
        selectedColor: selectedColor,
        improvementMetrics: {
            skinImprovement: document.getElementById('skin-improvement').textContent,
            harmonyScore: document.getElementById('harmony-score').textContent,
            expertRating: document.getElementById('expert-rating').textContent
        }
    };
    
    const reportContent = `
ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® Î¶¨Ìè¨Ìä∏

ÏßÑÎã® ÏùºÏãú: ${reportData.timestamp}
ÏßÑÎã®Îêú Í≥ÑÏ†à: ${reportData.season}
Ï†ÅÏö©Îêú ÏÉâÏÉÅ: ${reportData.selectedColor}

Í∞úÏÑ† ÏßÄÌëú:
- ÌîºÎ∂ÄÌÜ§ Í∞úÏÑ†: ${reportData.improvementMetrics.skinImprovement}
- Ï†ÑÏ≤¥ Ï°∞ÌôîÎèÑ: ${reportData.improvementMetrics.harmonyScore}
- Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤ú: ${reportData.improvementMetrics.expertRating}

Ï†ÑÎ¨∏Í∞Ä ÎÖ∏ÌïòÏö∞ Ï†ÅÏö©:
- Ïú†Ïù¥Î†à(UIREH): ${ExpertKnowledge.uireh.colorSpectrum}
- ÎπõÎÇ†Ïú§/Ï∞®ÌôçÏïÑÎ•¥Îçî: ${ExpertKnowledge.bitnalyun.principle}
- Î∏îÎ£®ÎØ∏: ${ExpertKnowledge.blume.specificTypes.warm}

Personal Color Pro - Ìó§Ïñ¥ÏÉµ Ï†ÑÏö© ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏãúÏä§ÌÖú
    `.trim();
    
    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `personal_color_report_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('ÏÉÅÎã¥ Î¶¨Ìè¨Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§', 'success');
}

// ==========================================
// ÏãúÏä§ÌÖú ÏÉÅÌÉú Î∞è Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
// ==========================================

// ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌëúÏãú
function showSystemStatus() {
    const status = `
Personal Color Pro - ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏãúÏä§ÌÖú

ÏãúÏä§ÌÖú ÏÉÅÌÉú:
‚Ä¢ MediaPipe: ${faceDetection ? '‚úÖ Î°úÎìúÎê®' : '‚ùå Ïã§Ìå®'}
‚Ä¢ Ïπ¥Î©îÎùº: ${videoElement && videoElement.srcObject ? '‚úÖ Ïó∞Í≤∞Îê®' : '‚ùå ÎåÄÍ∏∞Ï§ë'}
‚Ä¢ ÏñºÍµ¥ Ïù∏Ïãù: ${camera ? '‚úÖ ÌôúÏÑ±' : '‚ùå ÎπÑÌôúÏÑ±'}
‚Ä¢ ÌòÑÏû¨ Î™®Îìú: ${currentMode}

Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞:
‚Ä¢ ÏôÑÎ£åÎêú Î∂ÑÏÑù: ${analysisCount}Í±¥
‚Ä¢ ÏÑ†ÌÉùÎêú ÏÉâÏÉÅ: ${selectedColor || 'ÏóÜÏùå'}
‚Ä¢ ÌòÑÏû¨ Í≥ÑÏ†à: ${selectedSeason}

ÏÉâÏÉÅ ÌåîÎ†àÌä∏:
‚Ä¢ Î¥Ñ: ${seasonPalettes.spring.colors.length}Í∞ú
‚Ä¢ Ïó¨Î¶Ñ: ${seasonPalettes.summer.colors.length}Í∞ú
‚Ä¢ Í∞ÄÏùÑ: ${seasonPalettes.autumn.colors.length}Í∞ú
‚Ä¢ Í≤®Ïö∏: ${seasonPalettes.winter.colors.length}Í∞ú

Ï†ÑÎ¨∏Í∞Ä ÎÖ∏ÌïòÏö∞:
‚Ä¢ Ïú†Ïù¥Î†à(UIREH): ‚úÖ Ï†ÅÏö©Îê®
‚Ä¢ ÎπõÎÇ†Ïú§/Ï∞®ÌôçÏïÑÎ•¥Îçî: ‚úÖ Ï†ÅÏö©Îê®  
‚Ä¢ Î∏îÎ£®ÎØ∏: ‚úÖ Ï†ÅÏö©Îê®

Í∏∞Ïà† Ïä§ÌÉù:
‚Ä¢ RGB ‚Üí LAB Î≥ÄÌôò: ‚úÖ Íµ¨ÌòÑÎê®
‚Ä¢ Delta E 2000: ‚úÖ Íµ¨ÌòÑÎê®
‚Ä¢ Before/After ÎπÑÍµê: ‚úÖ Íµ¨ÌòÑÎê®
    `;
    
    alert(status);
}

// ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ
function showToast(message, type = 'info', duration = 3000) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, duration);
}

// ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && !event.shiftKey && !event.altKey) {
        switch(event.key) {
            case '1':
                event.preventDefault();
                switchMode('photo');
                break;
            case '2':
                event.preventDefault();
                switchMode('draping');
                break;
            case '0':
                event.preventDefault();
                goHome();
                break;
        }
    }
});

// ==========================================
// Î©îÏù∏ Ï¥àÍ∏∞Ìôî Ïã§Ìñâ (Î¨∏Ï†ú Ìï¥Í≤∞ ÏôÑÎ£å)
// ==========================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üé® Personal Color Pro ÏãúÏä§ÌÖú ÏãúÏûë...');
    
    updateLoadingProgress(10, 'ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...');
    
    // MediaPipe Ï¥àÍ∏∞Ìôî ÏãúÎèÑ
    const mediaPipeReady = await initializeMediaPipe();
    
    // Ïï± Ï¥àÍ∏∞Ìôî
    initializeApp();
    
    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
    setTimeout(() => {
        if (mediaPipeReady) {
            showToast('AI Î∂ÑÏÑù ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!', 'success');
        } else {
            showToast('MediaPipe Î°úÎìú Ïã§Ìå®. Í∏∞Î≥∏ Í∏∞Îä•ÏúºÎ°ú ÎèôÏûëÌï©ÎãàÎã§.', 'warning');
        }
    }, 2000);
});

console.log('‚úÖ Personal Color Pro ÏµúÏ¢Ö ÏôÑÏÑ± Î≤ÑÏ†Ñ Î°úÎìú ÏôÑÎ£å!');
</script>
</body>
</html>
