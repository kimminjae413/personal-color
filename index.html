<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Personal Color Pro - í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ</title>
    
    <!-- íŒŒë¹„ì½˜ 404 ì˜¤ë¥˜ ë°©ì§€ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ¨</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ¨</text></svg>">
    
    <!-- MediaPipe CDN (ìµœì‹  ì•ˆì • ë²„ì „) -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

<style>
/* ==========================================
   Personal Color Pro - íƒœë¸”ë¦¿ ìµœì í™” ë²„ì „
   ========================================== */

/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    /* íƒœë¸”ë¦¿ í„°ì¹˜ ìµœì í™” - í…ìŠ¤íŠ¸ ì„ íƒë§Œ ë°©ì§€ */
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

/* íƒœë¸”ë¦¿ ìŠ¤í¬ë¡¤ ë° í™•ëŒ€/ì¶•ì†Œ í—ˆìš© */
html, body {
    touch-action: pan-x pan-y pinch-zoom;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
    /* position: fixed ì œê±°í•˜ì—¬ ìŠ¤í¬ë¡¤ í—ˆìš© */
    width: 100%;
    min-height: 100vh;
}

/* ìƒˆë¡œê³ ì¹¨ ë°©ì§€ë§Œ ìœ ì§€ */
body {
    overscroll-behavior-y: contain;
    -webkit-overscroll-behavior-y: contain;
}

/* ìŠ¤í¬ë¡¤ ì˜ì—­ ìµœì í™” */
.scrollable {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
}

:root {
    --primary-pink: #E91E63;
    --secondary-rose: #F8BBD9;
    --light-pink: #FCE4EC;
    --dark-rose: #AD1457;
    --success: #4CAF50;
    --warning: #FF9800;
    --info: #2196F3;
    --error: #f44336;
    --face-color: #00FF88;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--light-pink) 0%, #fff 50%, var(--secondary-rose) 100%);
    min-height: 100vh;
    color: #333;
    /* íƒœë¸”ë¦¿ ìµœì í™” - ë¶€ë“œëŸ¬ìš´ í„°ì¹˜ í—ˆìš© */
    touch-action: pan-x pan-y pinch-zoom;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.loading-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 9999;
    flex-direction: column;
}

.loading-content {
    text-align: center;
}

.loading-logo {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    animation: pulse 2s infinite;
}

.loading-progress {
    width: 300px;
    height: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 1rem;
}

.loading-bar {
    height: 100%;
    background: white;
    width: 0%;
    border-radius: 3px;
    transition: width 0.3s ease;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.main-app {
    display: none;
    min-height: 100vh;
    position: relative;
}

.main-app.loaded {
    display: flex;
    flex-direction: column;
}

/* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
.app-header {
    background: white;
    padding: var(--spacing-lg);
    box-shadow: var(--shadow);
    border-bottom: 2px solid var(--secondary-rose);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.app-title-section {
    flex-grow: 1;
    min-width: 250px;
}

.app-title {
    font-size: 1.8rem;
    color: var(--primary-pink);
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.app-subtitle {
    color: #666;
    font-size: 0.9rem;
}

.header-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.header-btn {
    padding: 0.75rem 1rem;
    background: var(--primary-pink);
    color: white;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
}

.header-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-1px);
}

.header-btn.active {
    background: var(--dark-rose);
    box-shadow: 0 0 10px rgba(233, 30, 99, 0.4);
}

.header-btn.home-btn {
    background: #666;
    font-size: 1.2rem;
    padding: 0.5rem 0.75rem;
}

.header-btn.home-btn:hover {
    background: #333;
}

/* ì„¹ì…˜ ë„¤ë¹„ê²Œì´ì…˜ */
.section-nav {
    background: var(--light-pink);
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: var(--radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.nav-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-pink);
}

.nav-controls {
    display: flex;
    gap: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 1rem;
    background: white;
    color: var(--primary-pink);
    border: 2px solid var(--secondary-rose);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: var(--secondary-rose);
}

.nav-btn.danger {
    border-color: var(--error);
    color: var(--error);
}

.nav-btn.danger:hover {
    background: var(--error);
    color: white;
}

.main-content {
    padding: var(--spacing-lg);
    max-width: 1200px;
    margin: 0 auto;
    /* ìŠ¤í¬ë¡¤ í—ˆìš©ì„ ìœ„í•´ height ì œí•œ ì œê±° */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    flex: 1;
}

.section {
    display: none;
    background: white;
    border-radius: 16px;
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow);
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.section h2 {
    font-size: 1.8rem;
    color: var(--primary-pink);
    margin-bottom: var(--spacing-lg);
    text-align: center;
    font-weight: 600;
}

/* ëª¨ë“œ ì„ íƒ ì¹´ë“œë“¤ */
.mode-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.mode-card {
    background: linear-gradient(135deg, var(--light-pink), white);
    border: 2px solid var(--secondary-rose);
    border-radius: 16px;
    padding: var(--spacing-xl);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
}

.mode-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-pink);
}

.mode-card.selected {
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    color: white;
    transform: translateY(-3px);
}

.mode-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
    display: block;
}

.mode-card h3 {
    font-size: 1.3rem;
    margin-bottom: var(--spacing-md);
    font-weight: 600;
}

.mode-card p {
    margin-bottom: var(--spacing-md);
    line-height: 1.5;
    opacity: 0.9;
    font-size: 0.95rem;
}

.mode-features {
    list-style: none;
    text-align: left;
    margin-bottom: var(--spacing-md);
}

.mode-features li {
    padding: 0.4rem 0;
    position: relative;
    padding-left: var(--spacing-lg);
    font-size: 0.9rem;
}

.mode-features li::before {
    content: 'âœ“';
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

.mode-card.selected .mode-features li::before {
    color: white;
}

.mode-btn {
    background: var(--primary-pink);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.mode-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-1px);
}

.mode-card.selected .mode-btn {
    background: white;
    color: var(--primary-pink);
}

/* ë¶„ì„ ê·¸ë¦¬ë“œ */
.analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

/* ë“œë˜ì´í•‘ ëª¨ë“œ ë ˆì´ì•„ì›ƒ */
.draping-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.draping-left {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.video-container {
    position: relative;
    width: 100%;
    height: 350px;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    border: 3px solid var(--secondary-rose);
}

.video-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

/* ì–¼êµ´ ê°ì§€ ê°€ì´ë“œ (íƒ€ì›í˜•) */
.face-detection-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 220px;
    border: 3px dashed var(--primary-pink);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-pink);
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    text-align: center;
    padding: var(--spacing-md);
    font-size: 0.9rem;
    z-index: 5;
}

/* ì–¼êµ´ ê°ì§€ ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ */
.face-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
}

.analysis-panel {
    background: var(--light-pink);
    padding: var(--spacing-lg);
    border-radius: var(--radius);
    border: 2px solid var(--secondary-rose);
}

.analysis-step {
    text-align: center;
}

.analysis-step h3 {
    color: var(--primary-pink);
    margin-bottom: var(--spacing-md);
    font-size: 1.2rem;
}

.analysis-step p {
    margin-bottom: var(--spacing-md);
    color: #666;
    line-height: 1.4;
}

/* í”¼ë¶€í†¤ ì¶”ì¶œ ì˜ì—­ í‘œì‹œ */
.skin-analysis-regions {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 15;
}

.skin-region {
    position: absolute;
    border: 2px solid var(--face-color);
    border-radius: 50%;
    background: rgba(0, 255, 136, 0.1);
    animation: pulseRegion 2s infinite;
}

@keyframes pulseRegion {
    0%, 100% { 
        border-color: var(--face-color);
        box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
    }
    50% { 
        border-color: rgba(0, 255, 136, 0.8);
        box-shadow: 0 0 0 10px rgba(0, 255, 136, 0);
    }
}

/* ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
.color-palette-container {
    background: var(--light-pink);
    padding: var(--spacing-lg);
    border-radius: 12px;
    border: 2px solid var(--secondary-rose);
}

.season-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: var(--spacing-lg);
    justify-content: center;
    flex-wrap: wrap;
}

.season-tab {
    padding: 0.6rem 1.2rem;
    border: none;
    background: white;
    color: var(--primary-pink);
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid var(--secondary-rose);
    font-size: 0.85rem;
}

.season-tab.active {
    background: var(--primary-pink);
    color: white;
    border-color: var(--primary-pink);
}

.pccs-tone-info {
    background: white;
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: var(--spacing-md);
    border: 1px solid var(--secondary-rose);
    font-size: 0.9rem;
}

.color-palette {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 0.6rem;
    margin-bottom: var(--spacing-lg);
}

.color-swatch {
    aspect-ratio: 1;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.color-swatch:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.color-swatch.selected {
    border-color: var(--primary-pink);
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(233, 30, 99, 0.5);
}

/* Before/After ë¹„êµ */
.comparison-container {
    background: white;
    border-radius: 12px;
    padding: var(--spacing-lg);
    margin-top: var(--spacing-lg);
    box-shadow: var(--shadow);
    border: 2px solid var(--secondary-rose);
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
    gap: 1rem;
}

.comparison-controls {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.comparison-mode-btn {
    padding: 0.4rem 0.8rem;
    border: 2px solid var(--secondary-rose);
    background: white;
    color: var(--primary-pink);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    font-weight: 500;
}

.comparison-mode-btn.active {
    background: var(--primary-pink);
    color: white;
    border-color: var(--primary-pink);
}

.comparison-viewer {
    width: 100%;
    height: 250px;
    background: #f5f5f5;
    border-radius: var(--radius);
    border: 2px solid var(--secondary-rose);
    display: none;
    position: relative;
    overflow: hidden;
}

.comparison-viewer.active {
    display: block;
}

.improvement-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: var(--spacing-lg);
}

.metric {
    background: var(--light-pink);
    padding: 1rem;
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--secondary-rose);
}

.metric-label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.metric-value {
    display: block;
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--primary-pink);
}

/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
.toast {
    position: fixed;
    top: 80px;
    right: 20px;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    color: white;
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    max-width: 320px;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.success { background: var(--success); }
.toast.error { background: var(--error); }
.toast.info { background: var(--info); }
.toast.warning { background: var(--warning); }

/* ìŠ¬ë¼ì´ë” í„°ì¹˜ ìµœì í™” ìŠ¤íƒ€ì¼ */
input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    outline: none;
    touch-action: manipulation;
    cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary-pink);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--primary-pink);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input[type="range"]::-webkit-slider-track {
    height: 6px;
    background: #ddd;
    border-radius: 3px;
}

input[type="range"]::-moz-range-track {
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    border: none;
}

/* ë°˜ì‘í˜• ë””ìì¸ - íƒœë¸”ë¦¿ ìµœì í™” */
@media (max-width: 768px) {
    .analysis-grid,
    .draping-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    .mode-cards {
        grid-template-columns: 1fr;
    }
    .app-title {
        font-size: 1.5rem;
    }
    .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    .improvement-metrics {
        grid-template-columns: 1fr;
    }
    .season-tabs {
        justify-content: stretch;
    }
    .season-tab {
        flex: 1;
        min-width: 0;
        padding: 0.8rem 0.6rem;
        font-size: 0.9rem;
    }
    .color-palette {
        grid-template-columns: repeat(6, 1fr);
    }
    .comparison-controls {
        justify-content: center;
        width: 100%;
    }
    .nav-controls {
        width: 100%;
        justify-content: center;
    }
    .section-nav {
        flex-direction: column;
        text-align: center;
    }
    
    /* íƒœë¸”ë¦¿ í„°ì¹˜ ìµœì í™” */
    .mode-btn,
    .header-btn,
    .nav-btn,
    .season-tab,
    .comparison-mode-btn {
        min-height: 48px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* ë“œë˜ì´í•‘ ë ˆì´ì•„ì›ƒ ì¡°ì • */
    .draping-left {
        margin-bottom: 1rem;
    }
    
    /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ì¡°ì • */
    .video-container {
        height: 280px;
        margin-bottom: 1rem;
    }
}

/* íƒœë¸”ë¦¿ ì„¸ë¡œ ëª¨ë“œ ìµœì í™” */
@media (max-width: 768px) and (orientation: portrait) {
    .main-content {
        padding: 1rem;
    }
    
    .section {
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .video-container {
        height: 250px;
    }
    
    .mode-card {
        padding: 1.5rem;
    }
}

/* íƒœë¸”ë¦¿ ê°€ë¡œ ëª¨ë“œ ìµœì í™” */
@media (max-width: 1024px) and (orientation: landscape) {
    .analysis-grid,
    .draping-layout {
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .video-container {
        height: 320px;
    }
}

@media (max-width: 480px) {
    .header-controls {
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
        gap: 0.3rem;
    }
    .header-btn {
        flex: 1;
        min-width: 0;
        font-size: 0.8rem;
        padding: 0.6rem 0.5rem;
        min-height: 44px;
    }
    
    .main-content {
        padding: 0.8rem;
    }
    
    .section {
        padding: 1rem;
        border-radius: 12px;
    }
}
</style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">ğŸ¨</div>
            <h2>Personal Color Pro</h2>
            <p id="loading-text">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-content">
                <div class="app-title-section">
                    <h1 class="app-title">Personal Color Pro</h1>
                    <div class="app-subtitle">í—¤ì–´ìƒµ ì „ìš© í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ</div>
                </div>
                
                <div class="header-controls">
                    <button class="header-btn home-btn" onclick="goHome()" title="í™ˆìœ¼ë¡œ">ğŸ </button>
                    <button class="header-btn" onclick="switchMode('photo')">ğŸ“¸ AI ë¶„ì„</button>
                    <button class="header-btn" onclick="switchMode('draping')">ğŸ­ ë“œë˜ì´í•‘</button>
                    <button class="header-btn" onclick="showSystemStatus()">âš™ï¸ ìƒíƒœ</button>
                </div>
            </div>
        </header>

        <main class="main-content scrollable">
            <!-- ëª¨ë“œ ì„ íƒ ì„¹ì…˜ -->
            <section class="section active" id="mode-selection">
                <div class="section-nav">
                    <div class="nav-title">í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ëª¨ë“œ ì„ íƒ</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="showSystemStatus()">ì‹œìŠ¤í…œ ì •ë³´</button>
                    </div>
                </div>

                <div class="mode-cards">
                    <div class="mode-card" onclick="selectModeCard(this); startPhotoAnalysis();">
                        <div class="mode-icon">
                            <svg width="80" height="80" viewBox="0 0 40 40" style="fill: var(--primary-pink);">
                                <!-- ì–¼êµ´ ìœ¤ê³½ -->
                                <ellipse cx="20" cy="18" rx="12" ry="14" fill="#F5C6A0" stroke="var(--primary-pink)" stroke-width="2"/>
                                <!-- ëˆˆ -->
                                <circle cx="16" cy="15" r="2" fill="#333"/>
                                <circle cx="24" cy="15" r="2" fill="#333"/>
                                <circle cx="16.5" cy="14.5" r="0.8" fill="white"/>
                                <circle cx="24.5" cy="14.5" r="0.8" fill="white"/>
                                <!-- ì½” -->
                                <path d="M19 18 L20 20 L21 18" stroke="#D4A574" stroke-width="1.5" fill="none"/>
                                <!-- ì… -->
                                <path d="M17 23 Q20 25 23 23" stroke="#D4546F" stroke-width="2" fill="none"/>
                                <!-- ë¶„ì„ í¬ì¸íŠ¸ë“¤ -->
                                <circle cx="13" cy="12" r="1.5" fill="none" stroke="var(--primary-pink)" stroke-width="1"/>
                                <circle cx="27" cy="12" r="1.5" fill="none" stroke="var(--primary-pink)" stroke-width="1"/>
                                <circle cx="13" cy="20" r="1.5" fill="none" stroke="var(--primary-pink)" stroke-width="1"/>
                                <circle cx="27" cy="20" r="1.5" fill="none" stroke="var(--primary-pink)" stroke-width="1"/>
                            </svg>
                        </div>
                        <h3>AI ë¶„ì„ ëª¨ë“œ</h3>
                        <p>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ë¥¼ í†µí•œ AI ê¸°ë°˜ ê³¼í•™ì  í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨</p>
                        <ul class="mode-features">
                            <li>MediaPipe ì–¼êµ´ í˜•íƒœ ì¶”ì </li>
                            <li>ì–¼êµ´ ëª¨ì–‘ ê¸°ë°˜ í”¼ë¶€í†¤ ì¶”ì¶œ</li>
                            <li>RGBâ†’LAB ìƒ‰ê³µê°„ ë³€í™˜</li>
                            <li>Delta E 2000 ìƒ‰ì°¨ ì¸¡ì •</li>
                            <li>120ê°€ì§€ ì„¸ë¶€ íƒ€ì… ë¶„ì„</li>
                            <li>ë¸Œëœë“œë³„ ì œí’ˆ ì¶”ì²œ</li>
                        </ul>
                        <button class="mode-btn">ì‹œì‘í•˜ê¸°</button>
                    </div>

                    <div class="mode-card" onclick="selectModeCard(this); startDraping();">
                        <div class="mode-icon">
                            <svg width="80" height="80" viewBox="0 0 40 40" style="fill: var(--primary-pink);">
                                <!-- ì–¼êµ´ -->
                                <ellipse cx="20" cy="16" rx="10" ry="12" fill="#F5C6A0" stroke="#DDD" stroke-width="1"/>
                                <!-- ëˆˆ -->
                                <circle cx="17" cy="13" r="1.5" fill="#333"/>
                                <circle cx="23" cy="13" r="1.5" fill="#333"/>
                                <!-- ì… -->
                                <path d="M17 19 Q20 21 23 19" stroke="#D4546F" stroke-width="1.5" fill="none"/>
                                <!-- ë“œë˜ì´í•‘ ì²œ - ë¬´ì§€ê°œ ìƒ‰ìƒ -->
                                <path d="M8 25 Q12 22 16 24 Q20 26 24 24 Q28 22 32 25 L32 35 Q28 32 24 34 Q20 36 16 34 Q12 32 8 35 Z" fill="#FF6B6B"/>
                                <path d="M8 27 Q12 24 16 26 Q20 28 24 26 Q28 24 32 27 L32 37 Q28 34 24 36 Q20 38 16 36 Q12 34 8 37 Z" fill="#FFD93D"/>
                                <path d="M8 29 Q12 26 16 28 Q20 30 24 28 Q28 26 32 29 L32 39 Q28 36 24 38 Q20 40 16 38 Q12 36 8 39 Z" fill="#6BCF7F"/>
                                <path d="M8 31 Q12 28 16 30 Q20 32 24 30 Q28 28 32 31 L32 38 Q28 35 24 37 Q20 39 16 37 Q12 35 8 38 Z" fill="#4D96FF"/>
                                <path d="M8 33 Q12 30 16 32 Q20 34 24 32 Q28 30 32 33 L32 37 Q28 34 24 36 Q20 38 16 36 Q12 34 8 37 Z" fill="#9B59B6"/>
                            </svg>
                        </div>
                        <h3>ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ</h3>
                        <p>ì „ë¬¸ê°€ ë…¸í•˜ìš°ë¥¼ ë°˜ì˜í•œ ê°€ìƒ ë“œë˜ì´í•‘ ì§„ë‹¨</p>
                        <ul class="mode-features">
                            <li>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ë“œë˜ì´í•‘</li>
                            <li>4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</li>
                            <li>ìœ ì´ë ˆ/ë¹›ë‚ ìœ¤/ë¸”ë£¨ë¯¸ ë…¸í•˜ìš°</li>
                            <li>Before/After ë¹„êµ</li>
                            <li>ê°œì„ ë„ ì§€í‘œ ì¸¡ì •</li>
                        </ul>
                        <button class="mode-btn">ì‹œì‘í•˜ê¸°</button>
                    </div>
                </div>
            </section>

            <!-- AI ì‚¬ì§„ ë¶„ì„ ì„¹ì…˜ -->
            <section class="section" id="photo-analysis">
                <div class="section-nav">
                    <div class="nav-title">AI ê¸°ë°˜ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
                        <button class="nav-btn" onclick="switchMode('draping')">ë“œë˜ì´í•‘ ëª¨ë“œ</button>
                        <button class="nav-btn danger" onclick="resetAnalysis()">ë¶„ì„ ì´ˆê¸°í™”</button>
                    </div>
                </div>
                
                <div class="analysis-grid">
                    <div class="video-container">
                        <video id="camera-feed" class="video-feed" autoplay muted playsinline></video>
                        <canvas id="face-overlay" class="face-overlay"></canvas>
                        <div class="face-detection-guide" id="face-guide">
                            ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì—<br>ë§ì¶°ì£¼ì„¸ìš”
                        </div>
                        <div class="skin-analysis-regions" id="skin-regions"></div>
                    </div>

                    <div class="analysis-panel">
                        <div id="step-1" class="analysis-step active">
                            <h3>1ë‹¨ê³„: ì¹´ë©”ë¼ ì¤€ë¹„</h3>
                            <p>ì¹´ë©”ë¼ë¥¼ í™œì„±í™”í•˜ì—¬ ì–¼êµ´ì„ ì¸ì‹í•©ë‹ˆë‹¤</p>
                            <button class="mode-btn" onclick="startFaceDetection()">ì¹´ë©”ë¼ ì‹œì‘</button>
                        </div>
                        
                        <div id="step-2" class="analysis-step" style="display: none;">
                            <h3>2ë‹¨ê³„: ì–¼êµ´ ì¸ì‹ ì¤‘</h3>
                            <p>MediaPipeë¡œ ì–¼êµ´ í˜•íƒœë¥¼ ì¶”ì í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            <div style="color: #4CAF50; font-weight: bold; margin: 1rem 0;">âœ… ì–¼êµ´ ê°ì§€ë¨</div>
                            <button class="mode-btn" onclick="startToneAnalysis()">í”¼ë¶€í†¤ ë¶„ì„ ì‹œì‘</button>
                        </div>
                        
                        <div id="step-3" class="analysis-step" style="display: none;">
                            <h3>3ë‹¨ê³„: í”¼ë¶€í†¤ ë¶„ì„ ì¤‘</h3>
                            <p>ì–¼êµ´ ëª¨ì–‘ ê¸°ë°˜ìœ¼ë¡œ í”¼ë¶€í†¤ ì˜ì—­ì„ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            <div id="analysis-progress" style="background: #FCE4EC; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <div>í”¼ë¶€ìƒ‰ ì¶”ì¶œ ì¤‘...</div>
                            </div>
                        </div>
                        
                        <div id="step-4" class="analysis-step" style="display: none;">
                            <h3>4ë‹¨ê³„: ë¶„ì„ ì™„ë£Œ</h3>
                            <div id="final-results" style="background: white; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div id="result-season" style="font-size: 1.6rem; color: #E91E63; font-weight: bold;">-</div>
                                    <div>ì •í™•ë„: <span id="confidence-score" style="color: #4CAF50; font-weight: bold;">-</span></div>
                                </div>
                                
                                <div id="detailed-analysis">
                                    <h4>ìƒì„¸ ë¶„ì„ ê²°ê³¼:</h4>
                                    <div id="analysis-details"></div>
                                </div>
                                
                                <div style="margin-top: 1rem; text-align: center;">
                                    <button class="mode-btn" onclick="resetAnalysis()" style="margin-right: 0.5rem;">ë‹¤ì‹œ ë¶„ì„</button>
                                    <button class="mode-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ë“œë˜ì´í•‘ ëª¨ë“œ ì„¹ì…˜ -->
            <section class="section" id="draping-mode">
                <div class="section-nav">
                    <div class="nav-title">ì‹¤ì‹œê°„ ë“œë˜ì´í•‘ ì§„ë‹¨</div>
                    <div class="nav-controls">
                        <button class="nav-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
                        <button class="nav-btn" onclick="switchMode('photo')">AI ë¶„ì„ ëª¨ë“œ</button>
                        <button class="nav-btn danger" onclick="resetDraping()">ì´ˆê¸°í™”</button>
                    </div>
                </div>
                
                <div class="draping-layout">
                    <!-- ì™¼ìª½: ì¹´ë©”ë¼ + ì‚¬ìš©ë²• -->
                    <div class="draping-left">
                        <!-- ì‹¤ì‹œê°„ ì¹´ë©”ë¼ + ìƒ‰ìƒ ì˜¤ë²„ë ˆì´ -->
                        <div class="video-container">
                            <video id="draping-camera" class="video-feed" autoplay muted playsinline></video>
                            <canvas id="draping-overlay" class="face-overlay"></canvas>
                            <div class="face-detection-guide" id="draping-guide">
                                ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì—<br>ë§ì¶°ì£¼ì„¸ìš”
                            </div>
                            <div class="skin-analysis-regions" id="draping-regions"></div>
                            
                            <!-- AI ì°¸ê³  ì •ë³´ -->
                            <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; border-radius: 6px; font-size: 0.85rem;">
                                <div>AI ë¶„ì„: <span id="ai-reference">-</span></div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">(ì°¸ê³ ìš©)</div>
                            </div>
                            
                            <!-- Before/After í† ê¸€ ë²„íŠ¼ -->
                            <div style="position: absolute; bottom: 10px; right: 10px;">
                                <button onclick="toggleDrapingPreview()" style="background: var(--primary-pink); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer;">
                                    ì›ë³¸/ì ìš© (ìŠ¤í˜ì´ìŠ¤)
                                </button>
                            </div>
                        </div>

                        <!-- ì‚¬ìš©ë²• ì•ˆë‚´ (ì¹´ë©”ë¼ ë°”ë¡œ ë°‘) -->
                        <div style="background: linear-gradient(135deg, #FCE4EC, #F8BBD9); border: 2px solid var(--primary-pink); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.15);">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="background: var(--primary-pink); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold;">?</div>
                                <h3 style="color: var(--dark-rose); margin: 0; font-size: 1.2rem;">ì‹¤ì‹œê°„ ë“œë˜ì´í•‘ ì‚¬ìš©ë²•</h3>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 12px; border-left: 4px solid var(--primary-pink);">
                                    <div style="color: var(--primary-pink); font-weight: bold; margin-bottom: 0.5rem;">1ï¸âƒ£ ì¹´ë©”ë¼ ì¤€ë¹„</div>
                                    <div style="font-size: 0.9rem; color: #555; line-height: 1.4;">"ì¹´ë©”ë¼ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤ì‹œê°„ í™”ë©´ì„ ì¼œì„¸ìš”</div>
                                </div>
                                
                                <div style="background: white; padding: 1rem; border-radius: 12px; border-left: 4px solid #FF9800;">
                                    <div style="color: #FF9800; font-weight: bold; margin-bottom: 0.5rem;">2ï¸âƒ£ AI ì°¸ê³ </div>
                                    <div style="font-size: 0.9rem; color: #555; line-height: 1.4;">í™”ë©´ ì¢Œìƒë‹¨ì˜ AI ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ê³ í•˜ì„¸ìš”</div>
                                </div>
                                
                                <div style="background: white; padding: 1rem; border-radius: 12px; border-left: 4px solid #4CAF50;">
                                    <div style="color: #4CAF50; font-weight: bold; margin-bottom: 0.5rem;">3ï¸âƒ£ ìƒ‰ìƒ ì¡°ì •</div>
                                    <div style="font-size: 0.9rem; color: #555; line-height: 1.4;">4ê³„ì ˆ íƒ­ê³¼ ìŠ¬ë¼ì´ë”ë¡œ ìƒ‰ìƒì„ ì„¸ë°€í•˜ê²Œ ì¡°ì •</div>
                                </div>
                                
                                <div style="background: white; padding: 1rem; border-radius: 12px; border-left: 4px solid #9C27B0;">
                                    <div style="color: #9C27B0; font-weight: bold; margin-bottom: 0.5rem;">4ï¸âƒ£ ë¹„êµ í™•ì¸</div>
                                    <div style="font-size: 0.9rem; color: #555; line-height: 1.4;">ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ì›ë³¸/ì ìš© ë¹„êµí•˜ê¸°</div>
                                </div>
                                
                                <div style="background: white; padding: 1rem; border-radius: 12px; border-left: 4px solid #2196F3; grid-column: 1 / -1;">
                                    <div style="color: #2196F3; font-weight: bold; margin-bottom: 0.5rem;">5ï¸âƒ£ ì œí’ˆ ë§¤ì¹­</div>
                                    <div style="font-size: 0.9rem; color: #555; line-height: 1.4;">"í˜„ì¬ ìƒ‰ìƒ ì €ì¥" ë²„íŠ¼ìœ¼ë¡œ ë¡œë ˆì•Œ/ì›°ë¼/ë°€ë³¸ ì œí’ˆê³¼ ìë™ ë§¤ì¹­ë©ë‹ˆë‹¤</div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 0.75rem; border-radius: 8px; margin-top: 1rem; text-align: center; border: 1px dashed var(--primary-pink);">
                                <div style="font-size: 0.85rem; color: var(--dark-rose);">
                                    <strong>ğŸ’¡ íŒ:</strong> ëª…ë„/ì±„ë„/ì˜¨ë„ê° ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í•˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”!
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ì „ë¬¸ê°€ ì¡°ì • íŒ¨ë„ -->
                    <div class="color-palette-container">
                        <h3 style="text-align: center; margin-bottom: 1rem;">ì „ë¬¸ê°€ ìƒ‰ìƒ ì¡°ì •</h3>
                        
                        <!-- 4ê³„ì ˆ ëŒ€ë¶„ë¥˜ -->
                        <div class="season-tabs">
                            <button class="season-tab active" onclick="setDrapingSeason('spring')" id="draping-spring">ë´„</button>
                            <button class="season-tab" onclick="setDrapingSeason('summer')" id="draping-summer">ì—¬ë¦„</button>
                            <button class="season-tab" onclick="setDrapingSeason('autumn')" id="draping-autumn">ê°€ì„</button>
                            <button class="season-tab" onclick="setDrapingSeason('winter')" id="draping-winter">ê²¨ìš¸</button>
                        </div>

                        <!-- ì„¸ë¶€ ì¡°ì • ìŠ¬ë¼ì´ë”ë“¤ -->
                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; color: #333;">ëª…ë„ ì¡°ì •</label>
                                <input type="range" id="lightness-slider" min="-30" max="30" value="0" 
                                       style="width: 100%; margin-top: 0.5rem;"
                                       oninput="updateDrapingColor()" 
                                       onchange="updateDrapingColor()"
                                       ontouchmove="updateDrapingColor()">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                                    <span>ì–´ë‘¡ê²Œ</span>
                                    <span id="lightness-value">0</span>
                                    <span>ë°ê²Œ</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; color: #333;">ì±„ë„ ì¡°ì •</label>
                                <input type="range" id="saturation-slider" min="-50" max="50" value="0" 
                                       style="width: 100%; margin-top: 0.5rem;"
                                       oninput="updateDrapingColor()" 
                                       onchange="updateDrapingColor()"
                                       ontouchmove="updateDrapingColor()">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                                    <span>ì°¨ë¶„í•˜ê²Œ</span>
                                    <span id="saturation-value">0</span>
                                    <span>ì„ ëª…í•˜ê²Œ</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; color: #333;">ì˜¨ë„ê° ì¡°ì •</label>
                                <input type="range" id="warmth-slider" min="-40" max="40" value="0" 
                                       style="width: 100%; margin-top: 0.5rem;"
                                       oninput="updateDrapingColor()" 
                                       onchange="updateDrapingColor()"
                                       ontouchmove="updateDrapingColor()">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                                    <span>ì¿¨í†¤</span>
                                    <span id="warmth-value">0</span>
                                    <span>ì›œí†¤</span>
                                </div>
                            </div>
                        </div>

                        <!-- í˜„ì¬ ì ìš©ëœ ìƒ‰ìƒ í‘œì‹œ -->
                        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">í˜„ì¬ ìƒ‰ìƒ</div>
                            <div style="width: 60px; height: 60px; border-radius: 50%; margin: 0 auto; border: 3px solid #ddd;" id="current-draping-color"></div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem; color: #666;" id="current-color-info">ìƒ‰ìƒì„ ì¡°ì •í•´ë³´ì„¸ìš”</div>
                        </div>

                        <!-- ì¦ê²¨ì°¾ê¸° ìƒ‰ìƒ ì €ì¥ -->
                        <div style="text-align: center;">
                            <button class="mode-btn" onclick="saveFavoriteColor()" style="margin-right: 0.5rem;">
                                í˜„ì¬ ìƒ‰ìƒ ì €ì¥
                            </button>
                            <button class="mode-btn" onclick="startDrapingCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                        </div>
                        
                        <!-- ì €ì¥ëœ ìƒ‰ìƒë“¤ -->
                        <div id="favorite-colors" style="margin-top: 1rem; display: none;">
                            <h4 style="margin-bottom: 0.5rem;">ì €ì¥ëœ ìƒ‰ìƒ</h4>
                            <div id="favorite-colors-list" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
// ==========================================
// íƒœë¸”ë¦¿ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™” (ìˆ˜ì •ë¨)
// ==========================================

// í˜ì´ì§€ ë¡œë“œ ì‹œ í„°ì¹˜ ì´ë²¤íŠ¸ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    // ê³¼ë„í•œ ì¤Œ ë°©ì§€ (ì™„ì „ ì°¨ë‹¨ X, ì ì ˆí•œ ì œí•œ)
    document.addEventListener('touchstart', function(e) {
        // 3ê°œ ì´ìƒ ì†ê°€ë½ í„°ì¹˜ë§Œ ë°©ì§€ (ì¼ë°˜ì ì¸ í•€ì¹˜ ì¤Œì€ í—ˆìš©)
        if (e.touches.length > 2) {
            e.preventDefault();
        }
    }, { passive: false });

    // ìƒë‹¨ ë‹¹ê¸°ëŠ” ìƒˆë¡œê³ ì¹¨ë§Œ ë°©ì§€
    document.addEventListener('touchmove', function(e) {
        // ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ìˆì„ ë•Œë§Œ ìƒë‹¨ ë‹¹ê¸°ê¸° ë°©ì§€
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop === 0 && e.touches[0].clientY > e.touches[0].pageY) {
            e.preventDefault();
        }
    }, { passive: false });

    // ë”ë¸”íƒ­ ì¤Œë§Œ ë°©ì§€ (ì¼ë°˜ íƒ­ì€ í—ˆìš©)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);

    // Ctrl+ë§ˆìš°ìŠ¤ íœ  ì¤Œë§Œ ë°©ì§€
    document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
        }
    }, { passive: false });

    // í‚¤ë³´ë“œ ì¤Œ ë°©ì§€
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
            e.preventDefault();
        }
    });

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë°©ì§€ (ê¸¸ê²Œ ëˆ„ë¥´ê¸° ë©”ë‰´)
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€
    document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'IMG') {
            e.preventDefault();
        }
    });

    // í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ (ì…ë ¥ í•„ë“œ ì œì™¸)
    document.addEventListener('selectstart', function(e) {
        if (!e.target.closest('input') && !e.target.closest('textarea')) {
            e.preventDefault();
        }
    });
});

// ==========================================
// Personal Color Pro - íƒœë¸”ë¦¿ ìµœì í™” ë²„ì „
// 120ìƒ‰ ì¶”ì²œ ì‹œìŠ¤í…œ í¬í•¨
// ==========================================

// ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
let currentMode = 'selection';
let selectedColor = null;
let selectedSeason = 'spring';
let analysisCount = 0;
let faceDetection = null;
let videoElement = null;
let canvasElement = null;
let canvasCtx = null;
let camera = null;
let isAnalyzing = false;
let currentStep = 1;
let faceDetected = false;
let currentComparisonMode = 'slider';
let beforeImage = null;
let afterImage = null;
let uploadedImage = null;
let currentFaceBox = null;
let skinRegions = [];

// ì „ë¬¸ê°€ ë…¸í•˜ìš° ë°ì´í„° (ì‹¤ì œ ë°˜ì˜)
const ExpertKnowledge = {
    uireh: {
        colorSpectrum: "ì£¼í™©ìƒ‰ì€ ì ˆëŒ€ ì¿¨í†¤ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ì—†ìŒ",
        lightnessMatching: "íŒŒìš´ë°ì´ì…˜ 21-23í˜¸ëŠ” ë¹„ìŠ·í•œ ëª…ë„ í—¤ì–´ì»¬ëŸ¬ íšŒí”¼",
        winterClear: ["ì¡°ì´", "í˜„ì•„"]
    },
    bitnalyun: {
        skinConditions: {
            redness: "í™ì¡° í”¼ë¶€ â†’ ë¯¸ë“œë‚˜ì‡ ì»¬ëŸ¬ë¡œ ì¤‘í™”",
            pale: "ì°½ë°±í•œ í”¼ë¶€ â†’ ì›œí†¤ìœ¼ë¡œ ìƒê¸° ë¶€ì—¬", 
            yellowish: "í™©ê¸° í”¼ë¶€ â†’ ì• ì‰¬ ê³„ì—´ë¡œ íˆ¬ëª…ê°"
        },
        principle: "ëª…ë„Â·ì±„ë„ ì¡°í•©ì´ ì´ë¦„ë³´ë‹¤ ì¤‘ìš”"
    },
    blume: {
        specificTypes: {
            warm: "ì•„ì´ë³´ë¦¬ í”¼ë¶€ + ì½”í† ë¦¬ë² ì´ì§€/ì˜¤ë Œì§€ë¸Œë¼ìš´",
            cool: "í™”ì´íŠ¸ í”¼ë¶€ + ë¸”ë£¨ë¸”ë™/ì• ì‰¬ë¸”ë£¨"
        }
    }
};

// 4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì „ë¬¸ê°€ ê¸°ë°˜)
const seasonPalettes = {
    spring: {
        colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD', '#F5DEB3', '#FFEFD5', '#FFB347', '#FF7F50', '#32CD32', '#FF6347'],
        characteristics: ['ë°ê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë†’ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
    },
    summer: {
        colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA', '#D8BFD8', '#B19CD9', '#87CEEB', '#98FB98', '#FFB6C1', '#F0E68C'],
        characteristics: ['ë¶€ë“œëŸ½ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ì¤‘ê°„ ì±„ë„', 'íŒŒë€ ì–¸ë”í†¤']
    },
    autumn: {
        colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000', '#556B2F', '#6B8E23', '#DAA520', '#B8860B', '#FF8C00', '#FF7F50'],
        characteristics: ['ê¹Šê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë‚®ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
    },
    winter: {
        colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090', '#FF1493', '#DC143C', '#B22222', '#800080', '#000000', '#FFFFFF'],
        characteristics: ['ì§„í•˜ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ë†’ì€ ëŒ€ë¹„', 'íŒŒë€ ì–¸ë”í†¤']
    }
};

// ==========================================
// ë¡œë”© ë° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤
// ==========================================

// ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateLoadingProgress(percent, text) {
    const loadingBar = document.getElementById('loading-bar');
    const loadingText = document.getElementById('loading-text');
    if (loadingBar) loadingBar.style.width = percent + '%';
    if (loadingText) loadingText.textContent = text;
}

// MediaPipe ì´ˆê¸°í™”
async function initializeMediaPipe() {
    try {
        updateLoadingProgress(30, 'MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ì¤‘...');
        
        let mediapipeLoaded = false;
        let retryCount = 0;
        const maxRetries = 3;
        
        while (!mediapipeLoaded && retryCount < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, 800));
            
            if (typeof FaceDetection !== 'undefined') {
                try {
                    faceDetection = new FaceDetection({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
                        }
                    });
                    
                    await new Promise((resolve, reject) => {
                        try {
                            faceDetection.setOptions({
                                model: 'short',
                                minDetectionConfidence: 0.3,
                            });
                            
                            faceDetection.onResults(onFaceDetectionResults);
                            setTimeout(resolve, 500);
                        } catch (error) {
                            reject(error);
                        }
                    });
                    
                    mediapipeLoaded = true;
                    console.log('MediaPipe ì´ˆê¸°í™” ì„±ê³µ');
                    break;
                } catch (error) {
                    console.warn(`MediaPipe ì´ˆê¸°í™” ì‹œë„ ${retryCount + 1} ì‹¤íŒ¨:`, error);
                    faceDetection = null;
                }
            }
            
            retryCount++;
            updateLoadingProgress(30 + (retryCount * 15), `MediaPipe ì´ˆê¸°í™” ì¤‘... (${retryCount}/${maxRetries})`);
        }
        
        if (!mediapipeLoaded) {
            console.warn('MediaPipe ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ëª¨ë“œë¡œ ë™ì‘');
            updateLoadingProgress(80, 'MediaPipe ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ëª¨ë“œë¡œ ë™ì‘');
            return false;
        }
        
        updateLoadingProgress(90, 'MediaPipe ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
        
    } catch (error) {
        console.error('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        faceDetection = null;
        updateLoadingProgress(80, 'MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨ - ê¸°ë³¸ ëª¨ë“œë¡œ ë™ì‘');
        return false;
    }
}

// ì•± ì´ˆê¸°í™”
function initializeApp() {
    console.log('ğŸ¨ Personal Color Pro ì•± ì´ˆê¸°í™”...');
    
    try {
        updateLoadingProgress(95, 'ì•± ì´ˆê¸°í™” ì™„ë£Œ');
        
        currentDrapingSeason = 'spring';
        
        updateLoadingProgress(100, 'ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!');
        
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const mainApp = document.getElementById('main-app');
            
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.classList.add('loaded');
            }
            
            console.log('âœ… ì•± í™”ë©´ í™œì„±í™” ì™„ë£Œ');
            
        }, 800);
        
    } catch (error) {
        console.error('âŒ ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const mainApp = document.getElementById('main-app');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.classList.add('loaded');
            }
            
            showToast('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì¼ë¶€ ë¬¸ì œê°€ ìˆì—ˆì§€ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤', 'warning');
        }, 1000);
    }
}

// ==========================================
// ìƒ‰ìƒ ë³€í™˜ ë° ë¶„ì„ í•¨ìˆ˜ë“¤ (120ìƒ‰ ì‹œìŠ¤í…œ)
// ==========================================

// RGB â†’ LAB ë³€í™˜ í•¨ìˆ˜
function rgbToLab(r, g, b) {
    let rNorm = r / 255;
    let gNorm = g / 255;
    let bNorm = b / 255;
    
    rNorm = rNorm > 0.04045 ? Math.pow((rNorm + 0.055) / 1.055, 2.4) : rNorm / 12.92;
    gNorm = gNorm > 0.04045 ? Math.pow((gNorm + 0.055) / 1.055, 2.4) : gNorm / 12.92;
    bNorm = bNorm > 0.04045 ? Math.pow((bNorm + 0.055) / 1.055, 2.4) : bNorm / 12.92;
    
    let x = rNorm * 0.4124564 + gNorm * 0.3575761 + bNorm * 0.1804375;
    let y = rNorm * 0.2126729 + gNorm * 0.7151522 + bNorm * 0.0721750;
    let z = rNorm * 0.0193339 + gNorm * 0.1191920 + bNorm * 0.9503041;
    
    x = x / 0.95047;
    y = y / 1.00000;
    z = z / 1.08883;
    
    x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
    y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
    z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);
    
    const L = (116 * y) - 16;
    const A = 500 * (x - y);
    const B = 200 * (y - z);
    
    return { L, A, B };
}

// Delta E 2000 ê³„ì‚°
function calculateDeltaE2000(lab1, lab2) {
    const { L: L1, A: A1, B: B1 } = lab1;
    const { L: L2, A: A2, B: B2 } = lab2;
    
    const deltaL = L2 - L1;
    const avgL = (L1 + L2) / 2;
    
    const C1 = Math.sqrt(A1 * A1 + B1 * B1);
    const C2 = Math.sqrt(A2 * A2 + B2 * B2);
    const avgC = (C1 + C2) / 2;
    
    const deltaE = Math.sqrt(
        Math.pow(deltaL, 2) + 
        Math.pow(C2 - C1, 2) + 
        Math.pow(A2 - A1, 2) + 
        Math.pow(B2 - B1, 2)
    );
    
    return Math.min(deltaE, 100);
}

// ì–¼êµ´ ëª¨ì–‘ ê¸°ë°˜ í”¼ë¶€í†¤ ì¶”ì¶œ
function extractSkinColorFromFace(imageData, faceBox) {
    const { xCenter, yCenter, width, height } = faceBox;
    
    const samplePoints = [
        { x: xCenter - width * 0.1, y: yCenter - height * 0.2, name: 'ì¢Œìƒ ì´ë§ˆ' },
        { x: xCenter, y: yCenter - height * 0.25, name: 'ì¤‘ì•™ ì´ë§ˆ' },
        { x: xCenter + width * 0.1, y: yCenter - height * 0.2, name: 'ìš°ìƒ ì´ë§ˆ' },
        { x: xCenter - width * 0.2, y: yCenter - height * 0.05, name: 'ì¢Œì¸¡ ëº¨ ìƒë‹¨' },
        { x: xCenter + width * 0.2, y: yCenter - height * 0.05, name: 'ìš°ì¸¡ ëº¨ ìƒë‹¨' },
        { x: xCenter - width * 0.18, y: yCenter + height * 0.1, name: 'ì¢Œì¸¡ ëº¨ í•˜ë‹¨' },
        { x: xCenter + width * 0.18, y: yCenter + height * 0.1, name: 'ìš°ì¸¡ ëº¨ í•˜ë‹¨' },
        { x: xCenter - width * 0.08, y: yCenter + height * 0.2, name: 'ì¢Œì¸¡ í„±' },
        { x: xCenter + width * 0.08, y: yCenter + height * 0.2, name: 'ìš°ì¸¡ í„±' }
    ];
    
    let totalR = 0, totalG = 0, totalB = 0, validPixels = 0;
    const regionColors = [];
    
    samplePoints.forEach(point => {
        const sampleRadius = Math.min(width, height) * 0.025;
        let regionR = 0, regionG = 0, regionB = 0, regionPixels = 0;
        
        for (let dy = -sampleRadius; dy <= sampleRadius; dy += 1) {
            for (let dx = -sampleRadius; dx <= sampleRadius; dx += 1) {
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance > sampleRadius) continue;
                
                const x = Math.floor(point.x + dx);
                const y = Math.floor(point.y + dy);
                
                if (x >= 0 && x < imageData.width && y >= 0 && y < imageData.height) {
                    const index = (y * imageData.width + x) * 4;
                    const r = imageData.data[index];
                    const g = imageData.data[index + 1];
                    const b = imageData.data[index + 2];
                    
                    if (r > 70 && g > 50 && b > 30 && r < 235 && g < 210 && b < 190) {
                        if (r >= g && g >= b && (r - b) > 15) {
                            regionR += r;
                            regionG += g;
                            regionB += b;
                            regionPixels++;
                        }
                    }
                }
            }
        }
        
        if (regionPixels > 0) {
            const avgR = Math.round(regionR / regionPixels);
            const avgG = Math.round(regionG / regionPixels);
            const avgB = Math.round(regionB / regionPixels);
            
            regionColors.push({
                name: point.name,
                r: avgR, g: avgG, b: avgB,
                pixels: regionPixels
            });
            
            totalR += avgR;
            totalG += avgG;
            totalB += avgB;
            validPixels++;
        }
    });
    
    if (validPixels === 0) {
        return { r: 150, g: 120, b: 100 };
    }
    
    let weightedR = 0, weightedG = 0, weightedB = 0, totalWeight = 0;
    
    regionColors.forEach(region => {
        const weight = Math.sqrt(region.pixels);
        weightedR += region.r * weight;
        weightedG += region.g * weight;
        weightedB += region.b * weight;
        totalWeight += weight;
    });
    
    const finalColor = {
        r: Math.round(weightedR / totalWeight),
        g: Math.round(weightedG / totalWeight),
        b: Math.round(weightedB / totalWeight)
    };
    
    return finalColor;
}

// í¼ìŠ¤ë„ì»¬ëŸ¬ íŒì • (ë…¼ë¬¸ ê¸°ë°˜ ê°œì„  - 1ë‹¨ê³„)
function analyzePersonalColor(skinRgb) {
    const skinLab = rgbToLab(skinRgb.r, skinRgb.g, skinRgb.b);
    
    // ë…¼ë¬¸ ê¸°ë°˜ í•µì‹¬ 8ê°œ ìƒ‰ìƒ (ì‹¤ì œ CMYK ì¸¡ì •ê°’ì—ì„œ ë³€í™˜)
    const paperBasedReferences = [
        // ì ë¹›: C 58.04, M 87.06, Y 77.5, K 33.72 â†’ ê°€ì„
        { L: 31.5, A: 24.8, B: 8.2, sub: "íŠ¸ë£¨ ì˜¤í…€ - ëŸ¬ìŠ¤íŠ¸", season: "autumn", confidence: 95 },
        
        // ì£¼í™©: C 51.11, M 80.65, Y 86.93, K 20.14 â†’ ê°€ì„  
        { L: 45.2, A: 28.6, B: 35.4, sub: "íŠ¸ë£¨ ì˜¤í…€ - ì˜¤ë Œì§€", season: "autumn", confidence: 95 },
        
        // ê¸ˆë¹›: C 34.77, M 44.32, Y 65.75, K 0 â†’ ë´„
        { L: 68.8, A: 12.4, B: 42.8, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ê³¨ë“ ", season: "spring", confidence: 95 },
        
        // ë§¤íŠ¸: C 61.05, M 58.04, Y 77.52, K 3.99 â†’ ê°€ì„
        { L: 52.6, A: 18.2, B: 25.6, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ì˜¬ë¦¬ë¸Œ", season: "autumn", confidence: 95 },
        
        // ì¿ë¹›: C 58.95, M 54.77, Y 45.75, K 1.31 â†’ ì—¬ë¦„
        { L: 58.4, A: 8.6, B: 2.4, sub: "íŠ¸ë£¨ ì„œë¨¸ - ì• ì‰¬", season: "summer", confidence: 95 },
        
        // ë³´ë¼: C 59.87, M 77.78, Y 46.14, K 3.27 â†’ ê²¨ìš¸
        { L: 48.2, A: 22.4, B: -8.6, sub: "íŠ¸ë£¨ ìœˆí„° - ë°”ì´ì˜¬ë ›", season: "winter", confidence: 95 },
        
        // ê°ˆìƒ‰: C 72.8, M 84.57, Y 79.47, K 62.49 â†’ ê²¨ìš¸
        { L: 24.8, A: 12.6, B: 8.4, sub: "ë”¥ ìœˆí„° - ë‹¤í¬ë¸Œë¼ìš´", season: "winter", confidence: 95 },
        
        // ë¼ì´íŠ¸: C 21.89, M 34.16, Y 48.28, K 0 â†’ ì—¬ë¦„
        { L: 78.6, A: 6.4, B: 18.2, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë² ì´ì§€", season: "summer", confidence: 95 }
    ];
    
    // ê¸°ì¡´ 120ê°œ ì¤‘ ë‚˜ë¨¸ì§€ 112ê°œ (ì„ì‹œ ìœ ì§€)
    const seasonReferences = {
        spring: [
            // ë¼ì´íŠ¸ ìŠ¤í”„ë§ (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 76, A: 10, B: 22, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - í”¼ì¹˜" },
            { L: 80, A: 6, B: 20, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ì•„ì´ë³´ë¦¬" },
            { L: 75, A: 12, B: 25, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ì• í”„ë¦¬ì½”íŠ¸" },
            { L: 77, A: 9, B: 19, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - í¬ë¦¼" },
            { L: 79, A: 7, B: 21, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ë²„í„°" },
            { L: 74, A: 11, B: 24, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ê³¨ë“œ" },
            { L: 76, A: 8, B: 23, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - í—ˆë‹ˆ" },
            { L: 78, A: 10, B: 20, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ë°”ë‹ë¼" },
            { L: 77, A: 9, B: 22, sub: "ë¼ì´íŠ¸ ìŠ¤í”„ë§ - ìƒ´í˜ì¸" },
            
            // íŠ¸ë£¨ ìŠ¤í”„ë§ (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 68, A: 17, B: 30, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ì˜¤ë Œì§€" },
            { L: 72, A: 13, B: 26, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ì•°ë²„" },
            { L: 69, A: 16, B: 29, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ì¹´ë¼ë©œ" },
            { L: 71, A: 14, B: 27, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ë¸Œë¡ ì¦ˆ" },
            { L: 67, A: 18, B: 31, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - í„°ì¿¼ì´ì¦ˆ" },
            { L: 73, A: 12, B: 25, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ë¼ì„" },
            { L: 70, A: 15, B: 28, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - í‚¤ìœ„" },
            { L: 68, A: 16, B: 30, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - ë§ê³ " },
            { L: 71, A: 14, B: 27, sub: "íŠ¸ë£¨ ìŠ¤í”„ë§ - íŒŒíŒŒì•¼" },
            
            // ì›œ ìŠ¤í”„ë§ (10ê°œ)
            { L: 62, A: 20, B: 35, sub: "ì›œ ìŠ¤í”„ë§ - ëŸ¬ìŠ¤íŠ¸" },
            { L: 65, A: 18, B: 33, sub: "ì›œ ìŠ¤í”„ë§ - í…Œë¼ì½”íƒ€" },
            { L: 60, A: 22, B: 37, sub: "ì›œ ìŠ¤í”„ë§ - ë¸Œë¦­" },
            { L: 64, A: 19, B: 34, sub: "ì›œ ìŠ¤í”„ë§ - ì‹œë‚˜ëª¬" },
            { L: 63, A: 20, B: 36, sub: "ì›œ ìŠ¤í”„ë§ - ì§„ì €" },
            { L: 61, A: 21, B: 38, sub: "ì›œ ìŠ¤í”„ë§ - ìŠ¤íŒŒì´ìŠ¤" },
            { L: 66, A: 17, B: 32, sub: "ì›œ ìŠ¤í”„ë§ - í¼í‚¨" },
            { L: 62, A: 20, B: 35, sub: "ì›œ ìŠ¤í”„ë§ - ë¨¸ìŠ¤íƒ€ë“œ" },
            { L: 64, A: 18, B: 34, sub: "ì›œ ìŠ¤í”„ë§ - ì»¤ë¦¬" },
            { L: 63, A: 19, B: 36, sub: "ì›œ ìŠ¤í”„ë§ - ì‚¬í”„ë¡ " }
        ],
        
        summer: [
            // ë¼ì´íŠ¸ ì„œë¨¸ (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 75, A: 3, B: -8, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë¼ë²¤ë”" },
            { L: 77, A: 2, B: -6, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë¡œì¦ˆ" },
            { L: 73, A: 4, B: -10, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë¼ì¼ë½" },
            { L: 76, A: 3, B: -7, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - í¼í”Œ" },
            { L: 74, A: 2, B: -9, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë¯¸ìŠ¤íŠ¸" },
            { L: 75, A: 3, B: -8, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ë”ìŠ¤íŠ¸" },
            { L: 72, A: 4, B: -11, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ì‹¤ë²„" },
            { L: 76, A: 2, B: -7, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - í„" },
            { L: 74, A: 3, B: -9, sub: "ë¼ì´íŠ¸ ì„œë¨¸ - ì†Œí”„íŠ¸" },
            
            // íŠ¸ë£¨ ì„œë¨¸ (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨) 
            { L: 68, A: 6, B: -12, sub: "íŠ¸ë£¨ ì„œë¨¸ - ì¿¨ í•‘í¬" },
            { L: 66, A: 8, B: -14, sub: "íŠ¸ë£¨ ì„œë¨¸ - ë¨¸ë¸Œ" },
            { L: 70, A: 5, B: -10, sub: "íŠ¸ë£¨ ì„œë¨¸ - ë² ë¦¬" },
            { L: 67, A: 7, B: -13, sub: "íŠ¸ë£¨ ì„œë¨¸ - í”ŒëŸ¼" },
            { L: 69, A: 6, B: -11, sub: "íŠ¸ë£¨ ì„œë¨¸ - ê·¸ë ˆì´í”„" },
            { L: 65, A: 8, B: -15, sub: "íŠ¸ë£¨ ì„œë¨¸ - ì™€ì¸" },
            { L: 71, A: 4, B: -9, sub: "íŠ¸ë£¨ ì„œë¨¸ - í‹¸" },
            { L: 68, A: 6, B: -12, sub: "íŠ¸ë£¨ ì„œë¨¸ - ì„¸ì´ì§€" },
            { L: 66, A: 7, B: -14, sub: "íŠ¸ë£¨ ì„œë¨¸ - ë¯¼íŠ¸" },
            
            // ì†Œí”„íŠ¸ ì„œë¨¸ (10ê°œ)
            { L: 60, A: 10, B: -18, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ë”ìŠ¤í‚¤" },
            { L: 62, A: 9, B: -16, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ë¨¸ë””" },
            { L: 58, A: 11, B: -20, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ìŠ¤ëª¨í‚¤" },
            { L: 61, A: 10, B: -17, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ê·¸ë ˆì´ì‹œ" },
            { L: 59, A: 12, B: -19, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ë‰´íŠ¸ëŸ´" },
            { L: 63, A: 8, B: -15, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ëª¨ë¸Œ" },
            { L: 60, A: 10, B: -18, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - í†¤ë“œ" },
            { L: 58, A: 11, B: -21, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ë®¤í‹°ë“œ" },
            { L: 62, A: 9, B: -16, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ì„œë¸Œí‹€" },
            { L: 59, A: 10, B: -19, sub: "ì†Œí”„íŠ¸ ì„œë¨¸ - ì  í‹€" }
        ],
        
        autumn: [
            // ì†Œí”„íŠ¸ ì˜¤í…€ (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 60, A: 13, B: 27, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ì¹´í‚¤" },
            { L: 56, A: 16, B: 23, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ëª¨ìŠ¤" },
            { L: 59, A: 14, B: 26, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ì„¸ì´ì§€" },
            { L: 57, A: 15, B: 24, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - í¬ë ˆìŠ¤íŠ¸" },
            { L: 61, A: 12, B: 28, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ë¨¸ë“œ" },
            { L: 58, A: 15, B: 25, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ì–´ìŠ¤" },
            { L: 56, A: 17, B: 22, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - í´ë ˆì´" },
            { L: 60, A: 13, B: 27, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ìƒŒë“œ" },
            { L: 57, A: 16, B: 24, sub: "ì†Œí”„íŠ¸ ì˜¤í…€ - ìŠ¤í†¤" },
            
            // íŠ¸ë£¨ ì˜¤í…€ (8ê°œ - 2ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 50, A: 22, B: 35, sub: "íŠ¸ë£¨ ì˜¤í…€ - ì²´ìŠ¤ë„›" },
            { L: 54, A: 18, B: 30, sub: "íŠ¸ë£¨ ì˜¤í…€ - ë¸Œëœë””" },
            { L: 51, A: 21, B: 34, sub: "íŠ¸ë£¨ ì˜¤í…€ - ì½”ëƒ‘" },
            { L: 53, A: 19, B: 31, sub: "íŠ¸ë£¨ ì˜¤í…€ - ìœ„ìŠ¤í‚¤" },
            { L: 49, A: 23, B: 36, sub: "íŠ¸ë£¨ ì˜¤í…€ - ëŸ¼" },
            { L: 55, A: 17, B: 29, sub: "íŠ¸ë£¨ ì˜¤í…€ - ë²„ë²ˆ" },
            { L: 52, A: 20, B: 33, sub: "íŠ¸ë£¨ ì˜¤í…€ - í¬íŠ¸" },
            { L: 54, A: 18, B: 30, sub: "íŠ¸ë£¨ ì˜¤í…€ - ì…°ë¦¬" },
            
            // ë”¥ ì˜¤í…€ (10ê°œ)
            { L: 45, A: 25, B: 40, sub: "ë”¥ ì˜¤í…€ - ë§ˆí˜¸ê°€ë‹ˆ" },
            { L: 43, A: 27, B: 42, sub: "ë”¥ ì˜¤í…€ - ì—ìŠ¤í”„ë ˆì†Œ" },
            { L: 47, A: 23, B: 38, sub: "ë”¥ ì˜¤í…€ - ì´ˆì½œë¦¿" },
            { L: 44, A: 26, B: 41, sub: "ë”¥ ì˜¤í…€ - ì½”ì½”ì•„" },
            { L: 46, A: 24, B: 39, sub: "ë”¥ ì˜¤í…€ - ì¹´í‘¸ì¹˜ë…¸" },
            { L: 42, A: 28, B: 43, sub: "ë”¥ ì˜¤í…€ - ëª¨ì¹´" },
            { L: 48, A: 22, B: 37, sub: "ë”¥ ì˜¤í…€ - ë¼ë–¼" },
            { L: 45, A: 25, B: 40, sub: "ë”¥ ì˜¤í…€ - ì•„ë©”ë¦¬ì¹´ë…¸" },
            { L: 43, A: 27, B: 42, sub: "ë”¥ ì˜¤í…€ - ë“œë¦½" },
            { L: 47, A: 23, B: 38, sub: "ë”¥ ì˜¤í…€ - ë¡œìŠ¤íŠ¸" }
        ],
        
        winter: [
            // ë¼ì´íŠ¸ ìœˆí„° (10ê°œ)
            { L: 50, A: -2, B: -12, sub: "ë¼ì´íŠ¸ ìœˆí„° - ì•„ì´ì‹œ" },
            { L: 52, A: -1, B: -10, sub: "ë¼ì´íŠ¸ ìœˆí„° - í”„ë¡œìŠ¤í‹°" },
            { L: 48, A: -3, B: -14, sub: "ë¼ì´íŠ¸ ìœˆí„° - ê¸€ë ˆì´ì…œ" },
            { L: 51, A: -2, B: -11, sub: "ë¼ì´íŠ¸ ìœˆí„° - í¬ë¦¬ìŠ¤íƒˆ" },
            { L: 49, A: -4, B: -13, sub: "ë¼ì´íŠ¸ ìœˆí„° - ë‹¤ì´ì•„ëª¬ë“œ" },
            { L: 53, A: 0, B: -9, sub: "ë¼ì´íŠ¸ ìœˆí„° - í”Œë˜í‹°ë„˜" },
            { L: 50, A: -2, B: -12, sub: "ë¼ì´íŠ¸ ìœˆí„° - ìŠ¤ë…¸ìš°" },
            { L: 48, A: -3, B: -15, sub: "ë¼ì´íŠ¸ ìœˆí„° - ë¸”ë¦¬ìë“œ" },
            { L: 52, A: -1, B: -10, sub: "ë¼ì´íŠ¸ ìœˆí„° - ìœˆë“œ" },
            { L: 49, A: -3, B: -13, sub: "ë¼ì´íŠ¸ ìœˆí„° - ë¯¸ìŠ¤íŠ¸" },
            
            // íŠ¸ë£¨ ìœˆí„° (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 45, A: 2, B: -18, sub: "íŠ¸ë£¨ ìœˆí„° - ë¡œì–„" },
            { L: 43, A: 4, B: -20, sub: "íŠ¸ë£¨ ìœˆí„° - ì‚¬íŒŒì´ì–´" },
            { L: 47, A: 0, B: -16, sub: "íŠ¸ë£¨ ìœˆí„° - ì—ë©”ë„ë“œ" },
            { L: 44, A: 3, B: -19, sub: "íŠ¸ë£¨ ìœˆí„° - ë£¨ë¹„" },
            { L: 46, A: 1, B: -17, sub: "íŠ¸ë£¨ ìœˆí„° - ì•„ë©”ì§€ìŠ¤íŠ¸" },
            { L: 42, A: 5, B: -21, sub: "íŠ¸ë£¨ ìœˆí„° - ê°€ë„·" },
            { L: 48, A: -1, B: -15, sub: "íŠ¸ë£¨ ìœˆí„° - í† íŒŒì¦ˆ" },
            { L: 45, A: 2, B: -18, sub: "íŠ¸ë£¨ ìœˆí„° - ì˜¤ë‹‰ìŠ¤" },
            { L: 47, A: 0, B: -16, sub: "íŠ¸ë£¨ ìœˆí„° - ì˜µì‹œë””ì–¸" },
            
            // ë”¥ ìœˆí„° (9ê°œ - 1ê°œëŠ” ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ êµì²´ë¨)
            { L: 40, A: -8, B: -25, sub: "ë”¥ ìœˆí„° - ë¯¸ë“œë‚˜ì‡" },
            { L: 38, A: -10, B: -27, sub: "ë”¥ ìœˆí„° - ì´í´ë¦½ìŠ¤" },
            { L: 42, A: -6, B: -23, sub: "ë”¥ ìœˆí„° - ë…¸ì•„ë¥´" },
            { L: 39, A: -9, B: -26, sub: "ë”¥ ìœˆí„° - ì„€ë„ìš°" },
            { L: 41, A: -7, B: -24, sub: "ë”¥ ìœˆí„° - ë‹¤í¬ë‹ˆìŠ¤" },
            { L: 37, A: -11, B: -28, sub: "ë”¥ ìœˆí„° - ë³´ì´ë“œ" },
            { L: 43, A: -5, B: -22, sub: "ë”¥ ìœˆí„° - ì°¨ì½œ" },
            { L: 40, A: -8, B: -25, sub: "ë”¥ ìœˆí„° - ê·¸ë¼íŒŒì´íŠ¸" },
            { L: 38, A: -10, B: -27, sub: "ë”¥ ìœˆí„° - ìŠ¬ë ˆì´íŠ¸" }
        ]
    };
    
    let bestMatch = null;
    let lowestDelta = Infinity;
    let bestSubType = "";
    let finalConfidence = 50;
    
    // 1ìˆœìœ„: ë…¼ë¬¸ ê¸°ë°˜ 8ê°œ í•µì‹¬ ìƒ‰ìƒê³¼ ë¹„êµ (ë†’ì€ ì‹ ë¢°ë„)
    paperBasedReferences.forEach((refLab) => {
        const deltaE = calculateDeltaE2000(skinLab, refLab);
        if (deltaE < lowestDelta) {
            lowestDelta = deltaE;
            bestMatch = refLab.season;
            bestSubType = refLab.sub;
            finalConfidence = Math.max(85, refLab.confidence - deltaE * 2); // ë…¼ë¬¸ ê¸°ë°˜ì€ ë†’ì€ ì‹ ë¢°ë„
        }
    });
    
    // 2ìˆœìœ„: ê¸°ì¡´ 112ê°œì™€ ë¹„êµ (ë‚®ì€ ì‹ ë¢°ë„)
    for (const [season, variants] of Object.entries(seasonReferences)) {
        variants.forEach((refLab) => {
            const deltaE = calculateDeltaE2000(skinLab, refLab);
            if (deltaE < lowestDelta) {
                lowestDelta = deltaE;
                bestMatch = season;
                bestSubType = refLab.sub;
                finalConfidence = Math.max(50, Math.min(85, 100 - deltaE * 2)); // ê¸°ì¡´ ë°©ì‹ì€ ë‚®ì€ ì‹ ë¢°ë„
            }
        });
    }
    
    // RGB ê¸°ë°˜ ì¶”ê°€ ë¶„ì„
    const { r, g, b } = skinRgb;
    const warmCoolScore = (r - b) / Math.max(r + g + b, 1);
    const lightDarkScore = (r + g + b) / (3 * 255);
    
    // ì‹ ë¢°ë„ ìµœì¢… ì¡°ì •
    const rgbVariance = Math.abs(r - g) + Math.abs(g - b) + Math.abs(r - b);
    const varianceBonus = Math.min(5, rgbVariance / 10);
    
    finalConfidence = Math.round(Math.min(98, finalConfidence + varianceBonus));
    
    const expertAnalysis = generateExpertAnalysis(bestMatch, skinLab, skinRgb);
    
    console.log(`1ë‹¨ê³„ ê°œì„ : Delta E ${lowestDelta.toFixed(1)} â†’ ì‹ ë¢°ë„ ${finalConfidence}%`);
    
    return {
        season: bestSubType,
        confidence: finalConfidence,
        lab: {
            L: skinLab.L.toFixed(1),
            A: skinLab.A.toFixed(1), 
            B: skinLab.B.toFixed(1)
        },
        deltaE: lowestDelta.toFixed(1),
        rgb: skinRgb,
        expertAnalysis,
        warmCoolScore: warmCoolScore.toFixed(3),
        lightDarkScore: lightDarkScore.toFixed(2)
    };
}

function getSeasonName(season) {
    const names = {
        spring: 'ë´„ ì›œí†¤',
        summer: 'ì—¬ë¦„ ì¿¨í†¤',
        autumn: 'ê°€ì„ ì›œí†¤',
        winter: 'ê²¨ìš¸ ì¿¨í†¤'
    };
    return names[season] || 'ë¶„ì„ ì¤‘';
}

function getSeasonEnglish(season) {
    if (season.includes('ë¼ì´íŠ¸ ìŠ¤í”„ë§')) return 'Light Spring';
    if (season.includes('íŠ¸ë£¨ ìŠ¤í”„ë§')) return 'True Spring';
    if (season.includes('ì›œ ìŠ¤í”„ë§')) return 'Warm Spring';
    if (season.includes('ë¼ì´íŠ¸ ì„œë¨¸')) return 'Light Summer';
    if (season.includes('íŠ¸ë£¨ ì„œë¨¸')) return 'True Summer';
    if (season.includes('ì†Œí”„íŠ¸ ì„œë¨¸')) return 'Soft Summer';
    if (season.includes('ì†Œí”„íŠ¸ ì˜¤í…€')) return 'Soft Autumn';
    if (season.includes('íŠ¸ë£¨ ì˜¤í…€')) return 'True Autumn';
    if (season.includes('ë”¥ ì˜¤í…€')) return 'Deep Autumn';
    if (season.includes('ë¼ì´íŠ¸ ìœˆí„°')) return 'Light Winter';
    if (season.includes('íŠ¸ë£¨ ìœˆí„°')) return 'True Winter';
    if (season.includes('ë”¥ ìœˆí„°')) return 'Deep Winter';
    return 'Personal Color';
}

function getSeasonColor(season) {
    if (season.includes('ìŠ¤í”„ë§') || season.includes('Spring')) return '#FFB347';
    if (season.includes('ì„œë¨¸') || season.includes('Summer')) return '#B19CD9';
    if (season.includes('ì˜¤í…€') || season.includes('Autumn')) return '#A0522D';
    if (season.includes('ìœˆí„°') || season.includes('Winter')) return '#4B0082';
    
    // ì„¸ë¶€ íƒ€ì…ë³„ ìƒ‰ìƒ
    if (season.includes('í´ë ˆì´')) return '#B87333';
    if (season.includes('ì˜¬ë¦¬ë¸Œ')) return '#808000';
    if (season.includes('ëŸ¬ìŠ¤íŠ¸')) return '#B7410E';
    if (season.includes('ì²´ìŠ¤ë„›')) return '#954535';
    if (season.includes('ì½”ë„')) return '#FF7F7F';
    if (season.includes('í”¼ì¹˜')) return '#FFCBA4';
    if (season.includes('ë¼ë²¤ë”')) return '#E6E6FA';
    if (season.includes('ë¡œì¦ˆ')) return '#FF69B4';
    if (season.includes('ë¯¸ë“œë‚˜ì‡')) return '#191970';
    if (season.includes('ì‚¬íŒŒì´ì–´')) return '#0F52BA';
    
    return '#CD853F'; // ê¸°ë³¸ê°’
}

function generateExpertAnalysis(season, labValues, rgbValues) {
    const analyses = {
        spring: `${ExpertKnowledge.blume.specificTypes.warm} ë°ê³  ì„ ëª…í•œ ìƒ‰ìƒì´ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.`,
        summer: `${ExpertKnowledge.bitnalyun.principle}ì— ë”°ë¼ ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…” í†¤ì„ ì¶”ì²œí•©ë‹ˆë‹¤.`,
        autumn: `${ExpertKnowledge.bitnalyun.skinConditions.yellowish} ê¹Šê³  ë¦¬ì¹˜í•œ ë¸Œë¼ìš´ ê³„ì—´ì´ ì í•©í•©ë‹ˆë‹¤.`,
        winter: `${ExpertKnowledge.blume.specificTypes.cool} ëª…í™•í•œ ëŒ€ë¹„ë¥¼ ìœ„í•´ ì§„í•˜ê³  ì„ ëª…í•œ ìƒ‰ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
    };
    
    return analyses[season] || 'ì „ë¬¸ê°€ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.';
}

// ==========================================
// MediaPipe ì–¼êµ´ ì¸ì‹ í•¨ìˆ˜ë“¤
// ==========================================

let faceDetectionFrames = 0;
let lastToastTime = 0;
let stableDetectionCount = 0;
const REQUIRED_STABLE_FRAMES = 5;
const TOAST_THROTTLE_MS = 3000;

// MediaPipe ê²°ê³¼ ì²˜ë¦¬
function onFaceDetectionResults(results) {
    if (!canvasCtx || !videoElement) return;
    
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    const currentTime = Date.now();
    const hasDetection = results.detections && results.detections.length > 0;
    
    if (hasDetection) {
        const detection = results.detections[0];
        
        if (!detection.boundingBox) {
            stableDetectionCount = 0;
            return;
        }
        
        const bbox = detection.boundingBox;
        
        const x = bbox.xCenter * canvasElement.width - (bbox.width * canvasElement.width) / 2;
        const y = bbox.yCenter * canvasElement.height - (bbox.height * canvasElement.height) / 2;
        const width = bbox.width * canvasElement.width;
        const height = bbox.height * canvasElement.height;
        
        drawFaceContour(x, y, width, height);
        showSkinAnalysisRegions(x, y, width, height);
        
        currentFaceBox = {
            xCenter: bbox.xCenter * canvasElement.width,
            yCenter: bbox.yCenter * canvasElement.height,
            width: bbox.width * canvasElement.width,
            height: bbox.height * canvasElement.height
        };
        
        canvasCtx.font = 'bold 16px Arial';
        canvasCtx.fillStyle = '#00FF88';
        canvasCtx.strokeStyle = '#000';
        canvasCtx.lineWidth = 1;
        
        const text = 'FACE TRACKING';
        const textX = x + width/2 - 60;
        const textY = y - 15;
        
        canvasCtx.strokeText(text, textX, textY);
        canvasCtx.fillText(text, textX, textY);
        
        if (detection.score && detection.score[0]) {
            const confidence = Math.round(detection.score[0] * 100);
            const confText = `${confidence}%`;
            canvasCtx.font = '14px Arial';
            canvasCtx.fillText(confText, x + width - 40, y + height + 20);
        }
        
        stableDetectionCount++;
        
        if (!faceDetected && currentStep === 1 && stableDetectionCount >= REQUIRED_STABLE_FRAMES) {
            faceDetected = true;
            goToStep(2);
            if (currentTime - lastToastTime > TOAST_THROTTLE_MS) {
                showToast('ì–¼êµ´ ì¶”ì ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                lastToastTime = currentTime;
            }
        }
        
    } else {
        stableDetectionCount = Math.max(0, stableDetectionCount - 2);
        currentFaceBox = null;
        clearSkinRegions();
        
        if (faceDetected && currentStep === 2 && stableDetectionCount === 0) {
            if (currentTime - lastToastTime > TOAST_THROTTLE_MS) {
                showToast('ì–¼êµ´ì„ ë‹¤ì‹œ ì¹´ë©”ë¼ì— ë§ì¶°ì£¼ì„¸ìš”', 'warning');
                lastToastTime = currentTime;
            }
        }
    }
    
    faceDetectionFrames++;
}

// ì–¼êµ´ ìœ¤ê³½ì„  ê·¸ë¦¬ê¸°
function drawFaceContour(x, y, width, height) {
    if (!canvasCtx) return;
    
    canvasCtx.strokeStyle = '#00FF88';
    canvasCtx.lineWidth = 3;
    canvasCtx.setLineDash([]);
    
    canvasCtx.beginPath();
    canvasCtx.ellipse(
        x + width / 2,
        y + height / 2,
        width / 2,
        height / 2,
        0,
        0,
        2 * Math.PI
    );
    canvasCtx.stroke();
    
    const cornerSize = 20;
    canvasCtx.lineWidth = 4;
    
    // ëª¨ì„œë¦¬ ê°•ì¡°ì„ ë“¤
    canvasCtx.beginPath();
    canvasCtx.moveTo(x, y + cornerSize);
    canvasCtx.lineTo(x, y);
    canvasCtx.lineTo(x + cornerSize, y);
    canvasCtx.stroke();
    
    canvasCtx.beginPath();
    canvasCtx.moveTo(x + width - cornerSize, y);
    canvasCtx.lineTo(x + width, y);
    canvasCtx.lineTo(x + width, y + cornerSize);
    canvasCtx.stroke();
    
    canvasCtx.beginPath();
    canvasCtx.moveTo(x, y + height - cornerSize);
    canvasCtx.lineTo(x, y + height);
    canvasCtx.lineTo(x + cornerSize, y + height);
    canvasCtx.stroke();
    
    canvasCtx.beginPath();
    canvasCtx.moveTo(x + width - cornerSize, y + height);
    canvasCtx.lineTo(x + width, y + height);
    canvasCtx.lineTo(x + width, y + height - cornerSize);
    canvasCtx.stroke();
    
    // ì¤‘ì•™ ìŠ¤ìº” ë¼ì¸
    canvasCtx.strokeStyle = '#00FF88';
    canvasCtx.lineWidth = 2;
    canvasCtx.setLineDash([5, 5]);
    canvasCtx.globalAlpha = 0.7;
    
    const scanY = y + height/2 + Math.sin(Date.now() * 0.005) * 15;
    canvasCtx.beginPath();
    canvasCtx.moveTo(x + 30, scanY);
    canvasCtx.lineTo(x + width - 30, scanY);
    canvasCtx.stroke();
    
    canvasCtx.globalAlpha = 1.0;
    canvasCtx.setLineDash([]);
}

// í”¼ë¶€í†¤ ë¶„ì„ ì˜ì—­ í‘œì‹œ
function showSkinAnalysisRegions(faceX, faceY, faceWidth, faceHeight) {
    const regionsDiv = document.getElementById('skin-regions');
    if (!regionsDiv) return;
    
    clearSkinRegions();
    
    const regions = [
        { x: faceX + faceWidth * 0.5, y: faceY + faceHeight * 0.2, name: 'ì´ë§ˆ' },
        { x: faceX + faceWidth * 0.25, y: faceY + faceHeight * 0.5, name: 'ì¢Œì¸¡ ëº¨' },
        { x: faceX + faceWidth * 0.75, y: faceY + faceHeight * 0.5, name: 'ìš°ì¸¡ ëº¨' },
        { x: faceX + faceWidth * 0.5, y: faceY + faceHeight * 0.75, name: 'í„±' }
    ];
    
    regions.forEach((region, index) => {
        const regionElement = document.createElement('div');
        regionElement.className = 'skin-region';
        regionElement.style.left = (region.x - 15) + 'px';
        regionElement.style.top = (region.y - 15) + 'px';
        regionElement.style.width = '30px';
        regionElement.style.height = '30px';
        regionElement.style.animationDelay = (index * 0.2) + 's';
        regionElement.title = region.name + ' í”¼ë¶€í†¤ ë¶„ì„';
        
        regionsDiv.appendChild(regionElement);
        skinRegions.push(regionElement);
    });
}

// í”¼ë¶€í†¤ ë¶„ì„ ì˜ì—­ ì œê±°
function clearSkinRegions() {
    const regionsDiv = document.getElementById('skin-regions');
    if (regionsDiv) {
        regionsDiv.innerHTML = '';
    }
    skinRegions = [];
}

// ==========================================
// ë‹¨ê³„ë³„ ë¶„ì„ ì§„í–‰ í•¨ìˆ˜ë“¤
// ==========================================

// ë¶„ì„ ë‹¨ê³„ ì „í™˜
function goToStep(step) {
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
            stepElement.style.display = 'none';
            stepElement.classList.remove('active');
        }
    }
    
    const targetStep = document.getElementById(`step-${step}`);
    if (targetStep) {
        targetStep.style.display = 'block';
        targetStep.classList.add('active');
        currentStep = step;
    }
}

// ì–¼êµ´í†¤ ë¶„ì„ ì‹œì‘
function startToneAnalysis() {
    goToStep(3);
    
    const progressDiv = document.getElementById('analysis-progress');
    let step = 0;
    const steps = [
        'ì–¼êµ´ í˜•íƒœ ê¸°ë°˜ í”¼ë¶€ìƒ‰ ì˜ì—­ ê°ì§€ ì¤‘...',
        'RGB ìƒ‰ìƒ ë°ì´í„° ì¶”ì¶œ ì¤‘...',
        'RGB â†’ LAB ìƒ‰ê³µê°„ ë³€í™˜ ì¤‘...',
        'Delta E 2000 ì •ë°€ ê³„ì‚° ì¤‘...',
        '120ê°€ì§€ ì„¸ë¶€ íƒ€ì… ë§¤ì¹­ ì¤‘...',
        'ì „ë¬¸ê°€ ë…¸í•˜ìš° ì ìš© ì¤‘...',
        'ìµœì¢… ê²°ê³¼ ìƒì„± ì¤‘...'
    ];
    
    const updateProgress = () => {
        if (step < steps.length) {
            progressDiv.innerHTML = `
                <div style="margin-bottom: 0.5rem;">${steps[step]}</div>
                <div style="background: #E91E63; height: 4px; width: ${(step + 1) * 14.28}%; border-radius: 2px; transition: width 0.3s;"></div>
            `;
            step++;
            setTimeout(updateProgress, 700);
        } else {
            if (currentFaceBox && faceDetection) {
                performRealAnalysis();
            } else {
                performDemoAnalysis();
            }
        }
    };
    
    updateProgress();
}

// ë°ëª¨ ë¶„ì„
function performDemoAnalysis() {
    const demoSkinColor = { r: 156, g: 125, b: 103 };
    const analysis = analyzePersonalColor(demoSkinColor);
    showFinalResults(analysis);
    showToast('ë°ëª¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ë¶„ì„ì€ ì¹´ë©”ë¼ ê¶Œí•œ í—ˆìš© í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
}

// ì‹¤ì œ ë¶„ì„ ìˆ˜í–‰
async function performRealAnalysis() {
    try {
        if (!currentFaceBox) {
            throw new Error('ì–¼êµ´ ê°ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = videoElement.videoWidth;
        tempCanvas.height = videoElement.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(videoElement, 0, 0);
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        
        const skinColor = extractSkinColorFromFace(imageData, currentFaceBox);
        const analysis = analyzePersonalColor(skinColor);
        
        showFinalResults(analysis);
        
    } catch (error) {
        console.error('ë¶„ì„ ì‹¤íŒ¨:', error);
        showToast('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°ëª¨ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.', 'warning');
        performDemoAnalysis();
    }
}

// ìµœì¢… ê²°ê³¼ í‘œì‹œ
function showFinalResults(analysis) {
    goToStep(4);
    
    const seasonElement = document.getElementById('result-season');
    const confidenceElement = document.getElementById('confidence-score');
    
    if (seasonElement) seasonElement.textContent = analysis.season;
    if (confidenceElement) confidenceElement.textContent = analysis.confidence + '%';
    
    const productRecommendations = getProductRecommendations(analysis.season);
    
    const detailsDiv = document.getElementById('analysis-details');
    if (detailsDiv) {
        detailsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px;">
                    <strong>ì¶”ì¶œëœ í”¼ë¶€ìƒ‰</strong><br>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <div style="width: 30px; height: 30px; background: rgb(${analysis.rgb.r}, ${analysis.rgb.g}, ${analysis.rgb.b}); border: 1px solid #ccc; border-radius: 4px;"></div>
                        RGB(${analysis.rgb.r}, ${analysis.rgb.g}, ${analysis.rgb.b})
                    </div>
                </div>
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px;">
                    <strong>í¼ìŠ¤ë„ì»¬ëŸ¬</strong><br>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <div style="width: 30px; height: 30px; background: ${getSeasonColor(analysis.season)}; border: 1px solid #ccc; border-radius: 4px;"></div>
                        <div>
                            <div style="font-weight: 600;">${getSeasonEnglish(analysis.season)}</div>
                            <div style="font-size: 0.8rem; color: #666;">${analysis.season}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <details style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">ìƒì„¸ ë¶„ì„ ë°ì´í„° (ì „ë¬¸ê°€ìš©)</summary>
                <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                    <div><strong>LAB ìƒ‰ê³µê°„:</strong> L: ${analysis.lab.L}, A: ${analysis.lab.A}, B: ${analysis.lab.B}</div>
                    <div><strong>ìƒ‰ì°¨ ì¸¡ì •ê°’:</strong> Delta E 2000: ${analysis.deltaE}</div>
                    <div><strong>ì›œì¿¨ ì§€ìˆ˜:</strong> ${analysis.warmCoolScore}</div>
                    <div><strong>ëª…ë„ ì§€ìˆ˜:</strong> ${analysis.lightDarkScore}</div>
                </div>
            </details>
            
            <div style="background: #E3F2FD; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid #2196F3;">
                <h4 style="color: #1976D2; margin-bottom: 1rem; font-size: 1.2rem;">ì¶”ì²œ í—¤ì–´ì»¬ëŸ¬ ì œí’ˆ</h4>
                ${productRecommendations.map(brand => `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #BBDEFB;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #1976D2; font-size: 1.1rem;">${brand.name}</strong>
                            <span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">ì¶”ì²œ</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem;">
                            ${brand.products.map(product => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #F5F5F5; border-radius: 6px;">
                                    <div style="width: 20px; height: 20px; background: ${product.color}; border-radius: 50%; border: 1px solid #ddd;"></div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 0.9rem;">${product.code}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${product.name}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="background: #FCE4EC; padding: 1rem; border-radius: 8px;">
                <strong>ì „ë¬¸ê°€ ë¶„ì„</strong><br>
                ${analysis.expertAnalysis}
            </div>
        `;
    }
    
    analysisCount++;
    showToast(`í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì™„ë£Œ: ${analysis.season}`, 'success');
}

// ë¸Œëœë“œë³„ ì œí’ˆ ì¶”ì²œ í•¨ìˆ˜
function getProductRecommendations(season) {
    // ê³„ì ˆë³„ ì œí’ˆ ë§¤ì¹­ ë¡œì§
    if (season.includes('ìŠ¤í”„ë§') || season.includes('ë´„')) {
        return [
            {
                name: 'ë¡œë ˆì•Œ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '7.3', name: 'ê³¨ë“  ë¸”ë¡ ë“œ', color: '#D4AF37' },
                    { code: '8.34', name: 'ë¼ì´íŠ¸ ê³¨ë“  ì½”í¼', color: '#CD853F' },
                    { code: '6.35', name: 'ë‹¤í¬ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', color: '#8B4513' }
                ]
            },
            {
                name: 'ì›°ë¼ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '7/3', name: 'ë¯¸ë””ì›€ ê³¨ë“  ë¸”ë¡ ë“œ', color: '#DAA520' },
                    { code: '8/03', name: 'ë¼ì´íŠ¸ ë‚´ì¶”ëŸ´ ê³¨ë“ ', color: '#F0E68C' },
                    { code: '6/73', name: 'ë‹¤í¬ ë¸Œë¼ìš´ ê³¨ë“ ', color: '#A0522D' }
                ]
            },
            {
                name: 'ë°€ë³¸ ì˜¤ë¥´ë””ë¸Œ',
                products: [
                    { code: '7-CG', name: 'ì½”í¼ ê³¨ë“ ', color: '#B87333' },
                    { code: '8-CB', name: 'ì½”í¼ ë² ì´ì§€', color: '#DEB887' },
                    { code: '6-GM', name: 'ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', color: '#CD853F' }
                ]
            }
        ];
    } else if (season.includes('ì„œë¨¸') || season.includes('ì—¬ë¦„')) {
        return [
            {
                name: 'ë¡œë ˆì•Œ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '8.1', name: 'ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', color: '#C0C0C0' },
                    { code: '7.11', name: 'ì¸í…ìŠ¤ ì• ì‰¬ ë¸”ë¡ ë“œ', color: '#A9A9A9' },
                    { code: '9.1', name: 'ë² ë¦¬ ë¼ì´íŠ¸ ì• ì‰¬', color: '#E6E6FA' }
                ]
            },
            {
                name: 'ì›°ë¼ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '8/1', name: 'ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', color: '#D3D3D3' },
                    { code: '7/1', name: 'ë¯¸ë””ì›€ ì• ì‰¬ ë¸”ë¡ ë“œ', color: '#B0C4DE' },
                    { code: '6/1', name: 'ë‹¤í¬ ì• ì‰¬ ë¸”ë¡ ë“œ', color: '#778899' }
                ]
            },
            {
                name: 'ë°€ë³¸ ì˜¤ë¥´ë””ë¸Œ',
                products: [
                    { code: '8-A', name: 'ì• ì‰¬', color: '#C0C0C0' },
                    { code: '7-MT', name: 'ë§ˆíŠ¸ ë² ì´ì§€', color: '#F5F5DC' },
                    { code: '9-P', name: 'í•‘í¬ ë² ì´ì§€', color: '#F0E68C' }
                ]
            }
        ];
    } else if (season.includes('ì˜¤í…€') || season.includes('ê°€ì„')) {
        return [
            {
                name: 'ë¡œë ˆì•Œ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '6.3', name: 'ë‹¤í¬ ê³¨ë“  ë¸”ë¡ ë“œ', color: '#B8860B' },
                    { code: '5.35', name: 'ë¼ì´íŠ¸ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', color: '#8B4513' },
                    { code: '4.35', name: 'ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ ë¸Œë¼ìš´', color: '#A0522D' }
                ]
            },
            {
                name: 'ì›°ë¼ í”„ë¡œí˜ì…”ë„', 
                products: [
                    { code: '6/73', name: 'ë‹¤í¬ ë¸Œë¼ìš´ ê³¨ë“ ', color: '#8B4513' },
                    { code: '5/7', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´ ë¯¸ë””ì›€', color: '#CD853F' },
                    { code: '4/77', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´ ì¸í…ìŠ¤', color: '#8B4513' }
                ]
            },
            {
                name: 'ë°€ë³¸ ì˜¤ë¥´ë””ë¸Œ',
                products: [
                    { code: '6-CB', name: 'ì½”í¼ ë² ì´ì§€', color: '#DEB887' },
                    { code: '5-GM', name: 'ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', color: '#A0522D' },
                    { code: '7-OR', name: 'ì˜¤ë Œì§€', color: '#FF7F50' }
                ]
            }
        ];
    } else { // ìœˆí„°
        return [
            {
                name: 'ë¡œë ˆì•Œ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '1.0', name: 'ë¸”ë™', color: '#000000' },
                    { code: '2.1', name: 'ë¸Œë¼ìš´ ì• ì‰¬', color: '#2F4F4F' },
                    { code: '6.11', name: 'ë‹¤í¬ ì¸í…ìŠ¤ ì• ì‰¬', color: '#696969' }
                ]
            },
            {
                name: 'ì›°ë¼ í”„ë¡œí˜ì…”ë„',
                products: [
                    { code: '2/0', name: 'ë¸”ë™', color: '#000000' },
                    { code: '4/0', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´', color: '#2F4F4F' },
                    { code: '6/0', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ', color: '#696969' }
                ]
            },
            {
                name: 'ë°€ë³¸ ì˜¤ë¥´ë””ë¸Œ',
                products: [
                    { code: '2-N', name: 'ë‚´ì¶”ëŸ´ ë¸”ë™', color: '#000000' },
                    { code: '4-N', name: 'ë‚´ì¶”ëŸ´ ë¸Œë¼ìš´', color: '#2F2F2F' },
                    { code: '6-A', name: 'ì• ì‰¬ ë¸Œë¼ìš´', color: '#708090' }
                ]
            }
        ];
    }
}

// ë¶„ì„ ì´ˆê¸°í™”
function resetAnalysis() {
    currentStep = 1;
    faceDetected = false;
    currentFaceBox = null;
    
    if (videoElement && videoElement.srcObject) {
        const stream = videoElement.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        videoElement.srcObject = null;
    }
    
    if (canvasElement && canvasCtx) {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    }
    
    clearSkinRegions();
    
    const guide = document.getElementById('face-guide');
    if (guide) guide.style.display = 'flex';
    
    goToStep(1);
    showToast('ë¶„ì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// ==========================================
// ë„¤ë¹„ê²Œì´ì…˜ ë° UI í•¨ìˆ˜ë“¤
// ==========================================

function goHome() {
    resetAnalysis();
    resetDraping();
    switchMode('selection');
    showToast('í™ˆ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤', 'info');
}

function resetDraping() {
    selectedColor = null;
    uploadedImage = null;
    beforeImage = null;
    afterImage = null;
    showToast('ë“œë˜ì´í•‘ ëª¨ë“œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

function switchMode(mode) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.remove('active'));
    
    const headerBtns = document.querySelectorAll('.header-btn');
    headerBtns.forEach(btn => btn.classList.remove('active'));
    
    switch (mode) {
        case 'photo':
            document.getElementById('photo-analysis').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'photo\')"]').classList.add('active');
            break;
        case 'draping':
            document.getElementById('draping-mode').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'draping\')"]').classList.add('active');
            break;
        default:
            document.getElementById('mode-selection').classList.add('active');
            break;
    }
    
    currentMode = mode;
}

function selectModeCard(card) {
    const cards = document.querySelectorAll('.mode-card');
    cards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
}

function startPhotoAnalysis() {
    switchMode('photo');
}

function startDraping() {
    switchMode('draping');
}

// ì‹¤ì œ ì–¼êµ´ ì¸ì‹ ì‹œì‘
async function startFaceDetection() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                width: { ideal: 640, max: 1280 },
                height: { ideal: 480, max: 720 },
                facingMode: 'user'
            }
        });
        
        videoElement = document.getElementById('camera-feed');
        videoElement.srcObject = stream;
        
        const guide = document.getElementById('face-guide');
        if (guide) guide.style.display = 'none';
        
        canvasElement = document.getElementById('face-overlay');
        if (!canvasElement) {
            console.error('Face overlay canvas not found');
            return;
        }
        
        canvasCtx = canvasElement.getContext('2d');
        
        await new Promise((resolve) => {
            const handleLoadedMetadata = () => {
                const rect = videoElement.getBoundingClientRect();
                canvasElement.width = rect.width;
                canvasElement.height = rect.height;
                canvasElement.style.width = rect.width + 'px';
                canvasElement.style.height = rect.height + 'px';
                
                videoElement.removeEventListener('loadedmetadata', handleLoadedMetadata);
                resolve();
            };
            
            if (videoElement.readyState >= 1) {
                handleLoadedMetadata();
            } else {
                videoElement.addEventListener('loadedmetadata', handleLoadedMetadata);
            }
        });
        
        if (faceDetection && typeof Camera !== 'undefined') {
            try {
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        try {
                            if (faceDetection && videoElement.readyState === 4) {
                                await faceDetection.send({ image: videoElement });
                            }
                        } catch (error) {
                            console.warn('MediaPipe í”„ë ˆì„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                showToast('MediaPipe ì–¼êµ´ ì¶”ì ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.warn('Camera ì‹œì‘ ì‹¤íŒ¨, ê¸°ë³¸ ëª¨ë“œë¡œ ì „í™˜:', error);
                startBasicMode();
            }
        } else {
            startBasicMode();
        }
        
    } catch (error) {
        console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
        showToast('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ë˜ëŠ” HTTPS í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
    }
}

// ê¸°ë³¸ ëª¨ë“œ ì‹œì‘
function startBasicMode() {
    showToast('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¶„ì„ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.', 'info');
    
    setTimeout(() => {
        stableDetectionCount = REQUIRED_STABLE_FRAMES;
        faceDetected = true;
        goToStep(2);
        showToast('ì–¼êµ´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤ (ê¸°ë³¸ ëª¨ë“œ)', 'success');
    }, 3000);
}

// ==========================================
// ì‹¤ì‹œê°„ ë“œë˜ì´í•‘ ëª¨ë“œ í•¨ìˆ˜ë“¤
// ==========================================

let drapingVideoElement = null;
let drapingCanvasElement = null;
let drapingCanvasCtx = null;
let drapingCamera = null;
let currentDrapingSeason = 'spring';
let currentDrapingColor = null;
let isShowingOriginal = false;
let aiReferenceResult = null;
let favoriteColors = [];

// ë“œë˜ì´í•‘ ì¹´ë©”ë¼ ì‹œì‘
async function startDrapingCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                width: 640,
                height: 480,
                facingMode: 'user'
            }
        });
        
        drapingVideoElement = document.getElementById('draping-camera');
        drapingVideoElement.srcObject = stream;
        
        const guide = document.getElementById('draping-guide');
        if (guide) guide.style.display = 'none';
        
        drapingCanvasElement = document.getElementById('draping-overlay');
        drapingCanvasCtx = drapingCanvasElement.getContext('2d');
        
        drapingVideoElement.addEventListener('loadedmetadata', () => {
            drapingCanvasElement.width = drapingVideoElement.videoWidth || 640;
            drapingCanvasElement.height = drapingVideoElement.videoHeight || 480;
            
            performAIReference();
            setDrapingSeason('spring');
            
            showToast('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        });
        
    } catch (error) {
        console.error('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ ì‹¤íŒ¨:', error);
        showToast('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”', 'error');
    }
}

// AI ì°¸ê³  ë¶„ì„ ìˆ˜í–‰
async function performAIReference() {
    if (!drapingVideoElement) return;
    
    try {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = drapingVideoElement.videoWidth;
        tempCanvas.height = drapingVideoElement.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCtx.drawImage(drapingVideoElement, 0, 0);
        
        const centerX = tempCanvas.width / 2;
        const centerY = tempCanvas.height / 2;
        const sampleSize = 20;
        
        let totalR = 0, totalG = 0, totalB = 0, pixels = 0;
        
        for (let y = centerY - sampleSize; y < centerY + sampleSize; y++) {
            for (let x = centerX - sampleSize; x < centerX + sampleSize; x++) {
                if (x >= 0 && x < tempCanvas.width && y >= 0 && y < tempCanvas.height) {
                    const imageData = tempCtx.getImageData(x, y, 1, 1);
                    const r = imageData.data[0];
                    const g = imageData.data[1];
                    const b = imageData.data[2];
                    
                    if (r > 80 && g > 60 && b > 40 && r < 230 && g < 200 && b < 180) {
                        totalR += r;
                        totalG += g;
                        totalB += b;
                        pixels++;
                    }
                }
            }
        }
        
        if (pixels > 0) {
            const avgSkin = {
                r: Math.round(totalR / pixels),
                g: Math.round(totalG / pixels),
                b: Math.round(totalB / pixels)
            };
            
            aiReferenceResult = analyzePersonalColor(avgSkin);
            
            const refElement = document.getElementById('ai-reference');
            if (refElement) {
                refElement.textContent = aiReferenceResult.season;
            }
        }
    } catch (error) {
        console.warn('AI ì°¸ê³  ë¶„ì„ ì‹¤íŒ¨:', error);
    }
}

// ë“œë˜ì´í•‘ ê³„ì ˆ ì„¤ì •
function setDrapingSeason(season) {
    currentDrapingSeason = season;
    
    document.querySelectorAll('#draping-mode .season-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(`draping-${season}`).classList.add('active');
    
    const baseColors = {
        spring: '#FFB347',
        summer: '#B19CD9',
        autumn: '#CD853F',
        winter: '#4B0082'
    };
    
    currentDrapingColor = baseColors[season];
    updateDrapingColor();
    
    showToast(`${season} ê³„ì ˆ ì„ íƒë¨`, 'info');
}

// ë“œë˜ì´í•‘ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
function updateDrapingColor() {
    if (!currentDrapingColor) return;
    
    const lightnessSlider = document.getElementById('lightness-slider');
    const saturationSlider = document.getElementById('saturation-slider');
    const warmthSlider = document.getElementById('warmth-slider');
    
    if (!lightnessSlider || !saturationSlider || !warmthSlider) {
        return;
    }
    
    const lightness = parseInt(lightnessSlider.value);
    const saturation = parseInt(saturationSlider.value);
    const warmth = parseInt(warmthSlider.value);
    
    // ìˆ«ì ì—…ë°ì´íŠ¸ ê°•ì œ ì‹¤í–‰
    const lightnessValue = document.getElementById('lightness-value');
    const saturationValue = document.getElementById('saturation-value');
    const warmthValue = document.getElementById('warmth-value');
    
    if (lightnessValue) lightnessValue.textContent = lightness;
    if (saturationValue) saturationValue.textContent = saturation;
    if (warmthValue) warmthValue.textContent = warmth;
    
    console.log('ìŠ¬ë¼ì´ë” ê°’ë“¤:', { lightness, saturation, warmth }); // ë””ë²„ê¹…ìš©
    
    const baseRgb = hexToRgb(currentDrapingColor);
    
    let { r, g, b } = adjustColor(baseRgb, lightness, saturation, warmth);
    
    const adjustedColor = `rgb(${r}, ${g}, ${b})`;
    const adjustedHex = rgbToHex(r, g, b);
    
    const colorDisplay = document.getElementById('current-draping-color');
    const colorInfo = document.getElementById('current-color-info');
    
    if (colorDisplay) colorDisplay.style.backgroundColor = adjustedColor;
    if (colorInfo) colorInfo.textContent = adjustedHex;
    
    if (drapingVideoElement && drapingCanvasCtx && !isShowingOriginal) {
        applyColorOverlay(adjustedColor);
    }
}

// ìƒ‰ìƒ ì¡°ì • í•¨ìˆ˜
function adjustColor(rgb, lightness, saturation, warmth) {
    let { r, g, b } = rgb;
    
    // ëª…ë„ ì¡°ì •
    const lightnessFactor = 1 + (lightness / 100);
    r = Math.min(255, Math.max(0, r * lightnessFactor));
    g = Math.min(255, Math.max(0, g * lightnessFactor));
    b = Math.min(255, Math.max(0, b * lightnessFactor));
    
    // ì±„ë„ ì¡°ì •
    const gray = (r + g + b) / 3;
    const saturationFactor = 1 + (saturation / 100);
    r = Math.min(255, Math.max(0, gray + (r - gray) * saturationFactor));
    g = Math.min(255, Math.max(0, gray + (g - gray) * saturationFactor));
    b = Math.min(255, Math.max(0, gray + (b - gray) * saturationFactor));
    
    // ì˜¨ë„ê° ì¡°ì •
    if (warmth > 0) {
        r = Math.min(255, r + warmth * 0.8);
        g = Math.min(255, r + warmth * 0.4);
        b = Math.max(0, b - warmth * 0.6);
    } else if (warmth < 0) {
        r = Math.max(0, r + warmth * 0.6);
        g = Math.max(0, g + warmth * 0.4);
        b = Math.min(255, b - warmth * 0.8);
    }
    
    return {
        r: Math.round(r),
        g: Math.round(g),
        b: Math.round(b)
    };
}

// ì‹¤ì‹œê°„ ìƒ‰ìƒ ì˜¤ë²„ë ˆì´ ì ìš©
function applyColorOverlay(color) {
    if (!drapingCanvasCtx || !drapingVideoElement) return;
    
    drapingCanvasCtx.clearRect(0, 0, drapingCanvasElement.width, drapingCanvasElement.height);
    
    drapingCanvasCtx.globalCompositeOperation = 'multiply';
    drapingCanvasCtx.fillStyle = color;
    drapingCanvasCtx.globalAlpha = 0.4;
    drapingCanvasCtx.fillRect(0, 0, drapingCanvasElement.width, drapingCanvasElement.height * 0.35);
    
    drapingCanvasCtx.globalCompositeOperation = 'source-over';
    drapingCanvasCtx.globalAlpha = 1.0;
}

// Before/After í† ê¸€
function toggleDrapingPreview() {
    if (!drapingCanvasCtx || !drapingCanvasElement) {
        showToast('ë¨¼ì € ë“œë˜ì´í•‘ ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”', 'warning');
        return;
    }
    
    isShowingOriginal = !isShowingOriginal;
    
    if (isShowingOriginal) {
        drapingCanvasCtx.clearRect(0, 0, drapingCanvasElement.width, drapingCanvasElement.height);
    } else {
        updateDrapingColor();
    }
}

// ì¦ê²¨ì°¾ê¸° ìƒ‰ìƒ ì €ì¥
function saveFavoriteColor() {
    if (!currentDrapingColor) {
        showToast('ë¨¼ì € ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”', 'warning');
        return;
    }
    
    const lightness = parseInt(document.getElementById('lightness-slider').value);
    const saturation = parseInt(document.getElementById('saturation-slider').value);
    const warmth = parseInt(document.getElementById('warmth-slider').value);
    
    const baseRgb = hexToRgb(currentDrapingColor);
    const adjustedRgb = adjustColor(baseRgb, lightness, saturation, warmth);
    const finalHex = rgbToHex(adjustedRgb.r, adjustedRgb.g, adjustedRgb.b);
    
    const matchedProducts = findMatchingProducts(adjustedRgb);
    
    const favoriteColor = {
        base: currentDrapingColor,
        season: currentDrapingSeason,
        adjustments: { lightness, saturation, warmth },
        finalColor: finalHex,
        finalRgb: adjustedRgb,
        matchedProducts: matchedProducts,
        timestamp: Date.now()
    };
    
    favoriteColors.push(favoriteColor);
    updateFavoriteColorsList();
    
    showProductRecommendations(matchedProducts, finalHex);
    
    showToast('ìƒ‰ìƒì´ ì €ì¥ë˜ê³  ì œí’ˆì´ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ë¸Œëœë“œ ì œí’ˆê³¼ ìƒ‰ìƒ ë§¤ì¹­
function findMatchingProducts(targetRgb) {
    const allProducts = [
        { brand: 'ë¡œë ˆì•Œ', code: '7.3', name: 'ê³¨ë“  ë¸”ë¡ ë“œ', rgb: { r: 212, g: 175, b: 55 } },
        { brand: 'ë¡œë ˆì•Œ', code: '8.34', name: 'ë¼ì´íŠ¸ ê³¨ë“  ì½”í¼', rgb: { r: 205, g: 133, b: 63 } },
        { brand: 'ë¡œë ˆì•Œ', code: '6.35', name: 'ë‹¤í¬ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', rgb: { r: 139, g: 69, b: 19 } },
        { brand: 'ë¡œë ˆì•Œ', code: '8.1', name: 'ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', rgb: { r: 192, g: 192, b: 192 } },
        { brand: 'ë¡œë ˆì•Œ', code: '7.11', name: 'ì¸í…ìŠ¤ ì• ì‰¬ ë¸”ë¡ ë“œ', rgb: { r: 169, g: 169, b: 169 } },
        { brand: 'ì›°ë¼', code: '7/3', name: 'ë¯¸ë””ì›€ ê³¨ë“  ë¸”ë¡ ë“œ', rgb: { r: 218, g: 165, b: 32 } },
        { brand: 'ì›°ë¼', code: '8/03', name: 'ë¼ì´íŠ¸ ë‚´ì¶”ëŸ´ ê³¨ë“ ', rgb: { r: 240, g: 230, b: 140 } },
        { brand: 'ì›°ë¼', code: '8/1', name: 'ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', rgb: { r: 211, g: 211, b: 211 } },
        { brand: 'ë°€ë³¸', code: '7-CG', name: 'ì½”í¼ ê³¨ë“ ', rgb: { r: 184, g: 115, b: 51 } },
        { brand: 'ë°€ë³¸', code: '8-CB', name: 'ì½”í¼ ë² ì´ì§€', rgb: { r: 222, g: 184, b: 135 } },
        { brand: 'ë°€ë³¸', code: '8-A', name: 'ì• ì‰¬', rgb: { r: 192, g: 192, b: 192 } }
    ];
    
    const productMatches = allProducts.map(product => {
        const deltaE = calculateColorDistance(targetRgb, product.rgb);
        const similarity = Math.max(0, Math.min(100, 100 - deltaE * 2));
        
        return {
            ...product,
            deltaE: deltaE.toFixed(1),
            similarity: Math.round(similarity)
        };
    });
    
    return productMatches
        .sort((a, b) => parseFloat(a.deltaE) - parseFloat(b.deltaE))
        .slice(0, 5);
}

// ìƒ‰ìƒ ê±°ë¦¬ ê³„ì‚°
function calculateColorDistance(rgb1, rgb2) {
    const rDiff = rgb1.r - rgb2.r;
    const gDiff = rgb1.g - rgb2.g;
    const bDiff = rgb1.b - rgb2.b;
    
    return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff) / 4.41;
}

// ì œí’ˆ ì¶”ì²œ í‘œì‹œ
function showProductRecommendations(products, targetColor) {
    const recommendationsHtml = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
                    z-index: 10000; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--primary-pink); margin: 0;">ë§¤ì¹­ëœ í—¤ì–´ì»¬ëŸ¬ ì œí’ˆ</h3>
                <button onclick="closeProductRecommendations()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
            
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="display: inline-block; width: 60px; height: 60px; background: ${targetColor}; 
                           border-radius: 50%; border: 3px solid #ddd; margin-bottom: 0.5rem;"></div>
                <div style="font-weight: 600;">ì„ íƒí•œ ìƒ‰ìƒ: ${targetColor}</div>
            </div>
            
            <div style="display: grid; gap: 1rem;">
                ${products.map((product, index) => `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; 
                               background: ${index === 0 ? '#E8F5E8' : '#f9f9f9'}; border-radius: 8px;
                               border: ${index === 0 ? '2px solid #4CAF50' : '1px solid #ddd'};">
                        <div style="width: 40px; height: 40px; background: rgb(${product.rgb.r}, ${product.rgb.g}, ${product.rgb.b}); 
                                   border-radius: 50%; border: 2px solid #ddd; flex-shrink: 0;"></div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 0.2rem;">
                                ${product.brand} ${product.code} ${index === 0 ? 'â­ ìµœê³  ë§¤ì¹­' : ''}
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">${product.name}</div>
                            <div style="font-size: 0.8rem; color: #888;">
                                ìœ ì‚¬ë„: ${product.similarity}% | ìƒ‰ì°¨: ${product.deltaE}
                            </div>
                        </div>
                        <div style="text-align: center; flex-shrink: 0;">
                            <div style="background: var(--primary-pink); color: white; padding: 0.3rem 0.6rem; 
                                       border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                ${product.similarity}%
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <button onclick="exportProductList('${targetColor}', ${JSON.stringify(products).replace(/"/g, '&quot;')})" 
                        style="background: var(--primary-pink); color: white; border: none; padding: 0.75rem 1.5rem; 
                               border-radius: 8px; cursor: pointer; margin-right: 0.5rem;">
                    ì œí’ˆ ë¦¬ìŠ¤íŠ¸ ì €ì¥
                </button>
                <button onclick="closeProductRecommendations()" 
                        style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; 
                               border-radius: 8px; cursor: pointer;">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
        <div id="recommendation-backdrop" onclick="closeProductRecommendations()" 
             style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 9999;"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', recommendationsHtml);
}

// ì œí’ˆ ì¶”ì²œ ë‹«ê¸°
function closeProductRecommendations() {
    const recommendations = document.querySelector('[style*="position: fixed"][style*="transform: translate(-50%, -50%)"]');
    const backdrop = document.getElementById('recommendation-backdrop');
    
    if (recommendations) recommendations.remove();
    if (backdrop) backdrop.remove();
}

// ì œí’ˆ ë¦¬ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°
function exportProductList(targetColor, products) {
    const productData = typeof products === 'string' ? JSON.parse(products.replace(/&quot;/g, '"')) : products;
    
    const exportContent = `
í¼ìŠ¤ë„ì»¬ëŸ¬ ë“œë˜ì´í•‘ - ë§¤ì¹­ ì œí’ˆ ë¦¬ìŠ¤íŠ¸

ì„ íƒí•œ ìƒ‰ìƒ: ${targetColor}
ë§¤ì¹­ ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}

ì¶”ì²œ ì œí’ˆ (ìœ ì‚¬ë„ ìˆœ):
${productData.map((product, index) => `
${index + 1}. ${product.brand} ${product.code} - ${product.name}
   ìœ ì‚¬ë„: ${product.similarity}% | ìƒ‰ì°¨: ${product.deltaE}
   ${index === 0 ? 'â­ ìµœê³  ë§¤ì¹­ ì œí’ˆ' : ''}
`).join('')}

Personal Color Pro - ì‹¤ì‹œê°„ ë“œë˜ì´í•‘ ì§„ë‹¨ ì‹œìŠ¤í…œ
    `.trim();
    
    const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `product_matching_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('ì œí’ˆ ë¦¬ìŠ¤íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ì¦ê²¨ì°¾ê¸° ìƒ‰ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateFavoriteColorsList() {
    const container = document.getElementById('favorite-colors');
    const list = document.getElementById('favorite-colors-list');
    
    if (favoriteColors.length > 0) {
        container.style.display = 'block';
        list.innerHTML = '';
        
        favoriteColors.forEach((color, index) => {
            const baseRgb = hexToRgb(color.base);
            const { r, g, b } = adjustColor(baseRgb, color.adjustments.lightness, color.adjustments.saturation, color.adjustments.warmth);
            const adjustedColor = `rgb(${r}, ${g}, ${b})`;
            
            const colorElement = document.createElement('div');
            colorElement.style.cssText = `
                width: 40px; height: 40px; border-radius: 50%; 
                background: ${adjustedColor}; cursor: pointer; 
                border: 2px solid #ddd; position: relative;
            `;
            colorElement.title = `${color.season} - ${new Date(color.timestamp).toLocaleTimeString()}`;
            
            colorElement.onclick = () => {
                setDrapingSeason(color.season);
                document.getElementById('lightness-slider').value = color.adjustments.lightness;
                document.getElementById('saturation-slider').value = color.adjustments.saturation;
                document.getElementById('warmth-slider').value = color.adjustments.warmth;
                currentDrapingColor = color.base;
                updateDrapingColor();
                showToast('ì €ì¥ëœ ìƒ‰ìƒì„ ì ìš©í–ˆìŠµë‹ˆë‹¤', 'info');
            };
            
            list.appendChild(colorElement);
        });
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return { r, g, b };
}

function rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ Before/After í† ê¸€)
document.addEventListener('keydown', function(event) {
    if (currentMode === 'draping' && event.code === 'Space' && !event.ctrlKey) {
        event.preventDefault();
        toggleDrapingPreview();
    }
});

// ==========================================
// ì‹œìŠ¤í…œ ìƒíƒœ ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
// ==========================================

// ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ
function showSystemStatus() {
    const status = `
Personal Color Pro - í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ

ì‹œìŠ¤í…œ ìƒíƒœ:
â€¢ MediaPipe: ${faceDetection ? 'âœ… ë¡œë“œë¨' : 'âŒ ì‹¤íŒ¨'}
â€¢ ì¹´ë©”ë¼: ${videoElement && videoElement.srcObject ? 'âœ… ì—°ê²°ë¨' : 'âŒ ëŒ€ê¸°ì¤‘'}
â€¢ ì–¼êµ´ ì¸ì‹: ${camera ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
â€¢ í˜„ì¬ ëª¨ë“œ: ${currentMode}

ë¶„ì„ ë°ì´í„°:
â€¢ ì™„ë£Œëœ ë¶„ì„: ${analysisCount}ê±´
â€¢ ì„ íƒëœ ìƒ‰ìƒ: ${selectedColor || 'ì—†ìŒ'}
â€¢ í˜„ì¬ ê³„ì ˆ: ${selectedSeason}

ìƒ‰ìƒ íŒ”ë ˆíŠ¸:
â€¢ ë´„: ${seasonPalettes.spring.colors.length}ê°œ
â€¢ ì—¬ë¦„: ${seasonPalettes.summer.colors.length}ê°œ
â€¢ ê°€ì„: ${seasonPalettes.autumn.colors.length}ê°œ
â€¢ ê²¨ìš¸: ${seasonPalettes.winter.colors.length}ê°œ

ì „ë¬¸ê°€ ë…¸í•˜ìš°:
â€¢ ìœ ì´ë ˆ(UIREH): âœ… ì ìš©ë¨
â€¢ ë¹›ë‚ ìœ¤/ì°¨í™ì•„ë¥´ë”: âœ… ì ìš©ë¨  
â€¢ ë¸”ë£¨ë¯¸: âœ… ì ìš©ë¨

ê¸°ìˆ  ìŠ¤íƒ:
â€¢ RGB â†’ LAB ë³€í™˜: âœ… êµ¬í˜„ë¨
â€¢ Delta E 2000: âœ… êµ¬í˜„ë¨
â€¢ Before/After ë¹„êµ: âœ… êµ¬í˜„ë¨
â€¢ ì–¼êµ´ ëª¨ì–‘ ì¶”ì : âœ… êµ¬í˜„ë¨
â€¢ 120ìƒ‰ ë¶„ì„ ì‹œìŠ¤í…œ: âœ… êµ¬í˜„ë¨
    `;
    
    alert(status);
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
function showToast(message, type = 'info', duration = 3000) {
    const currentTime = Date.now();
    
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => {
        if (toast.textContent === message) {
            toast.remove();
        }
    });
    
    if (window.lastToastType === type && currentTime - (window.lastToastTime || 0) < 1500) {
        return;
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    window.lastToastType = type;
    window.lastToastTime = currentTime;
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, duration);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && !event.shiftKey && !event.altKey) {
        switch(event.key) {
            case '1':
                event.preventDefault();
                switchMode('photo');
                break;
            case '2':
                event.preventDefault();
                switchMode('draping');
                break;
            case '0':
                event.preventDefault();
                goHome();
                break;
        }
    }
});

// ==========================================
// ë©”ì¸ ì´ˆê¸°í™” ì‹¤í–‰
// ==========================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸ¨ Personal Color Pro ì‹œìŠ¤í…œ ì‹œì‘...');
    
    updateLoadingProgress(10, 'ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
    
    const mediaPipeReady = await initializeMediaPipe();
    
    initializeApp();
    
    setTimeout(() => {
        if (mediaPipeReady) {
            showToast('AI ì–¼êµ´ ì¶”ì  ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            showToast('MediaPipe ë¡œë“œ ì‹¤íŒ¨. ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.', 'warning');
        }
    }, 2000);
});

console.log('âœ… Personal Color Pro - 120ìƒ‰ ì¶”ì²œ ì‹œìŠ¤í…œ ìµœì¢… ì™„ì„± ë²„ì „!');
</script>
</body>
</html>
