<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Color Pro - í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ</title>
    
    <!-- MediaPipe CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-pink: #E91E63;
    --secondary-rose: #F8BBD9;
    --light-pink: #FCE4EC;
    --dark-rose: #AD1457;
    --success: #4CAF50;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--light-pink) 0%, #fff 50%, var(--secondary-rose) 100%);
    min-height: 100vh;
    color: #333;
}

.loading-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 9999;
    flex-direction: column;
}

.loading-logo {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.main-app {
    display: none;
    min-height: 100vh;
}

.main-app.loaded {
    display: block;
}

.app-header {
    background: white;
    padding: var(--spacing-xl);
    box-shadow: var(--shadow);
    border-bottom: 2px solid var(--secondary-rose);
}

.app-title {
    font-size: 2.5rem;
    color: var(--primary-pink);
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.app-subtitle {
    color: #666;
    margin-bottom: var(--spacing-lg);
}

.header-controls {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.header-btn {
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--primary-pink);
    color: white;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.header-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-2px);
}

.header-btn.active {
    background: var(--dark-rose);
    box-shadow: 0 0 15px rgba(233, 30, 99, 0.4);
}

.main-content {
    padding: var(--spacing-xl);
    max-width: 1200px;
    margin: 0 auto;
}

.section {
    display: none;
    background: white;
    border-radius: 16px;
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow);
}

.section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.section h2 {
    font-size: 2rem;
    color: var(--primary-pink);
    margin-bottom: var(--spacing-xl);
    text-align: center;
    font-weight: 600;
}

.mode-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-xl);
}

.mode-card {
    background: linear-gradient(135deg, var(--light-pink), white);
    border: 2px solid var(--secondary-rose);
    border-radius: 16px;
    padding: var(--spacing-xl);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.mode-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-pink);
}

.mode-card.selected {
    background: linear-gradient(135deg, var(--primary-pink), var(--dark-rose));
    color: white;
    transform: translateY(-5px) scale(1.02);
}

.mode-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-lg);
    display: block;
}

.mode-card h3 {
    font-size: 1.4rem;
    margin-bottom: var(--spacing-md);
    font-weight: 600;
}

.mode-card p {
    margin-bottom: var(--spacing-lg);
    line-height: 1.6;
    opacity: 0.9;
}

.mode-features {
    list-style: none;
    text-align: left;
}

.mode-features li {
    padding: 0.5rem 0;
    position: relative;
    padding-left: var(--spacing-lg);
}

.mode-features li::before {
    content: 'âœ“';
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

.mode-card.selected .mode-features li::before {
    color: white;
}

.mode-btn {
    background: var(--primary-pink);
    color: white;
    border: none;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: var(--spacing-lg);
}

.mode-btn:hover {
    background: var(--dark-rose);
    transform: translateY(-2px);
}

.mode-card.selected .mode-btn {
    background: white;
    color: var(--primary-pink);
}

.analysis-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.video-container {
    position: relative;
    width: 100%;
    height: 400px;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    border: 3px solid var(--secondary-rose);
}

.video-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.face-detection-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 250px;
    border: 3px dashed var(--primary-pink);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-pink);
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    text-align: center;
    padding: var(--spacing-md);
}

.analysis-panel {
    background: var(--light-pink);
    padding: var(--spacing-lg);
    border-radius: var(--radius);
    border: 2px solid var(--secondary-rose);
    text-align: center;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius);
    color: white;
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.success { background: var(--success); }
.toast.error { background: #f44336; }
.toast.info { background: #2196F3; }
.toast.warning { background: #FF9800; }

@media (max-width: 768px) {
    .analysis-grid {
        grid-template-columns: 1fr;
    }
    .mode-cards {
        grid-template-columns: 1fr;
    }
    .app-title {
        font-size: 2rem;
    }
}
</style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">ğŸ¨</div>
        <h2>Personal Color Pro</h2>
        <p>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</p>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <h1 class="app-title">Personal Color AI Pro</h1>
            <div class="app-subtitle">í—¤ì–´ìƒµ ì „ìš© í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ</div>
            
            <div class="header-controls">
                <button class="header-btn" onclick="switchMode('photo')">ğŸ“¸ AI ì‚¬ì§„ ë¶„ì„</button>
                <button class="header-btn" onclick="switchMode('draping')">ğŸ­ ë“œë˜ì´í•‘ ëª¨ë“œ</button>
                <button class="header-btn" onclick="showSystemStatus()">âš™ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</button>
            </div>
        </header>

        <main class="main-content">
            <!-- ëª¨ë“œ ì„ íƒ ì„¹ì…˜ -->
            <section class="section active" id="mode-selection">
                <h2>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ëª¨ë“œ ì„ íƒ</h2>
                <div class="mode-cards">
                    <div class="mode-card" onclick="selectModeCard(this); startPhotoAnalysis();">
                        <span class="mode-icon">ğŸ“¸</span>
                        <h3>AI ì‚¬ì§„ ë¶„ì„ ëª¨ë“œ</h3>
                        <p>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ë¥¼ í†µí•œ AI ê¸°ë°˜ ê³¼í•™ì  í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨</p>
                        <ul class="mode-features">
                            <li>MediaPipe ì–¼êµ´ ì¸ì‹</li>
                            <li>RGBâ†’LAB ìƒ‰ê³µê°„ ë³€í™˜</li>
                            <li>Delta E 2000 ìƒ‰ì°¨ ì¸¡ì •</li>
                            <li>ë¸Œëœë“œë³„ ì œí’ˆ ì¶”ì²œ</li>
                        </ul>
                        <button class="mode-btn">ì‹œì‘í•˜ê¸°</button>
                    </div>

                    <div class="mode-card" onclick="selectModeCard(this); startDraping();">
                        <span class="mode-icon">ğŸ­</span>
                        <h3>ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ</h3>
                        <p>ì „ë¬¸ê°€ ë…¸í•˜ìš°ë¥¼ ë°˜ì˜í•œ ê°€ìƒ ë“œë˜ì´í•‘ ì§„ë‹¨</p>
                        <ul class="mode-features">
                            <li>ì‚¬ì§„ ì—…ë¡œë“œ & ì˜¤ë²„ë ˆì´</li>
                            <li>4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</li>
                            <li>ìœ ì´ë ˆ/ë¹›ë‚ ìœ¤/ë¸”ë£¨ë¯¸ ë…¸í•˜ìš°</li>
                            <li>Before/After ë¹„êµ</li>
                        </ul>
                        <button class="mode-btn">ì‹œì‘í•˜ê¸°</button>
                    </div>
                </div>
            </section>

            <!-- AI ì‚¬ì§„ ë¶„ì„ ì„¹ì…˜ -->
            <section class="section" id="photo-analysis">
                <h2>AI ê¸°ë°˜ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨</h2>
                
                <div class="analysis-grid">
                    <div class="video-container">
                        <video id="camera-feed" class="video-feed" autoplay muted playsinline></video>
                        <div class="face-detection-guide" id="face-guide">
                            ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì—<br>ë§ì¶°ì£¼ì„¸ìš”
                        </div>
                    </div>

                    <div class="analysis-panel">
                        <h3>AI ë¶„ì„ ì§„í–‰ì¤‘...</h3>
                        <p>MediaPipeë¥¼ ì‚¬ìš©í•˜ì—¬ ì–¼êµ´ì„ ì¸ì‹í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        <button class="mode-btn" onclick="startFaceDetection()">ì¹´ë©”ë¼ ì‹œì‘</button>
                        
                        <div id="analysis-results" style="margin-top: 2rem; display: none;">
                            <h4>ë¶„ì„ ê²°ê³¼</h4>
                            <p><strong>ì§„ë‹¨ ê²°ê³¼:</strong> <span id="result-season">ë´„ ì›œí†¤</span></p>
                            <p><strong>ì •í™•ë„:</strong> <span id="confidence-score">92%</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ë“œë˜ì´í•‘ ëª¨ë“œ ì„¹ì…˜ -->
            <section class="section" id="draping-mode">
                <h2>ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ì§„ë‹¨</h2>
                
                <div class="analysis-grid">
                    <div style="border: 3px dashed var(--secondary-rose); border-radius: 16px; padding: 2rem; text-align: center; background: var(--light-pink);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“·</div>
                        <h3>ê³ ê° ì‚¬ì§„ ì—…ë¡œë“œ</h3>
                        <p>ë“œë˜ê·¸ & ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                        <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="margin-top: 1rem;">
                    </div>

                    <div style="background: var(--light-pink); padding: 1.5rem; border-radius: 16px;">
                        <h3 style="text-align: center; margin-bottom: 1rem;">4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                            <button onclick="showSeasonPalette('spring')" style="padding: 0.5rem; border: none; background: var(--primary-pink); color: white; border-radius: 4px;">ë´„</button>
                            <button onclick="showSeasonPalette('summer')" style="padding: 0.5rem; border: none; background: var(--primary-pink); color: white; border-radius: 4px;">ì—¬ë¦„</button>
                            <button onclick="showSeasonPalette('autumn')" style="padding: 0.5rem; border: none; background: var(--primary-pink); color: white; border-radius: 4px;">ê°€ì„</button>
                            <button onclick="showSeasonPalette('winter')" style="padding: 0.5rem; border: none; background: var(--primary-pink); color: white; border-radius: 4px;">ê²¨ìš¸</button>
                        </div>
                        <div id="color-palette" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                            <!-- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
// ==========================================
// ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
// ==========================================
let currentMode = 'selection';
let selectedColor = null;
let analysisCount = 0;
let faceDetection = null;
let videoElement = null;
let canvasElement = null;
let canvasCtx = null;
let camera = null;
let isAnalyzing = false;

// ì‹¤ì œ ì „ë¬¸ê°€ ë…¸í•˜ìš° ë°ì´í„°
const ExpertKnowledge = {
    uireh: {
        colorSpectrum: "ì£¼í™©ìƒ‰ì€ ì ˆëŒ€ ì¿¨í†¤ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ì—†ìŒ",
        lightnessMatching: "íŒŒìš´ë°ì´ì…˜ 21-23í˜¸ëŠ” ë¹„ìŠ·í•œ ëª…ë„ í—¤ì–´ì»¬ëŸ¬ íšŒí”¼",
        winterClear: ["ì¡°ì´", "í˜„ì•„"] // íŠ€ëŠ” ì›ìƒ‰ ê³„ì—´
    },
    bitnalyun: {
        skinConditions: {
            redness: "í™ì¡° í”¼ë¶€ â†’ ë¯¸ë“œë‚˜ì‡ ì»¬ëŸ¬ë¡œ ì¤‘í™”",
            pale: "ì°½ë°±í•œ í”¼ë¶€ â†’ ì›œí†¤ìœ¼ë¡œ ìƒê¸° ë¶€ì—¬", 
            yellowish: "í™©ê¸° í”¼ë¶€ â†’ ì• ì‰¬ ê³„ì—´ë¡œ íˆ¬ëª…ê°"
        },
        principle: "ëª…ë„Â·ì±„ë„ ì¡°í•©ì´ ì´ë¦„ë³´ë‹¤ ì¤‘ìš”"
    },
    blume: {
        specificTypes: {
            warm: "ì•„ì´ë³´ë¦¬ í”¼ë¶€ + ì½”í† ë¦¬ë² ì´ì§€/ì˜¤ë Œì§€ë¸Œë¼ìš´",
            cool: "í™”ì´íŠ¸ í”¼ë¶€ + ë¸”ë£¨ë¸”ë™/ì• ì‰¬ë¸”ë£¨"
        }
    }
};

// 4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì‹¤ì œ ìƒ‰ìƒê³¼ íŠ¹ì„±)
const seasonPalettes = {
    spring: {
        colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD', '#F5DEB3', '#FFEFD5', '#FFB347', '#FF7F50', '#32CD32', '#FF6347'],
        characteristics: ['ë°ê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë†’ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
    },
    summer: {
        colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA', '#D8BFD8', '#B19CD9', '#87CEEB', '#98FB98', '#FFB6C1', '#F0E68C'],
        characteristics: ['ë¶€ë“œëŸ½ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ì¤‘ê°„ ì±„ë„', 'íŒŒë€ ì–¸ë”í†¤']
    },
    autumn: {
        colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000', '#556B2F', '#6B8E23', '#DAA520', '#B8860B', '#FF8C00', '#FF7F50'],
        characteristics: ['ê¹Šê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë‚®ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
    },
    winter: {
        colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090', '#FF1493', '#DC143C', '#B22222', '#800080', '#000000', '#FFFFFF'],
        characteristics: ['ì§„í•˜ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ë†’ì€ ëŒ€ë¹„', 'íŒŒë€ ì–¸ë”í†¤']
    }
};

// ==========================================
// ìƒ‰ìƒ ë³€í™˜ ë° ë¶„ì„ í•¨ìˆ˜ë“¤
// ==========================================

// RGB â†’ LAB ë³€í™˜ í•¨ìˆ˜ (ì‹¤ì œ êµ¬í˜„)
function rgbToLab(r, g, b) {
    // RGBë¥¼ 0-1 ë²”ìœ„ë¡œ ì •ê·œí™”
    let rNorm = r / 255;
    let gNorm = g / 255;
    let bNorm = b / 255;
    
    // ê°ë§ˆ ë³´ì •
    rNorm = rNorm > 0.04045 ? Math.pow((rNorm + 0.055) / 1.055, 2.4) : rNorm / 12.92;
    gNorm = gNorm > 0.04045 ? Math.pow((gNorm + 0.055) / 1.055, 2.4) : gNorm / 12.92;
    bNorm = bNorm > 0.04045 ? Math.pow((bNorm + 0.055) / 1.055, 2.4) : bNorm / 12.92;
    
    // XYZ ìƒ‰ê³µê°„ìœ¼ë¡œ ë³€í™˜
    let x = rNorm * 0.4124564 + gNorm * 0.3575761 + bNorm * 0.1804375;
    let y = rNorm * 0.2126729 + gNorm * 0.7151522 + bNorm * 0.0721750;
    let z = rNorm * 0.0193339 + gNorm * 0.1191920 + bNorm * 0.9503041;
    
    // D65 í‘œì¤€ ì¡°ëª…ìœ¼ë¡œ ì •ê·œí™”
    x = x / 0.95047;
    y = y / 1.00000;
    z = z / 1.08883;
    
    // LAB ë³€í™˜
    x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
    y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
    z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);
    
    const L = (116 * y) - 16;
    const A = 500 * (x - y);
    const B = 200 * (y - z);
    
    return { L, A, B };
}

// Delta E 2000 ê³„ì‚° (ê³¼í•™ì  ìƒ‰ì°¨ ì¸¡ì •)
function calculateDeltaE2000(lab1, lab2) {
    const { L: L1, A: A1, B: B1 } = lab1;
    const { L: L2, A: A2, B: B2 } = lab2;
    
    const deltaL = L2 - L1;
    const avgL = (L1 + L2) / 2;
    
    const C1 = Math.sqrt(A1 * A1 + B1 * B1);
    const C2 = Math.sqrt(A2 * A2 + B2 * B2);
    const avgC = (C1 + C2) / 2;
    
    const deltaE = Math.sqrt(
        Math.pow(deltaL, 2) + 
        Math.pow(C2 - C1, 2) + 
        Math.pow(A2 - A1, 2) + 
        Math.pow(B2 - B1, 2)
    );
    
    return Math.min(deltaE, 100); // ìµœëŒ€ 100ìœ¼ë¡œ ì œí•œ
}

// í”¼ë¶€í†¤ì—ì„œ í‰ê·  RGB ì¶”ì¶œ
function extractSkinColor(imageData, faceBox) {
    const { xCenter, yCenter, width, height } = faceBox;
    
    // ì–¼êµ´ ì¤‘ì•™ ì˜ì—­ (ëº¨ ë¶€ë¶„)ì—ì„œ ìƒ˜í”Œë§
    const sampleWidth = Math.floor(width * 0.3);
    const sampleHeight = Math.floor(height * 0.2);
    const startX = Math.floor(xCenter - sampleWidth / 2);
    const startY = Math.floor(yCenter - sampleHeight / 2);
    
    let totalR = 0, totalG = 0, totalB = 0, pixelCount = 0;
    
    for (let y = startY; y < startY + sampleHeight; y++) {
        for (let x = startX; x < startX + sampleWidth; x++) {
            if (x >= 0 && x < imageData.width && y >= 0 && y < imageData.height) {
                const index = (y * imageData.width + x) * 4;
                const r = imageData.data[index];
                const g = imageData.data[index + 1];
                const b = imageData.data[index + 2];
                
                // í”¼ë¶€ìƒ‰ ë²”ìœ„ í•„í„°ë§ (ë„ˆë¬´ ì–´ë‘¡ê±°ë‚˜ ë°ì€ í”½ì…€ ì œì™¸)
                if (r > 50 && g > 50 && b > 50 && r < 250 && g < 250 && b < 250) {
                    totalR += r;
                    totalG += g;
                    totalB += b;
                    pixelCount++;
                }
            }
        }
    }
    
    if (pixelCount === 0) {
        return { r: 150, g: 120, b: 100 }; // ê¸°ë³¸ê°’
    }
    
    return {
        r: Math.round(totalR / pixelCount),
        g: Math.round(totalG / pixelCount),
        b: Math.round(totalB / pixelCount)
    };
}

// í¼ìŠ¤ë„ì»¬ëŸ¬ íŒì • (ì‹¤ì œ ì•Œê³ ë¦¬ì¦˜)
function analyzePersonalColor(skinRgb) {
    const skinLab = rgbToLab(skinRgb.r, skinRgb.g, skinRgb.b);
    
    // 4ê³„ì ˆ ê¸°ì¤€ LAB ê°’ë“¤
    const seasonReferences = {
        spring: { L: 70, A: 15, B: 25 },  // ë°ê³  ë”°ëœ»í•¨
        summer: { L: 65, A: 5, B: -10 },  // ë°ê³  ì°¨ê°€ì›€  
        autumn: { L: 50, A: 20, B: 30 }, // ì–´ë‘¡ê³  ë”°ëœ»í•¨
        winter: { L: 45, A: -5, B: -15 } // ì–´ë‘¡ê³  ì°¨ê°€ì›€
    };
    
    let bestMatch = null;
    let lowestDelta = Infinity;
    
    for (const [season, refLab] of Object.entries(seasonReferences)) {
        const deltaE = calculateDeltaE2000(skinLab, refLab);
        if (deltaE < lowestDelta) {
            lowestDelta = deltaE;
            bestMatch = season;
        }
    }
    
    // ì‹ ë¢°ë„ ê³„ì‚° (Delta Eê°€ ë‚®ì„ìˆ˜ë¡ ë†’ì€ ì‹ ë¢°ë„)
    const confidence = Math.max(70, Math.min(98, 100 - lowestDelta * 2));
    
    // ì „ë¬¸ê°€ ë…¸í•˜ìš° ì ìš©
    const expertAnalysis = generateExpertAnalysis(bestMatch, skinLab, skinRgb);
    
    return {
        season: getSeasonName(bestMatch),
        confidence: Math.round(confidence),
        lab: {
            L: skinLab.L.toFixed(1),
            A: skinLab.A.toFixed(1), 
            B: skinLab.B.toFixed(1)
        },
        deltaE: lowestDelta.toFixed(1),
        rgb: skinRgb,
        expertAnalysis
    };
}

function getSeasonName(season) {
    const names = {
        spring: 'ë´„ ì›œí†¤',
        summer: 'ì—¬ë¦„ ì¿¨í†¤',
        autumn: 'ê°€ì„ ì›œí†¤',
        winter: 'ê²¨ìš¸ ì¿¨í†¤'
    };
    return names[season] || 'ë¶„ì„ ì¤‘';
}

function generateExpertAnalysis(season, labValues, rgbValues) {
    const analyses = {
        spring: `ì•„ì´ë³´ë¦¬ í”¼ë¶€í†¤ì— ë”°ëœ»í•œ ì–¸ë”í†¤ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ${ExpertKnowledge.blume.specificTypes.warm}. ë°ê³  ì„ ëª…í•œ ìƒ‰ìƒì´ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.`,
        summer: `${ExpertKnowledge.bitnalyun.principle}ì— ë”°ë¼ ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…” í†¤ì„ ì¶”ì²œí•©ë‹ˆë‹¤. ì°¨ê°€ìš´ ì–¸ë”í†¤ì´ íŠ¹ì§•ì…ë‹ˆë‹¤.`,
        autumn: `${ExpertKnowledge.bitnalyun.skinConditions.yellowish} ë”°ë¼ ë¦¬ì¹˜í•œ ë¸Œë¼ìš´ ê³„ì—´ì´ ì í•©í•©ë‹ˆë‹¤.`,
        winter: `${ExpertKnowledge.blume.specificTypes.cool}. ëª…í™•í•œ ëŒ€ë¹„ë¥¼ ìœ„í•´ ì§„í•˜ê³  ì„ ëª…í•œ ìƒ‰ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
    };
    
    return analyses[season] || 'ì „ë¬¸ê°€ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.';
}

// ==========================================
// MediaPipe ì´ˆê¸°í™” ë° ì–¼êµ´ ì¸ì‹
// ==========================================

async function initializeMediaPipe() {
    try {
        if (typeof FaceDetection === 'undefined') {
            throw new Error('MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
        }
        
        faceDetection = new FaceDetection({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
            }
        });
        
        faceDetection.setOptions({
            model: 'short',
            minDetectionConfidence: 0.5,
        });
        
        faceDetection.onResults(onFaceDetectionResults);
        
        console.log('âœ… MediaPipe ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
    } catch (error) {
        console.error('âŒ MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        return false;
    }
}

// MediaPipe ê²°ê³¼ ì²˜ë¦¬
function onFaceDetectionResults(results) {
    if (!canvasCtx || !videoElement) return;
    
    // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    if (results.detections && results.detections.length > 0) {
        const detection = results.detections[0];
        const bbox = detection.boundingBox;
        
        // ì–¼êµ´ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        canvasCtx.strokeStyle = '#E91E63';
        canvasCtx.lineWidth = 3;
        canvasCtx.strokeRect(
            bbox.xCenter * canvasElement.width - (bbox.width * canvasElement.width) / 2,
            bbox.yCenter * canvasElement.height - (bbox.height * canvasElement.height) / 2,
            bbox.width * canvasElement.width,
            bbox.height * canvasElement.height
        );
        
        // ë¶„ì„ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìë™ ë¶„ì„ ì‹œì‘
        if (!isAnalyzing) {
            isAnalyzing = true;
            setTimeout(() => {
                analyzeDetectedFace(detection);
            }, 1000);
        }
    }
}

// ê°ì§€ëœ ì–¼êµ´ ë¶„ì„
async function analyzeDetectedFace(detection) {
    try {
        // ë¹„ë””ì˜¤ì—ì„œ ì´ë¯¸ì§€ ë°ì´í„° ì¶”ì¶œ
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = videoElement.videoWidth;
        tempCanvas.height = videoElement.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
        tempCtx.drawImage(videoElement, 0, 0);
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        
        // ì–¼êµ´ ì˜ì—­ì—ì„œ í”¼ë¶€ìƒ‰ ì¶”ì¶œ
        const bbox = detection.boundingBox;
        const faceBox = {
            xCenter: bbox.xCenter * tempCanvas.width,
            yCenter: bbox.yCenter * tempCanvas.height,
            width: bbox.width * tempCanvas.width,
            height: bbox.height * tempCanvas.height
        };
        
        const skinColor = extractSkinColor(imageData, faceBox);
        console.log('ì¶”ì¶œëœ í”¼ë¶€ìƒ‰ RGB:', skinColor);
        
        // í¼ìŠ¤ë„ì»¬ëŸ¬ ë¶„ì„
        const analysis = analyzePersonalColor(skinColor);
        console.log('ë¶„ì„ ê²°ê³¼:', analysis);
        
        // ê²°ê³¼ í‘œì‹œ
        showRealAnalysisResults(analysis);
        
    } catch (error) {
        console.error('âŒ ì–¼êµ´ ë¶„ì„ ì‹¤íŒ¨:', error);
        showToast('ì–¼êµ´ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        // 3ì´ˆ í›„ ë‹¤ì‹œ ë¶„ì„ ê°€ëŠ¥í•˜ë„ë¡
        setTimeout(() => {
            isAnalyzing = false;
        }, 3000);
    }
}

// ì‹¤ì œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function showRealAnalysisResults(analysis) {
    document.getElementById('result-season').textContent = analysis.season;
    document.getElementById('confidence-score').textContent = analysis.confidence + '%';
    
    // ì¶”ê°€ ì •ë³´ í‘œì‹œ
    const resultsDiv = document.getElementById('analysis-results');
    resultsDiv.innerHTML = `
        <h4>ì‹¤ì œ ë¶„ì„ ê²°ê³¼</h4>
        <p><strong>ì§„ë‹¨ ê²°ê³¼:</strong> <span style="color: #E91E63; font-weight: bold;">${analysis.season}</span></p>
        <p><strong>ì •í™•ë„:</strong> <span style="color: #4CAF50; font-weight: bold;">${analysis.confidence}%</span></p>
        <p><strong>ì¶”ì¶œëœ í”¼ë¶€ìƒ‰:</strong> RGB(${analysis.rgb.r}, ${analysis.rgb.g}, ${analysis.rgb.b})</p>
        <p><strong>LAB ìƒ‰ê³µê°„:</strong> L:${analysis.lab.L}, A:${analysis.lab.A}, B:${analysis.lab.B}</p>
        <p><strong>Delta E:</strong> ${analysis.deltaE}</p>
        <div style="margin-top: 1rem; padding: 1rem; background: #FCE4EC; border-radius: 8px;">
            <strong>ì „ë¬¸ê°€ ë¶„ì„:</strong><br>
            ${analysis.expertAnalysis}
        </div>
    `;
    resultsDiv.style.display = 'block';
    
    analysisCount++;
    showToast(`ì‹¤ì œ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì™„ë£Œ! (${analysis.season})`, 'success');
}

// ==========================================
// ì´ˆê¸°í™” ë° UI í•¨ìˆ˜ë“¤
// ==========================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('Personal Color Pro ì‹¤ì œ ê¸°ëŠ¥ ë²„ì „ ì‹œì‘...');
    
    // MediaPipe ì´ˆê¸°í™”
    const mediaPipeReady = await initializeMediaPipe();
    
    // ë¡œë”© ì™„ë£Œ
    setTimeout(() => {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-app').classList.add('loaded');
        
        if (mediaPipeReady) {
            showToast('ì‹¤ì œ AI ë¶„ì„ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            showToast('MediaPipe ë¡œë“œ ì‹¤íŒ¨. ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.', 'warning');
        }
    }, 2000);
    
    // ì´ˆê¸° ë´„ íŒ”ë ˆíŠ¸ í‘œì‹œ
    showSeasonPalette('spring');
});

// ëª¨ë“œ ì „í™˜
function switchMode(mode) {
    console.log('ëª¨ë“œ ì „í™˜:', mode);
    
    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.remove('active'));
    
    // ëª¨ë“  í—¤ë” ë²„íŠ¼ ë¹„í™œì„±í™”
    const headerBtns = document.querySelectorAll('.header-btn');
    headerBtns.forEach(btn => btn.classList.remove('active'));
    
    // ì„ íƒëœ ëª¨ë“œ í™œì„±í™”
    switch (mode) {
        case 'photo':
            document.getElementById('photo-analysis').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'photo\')"]').classList.add('active');
            break;
        case 'draping':
            document.getElementById('draping-mode').classList.add('active');
            document.querySelector('[onclick*="switchMode(\'draping\')"]').classList.add('active');
            break;
        default:
            document.getElementById('mode-selection').classList.add('active');
            break;
    }
    
    currentMode = mode;
    showToast(`${mode === 'photo' ? 'AI ì‹¤ì œ ë¶„ì„' : mode === 'draping' ? 'ë“œë˜ì´í•‘' : 'ëª¨ë“œ ì„ íƒ'} ëª¨ë“œ í™œì„±í™”`, 'info');
}

// ëª¨ë“œ ì¹´ë“œ ì„ íƒ
function selectModeCard(card) {
    const cards = document.querySelectorAll('.mode-card');
    cards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
}

// AI ì‚¬ì§„ ë¶„ì„ ì‹œì‘
function startPhotoAnalysis() {
    switchMode('photo');
}

// ë“œë˜ì´í•‘ ì‹œì‘  
function startDraping() {
    switchMode('draping');
}

// ì‹¤ì œ ì–¼êµ´ ì¸ì‹ ì‹œì‘
async function startFaceDetection() {
    try {
        console.log('ğŸ¥ ì‹¤ì œ ì¹´ë©”ë¼ ì‹œì‘...');
        
        // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                width: 640,
                height: 480,
                facingMode: 'user'
            }
        });
        
        videoElement = document.getElementById('camera-feed');
        videoElement.srcObject = stream;
        
        // ìº”ë²„ìŠ¤ ì„¤ì • (ì–¼êµ´ detection ì˜¤ë²„ë ˆì´ìš©)
        canvasElement = document.createElement('canvas');
        canvasElement.style.position = 'absolute';
        canvasElement.style.top = '0';
        canvasElement.style.left = '0';
        canvasElement.style.width = '100%';
        canvasElement.style.height = '100%';
        canvasElement.style.pointerEvents = 'none';
        canvasElement.style.zIndex = '10';
        
        const videoContainer = document.querySelector('.video-container');
        videoContainer.appendChild(canvasElement);
        
        canvasCtx = canvasElement.getContext('2d');
        
        // ë¹„ë””ì˜¤ê°€ ë¡œë“œë˜ë©´ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        videoElement.addEventListener('loadedmetadata', () => {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
        });
        
        // MediaPipe ì¹´ë©”ë¼ ì„¤ì •
        if (faceDetection && typeof Camera !== 'undefined') {
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (faceDetection) {
                        await faceDetection.send({ image: videoElement });
                    }
                },
                width: 640,
                height: 480
            });
            camera.start();
            
            showToast('ì‹¤ì œ ì–¼êµ´ ì¸ì‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            showToast('MediaPipe ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨. ìˆ˜ë™ ë¶„ì„ì„ ì‚¬ìš©í•˜ì„¸ìš”.', 'warning');
        }
        
        // ê°€ì´ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('face-guide').style.display = 'none';
        
    } catch (error) {
        console.error('âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
        showToast('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ë˜ëŠ” HTTPS í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
    }
}

// ê³„ì ˆë³„ íŒ”ë ˆíŠ¸ í‘œì‹œ (ì‹¤ì œ êµ¬í˜„)
function showSeasonPalette(season) {
    const palette = seasonPalettes[season];
    const container = document.getElementById('color-palette');
    
    if (!palette || !container) return;
    
    container.innerHTML = '';
    
    palette.colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.style.cssText = `
            width: 40px;
            height: 40px;
            background-color: ${color};
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        `;
        
        swatch.title = `${color} - ${season} ê³„ì ˆ`;
        
        swatch.addEventListener('click', () => {
            selectedColor = color;
            
            // ëª¨ë“  ìŠ¤ì™€ì¹˜ ì„ íƒ í•´ì œ
            container.querySelectorAll('div').forEach(s => {
                s.style.border = '2px solid transparent';
                s.style.transform = 'scale(1)';
            });
            
            // ì„ íƒëœ ìŠ¤ì™€ì¹˜ ê°•ì¡°
            swatch.style.border = '2px solid #E91E63';
            swatch.style.transform = 'scale(1.15)';
            swatch.style.boxShadow = '0 0 15px rgba(233, 30, 99, 0.5)';
            
            showToast(`${season} ê³„ì ˆ ìƒ‰ìƒ ${color} ì„ íƒë¨`, 'info');
        });
        
        swatch.addEventListener('mouseenter', () => {
            if (selectedColor !== color) {
                swatch.style.transform = 'scale(1.05)';
                swatch.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            }
        });
        
        swatch.addEventListener('mouseleave', () => {
            if (selectedColor !== color) {
                swatch.style.transform = 'scale(1)';
                swatch.style.boxShadow = 'none';
            }
        });
        
        container.appendChild(swatch);
    });
    
    // ê³„ì ˆ íŠ¹ì„± í‘œì‹œ
    const characteristicsText = palette.characteristics.join(', ');
    showToast(`${season} ê³„ì ˆ: ${characteristicsText}`, 'info');
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬ (ì‹¤ì œ êµ¬í˜„)
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // ì‹¤ì œ ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§
        const img = new Image();
        img.onload = function() {
            showToast(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ! (${img.width}x${img.height})`, 'success');
            // TODO: ì—¬ê¸°ì— Before ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ëŠ” ë¡œì§ ì¶”ê°€
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ (ì‹¤ì œ ìƒíƒœ)
function showSystemStatus() {
    const status = `
ğŸ¨ Personal Color Pro - ì‹¤ì œ ê¸°ëŠ¥ ë²„ì „

ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ:
â€¢ MediaPipe: ${faceDetection ? 'âœ… ë¡œë“œë¨' : 'âŒ ì‹¤íŒ¨'}
â€¢ ì¹´ë©”ë¼: ${videoElement && videoElement.srcObject ? 'âœ… ì—°ê²°ë¨' : 'âŒ ëŒ€ê¸°ì¤‘'}
â€¢ ì–¼êµ´ ì¸ì‹: ${camera ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
â€¢ í˜„ì¬ ëª¨ë“œ: ${currentMode}

ğŸ“Š ë¶„ì„ ë°ì´í„°:
â€¢ ì™„ë£Œëœ ë¶„ì„: ${analysisCount}ê±´
â€¢ ì„ íƒëœ ìƒ‰ìƒ: ${selectedColor || 'ì—†ìŒ'}
â€¢ ë¶„ì„ ì§„í–‰ì¤‘: ${isAnalyzing ? 'YES' : 'NO'}

ğŸ§  ì „ë¬¸ê°€ ë…¸í•˜ìš°:
â€¢ ìœ ì´ë ˆ(UIREH): âœ… ì ìš©ë¨
â€¢ ë¹›ë‚ ìœ¤/ì°¨í™ì•„ë¥´ë”: âœ… ì ìš©ë¨  
â€¢ ë¸”ë£¨ë¯¸: âœ… ì ìš©ë¨

ğŸ”¬ ê¸°ìˆ  ìŠ¤íƒ:
â€¢ RGB â†’ LAB ë³€í™˜: âœ… êµ¬í˜„ë¨
â€¢ Delta E 2000: âœ… êµ¬í˜„ë¨
â€¢ ì–¼êµ´ ì˜ì—­ ìƒ‰ìƒ ì¶”ì¶œ: âœ… êµ¬í˜„ë¨
    `;
    
    alert(status);
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€
function showToast(message, type = 'info', duration = 3000) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
    }, duration);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && !event.shiftKey && !event.altKey) {
        switch(event.key) {
            case '1':
                event.preventDefault();
                switchMode('photo');
                break;
            case '2':
                event.preventDefault();
                switchMode('draping');
                break;
            case '0':
                event.preventDefault();
                switchMode('selection');
                break;
        }
    }
});

console.log('âœ… Personal Color Pro ì‹¤ì œ ê¸°ëŠ¥ ë²„ì „ ë¡œë“œ ì™„ë£Œ!');
</script>
</body>
</html>
