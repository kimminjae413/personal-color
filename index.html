<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Color Analyzer Pro - 헤어디자이너 전용</title>
    
    <!-- PWA 메타데이터 -->
    <meta name="description" content="헤어디자이너를 위한 전문 퍼스널컬러 진단 시스템">
    <meta name="theme-color" content="#2C3E50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="manifest.json">
    
    <!-- 아이콘들 -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="assets/images/icons/icon-192x192.png">
    
    <!-- CSS 파일들 -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/tablet.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    
    <!-- 폰트 프리로드 -->
    <link rel="preload" href="assets/fonts/NotoSansKR-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="assets/fonts/Inter-Variable.woff2" as="font" type="font/woff2" crossorigin>
</head>

<body class="loading">
    <!-- 로딩 스크린 -->
    <div class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <h1>Personal Color Pro</h1>
                <p>헤어디자이너 전용 진단 시스템</p>
            </div>
            
            <div class="loading-progress-container">
                <div class="loading-progress-bar">
                    <div class="loading-progress" style="width: 0%"></div>
                </div>
                <div class="loading-message">시스템 초기화 중...</div>
            </div>
            
            <div class="loading-details">
                <div class="loading-step" id="step-config">⏳ 설정 로드 중...</div>
                <div class="loading-step" id="step-modules">⏳ 모듈 로드 중...</div>
                <div class="loading-step" id="step-ai">⏳ AI 시스템 준비 중...</div>
                <div class="loading-step" id="step-ui">⏳ UI 초기화 중...</div>
            </div>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div class="main-app" style="display: none;">
        <!-- 헤더 -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">Personal Color Pro</h1>
                <div class="current-customer">고객을 선택해주세요</div>
            </div>
            
            <div class="header-right">
                <button id="customer-management" class="header-btn">
                    <i class="icon-users"></i>
                    고객 관리
                </button>
                
                <button id="settings-btn" class="header-btn">
                    <i class="icon-settings"></i>
                    설정
                </button>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 진단 모드 선택 -->
            <section class="diagnosis-mode-selection">
                <h2>진단 모드를 선택하세요</h2>
                
                <div class="mode-cards">
                    <div class="mode-card" data-mode="ai_photo">
                        <div class="mode-icon">🤖</div>
                        <h3>AI 사진 분석</h3>
                        <p>스마트폰으로 간편하게<br>5-7분 소요</p>
                        <div class="mode-accuracy">정확도: 85%</div>
                        <button class="mode-select-btn">선택</button>
                    </div>
                    
                    <div class="mode-card" data-mode="draping">
                        <div class="mode-icon">🎨</div>
                        <h3>전문가 드레이핑</h3>
                        <p>색상 천을 활용한 정밀 진단<br>15-20분 소요</p>
                        <div class="mode-accuracy">정확도: 95%</div>
                        <button class="mode-select-btn">선택</button>
                    </div>
                    
                    <div class="mode-card" data-mode="hybrid">
                        <div class="mode-icon">⚡</div>
                        <h3>하이브리드</h3>
                        <p>AI + 전문가 검증<br>10-15분 소요</p>
                        <div class="mode-accuracy">정확도: 98%</div>
                        <button class="mode-select-btn recommended">추천</button>
                    </div>
                </div>
            </section>

            <!-- 진단 영역 -->
            <section class="diagnosis-area" style="display: none;">
                <div class="diagnosis-container">
                    <!-- AI 모드 컨테이너 -->
                    <div id="ai-mode-container" class="diagnosis-mode-container">
                        <h3>📷 AI 사진 분석</h3>
                        <div class="camera-container">
                            <video id="camera-preview" autoplay muted playsinline></video>
                            <canvas id="analysis-canvas"></canvas>
                            <div class="camera-overlay">
                                <div class="face-guide">얼굴을 프레임에 맞춰주세요</div>
                            </div>
                        </div>
                        
                        <div class="camera-controls">
                            <button id="capture-btn" class="primary-btn">📸 촬영</button>
                            <button id="upload-btn" class="secondary-btn">📁 파일 선택</button>
                            <input type="file" id="file-input" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- 드레이핑 모드 컨테이너 -->
                    <div id="draping-mode-container" class="diagnosis-mode-container" style="display: none;">
                        <h3>🎨 전문가 드레이핑</h3>
                        <div class="draping-workspace">
                            <div class="color-palette">
                                <h4>테스트 색상</h4>
                                <div class="color-swatches">
                                    <div class="color-swatch" data-color="#FF6B6B" style="background: #FF6B6B;"></div>
                                    <div class="color-swatch" data-color="#4ECDC4" style="background: #4ECDC4;"></div>
                                    <div class="color-swatch" data-color="#45B7D1" style="background: #45B7D1;"></div>
                                    <div class="color-swatch" data-color="#96CEB4" style="background: #96CEB4;"></div>
                                </div>
                            </div>
                            
                            <div class="draping-notes">
                                <h4>관찰 메모</h4>
                                <textarea id="draping-notes" placeholder="색상별 피부 반응을 기록하세요..."></textarea>
                            </div>
                        </div>
                        
                        <div class="draping-controls">
                            <button id="add-comparison" class="primary-btn">비교 추가</button>
                            <button id="complete-draping" class="secondary-btn">진단 완료</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 결과 영역 -->
            <section class="diagnosis-result" style="display: none;">
                <div class="result-container">
                    <h2>🎉 진단 결과</h2>
                    
                    <div class="result-summary">
                        <div class="season-badge">
                            <span class="season-name">봄 웜톤</span>
                            <span class="confidence">92% 확신</span>
                        </div>
                        
                        <div class="result-details">
                            <div class="detail-item">
                                <span class="label">피부 톤:</span>
                                <span class="value">따뜻한 톤</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">밝기:</span>
                                <span class="value">밝은 톤</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">채도:</span>
                                <span class="value">선명한 톤</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-actions">
                        <button id="generate-report" class="primary-btn" disabled>
                            📊 PDF 보고서 생성
                        </button>
                        <button id="save-result" class="secondary-btn">
                            💾 결과 저장
                        </button>
                        <button id="new-diagnosis" class="secondary-btn">
                            🔄 새 진단
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- 사이드바 (고객 관리) -->
        <aside class="sidebar" style="display: none;">
            <div class="sidebar-header">
                <h3>고객 관리</h3>
                <button class="close-sidebar">✕</button>
            </div>
            
            <div class="sidebar-content">
                <div class="customer-search">
                    <input type="text" placeholder="고객 검색..." id="customer-search">
                </div>
                
                <div class="customer-list">
                    <!-- 동적으로 생성됨 -->
                </div>
                
                <button id="add-customer" class="primary-btn full-width">
                    ➕ 새 고객 추가
                </button>
            </div>
        </aside>
    </div>

    <!-- 에러 토스트 컨테이너 -->
    <div class="toast-container"></div>

    <!-- 모달 컨테이너 -->
    <div class="modal-container"></div>

    <!-- JavaScript 로드 -->
    <script>
        // 에러 처리
        window.addEventListener('error', (e) => {
            console.error('전역 에러:', e.error);
        });

        // 로딩 진행률 업데이터
        function updateLoadingStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            if (step) {
                const icon = status === 'complete' ? '✅' : 
                            status === 'error' ? '❌' : '⏳';
                step.textContent = `${icon} ${message}`;
            }
        }

        // 로딩 완료 처리
        function completeLoading() {
            setTimeout(() => {
                document.querySelector('.loading-screen').style.display = 'none';
                document.querySelector('.main-app').style.display = 'block';
                document.body.classList.remove('loading');
            }, 500);
        }
    </script>

    <!-- 1. 설정 파일 (process 제거된 버전) -->
    <script src="js/config.js"></script>
    
    <!-- 2. 유틸리티들 -->
    <script src="js/utils/validation.js"></script>
    <script src="js/utils/performance.js"></script>
    <script src="js/utils/analytics.js"></script>
    
    <!-- 3. 모듈 로더 (ES6 모듈 호환성 해결) -->
    <script src="js/utils/moduleLoader.js"></script>
    
    <!-- 4. 누락된 파일들 -->
    <script>
        // 누락된 파일들을 인라인으로 로드
        // fashionGuide, makeupBrands, colorPalettes, etc.
        
        const fashionGuide = {
            spring: { colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] },
            summer: { colors: ['#A8E6CF', '#DCEDC8', '#C5E1A5', '#E1BEE7'] },
            autumn: { colors: ['#D4AF37', '#CD853F', '#A0522D', '#8B4513'] },
            winter: { colors: ['#000000', '#FFFFFF', '#DC143C', '#4169E1'] }
        };

        const makeupBrands = {
            hera: { name: '헤라', products: { foundation: ['#21', '#23', '#25'] } },
            laneige: { name: '라네즈', products: { foundation: ['#13', '#17', '#21'] } },
            innisfree: { name: '이니스프리', products: { foundation: ['#13', '#17', '#21'] } }
        };

        const colorPalettes = {
            spring: { primary: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
            summer: { primary: ['#A8E6CF', '#DCEDC8', '#C5E1A5'] },
            autumn: { primary: ['#D4AF37', '#CD853F', '#A0522D'] },
            winter: { primary: ['#000000', '#FFFFFF', '#DC143C'] }
        };

        // 전역에 등록
        window.fashionGuide = fashionGuide;
        window.makeupBrands = makeupBrands;
        window.colorPalettes = colorPalettes;

        // 간단한 클래스들
        class SeasonClassifier {
            async initialize() { console.log('✅ SeasonClassifier 초기화'); }
            classify(skinTone, undertone, lightness) {
                return undertone === 'warm' ? 
                    (lightness === 'light' ? 'spring' : 'autumn') :
                    (lightness === 'light' ? 'summer' : 'winter');
            }
        }

        class ColorClassifier {
            async initialize() { console.log('✅ ColorClassifier 초기화'); }
            classifyColors(colors) {
                return colors.map(color => ({ color, category: 'primary', confidence: 85 }));
            }
        }

        class ComparisonTool {
            constructor() { this.comparisons = []; }
            addComparison(before, after, metadata) {
                const comparison = { id: Date.now(), before, after, metadata };
                this.comparisons.push(comparison);
                return comparison;
            }
        }

        class ExpertWorkflow {
            constructor() { this.steps = []; this.currentStep = 0; }
            initializeWorkflow() {
                this.steps = [
                    { name: '고객 상담', duration: 5 },
                    { name: '드레이핑 테스트', duration: 15 }
                ];
            }
            nextStep() {
                if (this.currentStep < this.steps.length - 1) {
                    this.currentStep++;
                    return this.steps[this.currentStep];
                }
                return null;
            }
        }

        // 전역 등록
        window.SeasonClassifier = SeasonClassifier;
        window.ColorClassifier = ColorClassifier;
        window.ComparisonTool = ComparisonTool;
        window.ExpertWorkflow = ExpertWorkflow;

        updateLoadingStep('step-config', 'complete', '설정 로드 완료');
    </script>

    <!-- 5. 색상 시스템 (ColorConverter 포함) -->
    <script src="js/color/ColorConverter.js"></script>
    <script src="js/color/DeltaE.js"></script>

    <!-- 6. 진단 모드 관리 -->
    <script src="js/components/DiagnosisMode.js"></script>

    <!-- 7. AR 렌더러 -->
    <script src="js/draping/ARRenderer.js"></script>

    <!-- 8. 메인 앱 (수정된 버전) -->
    <script src="js/app.js"></script>

    <script>
        // 모든 스크립트 로드 완료 후
        updateLoadingStep('step-modules', 'complete', '모듈 로드 완료');
        updateLoadingStep('step-ai', 'complete', 'AI 시스템 준비 완료');
        updateLoadingStep('step-ui', 'complete', 'UI 초기화 완료');

        // 로딩 완료
        setTimeout(() => {
            completeLoading();
        }, 1000);
    </script>

    <!-- PWA 서비스 워커 등록 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('SW registered');
                    })
                    .catch(error => {
                        console.log('SW registration failed');
                    });
            });
        }
    </script>
</body>
</html>
