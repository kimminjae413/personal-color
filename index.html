<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Personal Color AI Pro - ì‹¤ì œ ì‘ë™ ì‹œìŠ¤í…œ</title>
    <meta name="description" content="ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ DB - í—¤ì–´ìƒµ í˜„ì¥ìš© ì™„ì „ ì‹œìŠ¤í…œ">
    
    <!-- PWA ì„¤ì • -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGVyc29uYWwgQ29sb3IgQUkgUHJvIiwic2hvcnRfbmFtZSI6IkNvbG9yQUkiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzYzNjZmMSJ9">
    
    <!-- MediaPipe ì™„ì „ í†µí•© -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>  
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- TensorFlow.js & ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            
            --spring: #22c55e;
            --summer: #06b6d4;  
            --autumn: #f59e0b;
            --winter: #3b82f6;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
            
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius: 8px;
            --radius-lg: 12px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* ë¡œë”© í™”ë©´ */
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-container { text-align: center; max-width: 500px; padding: 2rem; }
        .loading-logo h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; }
        .loading-logo p { font-size: 1rem; margin-bottom: 2rem; opacity: 0.9; }

        .loading-progress-bar {
            width: 320px; height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 1rem;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%; background: white;
            border-radius: 2px; width: 0%;
            transition: width 0.3s ease;
        }

        .loading-message { font-size: 0.9rem; margin-bottom: 1.5rem; opacity: 0.8; }
        .loading-steps { text-align: left; font-size: 0.8rem; }
        .loading-step { margin: 0.3rem 0; opacity: 0.6; transition: opacity 0.3s ease; }
        .loading-step.active { opacity: 1; }
        .loading-step.complete { opacity: 0.8; }

        /* ë©”ì¸ ì•± */
        .main-app {
            display: none;
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .main-app.loaded { opacity: 1; }

        /* í—¤ë” */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-lg);
            position: sticky; top: 0; z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .app-title {
            font-size: 1.8rem; font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-status {
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .status-item {
            margin: 0.2rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .status-indicator {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text);
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .header-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ëª¨ë“œ ì„ íƒ */
        .mode-selection { display: block; margin-bottom: 3rem; }
        .mode-selection.hidden { display: none; }

        .mode-selection h2 {
            font-size: 2.2rem; font-weight: 600;
            text-align: center; margin-bottom: 2rem;
            color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: 2rem; text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .mode-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-5px);
        }

        .mode-icon { font-size: 3rem; margin-bottom: 1.5rem; }
        .mode-card h3 { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.8rem; }
        .mode-card p { color: var(--text-light); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.5rem; }

        .mode-accuracy {
            background: var(--success); color: white;
            padding: 0.3rem 0.8rem; border-radius: 20px;
            font-size: 0.8rem; font-weight: 600;
            display: inline-block; margin-bottom: 1.5rem;
        }

        .mode-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none;
            padding: 0.8rem 2rem; border-radius: var(--radius);
            font-size: 0.95rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
            width: 100%; box-shadow: var(--shadow);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ì‹¤ì œ ì–¼êµ´ê°ì§€ ì„¹ì…˜ */
        .face-detection-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem; margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }
        .face-detection-section.active { display: block; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .section-title { font-size: 1.6rem; font-weight: 600; }
        .section-badge {
            background: var(--primary); color: white;
            padding: 0.3rem 0.8rem; border-radius: var(--radius);
            font-size: 0.8rem; font-weight: 500;
        }

        .detection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem; margin-bottom: 2rem;
        }

        .video-container {
            position: relative; width: 100%; height: 400px;
            background: #000; border-radius: var(--radius); overflow: hidden;
        }

        .video-feed {
            width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1);
        }

        .face-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        .skin-analysis-panel {
            background: #f8f9fa; padding: 1.5rem;
            border-radius: var(--radius); border: 1px solid var(--border);
        }

        .lab-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem; margin-bottom: 1.5rem;
        }

        .lab-value {
            text-align: center; padding: 1rem;
            background: white; border-radius: var(--radius);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .lab-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .lab-number { font-size: 1.8rem; font-weight: bold; color: var(--primary); }

        .sample-info { text-align: center; margin-bottom: 1rem; }
        .sample-count {
            background: var(--primary); color: white;
            padding: 0.5rem 1rem; border-radius: 20px;
            font-weight: 600; display: inline-block;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem; margin: 1.5rem 0;
        }

        .btn {
            padding: 0.8rem 1.5rem; border-radius: var(--radius);
            font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease;
            border: none; text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: white; color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ë“œë˜ì´í•‘ ì „ì²´í™”ë©´ */
        .draping-fullscreen {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #000; z-index: 1000; color: white;
        }
        .draping-fullscreen.active { display: flex; flex-direction: column; }

        .draping-header {
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 2rem; box-shadow: var(--shadow-lg);
        }

        .draping-title { font-size: 1.3rem; font-weight: 600; }
        .draping-controls { display: flex; gap: 0.5rem; }

        .draping-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 0.5rem 1rem;
            border-radius: var(--radius); cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s ease;
        }
        .draping-btn:hover { background: rgba(255, 255, 255, 0.3); }

        .draping-content { flex: 1; display: flex; }
        .draping-video-area { flex: 2; position: relative; background: #000; }
        .draping-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .virtual-fabric-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 10;
        }

        .virtual-fabric {
            position: absolute; border-radius: 15px; opacity: 0.8;
            transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary);
        }

        .draping-panel {
            flex: 1; background: rgba(0, 0, 0, 0.9);
            padding: 2rem; overflow-y: auto; min-width: 400px;
        }

        .panel-section { margin-bottom: 2rem; }
        .panel-section h4 {
            font-size: 1.1rem; margin-bottom: 1rem;
            color: var(--primary-light);
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            padding-bottom: 0.5rem;
        }

        .season-selector {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem; margin-bottom: 1rem;
        }

        .season-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 0.6rem; border-radius: var(--radius);
            cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;
            text-align: center;
        }

        .season-btn.active,
        .season-btn:hover {
            background: var(--primary); border-color: var(--primary);
            transform: translateY(-1px);
        }

        .color-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;
        }

        .color-item {
            aspect-ratio: 1; border-radius: var(--radius);
            cursor: pointer; border: 2px solid transparent;
            transition: all 0.3s ease; position: relative;
        }

        .color-item:hover,
        .color-item.selected {
            border-color: white; transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            z-index: 10;
        }

        .live-analysis {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius); padding: 1.5rem; text-align: center;
        }

        .delta-display { margin-bottom: 1rem; }
        .delta-value {
            font-size: 3rem; font-weight: 800;
            margin-bottom: 0.5rem; color: #fff;
        }
        .delta-description {
            font-size: 1rem; font-weight: 500; margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .delta-score {
            display: flex; align-items: center;
            gap: 1rem; margin-top: 1rem;
        }

        .score-gauge {
            flex: 1; height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px; overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px; transition: width 0.6s ease;
        }

        .score-text {
            font-size: 0.9rem; font-weight: 600;
            min-width: 60px; color: white;
        }

        /* ê³ ê° ê´€ë¦¬ ì„¹ì…˜ */
        .customer-management {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2rem; margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }
        .customer-management.active { display: block; }

        .customer-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-label {
            font-size: 0.9rem; font-weight: 500;
            margin-bottom: 0.5rem; color: var(--text);
        }

        .form-input {
            padding: 0.8rem; border: 1px solid var(--border);
            border-radius: var(--radius); font-size: 0.9rem;
            transition: border-color 0.2s ease; background: white;
        }

        .form-input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea { resize: vertical; min-height: 100px; }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 2rem;
        }

        .history-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.85rem; background: white;
            border-radius: var(--radius); overflow: hidden;
            box-shadow: var(--shadow);
        }

        .history-table th,
        .history-table td {
            text-align: left; padding: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        .history-table th {
            background: var(--bg-light);
            font-weight: 600; color: var(--text);
        }

        .history-table tr:hover { background: var(--bg-light); }

        /* ë¸Œëœë“œ ì„¹ì…˜ */
        .brand-section {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border-radius: var(--radius); padding: 1.5rem; margin-top: 1rem;
        }

        .brand-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius); padding: 1rem; margin-bottom: 0.8rem;
            border-left: 3px solid var(--primary);
        }

        .brand-name { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
        .brand-products { font-size: 0.8rem; color: var(--text-light); }

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast-container {
            position: fixed; top: 20px; right: 20px;
            z-index: 9999; pointer-events: none;
        }

        .toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            margin-bottom: 0.5rem; padding: 1rem 1.5rem;
            pointer-events: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
            max-width: 380px;
            display: flex; align-items: center; gap: 0.8rem;
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--info); }

        .toast-icon { font-size: 1.3rem; }
        .toast-content { flex: 1; }
        .toast-message { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.2rem; }
        .toast-submessage { font-size: 0.75rem; color: var(--text-light); }

        .toast-close {
            background: none; border: none; font-size: 1.3rem;
            cursor: pointer; color: var(--text-light);
            padding: 0.2rem; border-radius: 50%;
            transition: all 0.2s ease;
        }
        .toast-close:hover { color: var(--text); background: var(--bg-light); }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .draping-content { flex-direction: column; }
            .draping-panel {
                height: 50vh; border-top: 1px solid var(--primary);
                min-width: auto;
            }
            .detection-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .main-content { padding: 1rem; }
            .header-top { flex-direction: column; gap: 1rem; text-align: center; }
            .mode-cards, .customer-form, .action-buttons { grid-template-columns: 1fr; }
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>
    <!-- ë¡œë”© ìŠ¤í¬ë¦° -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <h1>Personal Color AI Pro</h1>
                <p>ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ DB - í—¤ì–´ìƒµ í˜„ì¥ìš© ì™„ì „ ì‹œìŠ¤í…œ</p>
            </div>
            
            <div class="loading-progress-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
            <div class="loading-message" id="loading-message">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step-mediapipe">MediaPipe Face Mesh ì‹¤ì œ ì—°ê²° ì¤‘...</div>
                <div class="loading-step" id="step-tensorflow">TensorFlow.js ëª¨ë¸ ë¡œë”© ì¤‘...</div>
                <div class="loading-step" id="step-deltae">Delta E 2000 ê³„ì‚° ì—”ì§„ ì¤€ë¹„ ì¤‘...</div>
                <div class="loading-step" id="step-skin">ì‹¤ì œ í”¼ë¶€í†¤ ì¶”ì¶œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
                <div class="loading-step" id="step-database">ì „ë¬¸ ë¸Œëœë“œ DB ë¡œë“œ ì¤‘...</div>
                <div class="loading-step" id="step-customer">ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
                <div class="loading-step" id="step-ui">UI ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="main-app" id="main-app">
        <!-- í—¤ë” -->
        <header class="app-header">
            <div class="header-top">
                <div>
                    <h1 class="app-title">Personal Color AI Pro</h1>
                    <div class="app-subtitle">ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ í†µí•© - í—¤ì–´ìƒµ í˜„ì¥ìš© ì™„ì „ ì‹œìŠ¤í…œ</div>
                </div>
                <div class="header-status">
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        MediaPipe: <span id="mediapipe-status">ì—°ê²° ì¤‘</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        ì§„ë‹¨ ì™„ë£Œ: <span id="diagnosis-count">0</span>íšŒ
                    </div>
                    <div class="status-item">
                        <span class="status-indicator"></span>
                        ê³ ê° ìˆ˜: <span id="customer-count">0</span>ëª…
                    </div>
                </div>
            </div>
            
            <div class="header-controls">
                <button class="header-btn" id="face-detection-btn">ì‹¤ì œ ì–¼êµ´ê°ì§€</button>
                <button class="header-btn" id="draping-mode-btn">ê°€ìƒ ë“œë˜ì´í•‘</button>
                <button class="header-btn" id="customer-management-btn">ê³ ê° ê´€ë¦¬</button>
                <button class="header-btn" id="brand-db-btn">ë¸Œëœë“œ DB</button>
                <button class="header-btn" id="export-data-btn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                <button class="header-btn" id="system-status-btn">ì‹œìŠ¤í…œ ìƒíƒœ</button>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- ëª¨ë“œ ì„ íƒ -->
            <section class="mode-selection" id="mode-selection">
                <h2>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ëª¨ë“œ ì„ íƒ</h2>
                <div class="mode-cards">
                    <div class="mode-card" data-mode="face-detection">
                        <div class="mode-icon">ğŸ”¬</div>
                        <h3>ì‹¤ì œ MediaPipe ì–¼êµ´ê°ì§€</h3>
                        <p><strong>ì§„ì§œ MediaPipe FaceMesh 468í¬ì¸íŠ¸ ê°ì§€</strong><br>
                        ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ â†’ CIE Lab ë³€í™˜ â†’ Delta E ê³„ì‚°<br>
                        ë” ì´ìƒ ì‹œë®¬ë ˆì´ì…˜ ì•„ë‹˜!</p>
                        <div class="mode-accuracy">ì‹¤ì œ ê°ì§€</div>
                        <button class="mode-btn">ì‹¤ì œ ì–¼êµ´ê°ì§€ ì‹œì‘</button>
                    </div>
                    
                    <div class="mode-card" data-mode="draping">
                        <div class="mode-icon">ğŸ­</div>
                        <h3>ê°€ìƒ ë“œë˜ì´í•‘ + ë¸Œëœë“œ DB</h3>
                        <p><strong>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ + ì „ë¬¸ ë¸Œëœë“œ ì¶”ì²œ</strong><br>
                        ë¡œë ˆì•ŒÂ·ì›°ë¼Â·ìŠˆë°”ë¥´ì¸ ì½”í”„Â·ë°€ë³¸ ì—¼ëª¨ì œ DB<br>
                        ì‹¤ì œ ìƒ‰ìƒì½”ë“œì™€ Delta E ë§¤ì¹­</p>
                        <div class="mode-accuracy">ì „ë¬¸ ë¸Œëœë“œ</div>
                        <button class="mode-btn">ë“œë˜ì´í•‘ ì‹œì‘</button>
                    </div>
                    
                    <div class="mode-card" data-mode="customer">
                        <div class="mode-icon">ğŸ‘¥</div>
                        <h3>ì™„ì „í•œ ê³ ê° ê´€ë¦¬</h3>
                        <p><strong>ì§„ë‹¨ â†’ ì €ì¥ â†’ ê´€ë¦¬ â†’ PDF ì¶œë ¥</strong><br>
                        ê³ ê°ë³„ ì§„ë‹¨ íˆìŠ¤í† ë¦¬ ê´€ë¦¬<br>
                        ë¸Œëœë“œë³„ ì¶”ì²œì„œ ë° ë³´ê³ ì„œ ìƒì„±</p>
                        <div class="mode-accuracy">ì™„ì „ ê´€ë¦¬</div>
                        <button class="mode-btn">ê³ ê° ê´€ë¦¬ ì‹œì‘</button>
                    </div>
                </div>
            </section>

            <!-- ì‹¤ì œ ì–¼êµ´ê°ì§€ ì„¹ì…˜ -->
            <section class="face-detection-section" id="face-detection-section">
                <div class="section-header">
                    <h3 class="section-title">ì‹¤ì œ MediaPipe ì–¼êµ´ê°ì§€ + í”¼ë¶€í†¤ ì¶”ì¶œ</h3>
                    <div class="section-badge">MediaPipe Active</div>
                </div>
                
                <div class="detection-grid">
                    <div class="video-container">
                        <video class="video-feed" id="video-feed" autoplay muted playsinline></video>
                        <canvas class="face-overlay" id="face-overlay"></canvas>
                    </div>
                    
                    <div class="skin-analysis-panel">
                        <h4>ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„ (ì‹¤ì œ í”½ì…€)</h4>
                        
                        <div class="sample-info">
                            <div class="sample-count" id="sample-counter">0ê°œ í”½ì…€</div>
                            <p id="detection-status">ì–¼êµ´ì„ í™”ë©´ì— ë§ì¶°ì£¼ì„¸ìš”</p>
                        </div>
                        
                        <div class="lab-display">
                            <div class="lab-value">
                                <div class="lab-label">L* (ëª…ë„)</div>
                                <div class="lab-number" id="l-value">--</div>
                            </div>
                            <div class="lab-value">
                                <div class="lab-label">a* (ë¹¨ê°•-ì´ˆë¡)</div>
                                <div class="lab-number" id="a-value">--</div>
                            </div>
                            <div class="lab-value">
                                <div class="lab-label">b* (ë…¸ë‘-íŒŒë‘)</div>
                                <div class="lab-number" id="b-value">--</div>
                            </div>
                        </div>
                        
                        <div class="live-analysis">
                            <h5>ì‹¤ì‹œê°„ ìƒ‰ìƒ ë§¤ì¹­ í…ŒìŠ¤íŠ¸</h5>
                            <div class="delta-display">
                                <div class="delta-value" id="face-delta-value">--.-</div>
                                <div class="delta-description" id="face-delta-description">ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>
                            </div>
                            
                            <div class="controls-grid" style="margin-top: 1rem;">
                                <button class="btn btn-secondary" style="background: #ff6b6b;" onclick="testFaceColor(255, 107, 107, 'ë´„ ì½”ë„')">ë´„ ì½”ë„</button>
                                <button class="btn btn-secondary" style="background: #4ecdc4; color: white;" onclick="testFaceColor(78, 205, 196, 'ì—¬ë¦„ ë¯¼íŠ¸')">ì—¬ë¦„ ë¯¼íŠ¸</button>
                                <button class="btn btn-secondary" style="background: #d4af37; color: white;" onclick="testFaceColor(212, 175, 55, 'ê°€ì„ ê³¨ë“œ')">ê°€ì„ ê³¨ë“œ</button>
                                <button class="btn btn-secondary" style="background: #2c3e50; color: white;" onclick="testFaceColor(44, 62, 80, 'ê²¨ìš¸ ë„¤ì´ë¹„')">ê²¨ìš¸ ë„¤ì´ë¹„</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="controls-grid">
                    <button class="btn btn-primary" id="start-camera-btn">ì¹´ë©”ë¼ ì‹œì‘</button>
                    <button class="btn btn-secondary" id="analyze-skin-btn" disabled>í”¼ë¶€í†¤ ë¶„ì„</button>
                    <button class="btn btn-secondary" id="reset-detection-btn">ì´ˆê¸°í™”</button>
                    <button class="btn btn-secondary" id="save-face-result-btn" disabled>ê²°ê³¼ ì €ì¥</button>
                </div>
            </section>

            <!-- ê³ ê° ê´€ë¦¬ ì„¹ì…˜ -->
            <section class="customer-management" id="customer-management">
                <div class="section-header">
                    <h3 class="section-title">ì™„ì „í•œ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ</h3>
                    <div class="section-badge">Professional</div>
                </div>
                
                <form class="customer-form" id="customer-form">
                    <div class="form-group">
                        <label class="form-label">ê³ ê° ì´ë¦„ *</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="í™ê¸¸ë™" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì—°ë½ì²˜</label>
                        <input type="tel" class="form-input" id="customer-phone" placeholder="010-0000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë‚˜ì´</label>
                        <input type="number" class="form-input" id="customer-age" min="1" max="120" placeholder="25">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„±ë³„</label>
                        <select class="form-input" id="customer-gender">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="female">ì—¬ì„±</option>
                            <option value="male">ë‚¨ì„±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë°©ë¬¸ ëª©ì </label>
                        <select class="form-input" id="visit-purpose">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="hair-color">í—¤ì–´ ì—¼ìƒ‰ ìƒë‹´</option>
                            <option value="personal-color">í¼ìŠ¤ë„ ì»¬ëŸ¬ ì§„ë‹¨</option>
                            <option value="makeup">ë©”ì´í¬ì—… ìƒë‹´</option>
                            <option value="total-styling">í† íƒˆ ìŠ¤íƒ€ì¼ë§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">íŠ¹ì´ì‚¬í•­</label>
                        <textarea class="form-input form-textarea" id="customer-notes" placeholder="ì•Œë ˆë¥´ê¸°, ì„ í˜¸ ìƒ‰ìƒ, ê¸°íƒ€ ìš”ì²­ì‚¬í•­"></textarea>
                    </div>
                </form>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="save-customer-btn">ê³ ê° ì •ë³´ ì €ì¥</button>
                    <button class="btn btn-secondary" id="clear-customer-btn">ì •ë³´ ì´ˆê¸°í™”</button>
                    <button class="btn btn-secondary" id="export-pdf-btn">PDF ë³´ê³ ì„œ ìƒì„±</button>
                    <button class="btn btn-secondary" id="export-customer-btn">ê³ ê° ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                </div>
                
                <div class="panel-section">
                    <h4>ìµœê·¼ ì§„ë‹¨ ì´ë ¥</h4>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ê³ ê°ëª…</th>
                                <th>ì§„ë‹¨ ê²°ê³¼</th>
                                <th>ë°©ë¬¸ ëª©ì </th>
                                <th>Delta E</th>
                                <th>ë¸Œëœë“œ ì¶”ì²œ</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="customer-history-body">
                            <!-- ì§„ë‹¨ ì´ë ¥ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- ê°€ìƒ ë“œë˜ì´í•‘ ì „ì²´í™”ë©´ -->
    <div class="draping-fullscreen" id="draping-fullscreen">
        <div class="draping-header">
            <div class="draping-title">ê°€ìƒ ë“œë˜ì´í•‘ + ì „ë¬¸ ë¸Œëœë“œ DB</div>
            <div class="draping-controls">
                <button class="draping-btn" id="capture-draping-btn">ğŸ“· ìº¡ì²˜</button>
                <button class="draping-btn" id="reset-draping-btn">ğŸ”„ ë¦¬ì…‹</button>
                <button class="draping-btn" id="save-draping-result-btn">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
                <button class="draping-btn" id="close-draping-btn">âœ• ë‹«ê¸°</button>
            </div>
        </div>
        
        <div class="draping-content">
            <div class="draping-video-area">
                <video class="draping-video" id="draping-video" autoplay muted playsinline></video>
                <div class="virtual-fabric-overlay" id="virtual-fabric-overlay"></div>
            </div>
            
            <div class="draping-panel">
                <div class="panel-section">
                    <h4>ğŸ¨ ê³„ì ˆë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</h4>
                    <div class="season-selector">
                        <button class="season-btn active" data-season="spring">ë´„ (Spring)</button>
                        <button class="season-btn" data-season="summer">ì—¬ë¦„ (Summer)</button>
                        <button class="season-btn" data-season="autumn">ê°€ì„ (Autumn)</button>
                        <button class="season-btn" data-season="winter">ê²¨ìš¸ (Winter)</button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h4>ìƒ‰ìƒ ì„ íƒ</h4>
                    <div class="color-grid" id="draping-color-grid"></div>
                </div>
                
                <div class="panel-section">
                    <h4>ğŸ“Š ì‹¤ì‹œê°„ Delta E ë¶„ì„</h4>
                    <div class="live-analysis">
                        <div class="delta-display">
                            <div class="delta-value" id="live-delta-value">--.-</div>
                            <div class="delta-description" id="live-delta-description">ìƒ‰ìƒ ì„ íƒ ì‹œ ì‹¤ì‹œê°„ ë§¤ì¹­</div>
                        </div>
                        <div class="delta-score">
                            <div class="score-gauge">
                                <div class="score-fill" id="live-score-fill" style="width: 0%;"></div>
                            </div>
                            <div class="score-text" id="live-score-text">0ì </div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h4>ğŸ·ï¸ ì „ë¬¸ ë¸Œëœë“œ ì¶”ì²œ</h4>
                    <div class="brand-section" id="brand-recommendations">
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                            ìƒ‰ìƒ ì„ íƒ ì‹œ ë§ì¶¤ ë¸Œëœë“œ ì œí’ˆì´ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        /**
         * ğŸ¯ ì‹¤ì œ ì‘ë™í•˜ëŠ” MediaPipe + ì „ë¬¸ ë¸Œëœë“œ DB í†µí•© ì‹œìŠ¤í…œ
         * - ì§„ì§œ MediaPipe FaceMesh ì—°ê²°
         * - ì‹¤ì œ 468í¬ì¸íŠ¸ ëœë“œë§ˆí¬ ì‚¬ìš©
         * - ì§„ì§œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ ë° Lab ë³€í™˜
         * - ì „ë¬¸ ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ ì™„ì „ í†µí•©
         * - ì™„ì „í•œ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ
         */
        
        // ì „ì—­ ì‹œìŠ¤í…œ ìƒíƒœ ê´€ë¦¬
        window.PersonalColorSystem = {
            version: 'COMPLETE-WORKING-v1.0',
            isLoaded: false,
            startTime: Date.now(),
            
            // ì‹¤ì œ AI ì‹œìŠ¤í…œ
            ai: {
                deltaE: null,              // Delta E 2000 ê³„ì‚° ì—”ì§„
                faceMesh: null,            // MediaPipe Face Mesh
                skinAnalyzer: null,        // í”¼ë¶€í†¤ ë¶„ì„ê¸°
                isMediaPipeReady: false    // MediaPipe ì¤€ë¹„ ìƒíƒœ
            },
            
            // í˜„ì¬ ìƒíƒœ
            currentMode: 'selection',
            currentCustomer: null,
            currentSkinTone: null,
            customerManager: null,
            drapingEngine: null,
            faceDetectionEngine: null,
            
            // ì„±ëŠ¥ í†µê³„
            performance: {
                totalAnalyses: 0,
                deltaECalculations: 0,
                customersServed: 0,
                mediaipeDetections: 0
            }
        };

        /**
         * ğŸ¨ ì „ë¬¸ ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤ì œ í˜„ì¥ ë°ì´í„°)
         * ë¡œë ˆì•Œ, ì›°ë¼, ìŠˆë°”ë¥´ì¸ ì½”í”„, ë°€ë³¸ 4ê°œ ë¸Œëœë“œ ì™„ì „ í†µí•©
         */
        const PROFESSIONAL_BRAND_DATABASE = {
            // ë¡œë ˆì•Œ í”„ë¡œí˜ì…”ë„ (35% ì‹œì¥ì ìœ ìœ¨)
            loreal: {
                name: "L'OrÃ©al Professional",
                country: "France",
                marketShare: 35,
                notation: "level.reflection",
                colors: {
                    spring: [
                        {code: '6.3', name: 'ë‹¤í¬ ê³¨ë“  ë¸”ë¡ ë“œ', hex: '#B8860B', lab: {L: 65, a: 8, b: 28}, cmyk: {c: 15, m: 25, y: 85, k: 10}},
                        {code: '7.3', name: 'ë¯¸ë””ì›€ ê³¨ë“  ë¸”ë¡ ë“œ', hex: '#DAA520', lab: {L: 70, a: 12, b: 35}, cmyk: {c: 10, m: 20, y: 90, k: 5}},
                        {code: '8.31', name: 'ë¼ì´íŠ¸ ê³¨ë“  ì• ì‰¬', hex: '#F0E68C', lab: {L: 85, a: 5, b: 25}, cmyk: {c: 5, m: 8, y: 45, k: 0}},
                        {code: '5.43', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´ ì¹´í¼', hex: '#CD853F', lab: {L: 60, a: 15, b: 30}, cmyk: {c: 20, m: 35, y: 75, k: 15}}
                    ],
                    summer: [
                        {code: '6.1', name: 'ë‹¤í¬ ì• ì‰¬ ë¸”ë¡ ë“œ', hex: '#8FBC8F', lab: {L: 65, a: -5, b: 8}, cmyk: {c: 25, m: 5, y: 25, k: 15}},
                        {code: '7.1', name: 'ë¯¸ë””ì›€ ì• ì‰¬', hex: '#B0C4DE', lab: {L: 70, a: -3, b: -8}, cmyk: {c: 30, m: 15, y: 5, k: 5}},
                        {code: '9.1', name: 'ë² ë¦¬ ë¼ì´íŠ¸ ì• ì‰¬', hex: '#E6E6FA', lab: {L: 88, a: 2, b: -5}, cmyk: {c: 8, m: 8, y: 0, k: 0}},
                        {code: '8.12', name: 'ë¼ì´íŠ¸ ì• ì‰¬ ë°”ì´ì˜¬ë ›', hex: '#DDA0DD', lab: {L: 78, a: 8, b: -12}, cmyk: {c: 15, m: 25, y: 0, k: 0}}
                    ],
                    autumn: [
                        {code: '4.35', name: 'ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', hex: '#8B4513', lab: {L: 40, a: 18, b: 25}, cmyk: {c: 30, m: 65, y: 90, k: 25}},
                        {code: '5.35', name: 'ë¼ì´íŠ¸ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', hex: '#A0522D', lab: {L: 50, a: 20, b: 30}, cmyk: {c: 25, m: 60, y: 85, k: 20}},
                        {code: '6.66', name: 'ë‹¤í¬ ë ˆë“œ', hex: '#693E2D', lab: {L: 32, a: 25, b: 20}, cmyk: {c: 62, m: 80, y: 72, k: 36}},
                        {code: '7.77', name: 'ì¸í…ìŠ¤ ë ˆë“œ', hex: '#B22222', lab: {L: 45, a: 45, b: 25}, cmyk: {c: 25, m: 85, y: 85, k: 10}}
                    ],
                    winter: [
                        {code: '1.0', name: 'ë¸”ë™', hex: '#000000', lab: {L: 10, a: 0, b: 0}, cmyk: {c: 30, m: 30, y: 30, k: 100}},
                        {code: '2.0', name: 'ë¸Œë£¨ë„¤íŠ¸', hex: '#2F4F4F', lab: {L: 25, a: 0, b: -3}, cmyk: {c: 45, m: 20, y: 20, k: 70}},
                        {code: '4.15', name: 'ì• ì‰¬ ë¸Œë¼ìš´', hex: '#696969', lab: {L: 45, a: 0, b: 0}, cmyk: {c: 30, m: 25, y: 25, k: 50}},
                        {code: '6.22', name: 'ì¸í…ìŠ¤ ë°”ì´ì˜¬ë ›', hex: '#4B0082', lab: {L: 20, a: 15, b: -25}, cmyk: {c: 65, m: 100, y: 0, k: 45}}
                    ]
                }
            },
            
            // ì›°ë¼ í”„ë¡œí˜ì…”ë„ (25% ì‹œì¥ì ìœ ìœ¨, 140ë…„ ì „í†µ)
            wella: {
                name: "Wella Professionals",
                country: "Germany",
                marketShare: 25,
                notation: "level/reflection",
                colors: {
                    spring: [
                        {code: '6/3', name: 'ë‹¤í¬ ê³¨ë“ ', hex: '#B8860B', lab: {L: 63, a: 10, b: 30}, cmyk: {c: 12, m: 28, y: 88, k: 8}},
                        {code: '7/3', name: 'ë¯¸ë””ì›€ ê³¨ë“ ', hex: '#DAA520', lab: {L: 72, a: 8, b: 32}, cmyk: {c: 8, m: 18, y: 92, k: 3}},
                        {code: '8/3', name: 'ë¼ì´íŠ¸ ê³¨ë“ ', hex: '#F0E68C', lab: {L: 82, a: 3, b: 28}, cmyk: {c: 3, m: 5, y: 48, k: 0}},
                        {code: '9/44', name: 'ì¸í…ìŠ¤ ì¹´í¼', hex: '#FF8C69', lab: {L: 75, a: 25, b: 35}, cmyk: {c: 0, m: 45, y: 58, k: 0}}
                    ],
                    summer: [
                        {code: '6/1', name: 'ë‹¤í¬ ì• ì‰¬', hex: '#8FBC8F', lab: {L: 68, a: -8, b: 5}, cmyk: {c: 28, m: 2, y: 28, k: 12}},
                        {code: '8/1', name: 'ë¼ì´íŠ¸ ì• ì‰¬', hex: '#C0C0C0', lab: {L: 78, a: 0, b: 0}, cmyk: {c: 25, m: 18, y: 18, k: 2}},
                        {code: '10/6', name: 'ë°”ì´ì˜¬ë ›', hex: '#DDA0DD', lab: {L: 82, a: 12, b: -8}, cmyk: {c: 12, m: 28, y: 0, k: 0}},
                        {code: '9/16', name: 'ì• ì‰¬ ë°”ì´ì˜¬ë ›', hex: '#E6E6FA', lab: {L: 85, a: 5, b: -12}, cmyk: {c: 10, m: 10, y: 0, k: 0}}
                    ],
                    autumn: [
                        {code: '5/7', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´ ë ˆë“œ', hex: '#A0522D', lab: {L: 48, a: 22, b: 28}, cmyk: {c: 28, m: 62, y: 88, k: 22}},
                        {code: '6/77', name: 'ì¸í…ìŠ¤ ë ˆë“œ', hex: '#B22222', lab: {L: 42, a: 48, b: 28}, cmyk: {c: 22, m: 88, y: 88, k: 12}},
                        {code: '7/71', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´ ì• ì‰¬', hex: '#8B4513', lab: {L: 52, a: 18, b: 22}, cmyk: {c: 32, m: 68, y: 92, k: 28}},
                        {code: '4/77', name: 'ì¸í…ìŠ¤ ë¸Œë¼ìš´ ë ˆë“œ', hex: '#800000', lab: {L: 25, a: 40, b: 20}, cmyk: {c: 35, m: 100, y: 100, k: 45}}
                    ],
                    winter: [
                        {code: '2/0', name: 'ë¸”ë™ ë¸Œë¼ìš´', hex: '#2F2F2F', lab: {L: 22, a: 0, b: 0}, cmyk: {c: 35, m: 35, y: 35, k: 80}},
                        {code: '4/0', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´', hex: '#654321', lab: {L: 35, a: 8, b: 15}, cmyk: {c: 35, m: 45, y: 75, k: 55}},
                        {code: '6/0', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ', hex: '#8B7355', lab: {L: 52, a: 5, b: 18}, cmyk: {c: 22, m: 32, y: 58, k: 28}},
                        {code: '1/0', name: 'ë¸”ë™', hex: '#000000', lab: {L: 8, a: 0, b: 0}, cmyk: {c: 30, m: 30, y: 30, k: 100}}
                    ]
                }
            },
            
            // ìŠˆë°”ë¥´ì¸ ì½”í”„ (ë…ì¼ í”„ë¦¬ë¯¸ì—„)
            schwarzkopf: {
                name: "Schwarzkopf Professional",
                country: "Germany",
                marketShare: 15,
                notation: "level-reflection",
                colors: {
                    spring: [
                        {code: '6-46', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ë¹„ì¦ˆ', hex: '#DEB887', lab: {L: 75, a: 8, b: 25}, cmyk: {c: 8, m: 18, y: 42, k: 2}},
                        {code: '7-77', name: 'ë¯¸ë””ì›€ ë¸”ë¡ ë“œ ì¸í…ìŠ¤', hex: '#D2B48C', lab: {L: 78, a: 12, b: 22}, cmyk: {c: 5, m: 18, y: 38, k: 0}},
                        {code: '8-00', name: 'ë¼ì´íŠ¸ ë¸”ë¡ ë“œ', hex: '#F5DEB3', lab: {L: 88, a: 2, b: 18}, cmyk: {c: 2, m: 8, y: 28, k: 0}},
                        {code: '5-65', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´ ê³¨ë“ ', hex: '#CD853F', lab: {L: 62, a: 12, b: 28}, cmyk: {c: 18, m: 35, y: 75, k: 12}}
                    ],
                    summer: [
                        {code: '7-1', name: 'ë¯¸ë””ì›€ ë¸”ë¡ ë“œ ì• ì‰¬', hex: '#B0C4DE', lab: {L: 72, a: -2, b: -5}, cmyk: {c: 28, m: 12, y: 2, k: 2}},
                        {code: '9-1', name: 'ë² ë¦¬ ë¼ì´íŠ¸ ì• ì‰¬', hex: '#E0E0E0', lab: {L: 88, a: 0, b: 0}, cmyk: {c: 12, m: 8, y: 8, k: 0}},
                        {code: '8-18', name: 'ë¼ì´íŠ¸ ì• ì‰¬ í„', hex: '#D3D3D3', lab: {L: 82, a: 0, b: -2}, cmyk: {c: 18, m: 12, y: 12, k: 0}},
                        {code: '6-12', name: 'ì• ì‰¬ ë°”ì´ì˜¬ë ›', hex: '#9370DB', lab: {L: 65, a: 8, b: -15}, cmyk: {c: 35, m: 45, y: 0, k: 8}}
                    ],
                    autumn: [
                        {code: '4-68', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´', hex: '#8B4513', lab: {L: 42, a: 18, b: 25}, cmyk: {c: 32, m: 65, y: 92, k: 28}},
                        {code: '5-7', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´ ì¹´í¼', hex: '#CD853F', lab: {L: 58, a: 15, b: 28}, cmyk: {c: 22, m: 38, y: 78, k: 15}},
                        {code: '6-77', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ì¹´í¼', hex: '#A0522D', lab: {L: 48, a: 22, b: 28}, cmyk: {c: 28, m: 62, y: 88, k: 22}},
                        {code: '7-88', name: 'ë¯¸ë””ì›€ ë¸”ë¡ ë“œ', hex: '#B8860B', lab: {L: 65, a: 12, b: 32}, cmyk: {c: 15, m: 28, y: 88, k: 8}}
                    ],
                    winter: [
                        {code: '1-0', name: 'ë¸”ë™', hex: '#000000', lab: {L: 8, a: 0, b: 0}, cmyk: {c: 30, m: 30, y: 30, k: 100}},
                        {code: '3-0', name: 'ë‹¤í¬ ë¸Œë¼ìš´', hex: '#2F2F2F', lab: {L: 22, a: 2, b: 2}, cmyk: {c: 35, m: 35, y: 35, k: 80}},
                        {code: '4-0', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´', hex: '#654321', lab: {L: 35, a: 8, b: 15}, cmyk: {c: 35, m: 45, y: 75, k: 55}},
                        {code: '5-0', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´', hex: '#8B7355', lab: {L: 52, a: 5, b: 18}, cmyk: {c: 22, m: 32, y: 58, k: 28}}
                    ]
                }
            },
            
            // ë°€ë³¸ (ì¼ë³¸ í”„ë¦¬ë¯¸ì—„, ì•„ì‹œì•„ì¸ íŠ¹í™”)
            milbon: {
                name: "Milbon Professional",
                country: "Japan", 
                marketShare: 20,
                notation: "level-reflection",
                colors: {
                    spring: [
                        {code: '6-30', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ì˜ë¡œìš°', hex: '#DAA520', lab: {L: 68, a: 8, b: 30}, cmyk: {c: 12, m: 22, y: 88, k: 5}},
                        {code: '7-30', name: 'ë¯¸ë””ì›€ ë¸”ë¡ ë“œ ì˜ë¡œìš°', hex: '#F0E68C', lab: {L: 82, a: 5, b: 28}, cmyk: {c: 5, m: 8, y: 45, k: 0}},
                        {code: '8-30', name: 'ë¼ì´íŠ¸ ë¸”ë¡ ë“œ ì˜ë¡œìš°', hex: '#FFFFE0', lab: {L: 95, a: -2, b: 15}, cmyk: {c: 2, m: 0, y: 12, k: 0}},
                        {code: '9-50', name: 'ë² ë¦¬ ë¼ì´íŠ¸ ë ˆë“œ', hex: '#FFA07A', lab: {L: 78, a: 20, b: 25}, cmyk: {c: 0, m: 38, y: 52, k: 0}}
                    ],
                    summer: [
                        {code: '6-10', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ì• ì‰¬', hex: '#8FBC8F', lab: {L: 68, a: -5, b: 8}, cmyk: {c: 25, m: 2, y: 25, k: 15}},
                        {code: '8-10', name: 'ë¼ì´íŠ¸ ë¸”ë¡ ë“œ ì• ì‰¬', hex: '#C0C0C0', lab: {L: 78, a: 0, b: 0}, cmyk: {c: 25, m: 18, y: 18, k: 2}},
                        {code: '9-60', name: 'ë² ë¦¬ ë¼ì´íŠ¸ ë°”ì´ì˜¬ë ›', hex: '#DDA0DD', lab: {L: 82, a: 12, b: -8}, cmyk: {c: 12, m: 28, y: 0, k: 0}},
                        {code: '13-10', name: 'í•˜ì´ ë¦¬í”„íŠ¸ ì• ì‰¬', hex: '#F5F5F5', lab: {L: 95, a: 0, b: 0}, cmyk: {c: 5, m: 2, y: 2, k: 0}}
                    ],
                    autumn: [
                        {code: '5-40', name: 'ë¼ì´íŠ¸ ë¸Œë¼ìš´ ì˜¤ë Œì§€', hex: '#CD853F', lab: {L: 58, a: 15, b: 28}, cmyk: {c: 22, m: 38, y: 78, k: 15}},
                        {code: '6-50', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ë ˆë“œ', hex: '#A0522D', lab: {L: 48, a: 22, b: 28}, cmyk: {c: 28, m: 62, y: 88, k: 22}},
                        {code: '7-50', name: 'ë¯¸ë””ì›€ ë¸”ë¡ ë“œ ë ˆë“œ', hex: '#B22222', lab: {L: 42, a: 48, b: 28}, cmyk: {c: 22, m: 88, y: 88, k: 12}},
                        {code: '4-70', name: 'ë¯¸ë””ì›€ ë¸Œë¼ìš´ ë ˆë“œ', hex: '#8B0000', lab: {L: 25, a: 45, b: 25}, cmyk: {c: 28, m: 100, y: 100, k: 45}}
                    ],
                    winter: [
                        {code: 'NB-1', name: 'ë‚´ì¶”ëŸ´ ë¸”ë™', hex: '#000000', lab: {L: 8, a: 0, b: 0}, cmyk: {c: 30, m: 30, y: 30, k: 100}},
                        {code: '3-NB', name: 'ë‹¤í¬ ë‚´ì¶”ëŸ´ ë¸Œë¼ìš´', hex: '#2F2F2F', lab: {L: 22, a: 2, b: 2}, cmyk: {c: 35, m: 35, y: 35, k: 80}},
                        {code: '5-NB', name: 'ë¼ì´íŠ¸ ë‚´ì¶”ëŸ´ ë¸Œë¼ìš´', hex: '#654321', lab: {L: 42, a: 8, b: 15}, cmyk: {c: 35, m: 45, y: 75, k: 50}},
                        {code: '6-20', name: 'ë‹¤í¬ ë¸”ë¡ ë“œ ê·¸ë¦°', hex: '#556B2F', lab: {L: 45, a: -8, b: 15}, cmyk: {c: 45, m: 22, y: 88, k: 35}}
                    ]
                }
            }
        };

        /**
         * ğŸ¨ 4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (í•œêµ­ì¸ íŠ¹í™”)
         */
        const SEASON_COLOR_PALETTES = {
            spring: {
                name: 'ë´„ ì›œí†¤ (Spring)',
                colors: [
                    '#FF6B6B', '#FF8E53', '#FF6B35', '#F39C12', '#E67E22', '#D68910',
                    '#F4D03F', '#F7DC6F', '#85C1E9', '#7FB3D3', '#52C41A', '#73D13D',
                    '#40E0D0', '#48CAE4', '#FFC0CB', '#FFB6C1', '#DDA0DD', '#BA68C8',
                    '#FFAB91', '#FFCC80', '#AED581', '#C5E1A5', '#81C784', '#A5D6A7'
                ],
                characteristics: ['ë”°ëœ»í•œ', 'ë°ì€', 'ìƒë™ê°ìˆëŠ”', 'í™”ì‚¬í•œ'],
                undertone: 'warm',
                labReference: { L: 70, a: 8, b: 25 }
            },
            summer: {
                name: 'ì—¬ë¦„ ì¿¨í†¤ (Summer)',
                colors: [
                    '#B39DDB', '#9FA8DA', '#90CAF9', '#81D4FA', '#80DEEA', '#80CBC4',
                    '#A5D6A7', '#C8E6C9', '#DCEDC8', '#F0F4C3', '#FFCDD2', '#F8BBD9',
                    '#E1BEE7', '#D1C4E9', '#C5CAE9', '#BBDEFB', '#B3E5FC', '#B2EBF2',
                    '#B2DFDB', '#C8E6C9', '#E6EE9C', '#F0F4C3', '#FFECB3', '#FFE0B2'
                ],
                characteristics: ['ì°¨ê°€ìš´', 'ë¶€ë“œëŸ¬ìš´', 'ìš°ì•„í•œ', 'ì ˆì œëœ'],
                undertone: 'cool',
                labReference: { L: 65, a: -3, b: -8 }
            },
            autumn: {
                name: 'ê°€ì„ ì›œí†¤ (Autumn)',
                colors: [
                    '#8B4513', '#A0522D', '#CD853F', '#DEB887', '#F4A460', '#D2B48C',
                    '#BC8F8F', '#CD5C5C', '#B22222', '#800000', '#8B0000', '#DC143C',
                    '#DAA520', '#B8860B', '#CD853F', '#D2691E', '#FF8C00', '#FF7F50',
                    '#BDB76B', '#6B8E23', '#808000', '#556B2F', '#9ACD32', '#32CD32'
                ],
                characteristics: ['ë”°ëœ»í•œ', 'ê¹Šì€', 'í’ì„±í•œ', 'ì„±ìˆ™í•œ'],
                undertone: 'warm', 
                labReference: { L: 50, a: 12, b: 30 }
            },
            winter: {
                name: 'ê²¨ìš¸ ì¿¨í†¤ (Winter)',
                colors: [
                    '#000000', '#2F2F2F', '#2C3E50', '#34495E', '#4A4A4A', '#696969',
                    '#DC143C', '#B22222', '#800000', '#8B0000', '#4169E1', '#0000CD',
                    '#191970', '#000080', '#8A2BE2', '#4B0082', '#663399', '#800080',
                    '#2E8B57', '#008B8B', '#4682B4', '#5F9EA0', '#708090', '#778899'
                ],
                characteristics: ['ì°¨ê°€ìš´', 'ì„ ëª…í•œ', 'ê°•ë ¬í•œ', 'ê·¹ì ì¸'],
                undertone: 'cool',
                labReference: { L: 40, a: 2, b: -15 }
            }
        };

        /**
         * ğŸ”¬ ì‹¤ì œ Delta E 2000 ê³„ì‚° ì—”ì§„
         * CIE Delta E 2000 ê³µì‹ ì™„ì „ êµ¬í˜„
         */
        class DeltaE2000Calculator {
            constructor() {
                this.cache = new Map();
                this.totalCalculations = 0;
                console.log('Delta E 2000 ê³„ì‚° ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ');
            }

            calculateDeltaE2000(lab1, lab2) {
                this.totalCalculations++;
                
                const cacheKey = this.getCacheKey(lab1, lab2);
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }
                
                const result = this.computeDeltaE2000(lab1, lab2);
                this.cache.set(cacheKey, result);
                
                window.PersonalColorSystem.performance.deltaECalculations++;
                return result;
            }

            computeDeltaE2000(lab1, lab2) {
                const L1 = lab1.L || lab1.l;
                const a1 = lab1.a;
                const b1 = lab1.b;
                const L2 = lab2.L || lab2.l;
                const a2 = lab2.a;
                const b2 = lab2.b;

                // Step 1: Calculate C and h
                const C1 = Math.sqrt(a1 * a1 + b1 * b1);
                const C2 = Math.sqrt(a2 * a2 + b2 * b2);
                const C_bar = (C1 + C2) / 2;

                // Step 2: Calculate G
                const G = 0.5 * (1 - Math.sqrt(Math.pow(C_bar, 7) / (Math.pow(C_bar, 7) + Math.pow(25, 7))));

                // Step 3: Calculate a' and C'
                const a1_prime = (1 + G) * a1;
                const a2_prime = (1 + G) * a2;
                const C1_prime = Math.sqrt(a1_prime * a1_prime + b1 * b1);
                const C2_prime = Math.sqrt(a2_prime * a2_prime + b2 * b2);

                // Step 4: Calculate h'
                const h1_prime = this.calculateHuePrime(a1_prime, b1);
                const h2_prime = this.calculateHuePrime(a2_prime, b2);

                // Step 5: Calculate differences
                const deltaL_prime = L2 - L1;
                const deltaC_prime = C2_prime - C1_prime;
                const deltaH_prime = this.calculateDeltaHPrime(C1_prime, C2_prime, h1_prime, h2_prime);

                // Step 6: Calculate averages
                const L_bar = (L1 + L2) / 2;
                const C_bar_prime = (C1_prime + C2_prime) / 2;
                const H_bar_prime = this.calculateHBarPrime(h1_prime, h2_prime);

                // Step 7: Calculate T
                const T = 1 - 0.17 * Math.cos(this.degreesToRadians(H_bar_prime - 30)) +
                         0.24 * Math.cos(this.degreesToRadians(2 * H_bar_prime)) +
                         0.32 * Math.cos(this.degreesToRadians(3 * H_bar_prime + 6)) -
                         0.20 * Math.cos(this.degreesToRadians(4 * H_bar_prime - 63));

                // Step 8: Calculate SL, SC, SH
                const SL = 1 + (0.015 * Math.pow(L_bar - 50, 2)) / Math.sqrt(20 + Math.pow(L_bar - 50, 2));
                const SC = 1 + 0.045 * C_bar_prime;
                const SH = 1 + 0.015 * C_bar_prime * T;

                // Step 9: Calculate RT
                const deltaTheta = 30 * Math.exp(-Math.pow((H_bar_prime - 275) / 25, 2));
                const RC = 2 * Math.sqrt(Math.pow(C_bar_prime, 7) / (Math.pow(C_bar_prime, 7) + Math.pow(25, 7)));
                const RT = -RC * Math.sin(this.degreesToRadians(2 * deltaTheta));

                // Step 10: Calculate final Delta E 2000
                const kL = 1, kC = 1, kH = 1;
                const deltaE2000 = Math.sqrt(
                    Math.pow(deltaL_prime / (kL * SL), 2) +
                    Math.pow(deltaC_prime / (kC * SC), 2) +
                    Math.pow(deltaH_prime / (kH * SH), 2) +
                    RT * (deltaC_prime / (kC * SC)) * (deltaH_prime / (kH * SH))
                );

                return parseFloat(deltaE2000.toFixed(3));
            }

            calculateHuePrime(a_prime, b) {
                if (a_prime === 0 && b === 0) return 0;
                const hue = this.radiansToDegrees(Math.atan2(b, a_prime));
                return hue >= 0 ? hue : hue + 360;
            }

            calculateDeltaHPrime(C1_prime, C2_prime, h1_prime, h2_prime) {
                if (C1_prime * C2_prime === 0) return 0;
                
                const delta_h = h2_prime - h1_prime;
                if (Math.abs(delta_h) <= 180) {
                    return 2 * Math.sqrt(C1_prime * C2_prime) * Math.sin(this.degreesToRadians(delta_h / 2));
                } else if (delta_h > 180) {
                    return 2 * Math.sqrt(C1_prime * C2_prime) * Math.sin(this.degreesToRadians((delta_h - 360) / 2));
                } else {
                    return 2 * Math.sqrt(C1_prime * C2_prime) * Math.sin(this.degreesToRadians((delta_h + 360) / 2));
                }
            }

            calculateHBarPrime(h1_prime, h2_prime) {
                if (Math.abs(h1_prime - h2_prime) > 180) {
                    return (h1_prime + h2_prime + 360) / 2;
                } else {
                    return (h1_prime + h2_prime) / 2;
                }
            }

            degreesToRadians(degrees) { return degrees * Math.PI / 180; }
            radiansToDegrees(radians) { return radians * 180 / Math.PI; }

            getCacheKey(lab1, lab2) {
                const l1 = (lab1.L || lab1.l).toFixed(2);
                const a1 = lab1.a.toFixed(2);
                const b1 = lab1.b.toFixed(2);
                const l2 = (lab2.L || lab2.l).toFixed(2);
                const a2 = lab2.a.toFixed(2);
                const b2 = lab2.b.toFixed(2);
                return `${l1},${a1},${b1}-${l2},${a2},${b2}`;
            }

            assessColorMatching(deltaE) {
                let level, score, description, recommendation;

                if (deltaE <= 1.0) {
                    level = 'perfect';
                    score = 100;
                    description = 'ì™„ë²½í•œ ë§¤ì¹­';
                    recommendation = 'ìµœê³ ì˜ ì„ íƒ!';
                } else if (deltaE <= 2.3) {
                    level = 'excellent';
                    score = Math.round(95 - deltaE * 5);
                    description = 'ìš°ìˆ˜í•œ ë§¤ì¹­';
                    recommendation = 'ê°•ë ¥ ì¶”ì²œ';
                } else if (deltaE <= 5.0) {
                    level = 'good';
                    score = Math.round(85 - deltaE * 4);
                    description = 'ì¢‹ì€ ë§¤ì¹­';
                    recommendation = 'ì¶”ì²œ';
                } else if (deltaE <= 10.0) {
                    level = 'acceptable';
                    score = Math.round(70 - deltaE * 3);
                    description = 'ì ë‹¹í•œ ë§¤ì¹­';
                    recommendation = 'ë³´í†µ';
                } else {
                    level = 'poor';
                    score = Math.max(10, Math.round(40 - deltaE * 2));
                    description = 'ë§¤ì¹­ ì–´ë ¤ì›€';
                    recommendation = 'ì¶”ì²œí•˜ì§€ ì•ŠìŒ';
                }

                return { 
                    level, 
                    score: Math.max(0, Math.min(100, score)), 
                    description, 
                    recommendation,
                    deltaE: parseFloat(deltaE.toFixed(3)) 
                };
            }

            getStats() {
                return {
                    totalCalculations: this.totalCalculations,
                    cacheSize: this.cache.size,
                    hitRate: this.cache.size > 0 ? Math.round((this.cache.size / this.totalCalculations) * 100) : 0
                };
            }
        }

        /**
         * ğŸ¥ ì‹¤ì œ MediaPipe ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œ
         * ì§„ì§œ FaceMesh 468í¬ì¸íŠ¸ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ í”¼ë¶€ ì¶”ì¶œ
         */
        class MediaPipeFaceDetectionSystem {
            constructor() {
                this.faceMesh = null;
                this.camera = null;
                this.videoElement = null;
                this.canvasElement = null;
                this.canvasCtx = null;
                
                this.isInitialized = false;
                this.isAnalyzing = false;
                this.currentSkinTone = null;
                this.lastResults = null;
                
                // MediaPipe 468 ëœë“œë§ˆí¬ ì¤‘ í”¼ë¶€ ì˜ì—­ ì¸ë±ìŠ¤
                this.skinLandmarkIndices = {
                    forehead: [9, 10, 151, 337, 299, 333, 298, 301],
                    leftCheek: [116, 117, 118, 119, 120, 121, 126, 142, 36, 205],
                    rightCheek: [345, 346, 347, 348, 349, 350, 355, 371, 266, 425],
                    noseBridge: [6, 51, 115, 131, 134, 102, 49, 220],
                    chin: [18, 175, 199, 200, 9, 10, 151, 175]
                };
                
                console.log('MediaPipe ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
            }

            async initialize() {
                try {
                    console.log('MediaPipe FaceMesh ë¡œë”© ì¤‘...');
                    
                    // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                    this.videoElement = document.getElementById('video-feed');
                    this.canvasElement = document.getElementById('face-overlay');
                    this.canvasCtx = this.canvasElement.getContext('2d');
                    
                    if (!this.videoElement || !this.canvasElement) {
                        throw new Error('ë¹„ë””ì˜¤ ë˜ëŠ” ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    // MediaPipe FaceMesh ì´ˆê¸°í™” - ì‹¤ì œ ì—°ê²°
                    await this.initializeMediaPipe();
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    this.setupEventListeners();
                    
                    this.isInitialized = true;
                    window.PersonalColorSystem.ai.isMediaPipeReady = true;
                    
                    console.log('MediaPipe ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ!');
                    return true;
                    
                } catch (error) {
                    console.error('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            async initializeMediaPipe() {
                // MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
                if (typeof FaceMesh === 'undefined') {
                    throw new Error('MediaPipe FaceMesh ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                // FaceMesh ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                this.faceMesh = new FaceMesh({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }
                });

                // MediaPipe ì„¤ì •
                this.faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                // ê²°ê³¼ ì²˜ë¦¬ ì½œë°± ì„¤ì • - ì‹¤ì œ ì—°ê²°!
                this.faceMesh.onResults((results) => {
                    this.onFaceMeshResults(results);
                });
                
                console.log('MediaPipe FaceMesh ì„¤ì • ì™„ë£Œ - ì‹¤ì œ ì—°ê²°ë¨!');
            }

            setupEventListeners() {
                document.getElementById('start-camera-btn')?.addEventListener('click', () => {
                    this.startCamera();
                });
                
                document.getElementById('analyze-skin-btn')?.addEventListener('click', () => {
                    this.performSkinAnalysis();
                });
                
                document.getElementById('reset-detection-btn')?.addEventListener('click', () => {
                    this.reset();
                });
                
                document.getElementById('save-face-result-btn')?.addEventListener('click', () => {
                    this.saveResults();
                });
            }

            async startCamera() {
                try {
                    console.log('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘ ì¤‘...');
                    
                    const constraints = {
                        video: {
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            facingMode: 'user',
                            frameRate: { ideal: 30 }
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.videoElement.srcObject = stream;
                    
                    this.videoElement.onloadedmetadata = () => {
                        // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ì™€ ë§ì¶¤
                        this.canvasElement.width = this.videoElement.videoWidth;
                        this.canvasElement.height = this.videoElement.videoHeight;
                        
                        // ì‹¤ì‹œê°„ ì–¼êµ´ê°ì§€ ì‹œì‘
                        this.startRealTimeFaceDetection();
                        
                        console.log('ì¹´ë©”ë¼ ì‹œì‘ë¨ - ì‹¤ì‹œê°„ MediaPipe ë¶„ì„ ì‹œì‘');
                        document.getElementById('start-camera-btn').disabled = true;
                        document.getElementById('analyze-skin-btn').disabled = false;
                        
                        showToast('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì–¼êµ´ì„ í™”ë©´ì— ë§ì¶°ì£¼ì„¸ìš”.', 'success');
                    };
                    
                } catch (error) {
                    console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                    showToast('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
                }
            }

            startRealTimeFaceDetection() {
                const detectFrame = async () => {
                    if (this.faceMesh && this.videoElement.videoWidth > 0) {
                        // MediaPipeì— í˜„ì¬ í”„ë ˆì„ ì „ì†¡ - ì‹¤ì œ ì—°ê²°!
                        await this.faceMesh.send({ image: this.videoElement });
                    }
                    requestAnimationFrame(detectFrame);
                };
                
                detectFrame();
                console.log('ì‹¤ì‹œê°„ MediaPipe ì–¼êµ´ê°ì§€ ë£¨í”„ ì‹œì‘ë¨');
            }

            // MediaPipe ê²°ê³¼ ì²˜ë¦¬ - ì‹¤ì œ ì½œë°±!
            onFaceMeshResults(results) {
                this.lastResults = results;
                
                // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
                this.canvasCtx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    
                    // ì–¼êµ´ ìœ¤ê³½ ê·¸ë¦¬ê¸°
                    this.drawFaceMesh(landmarks);
                    
                    // í”¼ë¶€ ì˜ì—­ í‘œì‹œ
                    this.drawSkinRegions(landmarks);
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.getElementById('detection-status').textContent = 
                        `ì–¼êµ´ ê°ì§€ë¨ - ${landmarks.length}ê°œ í¬ì¸íŠ¸`;
                    
                    window.PersonalColorSystem.performance.mediaipeDetections++;
                    
                } else {
                    document.getElementById('detection-status').textContent = 
                        'ì–¼êµ´ì„ í™”ë©´ì— ë§ì¶°ì£¼ì„¸ìš”';
                    this.updateSampleCount(0);
                }
            }

            drawFaceMesh(landmarks) {
                // ì–¼êµ´ ìœ¤ê³½ì„  ê·¸ë¦¬ê¸°
                this.canvasCtx.strokeStyle = '#00ff00';
                this.canvasCtx.lineWidth = 2;
                
                // FACE_OVAL ì—°ê²°ì ë“¤
                const faceOval = [
                    10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288,
                    397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136,
                    172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109
                ];
                
                this.canvasCtx.beginPath();
                faceOval.forEach((pointIndex, i) => {
                    const point = landmarks[pointIndex];
                    const x = point.x * this.canvasElement.width;
                    const y = point.y * this.canvasElement.height;
                    
                    if (i === 0) {
                        this.canvasCtx.moveTo(x, y);
                    } else {
                        this.canvasCtx.lineTo(x, y);
                    }
                });
                this.canvasCtx.closePath();
                this.canvasCtx.stroke();
            }

            drawSkinRegions(landmarks) {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
                const regionNames = Object.keys(this.skinLandmarkIndices);
                
                regionNames.forEach((regionName, index) => {
                    const indices = this.skinLandmarkIndices[regionName];
                    this.canvasCtx.fillStyle = colors[index % colors.length];
                    
                    indices.forEach(pointIndex => {
                        const point = landmarks[pointIndex];
                        const x = point.x * this.canvasElement.width;
                        const y = point.y * this.canvasElement.height;
                        
                        this.canvasCtx.beginPath();
                        this.canvasCtx.arc(x, y, 3, 0, 2 * Math.PI);
                        this.canvasCtx.fill();
                    });
                });
            }

            async performSkinAnalysis() {
                if (this.isAnalyzing || !this.lastResults) {
                    showToast('ë¨¼ì € ì–¼êµ´ì´ ê°ì§€ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                this.isAnalyzing = true;
                console.log('ì‹¤ì œ í”¼ë¶€í†¤ ë¶„ì„ ì‹œì‘...');
                
                try {
                    const landmarks = this.lastResults.multiFaceLandmarks[0];
                    
                    // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ë¡œ ìº¡ì²˜
                    const imageData = await this.captureVideoFrame();
                    
                    // ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ
                    const skinPixels = this.extractSkinPixels(imageData, landmarks);
                    
                    if (skinPixels.length > 0) {
                        // CIE Labìœ¼ë¡œ ë³€í™˜ ë° í‰ê·  ê³„ì‚°
                        const skinTone = this.calculateAverageSkinTone(skinPixels);
                        this.currentSkinTone = skinTone;
                        
                        // UI ì—…ë°ì´íŠ¸
                        this.updateSkinToneDisplay(skinTone);
                        this.updateSampleCount(skinPixels.length);
                        
                        document.getElementById('save-face-result-btn').disabled = false;
                        
                        console.log(`ì‹¤ì œ í”¼ë¶€í†¤ ë¶„ì„ ì™„ë£Œ: L=${skinTone.L.toFixed(1)}, a=${skinTone.a.toFixed(1)}, b=${skinTone.b.toFixed(1)} (${skinPixels.length}ê°œ í”½ì…€)`);
                        showToast('ì‹¤ì œ í”¼ë¶€í†¤ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        
                        window.PersonalColorSystem.performance.totalAnalyses++;
                        
                    } else {
                        showToast('ìœ íš¨í•œ í”¼ë¶€ í”½ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    }
                    
                } catch (error) {
                    console.error('í”¼ë¶€í†¤ ë¶„ì„ ì‹¤íŒ¨:', error);
                    showToast('í”¼ë¶€í†¤ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    this.isAnalyzing = false;
                }
            }

            async captureVideoFrame() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                ctx.drawImage(this.videoElement, 0, 0);
                return ctx.getImageData(0, 0, canvas.width, canvas.height);
            }

            extractSkinPixels(imageData, landmarks) {
                const { data, width, height } = imageData;
                const samples = [];
                
                // ê° í”¼ë¶€ ì˜ì—­ì—ì„œ í”½ì…€ ìƒ˜í”Œë§
                Object.keys(this.skinLandmarkIndices).forEach(regionName => {
                    const indices = this.skinLandmarkIndices[regionName];
                    
                    indices.forEach(pointIndex => {
                        const landmark = landmarks[pointIndex];
                        const x = Math.round(landmark.x * width);
                        const y = Math.round(landmark.y * height);
                        
                        // 5x5 ì˜ì—­ì—ì„œ ìƒ˜í”Œë§ (ë” ë§ì€ í”½ì…€)
                        for (let dy = -2; dy <= 2; dy++) {
                            for (let dx = -2; dx <= 2; dx++) {
                                const px = x + dx;
                                const py = y + dy;
                                
                                if (px >= 0 && px < width && py >= 0 && py < height) {
                                    const index = (py * width + px) * 4;
                                    const r = data[index];
                                    const g = data[index + 1];
                                    const b = data[index + 2];
                                    const alpha = data[index + 3];
                                    
                                    // ìœ íš¨í•œ í”¼ë¶€ í”½ì…€ì¸ì§€ ê²€ì¦
                                    if (alpha > 200 && this.isValidSkinPixel(r, g, b)) {
                                        samples.push({ r, g, b });
                                    }
                                }
                            }
                        }
                    });
                });
                
                console.log(`ì¶”ì¶œëœ í”¼ë¶€ í”½ì…€: ${samples.length}ê°œ`);
                return samples;
            }

            isValidSkinPixel(r, g, b) {
                // í”¼ë¶€ìƒ‰ í•„í„°ë§ ì¡°ê±´
                const brightness = (r + g + b) / 3;
                
                // ë„ˆë¬´ ì–´ë‘¡ê±°ë‚˜ ë°ì§€ ì•ŠìŒ
                if (brightness < 40 || brightness > 240) return false;
                
                // í”¼ë¶€ìƒ‰ íŠ¹ì„±: ë¹¨ê°„ìƒ‰ > ì´ˆë¡ìƒ‰ > íŒŒë€ìƒ‰
                if (r < g || g < b) return false;
                
                // ìƒ‰ìƒ ì°¨ì´ê°€ ê·¹ë‹¨ì ì´ì§€ ì•ŠìŒ
                const maxDiff = Math.max(Math.abs(r - g), Math.abs(g - b), Math.abs(r - b));
                if (maxDiff > 80) return false;
                
                // ì±„ë„ê°€ ë„ˆë¬´ ë†’ì§€ ì•ŠìŒ (ìì—°ìŠ¤ëŸ¬ìš´ í”¼ë¶€ìƒ‰)
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                const saturation = max === 0 ? 0 : (max - min) / max;
                if (saturation > 0.6) return false;
                
                return true;
            }

            calculateAverageSkinTone(samples) {
                if (samples.length === 0) return null;
                
                // RGBë¥¼ CIE Labìœ¼ë¡œ ë³€í™˜
                const labSamples = samples.map(rgb => this.rgbToLab(rgb.r, rgb.g, rgb.b));
                
                // í‰ê·  ê³„ì‚°
                const sum = labSamples.reduce((acc, lab) => ({
                    L: acc.L + lab.L,
                    a: acc.a + lab.a,
                    b: acc.b + lab.b
                }), { L: 0, a: 0, b: 0 });
                
                return {
                    L: sum.L / labSamples.length,
                    a: sum.a / labSamples.length,
                    b: sum.b / labSamples.length,
                    sampleCount: samples.length
                };
            }

            rgbToLab(r, g, b) {
                // RGB to XYZ (sRGB, D65)
                let R = r / 255.0;
                let G = g / 255.0;
                let B = b / 255.0;

                // ê°ë§ˆ ë³´ì •
                R = R > 0.04045 ? Math.pow((R + 0.055) / 1.055, 2.4) : R / 12.92;
                G = G > 0.04045 ? Math.pow((G + 0.055) / 1.055, 2.4) : G / 12.92;
                B = B > 0.04045 ? Math.pow((B + 0.055) / 1.055, 2.4) : B / 12.92;

                // XYZ ë³€í™˜ (D65 í‘œì¤€)
                let X = R * 0.4124564 + G * 0.3575761 + B * 0.1804375;
                let Y = R * 0.2126729 + G * 0.7151522 + B * 0.0721750;
                let Z = R * 0.0193339 + G * 0.1191920 + B * 0.9503041;

                // D65 í‘œì¤€í™”
                X = X / 0.95047;
                Y = Y / 1.00000;
                Z = Z / 1.08883;

                // Lab ë³€í™˜
                const fx = X > 0.008856 ? Math.pow(X, 1/3) : (7.787 * X + 16/116);
                const fy = Y > 0.008856 ? Math.pow(Y, 1/3) : (7.787 * Y + 16/116);
                const fz = Z > 0.008856 ? Math.pow(Z, 1/3) : (7.787 * Z + 16/116);

                const L = 116 * fy - 16;
                const a = 500 * (fx - fy);
                const bLab = 200 * (fy - fz);

                return { L, a, b: bLab };
            }

            updateSkinToneDisplay(skinTone) {
                document.getElementById('l-value').textContent = skinTone.L.toFixed(1);
                document.getElementById('a-value').textContent = skinTone.a.toFixed(1);
                document.getElementById('b-value').textContent = skinTone.b.toFixed(1);
            }

            updateSampleCount(count) {
                document.getElementById('sample-counter').textContent = `${count}ê°œ í”½ì…€`;
                
                // ìƒ‰ìƒìœ¼ë¡œ í’ˆì§ˆ í‘œì‹œ
                const counter = document.getElementById('sample-counter');
                if (count >= 200) {
                    counter.style.background = '#10b981'; // ì´ˆë¡ - ìš°ìˆ˜
                } else if (count >= 100) {
                    counter.style.background = '#3b82f6'; // íŒŒë‘ - ì¢‹ìŒ
                } else if (count >= 50) {
                    counter.style.background = '#f59e0b'; // ì£¼í™© - ë³´í†µ
                } else {
                    counter.style.background = '#ef4444'; // ë¹¨ê°• - ë¶€ì¡±
                }
            }

            saveResults() {
                if (!this.currentSkinTone) {
                    showToast('ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const result = {
                    timestamp: new Date().toISOString(),
                    method: 'mediapipe_real',
                    skinTone: this.currentSkinTone,
                    customer: window.PersonalColorSystem.currentCustomer,
                    performance: {
                        sampleCount: this.currentSkinTone.sampleCount,
                        mediaipeVersion: 'FaceMesh_468points',
                        analysisQuality: this.currentSkinTone.sampleCount >= 200 ? 'excellent' : 
                                      this.currentSkinTone.sampleCount >= 100 ? 'good' : 'acceptable'
                    }
                };

                // ë¡œì»¬ ì €ì¥
                const existingResults = JSON.parse(localStorage.getItem('faceResults') || '[]');
                existingResults.push(result);
                localStorage.setItem('faceResults', JSON.stringify(existingResults));

                // ê³ ê° ì •ë³´ì— ì¶”ê°€
                if (window.PersonalColorSystem.currentCustomer && window.PersonalColorSystem.customerManager) {
                    window.PersonalColorSystem.customerManager.addDiagnosis(
                        window.PersonalColorSystem.currentCustomer.id,
                        result
                    );
                }

                console.log('ì‹¤ì œ ì–¼êµ´ê°ì§€ ê²°ê³¼ ì €ì¥ë¨:', result);
                showToast('ì‹¤ì œ ì–¼êµ´ê°ì§€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }

            reset() {
                this.currentSkinTone = null;
                
                document.getElementById('l-value').textContent = '--';
                document.getElementById('a-value').textContent = '--';
                document.getElementById('b-value').textContent = '--';
                document.getElementById('face-delta-value').textContent = '--.-';
                document.getElementById('face-delta-description').textContent = 'ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”';
                document.getElementById('sample-counter').textContent = '0ê°œ í”½ì…€';
                document.getElementById('detection-status').textContent = 'ì–¼êµ´ì„ í™”ë©´ì— ë§ì¶°ì£¼ì„¸ìš”';
                document.getElementById('save-face-result-btn').disabled = true;
                
                // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
                if (this.canvasCtx) {
                    this.canvasCtx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                }
                
                console.log('ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨');
            }
        }

        /**
         * ğŸ­ ê°€ìƒ ë“œë˜ì´í•‘ ì—”ì§„ + ë¸Œëœë“œ DB í†µí•©
         */
        class VirtualDrapingEngine {
            constructor() {
                this.stream = null;
                this.selectedColors = [];
                this.currentSkinTone = null;
                this.fabricElements = [];
                this.isActive = false;
                
                // ê³ ì •ëœ í•œêµ­ì¸ í‰ê·  í”¼ë¶€í†¤ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
                this.averageKoreanSkinTone = {
                    L: 62.5,  // í•œêµ­ì¸ í‰ê·  ëª…ë„
                    a: 7.8,   // ì•½ê°„ ë¶‰ì€ ê¸°ì¡°
                    b: 15.2   // ë…¸ë€ ê¸°ì¡° (ì›œí†¤ ì„±í–¥)
                };
                
                console.log('ê°€ìƒ ë“œë˜ì´í•‘ ì—”ì§„ ì´ˆê¸°í™”ë¨');
            }

            async initialize() {
                try {
                    console.log('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘...');
                    
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 1280, min: 640 }, 
                            height: { ideal: 720, min: 480 },
                            facingMode: 'user',
                            frameRate: { ideal: 30 }
                        }
                    });
                    
                    const video = document.getElementById('draping-video');
                    if (video) {
                        video.srcObject = this.stream;
                        video.onloadedmetadata = () => video.play();
                    }
                    
                    // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„¤ì •
                    this.setupColorPalette();
                    this.setupSeasonButtons();
                    
                    // ì‹¤ì œ ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œì—ì„œ í”¼ë¶€í†¤ ê°€ì ¸ì˜¤ê¸°
                    if (window.PersonalColorSystem.faceDetectionEngine?.currentSkinTone) {
                        this.currentSkinTone = window.PersonalColorSystem.faceDetectionEngine.currentSkinTone;
                        console.log('ì‹¤ì œ ë¶„ì„ëœ í”¼ë¶€í†¤ ì‚¬ìš©:', this.currentSkinTone);
                    } else {
                        this.currentSkinTone = this.averageKoreanSkinTone;
                        console.log('í•œêµ­ì¸ í‰ê·  í”¼ë¶€í†¤ ì‚¬ìš©:', this.currentSkinTone);
                    }
                    
                    this.isActive = true;
                    console.log('ë“œë˜ì´í•‘ ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('ë“œë˜ì´í•‘ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            setupColorPalette() {
                this.updateColorGrid('spring'); // ê¸°ë³¸ê°’
            }

            setupSeasonButtons() {
                document.querySelectorAll('.season-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const season = btn.dataset.season;
                        this.updateColorGrid(season);
                        this.updateBrandRecommendations(season);
                    });
                });
            }

            updateColorGrid(season) {
                const seasonData = SEASON_COLOR_PALETTES[season];
                const grid = document.getElementById('draping-color-grid');
                
                if (!seasonData || !grid) return;
                
                grid.innerHTML = '';
                seasonData.colors.forEach(color => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.backgroundColor = color;
                    colorItem.title = `${color} - ${seasonData.name}`;
                    colorItem.addEventListener('click', () => this.selectColor(color, colorItem, season));
                    grid.appendChild(colorItem);
                });
            }

            async selectColor(color, element, season) {
                element.classList.toggle('selected');
                
                if (element.classList.contains('selected')) {
                    this.selectedColors.push({ color, season });
                    this.createVirtualFabric(color);
                    await this.performColorAnalysis(color, season);
                } else {
                    this.selectedColors = this.selectedColors.filter(c => c.color !== color);
                    this.removeVirtualFabric(color);
                }
                
                // ë¸Œëœë“œ ì¶”ì²œ ì—…ë°ì´íŠ¸
                this.updateBrandRecommendations(season);
            }

            createVirtualFabric(color) {
                const overlay = document.getElementById('virtual-fabric-overlay');
                if (!overlay) return;
                
                const fabric = document.createElement('div');
                fabric.className = 'virtual-fabric';
                fabric.style.backgroundColor = color;
                fabric.style.background = `linear-gradient(135deg, ${color}, ${this.adjustBrightness(color, -10)})`;
                fabric.dataset.color = color;
                
                // ëª©-ì–´ê¹¨ ì˜ì—­ì— ì²œ ë°°ì¹˜
                const positions = [
                    { left: '10%', top: '30%', width: '200px', height: '300px', rotation: '-5deg' },
                    { left: '70%', top: '25%', width: '180px', height: '280px', rotation: '3deg' },
                    { left: '40%', top: '35%', width: '160px', height: '250px', rotation: '0deg' }
                ];
                
                const pos = positions[this.fabricElements.length % positions.length];
                fabric.style.left = pos.left;
                fabric.style.top = pos.top;
                fabric.style.width = pos.width;
                fabric.style.height = pos.height;
                fabric.style.transform = `rotate(${pos.rotation})`;
                
                overlay.appendChild(fabric);
                this.fabricElements.push(fabric);
            }

            removeVirtualFabric(color) {
                const overlay = document.getElementById('virtual-fabric-overlay');
                if (!overlay) return;
                
                const fabric = overlay.querySelector(`[data-color="${color}"]`);
                if (fabric) {
                    overlay.removeChild(fabric);
                    this.fabricElements = this.fabricElements.filter(f => f !== fabric);
                }
            }

            adjustBrightness(hexColor, amount) {
                const hex = hexColor.replace('#', '');
                const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
                const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
                const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }

            async performColorAnalysis(selectedColor, season) {
                if (!this.currentSkinTone) return;
                
                const deltaE = window.PersonalColorSystem.ai.deltaE;
                if (!deltaE) return;
                
                try {
                    const colorLab = this.hexToLab(selectedColor);
                    const deltaEValue = deltaE.calculateDeltaE2000(this.currentSkinTone, colorLab);
                    const assessment = deltaE.assessColorMatching(deltaEValue);
                    
                    // UI ì—…ë°ì´íŠ¸
                    this.updateLiveDisplay(deltaEValue, assessment, selectedColor, season);
                    
                    console.log(`ìƒ‰ìƒ ë¶„ì„: ${selectedColor} (${season}) â†’ Î”E=${deltaEValue.toFixed(1)} (${assessment.description})`);
                    
                } catch (error) {
                    console.warn('ìƒ‰ìƒ ë¶„ì„ ì˜¤ë¥˜:', error);
                }
            }

            hexToLab(hex) {
                // Hex to RGB
                const r = parseInt(hex.substr(1, 2), 16) / 255.0;
                const g = parseInt(hex.substr(3, 2), 16) / 255.0;
                const b = parseInt(hex.substr(5, 2), 16) / 255.0;
                
                // sRGB to Linear RGB
                const rLinear = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
                const gLinear = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
                const bLinear = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
                
                // Linear RGB to XYZ (D65)
                const X = rLinear * 0.4124564 + gLinear * 0.3575761 + bLinear * 0.1804375;
                const Y = rLinear * 0.2126729 + gLinear * 0.7151522 + bLinear * 0.0721750;
                const Z = rLinear * 0.0193339 + gLinear * 0.1191920 + bLinear * 0.9503041;
                
                // XYZ to Lab
                const Xn = 0.95047, Yn = 1.00000, Zn = 1.08883;
                
                const fx = this.xyzToLabFunc(X / Xn);
                const fy = this.xyzToLabFunc(Y / Yn);
                const fz = this.xyzToLabFunc(Z / Zn);
                
                const L = 116 * fy - 16;
                const a = 500 * (fx - fy);
                const bLab = 200 * (fy - fz);
                
                return { L, a, b: bLab };
            }

            xyzToLabFunc(t) {
                return t > 0.008856 ? Math.pow(t, 1/3) : (7.787 * t + 16/116);
            }

            updateLiveDisplay(deltaE, assessment, color, season) {
                const elements = {
                    'live-delta-value': deltaE.toFixed(1),
                    'live-delta-description': `${assessment.description} - ${assessment.recommendation}`,
                    'live-score-text': `${assessment.score}ì `
                };
                
                Object.keys(elements).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = elements[id];
                    }
                });
                
                // ì ìˆ˜ ê²Œì´ì§€ ì—…ë°ì´íŠ¸
                const scoreFill = document.getElementById('live-score-fill');
                if (scoreFill) {
                    scoreFill.style.width = `${assessment.score}%`;
                }
                
                // ì„±ëŠ¥ í†µê³„ ì—…ë°ì´íŠ¸
                window.PersonalColorSystem.performance.totalAnalyses++;
            }

            updateBrandRecommendations(season) {
                const container = document.getElementById('brand-recommendations');
                if (!container || !season) return;
                
                container.innerHTML = '';
                
                // ê° ë¸Œëœë“œë³„ ì¶”ì²œ
                Object.keys(PROFESSIONAL_BRAND_DATABASE).forEach(brandKey => {
                    const brand = PROFESSIONAL_BRAND_DATABASE[brandKey];
                    const seasonColors = brand.colors[season];
                    
                    if (seasonColors && seasonColors.length > 0) {
                        const brandDiv = document.createElement('div');
                        brandDiv.className = 'brand-item';
                        
                        // ìƒìœ„ 3ê°œ ì¶”ì²œ
                        const topRecommendations = seasonColors.slice(0, 3);
                        
                        brandDiv.innerHTML = `
                            <div class="brand-name">${brand.name}</div>
                            <div class="brand-products">
                                ${topRecommendations.map(item => 
                                    `${item.code} ${item.name}`
                                ).join(', ')}
                                ${seasonColors.length > 3 ? ` (+${seasonColors.length - 3}ê°œ)` : ''}
                            </div>
                        `;
                        
                        container.appendChild(brandDiv);
                    }
                });
                
                if (container.children.length === 0) {
                    container.innerHTML = `
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                            ${season} ì‹œì¦Œ ë¸Œëœë“œ ì¶”ì²œ ì¤€ë¹„ ì¤‘...
                        </p>
                    `;
                }
            }

            capture() {
                const video = document.getElementById('draping-video');
                if (!video) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.scale(-1, 1);
                ctx.drawImage(video, -canvas.width, 0);
                
                const dataURL = canvas.toDataURL('image/png');
                
                // ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.download = `ë“œë˜ì´í•‘ê²°ê³¼_${new Date().getTime()}.png`;
                link.href = dataURL;
                link.click();
                
                showToast('ë“œë˜ì´í•‘ ê²°ê³¼ê°€ ìº¡ì²˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                return dataURL;
            }

            saveResults() {
                if (this.selectedColors.length === 0) {
                    showToast('ë¶„ì„í•  ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                const results = this.selectedColors.map(colorData => {
                    const colorLab = this.hexToLab(colorData.color);
                    const deltaE = window.PersonalColorSystem.ai.deltaE.calculateDeltaE2000(this.currentSkinTone, colorLab);
                    const assessment = window.PersonalColorSystem.ai.deltaE.assessColorMatching(deltaE);
                    
                    return {
                        color: colorData.color,
                        season: colorData.season,
                        deltaE: deltaE,
                        assessment: assessment,
                        brandRecommendations: this.getBrandRecommendationsForColor(colorData.season)
                    };
                });

                const finalResult = {
                    timestamp: new Date().toISOString(),
                    method: 'virtual_draping',
                    skinTone: this.currentSkinTone,
                    selectedColors: this.selectedColors,
                    analysis: results,
                    customer: window.PersonalColorSystem.currentCustomer
                };

                // ë¡œì»¬ ì €ì¥
                const existingResults = JSON.parse(localStorage.getItem('drapingResults') || '[]');
                existingResults.push(finalResult);
                localStorage.setItem('drapingResults', JSON.stringify(existingResults));

                // ê³ ê° ì •ë³´ì— ì¶”ê°€
                if (window.PersonalColorSystem.currentCustomer && window.PersonalColorSystem.customerManager) {
                    window.PersonalColorSystem.customerManager.addDiagnosis(
                        window.PersonalColorSystem.currentCustomer.id,
                        finalResult
                    );
                }

                console.log('ë“œë˜ì´í•‘ ê²°ê³¼ ì €ì¥ë¨:', finalResult);
                showToast('ë“œë˜ì´í•‘ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', 4000, 'ê³ ê° ê´€ë¦¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            getBrandRecommendationsForColor(season) {
                const recommendations = {};
                
                Object.keys(PROFESSIONAL_BRAND_DATABASE).forEach(brandKey => {
                    const brand = PROFESSIONAL_BRAND_DATABASE[brandKey];
                    const seasonColors = brand.colors[season];
                    
                    if (seasonColors && seasonColors.length > 0) {
                        recommendations[brand.name] = seasonColors.slice(0, 3).map(item => ({
                            code: item.code,
                            name: item.name,
                            hex: item.hex
                        }));
                    }
                });
                
                return recommendations;
            }

            reset() {
                this.selectedColors = [];
                
                // ê°€ìƒ ì²œ ì œê±°
                this.fabricElements.forEach(fabric => {
                    if (fabric.parentNode) {
                        fabric.parentNode.removeChild(fabric);
                    }
                });
                this.fabricElements = [];
                
                // ìƒ‰ìƒ ì„ íƒ í•´ì œ
                document.querySelectorAll('.color-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // ë¶„ì„ ë””ìŠ¤í”Œë ˆì´ ì´ˆê¸°í™”
                document.getElementById('live-delta-value').textContent = '--.-';
                document.getElementById('live-delta-description').textContent = 'ìƒ‰ìƒ ì„ íƒ ì‹œ ì‹¤ì‹œê°„ ë§¤ì¹­';
                document.getElementById('live-score-text').textContent = '0ì ';
                document.getElementById('live-score-fill').style.width = '0%';
                
                // ë¸Œëœë“œ ì¶”ì²œ ì´ˆê¸°í™”
                const brandContainer = document.getElementById('brand-recommendations');
                if (brandContainer) {
                    brandContainer.innerHTML = `
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                            ìƒ‰ìƒ ì„ íƒ ì‹œ ë§ì¶¤ ë¸Œëœë“œ ì œí’ˆì´ í‘œì‹œë©ë‹ˆë‹¤
                        </p>
                    `;
                }
                
                console.log('ë“œë˜ì´í•‘ ì‹œìŠ¤í…œ ë¦¬ì…‹ë¨');
            }

            destroy() {
                this.isActive = false;
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.reset();
                console.log('ë“œë˜ì´í•‘ ì—”ì§„ ì¢…ë£Œë¨');
            }
        }

        /**
         * ğŸ‘¥ ì™„ì „í•œ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ
         * ì§„ë‹¨ ì´ë ¥, PDF ìƒì„±, ë°ì´í„° ê´€ë¦¬
         */
        class CustomerManagementSystem {
            constructor() {
                this.customers = this.loadCustomers();
                this.diagnoses = this.loadDiagnoses();
                console.log('ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨');
            }

            loadCustomers() {
                try {
                    const data = localStorage.getItem('personalcolor_customers');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.warn('ê³ ê° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    return [];
                }
            }

            loadDiagnoses() {
                try {
                    const data = localStorage.getItem('personalcolor_diagnoses');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.warn('ì§„ë‹¨ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    return [];
                }
            }

            saveCustomers() {
                try {
                    localStorage.setItem('personalcolor_customers', JSON.stringify(this.customers));
                    console.log('ê³ ê° ë°ì´í„° ì €ì¥ë¨');
                } catch (error) {
                    console.error('ê³ ê° ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            saveDiagnoses() {
                try {
                    localStorage.setItem('personalcolor_diagnoses', JSON.stringify(this.diagnoses));
                    console.log('ì§„ë‹¨ ë°ì´í„° ì €ì¥ë¨');
                } catch (error) {
                    console.error('ì§„ë‹¨ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            addCustomer(customerData) {
                const customer = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...customerData
                };
                
                this.customers.push(customer);
                this.saveCustomers();
                this.updateCustomerCount();
                this.displayCustomerHistory();
                
                console.log('ìƒˆ ê³ ê° ì¶”ê°€ë¨:', customer.name);
                return customer;
            }

            addDiagnosis(customerId, diagnosisData) {
                const diagnosis = {
                    id: Date.now().toString(),
                    customerId: customerId,
                    timestamp: new Date().toISOString(),
                    ...diagnosisData
                };
                
                this.diagnoses.push(diagnosis);
                this.saveDiagnoses();
                
                // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
                const customerIndex = this.customers.findIndex(c => c.id === customerId);
                if (customerIndex !== -1) {
                    this.customers[customerIndex].updatedAt = new Date().toISOString();
                    this.customers[customerIndex].lastDiagnosis = diagnosis.id;
                    this.saveCustomers();
                }
                
                this.displayCustomerHistory();
                console.log('ì§„ë‹¨ ê¸°ë¡ ì¶”ê°€ë¨');
                return diagnosis;
            }

            getCustomerHistory(limit = 20) {
                return this.customers
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, limit);
            }

            getCustomerDiagnoses(customerId) {
                return this.diagnoses
                    .filter(d => d.customerId === customerId)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            updateCustomerCount() {
                const countElement = document.getElementById('customer-count');
                if (countElement) {
                    countElement.textContent = this.customers.length;
                }
                window.PersonalColorSystem.performance.customersServed = this.customers.length;
            }

            displayCustomerHistory() {
                const tbody = document.getElementById('customer-history-body');
                if (!tbody) return;
                
                const history = this.getCustomerHistory(20);
                tbody.innerHTML = '';
                
                history.forEach(customer => {
                    const diagnoses = this.getCustomerDiagnoses(customer.id);
                    const lastDiagnosis = diagnoses[0];
                    
                    let diagnosisResult = 'ë¯¸ì§„ë‹¨';
                    let deltaEScore = '-';
                    let brandRecommendation = '-';
                    
                    if (lastDiagnosis) {
                        if (lastDiagnosis.analysis && lastDiagnosis.analysis.length > 0) {
                            const bestMatch = lastDiagnosis.analysis.reduce((best, current) => 
                                current.deltaE < best.deltaE ? current : best
                            );
                            diagnosisResult = `${bestMatch.season} (${bestMatch.assessment.description})`;
                            deltaEScore = bestMatch.deltaE.toFixed(1);
                            
                            if (bestMatch.brandRecommendations) {
                                const firstBrand = Object.keys(bestMatch.brandRecommendations)[0];
                                if (firstBrand) {
                                    brandRecommendation = firstBrand;
                                }
                            }
                        } else if (lastDiagnosis.skinTone) {
                            diagnosisResult = 'í”¼ë¶€í†¤ ë¶„ì„';
                            deltaEScore = 'N/A';
                        }
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(customer.updatedAt).toLocaleDateString('ko-KR')}</td>
                        <td><strong>${customer.name}</strong></td>
                        <td>${diagnosisResult}</td>
                        <td>${customer.visitPurpose || '-'}</td>
                        <td>${deltaEScore}</td>
                        <td>${brandRecommendation}</td>
                        <td>
                            <button onclick="loadCustomer('${customer.id}')" class="btn btn-secondary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            generatePDFReport(customerId) {
                const customer = this.customers.find(c => c.id === customerId);
                const diagnoses = this.getCustomerDiagnoses(customerId);
                
                if (!customer || diagnoses.length === 0) {
                    showToast('PDF ìƒì„±ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // í•œê¸€ í°íŠ¸ ì„¤ì • (ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©)
                    doc.setFont('helvetica', 'normal');
                    
                    // ì œëª©
                    doc.setFontSize(20);
                    doc.text('Personal Color Analysis Report', 20, 30);
                    
                    // ê³ ê° ì •ë³´
                    doc.setFontSize(14);
                    doc.text('Customer Information', 20, 50);
                    doc.setFontSize(11);
                    doc.text(`Name: ${customer.name}`, 25, 60);
                    doc.text(`Phone: ${customer.phone || 'N/A'}`, 25, 70);
                    doc.text(`Age: ${customer.age || 'N/A'}`, 25, 80);
                    doc.text(`Gender: ${customer.gender || 'N/A'}`, 25, 90);
                    doc.text(`Visit Purpose: ${customer.visitPurpose || 'N/A'}`, 25, 100);
                    
                    // ìµœì‹  ì§„ë‹¨ ê²°ê³¼
                    const latestDiagnosis = diagnoses[0];
                    doc.setFontSize(14);
                    doc.text('Latest Analysis Results', 20, 120);
                    doc.setFontSize(11);
                    doc.text(`Date: ${new Date(latestDiagnosis.timestamp).toLocaleString()}`, 25, 130);
                    
                    if (latestDiagnosis.skinTone) {
                        doc.text(`Skin Tone (Lab): L=${latestDiagnosis.skinTone.L.toFixed(1)}, a=${latestDiagnosis.skinTone.a.toFixed(1)}, b=${latestDiagnosis.skinTone.b.toFixed(1)}`, 25, 140);
                    }
                    
                    // ìƒ‰ìƒ ë¶„ì„ ê²°ê³¼
                    if (latestDiagnosis.analysis) {
                        doc.text('Color Analysis:', 25, 155);
                        latestDiagnosis.analysis.forEach((result, index) => {
                            const y = 165 + (index * 10);
                            doc.text(`${result.season}: ${result.color} (Delta E: ${result.deltaE.toFixed(1)} - ${result.assessment.description})`, 30, y);
                        });
                    }
                    
                    // ë¸Œëœë“œ ì¶”ì²œ
                    if (latestDiagnosis.analysis && latestDiagnosis.analysis[0]?.brandRecommendations) {
                        doc.text('Brand Recommendations:', 25, 200);
                        let y = 210;
                        Object.keys(latestDiagnosis.analysis[0].brandRecommendations).forEach(brand => {
                            doc.text(`${brand}:`, 30, y);
                            y += 10;
                            latestDiagnosis.analysis[0].brandRecommendations[brand].forEach(product => {
                                doc.text(`- ${product.code} ${product.name}`, 35, y);
                                y += 8;
                            });
                        });
                    }
                    
                    // ì €ì¥
                    doc.save(`PersonalColor_${customer.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                    console.log('PDF ë³´ê³ ì„œ ìƒì„±ë¨');
                    showToast('PDF ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    
                } catch (error) {
                    console.error('PDF ìƒì„± ì‹¤íŒ¨:', error);
                    showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            exportAllData() {
                try {
                    const data = {
                        exportDate: new Date().toISOString(),
                        version: window.PersonalColorSystem.version,
                        customers: this.customers,
                        diagnoses: this.diagnoses,
                        performance: window.PersonalColorSystem.performance,
                        systemInfo: {
                            userAgent: navigator.userAgent,
                            mediapikeSupport: window.PersonalColorSystem.ai.isMediaPipeReady,
                            deltaEStats: window.PersonalColorSystem.ai.deltaE?.getStats() || {}
                        }
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `PersonalColor_Export_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    console.log('ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
                    showToast('ëª¨ë“  ë°ì´í„°ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!', 'success');
                    
                } catch (error) {
                    console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                    showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        /**
         * ğŸ“± í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì‹œìŠ¤í…œ
         */
        function showToast(message, type = 'info', duration = 4000, submessage = '') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ', 
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                    ${submessage ? `<div class="toast-submessage">${submessage}</div>` : ''}
                </div>
                <button class="toast-close">&times;</button>
            `;

            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) container.removeChild(toast);
                }, 300);
            });

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) container.removeChild(toast);
                    }, 300);
                }
            }, duration);
        }

        /**
         * ğŸ”„ ëª¨ë“œ ì „í™˜ ì‹œìŠ¤í…œ
         */
        function switchMode(mode) {
            console.log('ëª¨ë“œ ì „í™˜:', mode);
            
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('mode-selection').classList.add('hidden');
            document.getElementById('face-detection-section').classList.remove('active');
            document.getElementById('customer-management').classList.remove('active');
            
            // ë“œë˜ì´í•‘ ì „ì²´í™”ë©´ ë‹«ê¸°
            const drapingFullscreen = document.getElementById('draping-fullscreen');
            if (drapingFullscreen.classList.contains('active')) {
                closeDraping();
            }
            
            // í—¤ë” ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            document.querySelectorAll('.header-btn').forEach(btn => btn.classList.remove('active'));
            
            // ëª¨ë“œ ì¹´ë“œ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            
            switch (mode) {
                case 'selection':
                    document.getElementById('mode-selection').classList.remove('hidden');
                    break;
                    
                case 'face-detection':
                    document.getElementById('face-detection-section').classList.add('active');
                    document.getElementById('face-detection-btn').classList.add('active');
                    document.querySelector('[data-mode="face-detection"]').classList.add('selected');
                    initializeFaceDetection();
                    break;
                    
                case 'draping':
                    initializeDrapingMode();
                    document.getElementById('draping-mode-btn').classList.add('active');
                    document.querySelector('[data-mode="draping"]').classList.add('selected');
                    break;
                    
                case 'customer':
                    document.getElementById('customer-management').classList.add('active');
                    document.getElementById('customer-management-btn').classList.add('active');
                    document.querySelector('[data-mode="customer"]').classList.add('selected');
                    break;
            }
            
            window.PersonalColorSystem.currentMode = mode;
        }

        /**
         * ğŸ”¬ ì‹¤ì œ ì–¼êµ´ê°ì§€ ëª¨ë“œ ì´ˆê¸°í™”
         */
        async function initializeFaceDetection() {
            try {
                showToast('ì‹¤ì œ MediaPipe ì–¼êµ´ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...', 'info');
                
                if (!window.PersonalColorSystem.faceDetectionEngine) {
                    const faceEngine = new MediaPipeFaceDetectionSystem();
                    await faceEngine.initialize();
                    window.PersonalColorSystem.faceDetectionEngine = faceEngine;
                    window.PersonalColorSystem.ai.faceMesh = faceEngine.faceMesh;
                }
                
                showToast('ì‹¤ì œ MediaPipe ì–¼êµ´ê°ì§€ ì¤€ë¹„ ì™„ë£Œ!', 'success', 5000, '468í¬ì¸íŠ¸ ì •ë°€ ê°ì§€ + ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ');
                
            } catch (error) {
                console.error('ì–¼êµ´ê°ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showToast('ì–¼êµ´ê°ì§€ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        /**
         * ğŸ­ ë“œë˜ì´í•‘ ëª¨ë“œ ì´ˆê¸°í™”
         */
        async function initializeDrapingMode() {
            try {
                showToast('ê°€ìƒ ë“œë˜ì´í•‘ ì‹œìŠ¤í…œ ì‹œì‘ ì¤‘...', 'info');
                
                const drapingEngine = new VirtualDrapingEngine();
                await drapingEngine.initialize();
                
                window.PersonalColorSystem.drapingEngine = drapingEngine;
                
                document.getElementById('draping-fullscreen').classList.add('active');
                
                showToast('ê°€ìƒ ë“œë˜ì´í•‘ ì¤€ë¹„ ì™„ë£Œ!', 'success', 5000, 'ì „ë¬¸ ë¸Œëœë“œ DB + Delta E ì‹¤ì‹œê°„ ë¶„ì„');
                
            } catch (error) {
                console.error('ë“œë˜ì´í•‘ ëª¨ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showToast('ë“œë˜ì´í•‘ ëª¨ë“œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        /**
         * ğŸ¯ ì–¼êµ´ê°ì§€ ìƒ‰ìƒ í…ŒìŠ¤íŠ¸
         */
        function testFaceColor(r, g, b, colorName) {
            const faceEngine = window.PersonalColorSystem.faceDetectionEngine;
            if (!faceEngine || !faceEngine.currentSkinTone) {
                showToast('ë¨¼ì € í”¼ë¶€í†¤ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const testColorLab = faceEngine.rgbToLab(r, g, b);
            const deltaE = window.PersonalColorSystem.ai.deltaE.calculateDeltaE2000(
                faceEngine.currentSkinTone, 
                testColorLab
            );
            const assessment = window.PersonalColorSystem.ai.deltaE.assessColorMatching(deltaE);
            
            document.getElementById('face-delta-value').textContent = deltaE.toFixed(1);
            document.getElementById('face-delta-description').textContent = 
                `${colorName}: ${assessment.description} - ${assessment.recommendation}`;
            
            console.log(`ìƒ‰ìƒ ë§¤ì¹­ í…ŒìŠ¤íŠ¸: ${colorName} RGB(${r}, ${g}, ${b}) â†’ Î”E = ${deltaE.toFixed(1)} (${assessment.description})`);
        }

        /**
         * ğŸ‘¥ ê³ ê° ê´€ë¦¬ í•¨ìˆ˜ë“¤
         */
        function saveCustomer() {
            const customerData = {
                name: document.getElementById('customer-name').value.trim(),
                phone: document.getElementById('customer-phone').value.trim(),
                age: document.getElementById('customer-age').value,
                gender: document.getElementById('customer-gender').value,
                visitPurpose: document.getElementById('visit-purpose').value,
                notes: document.getElementById('customer-notes').value.trim()
            };
            
            if (!customerData.name) {
                showToast('ê³ ê° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const customer = window.PersonalColorSystem.customerManager.addCustomer(customerData);
                window.PersonalColorSystem.currentCustomer = customer;
                
                showToast(`${customer.name}ë‹˜ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                
            } catch (error) {
                console.error('ê³ ê° ì €ì¥ ì‹¤íŒ¨:', error);
                showToast('ê³ ê° ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function loadCustomer(customerId) {
            const customer = window.PersonalColorSystem.customerManager.customers.find(c => c.id === customerId);
            
            if (!customer) {
                showToast('ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // í¼ì— ê³ ê° ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('customer-name').value = customer.name || '';
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-age').value = customer.age || '';
            document.getElementById('customer-gender').value = customer.gender || '';
            document.getElementById('visit-purpose').value = customer.visitPurpose || '';
            document.getElementById('customer-notes').value = customer.notes || '';
            
            window.PersonalColorSystem.currentCustomer = customer;
            
            const diagnoses = window.PersonalColorSystem.customerManager.getCustomerDiagnoses(customerId);
            showToast(`${customer.name}ë‹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success', 4000, 
                `ì§„ë‹¨ ì´ë ¥ ${diagnoses.length}ê±´`);
        }

        function clearCustomerForm() {
            const fields = ['customer-name', 'customer-phone', 'customer-age', 'customer-gender', 'visit-purpose', 'customer-notes'];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = '';
                }
            });
            
            window.PersonalColorSystem.currentCustomer = null;
            showToast('ê³ ê° ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        function generatePDFReport() {
            const currentCustomer = window.PersonalColorSystem.currentCustomer;
            if (!currentCustomer) {
                showToast('PDF ìƒì„±ì„ ìœ„í•´ ê³ ê°ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            window.PersonalColorSystem.customerManager.generatePDFReport(currentCustomer.id);
        }

        function exportAllData() {
            window.PersonalColorSystem.customerManager.exportAllData();
        }

        function showSystemStatus() {
            const system = window.PersonalColorSystem;
            const deltaStats = system.ai.deltaE?.getStats() || {};
            
            let status = '=== Personal Color AI Pro ì‹œìŠ¤í…œ ìƒíƒœ ===\n\n';
            status += `ë²„ì „: ${system.version}\n`;
            status += `ì‹œì‘ ì‹œê°„: ${new Date(system.startTime).toLocaleString()}\n`;
            status += `ì‹¤í–‰ ì‹œê°„: ${((Date.now() - system.startTime) / 1000 / 60).toFixed(1)}ë¶„\n\n`;
            
            status += '=== AI ì‹œìŠ¤í…œ ìƒíƒœ ===\n';
            status += `Delta E 2000 ì—”ì§„: ${system.ai.deltaE ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}\n`;
            status += `MediaPipe ì—°ê²°: ${system.ai.isMediaPipeReady ? 'âœ… ì—°ê²°ë¨' : 'âŒ ë¯¸ì—°ê²°'}\n`;
            status += `ì–¼êµ´ê°ì§€ ì—”ì§„: ${system.faceDetectionEngine ? 'âœ… ì¤€ë¹„ë¨' : 'âŒ ë¯¸ì¤€ë¹„'}\n`;
            status += `ë“œë˜ì´í•‘ ì—”ì§„: ${system.drapingEngine ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}\n\n`;
            
            status += '=== ì„±ëŠ¥ í†µê³„ ===\n';
            status += `ì´ ë¶„ì„ íšŸìˆ˜: ${system.performance.totalAnalyses}íšŒ\n`;
            status += `Delta E ê³„ì‚°: ${system.performance.deltaECalculations}íšŒ\n`;
            status += `MediaPipe ê°ì§€: ${system.performance.mediaipeDetections}íšŒ\n`;
            status += `ì„œë¹„ìŠ¤í•œ ê³ ê°: ${system.performance.customersServed}ëª…\n\n`;
            
            if (deltaStats.totalCalculations) {
                status += '=== Delta E 2000 ìƒì„¸ ===\n';
                status += `ì´ ê³„ì‚°: ${deltaStats.totalCalculations}íšŒ\n`;
                status += `ìºì‹œ ì ì¤‘ë¥ : ${deltaStats.hitRate}%\n`;
                status += `ìºì‹œ í¬ê¸°: ${deltaStats.cacheSize}ê°œ\n`;
            }
            
            alert(status);
        }

        /**
         * ğŸ­ ë“œë˜ì´í•‘ ì œì–´ í•¨ìˆ˜ë“¤
         */
        function captureDraping() {
            const engine = window.PersonalColorSystem.drapingEngine;
            if (engine) {
                engine.capture();
            } else {
                showToast('ë“œë˜ì´í•‘ ì—”ì§„ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function resetDraping() {
            const engine = window.PersonalColorSystem.drapingEngine;
            if (engine) {
                engine.reset();
            }
        }

        function saveDrapingResult() {
            const engine = window.PersonalColorSystem.drapingEngine;
            if (engine) {
                engine.saveResults();
            } else {
                showToast('ë“œë˜ì´í•‘ ì—”ì§„ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function closeDraping() {
            const engine = window.PersonalColorSystem.drapingEngine;
            if (engine) {
                engine.destroy();
                window.PersonalColorSystem.drapingEngine = null;
            }
            
            document.getElementById('draping-fullscreen').classList.remove('active');
            switchMode('selection');
        }

        /**
         * ğŸš€ ì•± ì´ˆê¸°í™” ì‹œìŠ¤í…œ
         */
        class AppInitializer {
            constructor() {
                this.loadingSteps = [
                    { id: 'mediapipe', name: 'MediaPipe Face Mesh ì‹¤ì œ ì—°ê²°', duration: 800 },
                    { id: 'tensorflow', name: 'TensorFlow.js ëª¨ë¸ ë¡œë”©', duration: 600 },
                    { id: 'deltae', name: 'Delta E 2000 ê³„ì‚° ì—”ì§„ ì¤€ë¹„', duration: 400 },
                    { id: 'skin', name: 'ì‹¤ì œ í”¼ë¶€í†¤ ì¶”ì¶œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”', duration: 500 },
                    { id: 'database', name: 'ì „ë¬¸ ë¸Œëœë“œ DB ë¡œë“œ', duration: 600 },
                    { id: 'customer', name: 'ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ ì¤€ë¹„', duration: 400 },
                    { id: 'ui', name: 'UI ì‹œìŠ¤í…œ ì¤€ë¹„', duration: 350 }
                ];
                
                this.currentStep = 0;
                this.totalSteps = this.loadingSteps.length;
            }

            async initialize() {
                console.log('ğŸš€ Personal Color AI Pro ì™„ì „ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
                
                try {
                    for (let i = 0; i < this.loadingSteps.length; i++) {
                        const step = this.loadingSteps[i];
                        
                        this.updateStep(step.id, 'active');
                        this.updateProgress((i / this.totalSteps) * 100, step.name + '...');
                        
                        await this.executeStep(step);
                        await this.delay(step.duration);
                        
                        this.updateStep(step.id, 'complete');
                    }
                    
                    this.updateProgress(100, 'ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!');
                    
                    setTimeout(() => {
                        this.completeLoading();
                    }, 500);
                    
                } catch (error) {
                    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showError('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async executeStep(step) {
                switch (step.id) {
                    case 'mediapipe':
                        // MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                        if (typeof FaceMesh !== 'undefined') {
                            window.PersonalColorSystem.ai.isMediaPipeReady = true;
                            console.log('âœ… MediaPipe FaceMesh ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ë¨');
                        } else {
                            console.warn('âš ï¸ MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                        }
                        break;
                        
                    case 'tensorflow':
                        if (typeof tf !== 'undefined') {
                            console.log('âœ… TensorFlow.js ë²„ì „:', tf.version.core);
                        }
                        break;
                        
                    case 'deltae':
                        window.PersonalColorSystem.ai.deltaE = new DeltaE2000Calculator();
                        console.log('âœ… Delta E 2000 ê³„ì‚° ì—”ì§„ ì´ˆê¸°í™”ë¨');
                        break;
                        
                    case 'skin':
                        // í”¼ë¶€í†¤ ë¶„ì„ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ
                        console.log('âœ… í”¼ë¶€í†¤ ë¶„ì„ ì‹œìŠ¤í…œ ì¤€ë¹„ë¨');
                        break;
                        
                    case 'database':
                        // ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ í™•ì¸
                        console.log('âœ… ì „ë¬¸ ë¸Œëœë“œ DB ë¡œë“œë¨:', Object.keys(PROFESSIONAL_BRAND_DATABASE).length, 'ê°œ ë¸Œëœë“œ');
                        console.log('âœ… 4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ë¡œë“œë¨:', Object.keys(SEASON_COLOR_PALETTES).length, 'ê°œ ì‹œì¦Œ');
                        break;
                        
                    case 'customer':
                        window.PersonalColorSystem.customerManager = new CustomerManagementSystem();
                        console.log('âœ… ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨');
                        break;
                        
                    case 'ui':
                        this.initializeUI();
                        console.log('âœ… UI ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨');
                        break;
                }
            }

            initializeUI() {
                this.setupEventListeners();
                
                // ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (window.PersonalColorSystem.customerManager) {
                    window.PersonalColorSystem.customerManager.updateCustomerCount();
                    window.PersonalColorSystem.customerManager.displayCustomerHistory();
                }
            }

            setupEventListeners() {
                // í—¤ë” ë²„íŠ¼ë“¤
                document.getElementById('face-detection-btn')?.addEventListener('click', () => switchMode('face-detection'));
                document.getElementById('draping-mode-btn')?.addEventListener('click', () => switchMode('draping'));
                document.getElementById('customer-management-btn')?.addEventListener('click', () => switchMode('customer'));
                document.getElementById('system-status-btn')?.addEventListener('click', showSystemStatus);
                document.getElementById('export-data-btn')?.addEventListener('click', exportAllData);
                
                // ëª¨ë“œ ì¹´ë“œë“¤
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const mode = card.getAttribute('data-mode');
                        if (mode) switchMode(mode);
                    });
                });
                
                // ë“œë˜ì´í•‘ ì»¨íŠ¸ë¡¤
                document.getElementById('capture-draping-btn')?.addEventListener('click', captureDraping);
                document.getElementById('reset-draping-btn')?.addEventListener('click', resetDraping);
                document.getElementById('save-draping-result-btn')?.addEventListener('click', saveDrapingResult);
                document.getElementById('close-draping-btn')?.addEventListener('click', closeDraping);
                
                // ê³ ê° ê´€ë¦¬
                document.getElementById('save-customer-btn')?.addEventListener('click', saveCustomer);
                document.getElementById('clear-customer-btn')?.addEventListener('click', clearCustomerForm);
                document.getElementById('export-pdf-btn')?.addEventListener('click', generatePDFReport);
                document.getElementById('export-customer-btn')?.addEventListener('click', exportAllData);
                
                console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            }

            updateStep(stepId, status) {
                const step = document.getElementById(`step-${stepId}`);
                if (!step) return;
                
                const icons = { active: 'â³', complete: 'âœ…', error: 'âŒ' };
                const text = step.textContent.replace(/[â³âœ…âŒ]\s*/, '');
                step.textContent = `${icons[status]} ${text}`;
                
                if (status === 'active') {
                    step.classList.add('active');
                } else if (status === 'complete') {
                    step.classList.add('complete');
                    step.classList.remove('active');
                }
            }

            updateProgress(percentage, message) {
                const progressBar = document.getElementById('loading-progress');
                const messageEl = document.getElementById('loading-message');
                
                if (progressBar) {
                    progressBar.style.width = Math.min(100, Math.max(0, percentage)) + '%';
                }
                
                if (messageEl && message) {
                    messageEl.textContent = message;
                }
            }

            completeLoading() {
                const loadingScreen = document.getElementById('loading-screen');
                const mainApp = document.getElementById('main-app');
                
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                
                if (mainApp) {
                    mainApp.style.display = 'block';
                    mainApp.classList.add('loaded');
                }
                
                window.PersonalColorSystem.isLoaded = true;
                
                // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                document.getElementById('mediapipe-status').textContent = 
                    window.PersonalColorSystem.ai.isMediaPipeReady ? 'ì—°ê²°ë¨' : 'ë¯¸ì—°ê²°';
                document.getElementById('diagnosis-count').textContent = '0';
                
                showToast(
                    'ğŸ¯ Personal Color AI Pro ì™„ì „ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 
                    'success', 
                    6000, 
                    'ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ DB + ì™„ì „í•œ ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ'
                );
                
                console.log('ğŸ‰ Personal Color AI Pro ë¡œë”© ì™„ë£Œ!');
                console.log('âœ… ì‹¤ì œ MediaPipe FaceMesh 468í¬ì¸íŠ¸ ê°ì§€ í™œì„±í™”');
                console.log('âœ… ì‹¤ì œ Delta E 2000 ê³„ì‚° ì—”ì§„ í™œì„±í™”');  
                console.log('âœ… ì „ë¬¸ ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤ (ë¡œë ˆì•Œ/ì›°ë¼/ìŠˆë°”ë¥´ì¸ ì½”í”„/ë°€ë³¸) ë¡œë“œ');
                console.log('âœ… ì™„ì „í•œ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ í™œì„±í™”');
                console.log('âœ… PDF ë³´ê³ ì„œ ìƒì„± ì‹œìŠ¤í…œ ì¤€ë¹„');
                console.log('âœ… ë” ì´ìƒ ì‹œë®¬ë ˆì´ì…˜ ì•„ë‹˜ - ì‹¤ì œ ì‘ë™í•˜ëŠ” ì‹œìŠ¤í…œ!');
            }

            showError(message) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', message);
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%;
                    transform: translate(-50%, -50%);
                    background: white; color: #dc2626;
                    padding: 2rem; border-radius: 12px;
                    border: 2px solid #fecaca;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    z-index: 10000; text-align: center;
                    max-width: 400px;
                `;
                
                errorDiv.innerHTML = `
                    <h3 style="margin-bottom: 1rem; color: #dc2626;">âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜</h3>
                    <p style="margin-bottom: 1.5rem; line-height: 1.5; color: #374151;">${message}</p>
                    <button onclick="location.reload()" style="
                        background: #dc2626; color: white; border: none; 
                        padding: 0.8rem 1.5rem; border-radius: 8px; 
                        cursor: pointer; font-size: 0.9rem; font-weight: 600;
                    ">í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
                `;
                
                document.body.appendChild(errorDiv);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ğŸš€ ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ë¡œë“œ ì™„ë£Œ - Personal Color AI Pro ì‹œì‘');
            
            try {
                const appInitializer = new AppInitializer();
                appInitializer.initialize().catch((error) => {
                    console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
                    
                    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ê¸°ë³¸ ì‹œìŠ¤í…œ ë¡œë“œ
                    setTimeout(() => {
                        console.log('ìë™ìœ¼ë¡œ ê¸°ë³¸ ì‹œìŠ¤í…œ ë¡œë“œ');
                        
                        const loadingScreen = document.getElementById('loading-screen');
                        const mainApp = document.getElementById('main-app');
                        if (loadingScreen) loadingScreen.style.display = 'none';
                        if (mainApp) {
                            mainApp.style.display = 'block';
                            mainApp.classList.add('loaded');
                        }
                        
                        // ê¸°ë³¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                        try {
                            window.PersonalColorSystem.ai.deltaE = new DeltaE2000Calculator();
                            window.PersonalColorSystem.customerManager = new CustomerManagementSystem();
                            window.PersonalColorSystem.isLoaded = true;
                            
                            // ê¸°ë³¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                            document.getElementById('face-detection-btn')?.addEventListener('click', () => switchMode('face-detection'));
                            document.getElementById('draping-mode-btn')?.addEventListener('click', () => switchMode('draping'));
                            document.getElementById('customer-management-btn')?.addEventListener('click', () => switchMode('customer'));
                            
                            document.querySelectorAll('.mode-card').forEach(card => {
                                card.addEventListener('click', () => {
                                    const mode = card.getAttribute('data-mode');
                                    if (mode) switchMode(mode);
                                });
                            });
                            
                            showToast('ê¸°ë³¸ ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                            console.log('âœ… ê¸°ë³¸ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
                            
                        } catch (fallbackError) {
                            console.error('ê¸°ë³¸ ì‹œìŠ¤í…œ ë¡œë“œë„ ì‹¤íŒ¨:', fallbackError);
                            showToast('ì‹œìŠ¤í…œ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
                        }
                    }, 5000);
                });
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
            }
        });

        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', (event) => {
            console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
            showToast('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
        });

        // ê°œë°œì ë„êµ¬
        window.PersonalColorDebug = {
            system: () => window.PersonalColorSystem,
            testDeltaE: () => {
                const deltaE = window.PersonalColorSystem.ai.deltaE;
                if (deltaE) {
                    const lab1 = { L: 50, a: 10, b: 20 };
                    const lab2 = { L: 60, a: 15, b: 25 };
                    const result = deltaE.calculateDeltaE2000(lab1, lab2);
                    console.log(`Delta E 2000 í…ŒìŠ¤íŠ¸: ${result}`);
                    showToast(`Delta E í…ŒìŠ¤íŠ¸: ${result}`, 'info');
                    return result;
                }
                return 'Delta E ì—”ì§„ ì—†ìŒ';
            },
            testMediaPipe: () => {
                console.log('MediaPipe ìƒíƒœ:', window.PersonalColorSystem.ai.isMediaPipeReady);
                console.log('FaceMesh ê°ì²´:', window.PersonalColorSystem.ai.faceMesh);
                return window.PersonalColorSystem.ai.isMediaPipeReady;
            },
            exportLog: () => {
                const log = {
                    timestamp: new Date().toISOString(),
                    system: window.PersonalColorSystem,
                    userAgent: navigator.userAgent,
                    mediapikeSupport: typeof FaceMesh !== 'undefined',
                    tensorflowSupport: typeof tf !== 'undefined',
                    performance: performance.getEntriesByType('navigation')
                };
                console.log('ì‹œìŠ¤í…œ ë¡œê·¸:', log);
                return log;
            }
        };

        console.log('ğŸ¯ Personal Color AI Pro ì™„ì „ ì‹œìŠ¤í…œ ë¡œë”© ì™„ë£Œ!');
        console.log('ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ DB + ì™„ì „í•œ ê³ ê°ê´€ë¦¬');
        console.log('- ì‹¤ì œ FaceMesh 468í¬ì¸íŠ¸ ì–¼êµ´ ê°ì§€');
        console.log('- ì‹¤ì œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ + CIE Lab ë³€í™˜');
        console.log('- ì‹¤ì œ Delta E 2000 ê³µì‹ ê³„ì‚°');
        console.log('- ë¡œë ˆì•Œ/ì›°ë¼/ìŠˆë°”ë¥´ì¸ ì½”í”„/ë°€ë³¸ ì „ë¬¸ ë¸Œëœë“œ DB');
        console.log('- ì™„ì „í•œ ê³ ê° ê´€ë¦¬ + PDF ë³´ê³ ì„œ ìƒì„±');
        console.log('- ê°€ìƒ ë“œë˜ì´í•‘ + ì‹¤ì‹œê°„ ìƒ‰ìƒ ë¶„ì„');
        console.log('ë””ë²„ê·¸: window.PersonalColorDebug ì‚¬ìš© ê°€ëŠ¥');
    </script>
</body>
</html>
