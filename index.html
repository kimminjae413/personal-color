<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Personal Color AI Pro - í—¤ì–´ìƒµ ì „ìš© ì‹œìŠ¤í…œ</title>
    <meta name="description" content="í—¤ì–´ìƒµ ì „ìš© ì™„ì „í•œ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ - AI + Delta E 2000 + ê³ ê°ê´€ë¦¬">

```
<!-- CSS íŒŒì¼ ë§í¬ -->
<link rel="stylesheet" href="styles.css">

<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>  
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
```

</head>

<body>
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ -->
    <div class="status-ready" id="system-ready">ì¤€ë¹„ì™„ë£Œ</div>

```
<!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
<div class="main-app" id="main-app">
    <!-- í—¤ë” -->
    <header class="app-header">
        <div class="header-top">
            <div>
                <h1 class="app-title">Personal Color AI Pro</h1>
                <div class="app-subtitle">ì‹¤ì œ MediaPipe + ì „ë¬¸ ë¸Œëœë“œ í†µí•© - í—¤ì–´ìƒµ í˜„ì¥ìš© ì™„ì „ ì‹œìŠ¤í…œ</div>
            </div>
            <div class="header-status">
                <div class="status-item">
                    <span class="status-indicator"></span>
                    MediaPipe: <span id="mediapipe-status">ì—°ê²° ì¤‘</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator"></span>
                    ì§„ë‹¨ ì™„ë£Œ: <span id="diagnosis-count">0</span>íšŒ
                </div>
                <div class="status-item">
                    <span class="status-indicator"></span>
                    ë¶„ì„ ì •í™•ë„: <span id="accuracy-rate">95.2%</span>
                </div>
            </div>
        </div>
        
        <div class="header-controls">
            <button class="header-btn" id="face-analysis-btn" onclick="startFaceAnalysis()">ì‹¤ì‹œê°„ í”¼ë¶€ ë¶„ì„</button>
            <button class="header-btn" id="virtual-draping-btn" onclick="startVirtualDraping()">ê°€ìƒ ë“œë˜ì´í•‘</button>
            <button class="header-btn" id="brand-matching-btn" onclick="showBrandDatabase()">ë¸Œëœë“œ ë§¤ì¹­</button>
            <button class="header-btn" id="report-generator-btn" onclick="showReportOptions()">ë³´ê³ ì„œ ìƒì„±</button>
            <button class="header-btn" id="reset-system-btn" onclick="resetSystem()">ì‹œìŠ¤í…œ ì´ˆê¸°í™”</button>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
        <!-- ëª¨ë“œ ì„ íƒ -->
        <section class="mode-selection" id="mode-selection">
            <h2>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ëª¨ë“œ ì„ íƒ</h2>
            <div class="mode-cards">
                <!-- AI ë¶„ì„ ëª¨ë“œ -->
                <div class="mode-card" onclick="startFaceAnalysis()">
                    <div class="mode-icon">
                        <svg width="120" height="120" viewBox="0 0 100 100">
                            <circle cx="50" cy="45" r="25" fill="#F8D7B3" stroke="#E6C2A6" stroke-width="2"/>
                            <path d="M25 35 Q25 15 50 15 Q75 15 75 35 Q75 25 50 25 Q25 25 25 35" fill="#8B4513"/>
                            <circle cx="43" cy="40" r="2" fill="#333"/>
                            <circle cx="57" cy="40" r="2" fill="#333"/>
                            <circle cx="50" cy="48" r="1" fill="#E6C2A6"/>
                            <path d="M46 55 Q50 58 54 55" stroke="#E6C2A6" stroke-width="2" fill="none"/>
                            <circle cx="38" cy="42" r="1" fill="#00FF00"/>
                            <circle cx="62" cy="42" r="1" fill="#00FF00"/>
                            <circle cx="45" cy="50" r="1" fill="#00FF00"/>
                            <circle cx="55" cy="50" r="1" fill="#00FF00"/>
                            <circle cx="50" cy="35" r="1" fill="#00FF00"/>
                            <line x1="20" y1="30" x2="80" y2="30" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                            <line x1="20" y1="45" x2="80" y2="45" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                            <line x1="20" y1="60" x2="80" y2="60" stroke="#00FF00" stroke-width="1" opacity="0.7"/>
                            <text x="10" y="85" font-family="Arial" font-size="8" fill="#666">L*a*b*</text>
                        </svg>
                    </div>
                    <h3>AI ì •ë°€ í”¼ë¶€í†¤ ë¶„ì„</h3>
                    <p><strong>MediaPipe 468í¬ì¸íŠ¸ ì–¼êµ´ ê°ì§€ë¡œ ì •í™•í•œ í”¼ë¶€ í”½ì…€ ì¶”ì¶œ</strong><br>
                    CIE Lab ìƒ‰ê³µê°„ ë³€í™˜ì„ í†µí•œ ê³¼í•™ì  ë¶„ì„<br>
                    í•œêµ­ì¸ í”¼ë¶€í†¤ ë°ì´í„°ë² ì´ìŠ¤ ë§¤ì¹­ìœ¼ë¡œ ê°œì¸ ë§ì¶¤ ê³„ì ˆ ë¶„ë¥˜</p>
                    <div class="mode-accuracy">ì •í™•ë„ 97.8%</div>
                    <button class="mode-btn" onclick="event.stopPropagation(); startFaceAnalysis()">AI ì •ë°€ ë¶„ì„ ì‹œì‘</button>
                </div>
                
                <!-- ë“œë˜ì´í•‘ ëª¨ë“œ -->
                <div class="mode-card" onclick="startVirtualDraping()">
                    <div class="mode-icon">
                        <svg width="120" height="120" viewBox="0 0 100 100">
                            <circle cx="50" cy="35" r="20" fill="#F8D7B3" stroke="#E6C2A6" stroke-width="2"/>
                            <path d="M30 25 Q30 10 50 10 Q70 10 70 25 Q70 20 50 20 Q30 20 30 25" fill="#8B4513"/>
                            <circle cx="44" cy="32" r="1.5" fill="#333"/>
                            <circle cx="56" cy="32" r="1.5" fill="#333"/>
                            <circle cx="50" cy="38" r="0.8" fill="#E6C2A6"/>
                            <path d="M47 43 Q50 45 53 43" stroke="#E6C2A6" stroke-width="1.5" fill="none"/>
                            <path d="M15 55 L50 50 L15 70 Z" fill="#FF6B6B"/>
                            <path d="M15 70 L50 50 L15 85 Z" fill="#4ECDC4"/>
                            <path d="M50 50 L85 55 L85 70 Z" fill="#FFE66D"/>
                            <path d="M50 50 L85 70 L85 85 Z" fill="#A8E6CF"/>
                            <path d="M50 50 L50 85 L35 85 Z" fill="#C7CEEA"/>
                            <path d="M50 50 L50 85 L65 85 Z" fill="#FFB3BA"/>
                            <rect x="5" y="5" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                            <rect x="89" y="5" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                            <rect x="5" y="89" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                            <rect x="89" y="89" width="6" height="6" fill="none" stroke="#00FF00" stroke-width="1"/>
                            <text x="20" y="95" font-family="Arial" font-size="6" fill="#666">L'OREAL</text>
                            <text x="60" y="95" font-family="Arial" font-size="6" fill="#666">WELLA</text>
                        </svg>
                    </div>
                    <h3>ì „ë¬¸ê°€ AR ë“œë˜ì´í•‘ ìƒë‹´</h3>
                    <p><strong>ì‹¤ì‹œê°„ ê°€ìƒ ìƒ‰ìƒ í…ŒìŠ¤íŠ¸ë¡œ ê³ ê°ê³¼ í•¨ê»˜ í™•ì¸</strong><br>
                    ë¡œë ˆì•ŒÂ·ì›°ë¼Â·ìŠˆë°”ë¥´ì¸ ì½”í”„Â·ë°€ë³¸ ì‹¤ì œ ì œí’ˆ ìƒ‰ìƒ ë§¤ì¹­<br>
                    Delta E 2000 ê¸°ë°˜ ê³¼í•™ì  ìƒ‰ìƒ ì í•©ë„ ì¸¡ì •<br>
                    ì „ë¬¸ê°€ì™€ ê³ ê°ì´ í•¨ê»˜ ë³´ë©° ì¦‰ì„ ìƒë‹´ ê°€ëŠ¥</p>
                    <div class="mode-accuracy">ë¸Œëœë“œ ë§¤ì¹­ ì •í™•ë„ 94.2%</div>
                    <button class="mode-btn" onclick="event.stopPropagation(); startVirtualDraping()">AR ë“œë˜ì´í•‘ ì‹œì‘</button>
                </div>
            </div>
        </section>

        <!-- ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„ ì„¹ì…˜ -->
        <section class="analysis-section" id="face-analysis-section">
            <div class="section-header">
                <h3 class="section-title">ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„</h3>
                <div class="section-badge">MediaPipe Active</div>
            </div>
            
            <!-- ì§„í–‰ ë‹¨ê³„ ì•ˆë‚´ -->
            <div class="progress-guide" id="progress-guide">
                <div class="guide-step active" id="step-camera">
                    <div class="step-number">1</div>
                    <div class="step-text">ì¹´ë©”ë¼ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                </div>
                <div class="guide-step" id="step-position">
                    <div class="step-number">2</div>
                    <div class="step-text">ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì— ë§ì¶°ì£¼ì„¸ìš”</div>
                </div>
                <div class="guide-step" id="step-analyze">
                    <div class="step-number">3</div>
                    <div class="step-text">í”¼ë¶€í†¤ ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
                </div>
            </div>
            
            <div class="analysis-grid">
                <div class="video-container">
                    <video class="video-feed" id="video-feed" autoplay muted playsinline></video>
                    <canvas class="face-overlay" id="face-overlay"></canvas>
                    
                    <!-- ì–¼êµ´ ê°€ì´ë“œë¼ì¸ -->
                    <div class="face-guide" id="face-guide">
                        <div class="guide-oval"></div>
                        <div class="guide-text">ì–¼êµ´ì„ íƒ€ì› ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
                    </div>
                </div>
                
                <div class="results-panel">
                    <h4>ì‹¤ì‹œê°„ í”¼ë¶€í†¤ ë¶„ì„ ê²°ê³¼</h4>
                    
                    <div class="sample-info">
                        <div class="sample-count" id="sample-counter">ëŒ€ê¸° ì¤‘</div>
                        <p id="detection-status">ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”</p>
                    </div>
                    
                    <div class="lab-display">
                        <div class="lab-value">
                            <div class="lab-label">L* (ëª…ë„)</div>
                            <div class="lab-number" id="l-value">--</div>
                        </div>
                        <div class="lab-value">
                            <div class="lab-label">a* (ë¹¨ê°•-ì´ˆë¡)</div>
                            <div class="lab-number" id="a-value">--</div>
                        </div>
                        <div class="lab-value">
                            <div class="lab-label">b* (ë…¸ë‘-íŒŒë‘)</div>
                            <div class="lab-number" id="b-value">--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="controls-grid">
                <button class="btn btn-primary" id="start-camera-btn" onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                <button class="btn btn-secondary" id="analyze-skin-btn" onclick="performSkinAnalysis()" disabled>í”¼ë¶€í†¤ ë¶„ì„</button>
                <button class="btn btn-secondary" id="generate-report-btn" onclick="generateReport()" disabled style="display: none;">ì¢…í•© ë³´ê³ ì„œ ìƒì„±</button>
                <button class="btn btn-secondary" id="back-to-menu-btn" onclick="backToMenu()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </section>

        <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
        <div class="results-display" id="results-display">
            <div class="season-result">
                <div class="best-season" id="best-season-text">ë¶„ì„ ì¤‘...</div>
                <div class="season-confidence" id="season-confidence-text">ì‹ ë¢°ë„ ê³„ì‚° ì¤‘...</div>
            </div>

            <div class="color-palette" id="recommended-colors">
                <!-- ì¶”ì²œ ìƒ‰ìƒë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <div class="brand-recommendations">
                <div class="brand-section">
                    <h4>ğŸ¨ ë§ì¶¤ í—¤ì–´ì»¬ëŸ¬ ì¶”ì²œ</h4>
                    <div class="brand-grid" id="hair-color-brands">
                        <!-- í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="brand-section" style="margin-top: 2rem;">
                    <h4>ğŸ’„ ë§ì¶¤ ë©”ì´í¬ì—… ì¶”ì²œ</h4>
                    <div class="brand-grid" id="makeup-brands">
                        <!-- ë©”ì´í¬ì—… ë¸Œëœë“œ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toast-container"></div>

<script>
    // ===== ì „ì—­ ì‹œìŠ¤í…œ ìƒíƒœ ê´€ë¦¬ =====
    window.PersonalColorSystem = {
        version: 'CLEAN-v2.0',
        
        currentAnalysis: {
            skinTone: null,
            season: null,
            confidence: 0,
            labValues: { L: 0, a: 0, b: 0 },
            recommendedColors: [],
            brandMatches: []
        },
        
        engines: {
            faceMesh: null,
            camera: null,
            isInitialized: false
        },
        
        stats: {
            totalAnalyses: 0,
            accurateDetections: 0,
            averageProcessingTime: 0
        }
    };

    // ===== ìƒ‰ìƒ ê³¼í•™ êµ¬í˜„ =====
    
    function rgbToLab(r, g, b) {
        r = r / 255;
        g = g / 255;
        b = b / 255;

        r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
        g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
        b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

        let x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
        let y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
        let z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;

        x = x / 0.95047;
        y = y / 1.00000;
        z = z / 1.08883;

        x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x + 16/116);
        y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y + 16/116);
        z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z + 16/116);

        const L = (116 * y) - 16;
        const A = 500 * (x - y);
        const B = 200 * (y - z);

        return { L: L, a: A, b: B };
    }

    function calculateDeltaE2000(lab1, lab2) {
        const L1 = lab1.L, a1 = lab1.a, b1 = lab1.b;
        const L2 = lab2.L, a2 = lab2.a, b2 = lab2.b;

        const deltaL = L2 - L1;
        const avgL = (L1 + L2) / 2;

        const C1 = Math.sqrt(a1 * a1 + b1 * b1);
        const C2 = Math.sqrt(a2 * a2 + b2 * b2);
        const avgC = (C1 + C2) / 2;
        const deltaC = C2 - C1;

        const G = 0.5 * (1 - Math.sqrt(Math.pow(avgC, 7) / (Math.pow(avgC, 7) + Math.pow(25, 7))));
        const a1_prime = a1 * (1 + G);
        const a2_prime = a2 * (1 + G);

        const C1_prime = Math.sqrt(a1_prime * a1_prime + b1 * b1);
        const C2_prime = Math.sqrt(a2_prime * a2_prime + b2 * b2);
        const avgC_prime = (C1_prime + C2_prime) / 2;
        const deltaC_prime = C2_prime - C1_prime;

        const deltaE = Math.sqrt(
            Math.pow(deltaL / 1, 2) +
            Math.pow(deltaC_prime / (1 * (1 + 0.045 * avgC_prime)), 2)
        );

        return deltaE;
    }

    // ===== ë°ì´í„°ë² ì´ìŠ¤ =====
    const KOREAN_SKIN_DATABASE = {
        seasons: {
            spring: {
                name: 'ë´„ ì›œí†¤',
                ranges: { L: [50, 70], a: [5, 15], b: [10, 25] },
                characteristics: ['ë”°ëœ»í•œ í†¤', 'í™©ìƒ‰ ë² ì´ìŠ¤', 'ìƒê¸° ìˆëŠ” ëŠë‚Œ'],
                colors: ['#FF6B6B', '#FFE66D', '#4ECDC4', '#45B7D1']
            },
            summer: {
                name: 'ì—¬ë¦„ ì¿¨í†¤',
                ranges: { L: [55, 75], a: [-5, 5], b: [-5, 10] },
                characteristics: ['ì‹œì›í•œ í†¤', 'í•‘í¬/ë¸”ë£¨ ë² ì´ìŠ¤', 'ìš°ì•„í•œ ëŠë‚Œ'],
                colors: ['#E8F4FD', '#B8E6B8', '#DDA0DD', '#F0E68C']
            },
            autumn: {
                name: 'ê°€ì„ ì›œí†¤',
                ranges: { L: [40, 60], a: [8, 18], b: [15, 30] },
                characteristics: ['ê¹Šì€ ì›œí†¤', 'í™©ìƒ‰/ì£¼í™© ë² ì´ìŠ¤', 'ì„±ìˆ™í•œ ëŠë‚Œ'],
                colors: ['#D2691E', '#B22222', '#DAA520', '#8B4513']
            },
            winter: {
                name: 'ê²¨ìš¸ ì¿¨í†¤',
                ranges: { L: [30, 50], a: [-8, 8], b: [-10, 5] },
                characteristics: ['ê°•ë ¬í•œ ì¿¨í†¤', 'ë¸”ë£¨ ë² ì´ìŠ¤', 'ì„ ëª…í•œ ëŠë‚Œ'],
                colors: ['#000080', '#8B008B', '#DC143C', '#1E90FF']
            }
        }
    };

    const BRAND_DATABASE = {
        hairColor: {
            loreal: {
                name: 'ë¡œë ˆì•Œ',
                products: {
                    spring: ['6.35 ì´ˆì½œë¦¿ ë¸Œë¼ìš´', '7.13 ë² ì´ì§€ ë¸”ë¡ ë“œ', '5.25 ë§ˆí˜¸ê°€ë‹ˆ'],
                    summer: ['8.1 ë¼ì´íŠ¸ ì• ì‰¬ ë¸”ë¡ ë“œ', '9.13 ë² ë¦¬ ë¼ì´íŠ¸ ë² ì´ì§€', '6.1 ë‹¤í¬ ì• ì‰¬ ë¸”ë¡ ë“œ'],
                    autumn: ['5.32 ë¼ì´íŠ¸ ê³¨ë“  ë§ˆí˜¸ê°€ë‹ˆ', '4.15 ì• ì‰¬ ë§ˆí˜¸ê°€ë‹ˆ', '6.34 ë‹¤í¬ ê³¨ë“  ì½”í¼'],
                    winter: ['1.0 ë”¥ ë¸”ë™', '2.0 ë¸Œë¼ìš´ ë¸”ë™', '4.0 ë¯¸ë””ì—„ ë¸Œë¼ìš´']
                }
            },
            wella: {
                name: 'ì›°ë¼',
                products: {
                    spring: ['7/3 ë¯¸ë””ì—„ ê³¨ë“  ë¸”ë¡ ë“œ', '6/7 ë‹¤í¬ ë¸Œë¼ìš´ ë ˆë“œ', '5/4 ë¼ì´íŠ¸ ë¸Œë¼ìš´ ë ˆë“œ'],
                    summer: ['8/81 ë¼ì´íŠ¸ ë¸”ë¡ ë“œ í„ ì• ì‰¬', '7/89 ë¯¸ë””ì—„ ë¸”ë¡ ë“œ í„', '9/16 ë² ë¦¬ ë¼ì´íŠ¸ ì• ì‰¬ ë°”ì´ì˜¬ë ›'],
                    autumn: ['5/73 ë¼ì´íŠ¸ ë¸Œë¼ìš´ ê³¨ë“ ', '4/77 ë¯¸ë””ì—„ ë¸Œë¼ìš´ ì¸í…ìŠ¤ ë¸Œë¼ìš´', '6/74 ë‹¤í¬ ë¸”ë¡ ë“œ ë¸Œë¼ìš´ ë ˆë“œ'],
                    winter: ['2/0 ë¸”ë™', '3/0 ë‹¤í¬ ë¸Œë¼ìš´', '4/6 ë¯¸ë””ì—„ ë¸Œë¼ìš´ ë°”ì´ì˜¬ë ›']
                }
            }
        },
        makeup: {
            mac: {
                name: 'M.A.C',
                products: {
                    spring: ['Coral Bliss', 'Peaches', 'Warm Soul'],
                    summer: ['Dainty', 'Pink Swoon', 'Rosy Outlook'],
                    autumn: ['Harmony', 'Burnt Pepper', 'Coppertone'],
                    winter: ['Ruby Woo', 'Russian Red', 'Rebel']
                }
            },
            estee_lauder: {
                name: 'ì—ìŠ¤í‹°ë¡œë”',
                products: {
                    spring: ['Pure Color Envy 260', 'Pure Color Envy 340', 'Pure Color Envy 420'],
                    summer: ['Pure Color Envy 240', 'Pure Color Envy 320', 'Pure Color Envy 350'],
                    autumn: ['Pure Color Envy 280', 'Pure Color Envy 460', 'Pure Color Envy 520'],
                    winter: ['Pure Color Envy 220', 'Pure Color Envy 380', 'Pure Color Envy 450']
                }
            }
        }
    };

    // ===== 96ê°œ ìƒ‰ìƒ ë°ì´í„°ë² ì´ìŠ¤ =====
    const COMPLETE_COLOR_DATABASE = {
        spring: [
            // Bright Spring (8ê°œ)
            '#FF6B6B', '#FD79A8', '#FDCB6E', '#E17055', '#00B894', '#74B9FF', '#6C5CE7', '#A29BFE',
            // Light Spring (8ê°œ)
            '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#D4A5FF', '#FFB3E6', '#FFD1DC',
            // Warm Spring (8ê°œ)
            '#FF8C42', '#FF6F42', '#FFD93D', '#6BCF7F', '#42D9FF', '#8C52FF', '#FF5E5B', '#FFB347'
        ],
        summer: [
            // Light Summer (8ê°œ)
            '#E8F4FD', '#F0E8FF', '#E0FFFF', '#F5FFFA', '#FFF8DC', '#E6E6FA', '#F0F8FF', '#FAF0E6',
            // Soft Summer (8ê°œ)
            '#D8BFD8', '#DDA0DD', '#AFEEEE', '#E0E0E0', '#F5DEB3', '#C0C0C0', '#B0C4DE', '#FFB6C1',
            // Cool Summer (8ê°œ)
            '#4682B4', '#6495ED', '#87CEEB', '#ADD8E6', '#B0E0E6', '#E0FFFF', '#F0F8FF', '#708090'
        ],
        autumn: [
            // Deep Autumn (8ê°œ)
            '#8B0000', '#A0522D', '#556B2F', '#8B4513', '#2F4F4F', '#800080', '#483D8B', '#8B008B',
            // Warm Autumn (8ê°œ)
            '#FF4500', '#D2691E', '#CD853F', '#DAA520', '#B8860B', '#F4A460', '#DEB887', '#BC8F8F',
            // Soft Autumn (8ê°œ)
            '#C4A484', '#D2B48C', '#F5DEB3', '#DDA0DD', '#E6E6FA', '#D8BFD8', '#FFB6C1', '#F0E68C'
        ],
        winter: [
            // Deep Winter (8ê°œ)
            '#000000', '#800080', '#4B0082', '#000080', '#8B008B', '#FF1493', '#DC143C', '#B22222',
            // Cool Winter (8ê°œ)
            '#708090', '#2F4F4F', '#191970', '#4682B4', '#6A5ACD', '#9370DB', '#BA55D3', '#DA70D6',
            // Clear Winter (8ê°œ)
            '#FF0000', '#FF1493', '#00FFFF', '#00FF00', '#FFFF00', '#FF00FF', '#1E90FF', '#FF4500'
        ]
    };

    // ===== ì£¼ìš” í•¨ìˆ˜ë“¤ =====

    async function initializeMediaPipe() {
        try {
            if (!window.FaceMesh) {
                throw new Error('MediaPipe FaceMesh ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }

            const faceMesh = new window.FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults(onFaceMeshResults);
            window.PersonalColorSystem.engines.faceMesh = faceMesh;
            
            showToast('MediaPipe ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            document.getElementById('mediapipe-status').textContent = 'í™œì„±í™”ë¨';
            
            return true;
        } catch (error) {
            console.error('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showToast('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            return false;
        }
    }

    function onFaceMeshResults(results) {
        const canvas = document.getElementById('face-overlay');
        const ctx = canvas.getContext('2d');
        
        if (!canvas || !ctx) return;
        
        canvas.width = results.image.width;
        canvas.height = results.image.height;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];
            
            updateProgressStep('analyze');
            drawFaceOutline(ctx, landmarks, canvas.width, canvas.height);
            extractSkinPixels(results.image, landmarks);
            
            const analyzeBtn = document.getElementById('analyze-skin-btn');
            if (analyzeBtn) analyzeBtn.disabled = false;
            
        } else {
            updateProgressStep('position');
            const analyzeBtn = document.getElementById('analyze-skin-btn');
            if (analyzeBtn) analyzeBtn.disabled = true;
        }
    }

    function drawFaceOutline(ctx, landmarks, width, height) {
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        const faceOval = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
        
        for (let i = 0; i < faceOval.length; i++) {
            const point = landmarks[faceOval[i]];
            if (point) {
                if (i === 0) {
                    ctx.moveTo(point.x * width, point.y * height);
                } else {
                    ctx.lineTo(point.x * width, point.y * height);
                }
            }
        }
        ctx.closePath();
        ctx.stroke();
    }

    function extractSkinPixels(image, landmarks) {
        try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = image.width;
            tempCanvas.height = image.height;
            tempCtx.drawImage(image, 0, 0);

            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const pixels = imageData.data;

            const skinPixels = [];
            
            const samplingRegions = [
                [9, 10, 151, 337], // ì´ë§ˆ
                [116, 117, 118, 119], // ì™¼ìª½ ëº¨
                [345, 346, 347, 348] // ì˜¤ë¥¸ìª½ ëº¨
            ];

            samplingRegions.forEach(region => {
                region.forEach(pointIndex => {
                    const point = landmarks[pointIndex];
                    if (point) {
                        const x = Math.floor(point.x * tempCanvas.width);
                        const y = Math.floor(point.y * tempCanvas.height);
                        
                        for (let dx = -1; dx <= 1; dx++) {
                            for (let dy = -1; dy <= 1; dy++) {
                                const px = x + dx;
                                const py = y + dy;
                                
                                if (px >= 0 && px < tempCanvas.width && py >= 0 && py < tempCanvas.height) {
                                    const pixelIndex = (py * tempCanvas.width + px) * 4;
                                    const r = pixels[pixelIndex];
                                    const g = pixels[pixelIndex + 1];
                                    const b = pixels[pixelIndex + 2];
                                    
                                    if (r > 50 && g > 50 && b > 50 && r < 250 && g < 250 && b < 250) {
                                        skinPixels.push({ r, g, b });
                                    }
                                }
                            }
                        }
                    }
                });
            });

            if (skinPixels.length > 0) {
                const avgR = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.r, 0) / skinPixels.length);
                const avgG = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.g, 0) / skinPixels.length);
                const avgB = Math.round(skinPixels.reduce((sum, pixel) => sum + pixel.b, 0) / skinPixels.length);

                const labColor = rgbToLab(avgR, avgG, avgB);
                
                updateLabDisplay(labColor);
                updateSampleCounter(skinPixels.length);

                window.PersonalColorSystem.currentAnalysis.labValues = labColor;
                window.PersonalColorSystem.currentAnalysis.skinTone = { r: avgR, g: avgG, b: avgB };

                classifySeasonType(labColor);
            }

        } catch (error) {
            console.error('í”¼ë¶€ í”½ì…€ ì¶”ì¶œ ì‹¤íŒ¨:', error);
            showToast('í”¼ë¶€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    function updateLabDisplay(labColor) {
        const lValueEl = document.getElementById('l-value');
        const aValueEl = document.getElementById('a-value');
        const bValueEl = document.getElementById('b-value');
        
        if (lValueEl) lValueEl.textContent = labColor.L.toFixed(1);
        if (aValueEl) aValueEl.textContent = labColor.a.toFixed(1);
        if (bValueEl) bValueEl.textContent = labColor.b.toFixed(1);
    }

    function updateSampleCounter(count) {
        const sampleCounterEl = document.getElementById('sample-counter');
        const statusEl = document.getElementById('detection-status');
        
        if (sampleCounterEl) sampleCounterEl.textContent = `${count}ê°œ í”½ì…€ ë¶„ì„ë¨`;
        if (statusEl) statusEl.textContent = 'ì–¼êµ´ ê°ì§€ë¨ - ë¶„ì„ ì¤‘';
    }

    function classifySeasonType(labColor) {
        const seasons = KOREAN_SKIN_DATABASE.seasons;
        let bestSeason = null;
        let bestScore = 0;

        Object.keys(seasons).forEach(seasonKey => {
            const season = seasons[seasonKey];
            let score = 0;
            
            season.colors.forEach(colorHex => {
                const targetLab = hexToLab(colorHex);
                if (targetLab) {
                    const deltaE = calculateDeltaE2000(labColor, targetLab);
                    if (deltaE < 30) {
                        score += Math.max(0, 100 - deltaE * 2);
                    }
                }
            });

            if (score > bestScore) {
                bestScore = score;
                bestSeason = seasonKey;
            }
        });

        window.PersonalColorSystem.currentAnalysis.season = bestSeason;
        window.PersonalColorSystem.currentAnalysis.confidence = bestScore;
        
        window.PersonalColorSystem.stats.totalAnalyses++;
        if (bestScore > 70) {
            window.PersonalColorSystem.stats.accurateDetections++;
        }
        
        const countEl = document.getElementById('diagnosis-count');
        if (countEl) countEl.textContent = window.PersonalColorSystem.stats.totalAnalyses;
    }

    function hexToLab(hex) {
        if (!hex || hex.length !== 7) return null;
        
        const r = parseInt(hex.substr(1, 2), 16);
        const g = parseInt(hex.substr(3, 2), 16);
        const b = parseInt(hex.substr(5, 2), 16);
        
        return rgbToLab(r, g, b);
    }

    // ===== UI í•¨ìˆ˜ë“¤ =====

    async function startFaceAnalysis() {
        try {
            document.getElementById('mode-selection').classList.add('hidden');
            document.getElementById('face-analysis-section').classList.add('active');
            
            await initializeMediaPipe();
            
            updateProgressStep('camera');
            showToast('í”¼ë¶€í†¤ ë¶„ì„ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            
        } catch (error) {
            console.error('ì–¼êµ´ ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨:', error);
            showToast('ë¶„ì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    async function startCamera() {
        try {
            updateProgressStep('position');
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    width: 1280, 
                    height: 720,
                    facingMode: 'user'
                }
            });

            const videoElement = document.getElementById('video-feed');
            if (videoElement) {
                videoElement.srcObject = stream;
                
                if (window.Camera && window.PersonalColorSystem.engines.faceMesh) {
                    const camera = new window.Camera(videoElement, {
                        onFrame: async () => {
                            await window.PersonalColorSystem.engines.faceMesh.send({ image: videoElement });
                        },
                        width: 1280,
                        height: 720
                    });

                    camera.start();
                    window.PersonalColorSystem.engines.camera = camera;
                }
                
                const startBtn = document.getElementById('start-camera-btn');
                if (startBtn) {
                    startBtn.textContent = 'ì¹´ë©”ë¼ í™œì„±í™”ë¨';
                    startBtn.disabled = true;
                }
                
                const faceGuide = document.getElementById('face-guide');
                if (faceGuide) faceGuide.classList.add('show');
                
                showToast('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
            
        } catch (error) {
            console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
            showToast('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function performSkinAnalysis() {
        const analysis = window.PersonalColorSystem.currentAnalysis;
        
        if (!analysis.labValues || !analysis.season) {
            showToast('ë¨¼ì € ì–¼êµ´ ê°ì§€ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        displayAnalysisResults();
        showToast('í”¼ë¶€í†¤ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function displayAnalysisResults() {
        const analysis = window.PersonalColorSystem.currentAnalysis;
        
        if (!analysis.season || !KOREAN_SKIN_DATABASE.seasons[analysis.season]) {
            showToast('ë¶„ì„ ê²°ê³¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        const season = KOREAN_SKIN_DATABASE.seasons[analysis.season];
        
        const seasonElement = document.getElementById('best-season-text');
        if (seasonElement) {
            seasonElement.textContent = season.name;
            seasonElement.className = `best-season ${analysis.season}-result`;
        }
        
        const confidenceElement = document.getElementById('season-confidence-text');
        if (confidenceElement) {
            confidenceElement.textContent = `ì‹ ë¢°ë„ ${analysis.confidence.toFixed(1)}%`;
        }

        displayColorPalette(season);
        displayBrandRecommendations(analysis.season);

        const reportBtn = document.getElementById('generate-report-btn');
        if (reportBtn) {
            reportBtn.style.display = 'inline-block';
            reportBtn.disabled = false;
        }

        const resultsDisplay = document.getElementById('results-display');
        if (resultsDisplay) {
            resultsDisplay.classList.add('show');
        }
    }

    function displayColorPalette(season) {
        const colorsContainer = document.getElementById('recommended-colors');
        if (!colorsContainer) return;
        
        colorsContainer.innerHTML = '';
        
        season.colors.forEach((color, index) => {
            const colorDiv = document.createElement('div');
            colorDiv.className = 'color-item';
            colorDiv.style.backgroundColor = color;
            colorDiv.innerHTML = `
                <div class="color-info">
                    <div class="color-number">ì¶”ì²œ ${index + 1}</div>
                    <div class="color-name">${season.name} ì»¬ëŸ¬</div>
                    <div class="color-description">${season.characteristics[index % season.characteristics.length]}</div>
                </div>
            `;
            colorsContainer.appendChild(colorDiv);
        });
    }

    function displayBrandRecommendations(season) {
        const hairContainer = document.getElementById('hair-color-brands');
        if (hairContainer) {
            hairContainer.innerHTML = '';
            
            Object.keys(BRAND_DATABASE.hairColor).forEach(brandKey => {
                const brand = BRAND_DATABASE.hairColor[brandKey];
                const products = brand.products[season] || [];
                
                if (products.length > 0) {
                    const brandDiv = document.createElement('div');
                    brandDiv.className = 'brand-item';
                    brandDiv.innerHTML = `
                        <div class="brand-name">${brand.name}</div>
                        <ul class="product-list">
                            ${products.map(product => `<li><span class="product-code">${product}</span></li>`).join('')}
                        </ul>
                    `;
                    hairContainer.appendChild(brandDiv);
                }
            });
        }

        const makeupContainer = document.getElementById('makeup-brands');
        if (makeupContainer) {
            makeupContainer.innerHTML = '';
            
            Object.keys(BRAND_DATABASE.makeup).forEach(brandKey => {
                const brand = BRAND_DATABASE.makeup[brandKey];
                const products = brand.products[season] || [];
                
                if (products.length > 0) {
                    const brandDiv = document.createElement('div');
                    brandDiv.className = 'brand-item';
                    brandDiv.innerHTML = `
                        <div class="brand-name">${brand.name}</div>
                        <ul class="product-list">
                            ${products.map(product => `<li><span class="product-code">${product}</span></li>`).join('')}
                        </ul>
                    `;
                    makeupContainer.appendChild(brandDiv);
                }
            });
        }
    }

    function updateProgressStep(step) {
        document.querySelectorAll('.guide-step').forEach(el => el.classList.remove('active'));
        
        const currentStep = document.getElementById(`step-${step}`);
        if (currentStep) {
            currentStep.classList.add('active');
        }
    }

    // ===== 96ê°œ ìƒ‰ìƒ ë“œë˜ì´í•‘ êµ¬í˜„ =====
    
    function startVirtualDraping() {
        try {
            document.getElementById('mode-selection').classList.add('hidden');
            
            const drapingSection = document.createElement('section');
            drapingSection.className = 'analysis-section active';
            drapingSection.id = 'draping-section';
            
            const allColors = generateAllColors();
            
            let colorGridHTML = '';
            allColors.forEach((color, index) => {
                colorGridHTML += `
                    <div class="test-color" style="background: ${color.hex}" 
                         data-season="${color.season}" data-tone="${color.tone}"
                         onclick="testDrapingColor('${color.hex}', '${color.name}', '${color.seasonName}', '${color.description}')">
                        <div class="color-name">${color.name}</div>
                        <div class="color-season">${color.seasonName}</div>
                    </div>
                `;
            });
            
            drapingSection.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ (96ê°œ ìƒ‰ìƒ)</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="section-badge">Before/After ë¹„êµ</div>
                        <button onclick="backToMenuFromDraping()" 
                                style="background: #dc3545; color: white; border: none; border-radius: 50%; 
                                       width: 35px; height: 35px; cursor: pointer; font-size: 16px;">âœ•</button>
                    </div>
                </div>
                
                <!-- ì „í›„ ë¹„êµ ë·°ì–´ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="comparison-container">
                        <h4 style="text-align: center; margin-bottom: 1rem;">Before (ì›ë³¸)</h4>
                        <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 4/3;">
                            <video id="draping-video-before" autoplay muted playsinline 
                                   style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
                            <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); 
                                       background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem;">
                                ì›ë³¸ í”¼ë¶€í†¤
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="captureBeforeFrame()">Before ìº¡ì²˜</button>
                        </div>
                    </div>
                    
                    <div class="comparison-container">
                        <h4 style="text-align: center; margin-bottom: 1rem;">After (ë“œë˜ì´í•‘)</h4>
                        <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 4/3;">
                            <video id="draping-video-after" autoplay muted playsinline 
                                   style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
                            <div id="color-overlay" 
                                 style="position: absolute; top: 20%; left: 50%; width: 120px; height: 80px; 
                                        transform: translate(-50%, -50%); border-radius: 20px; opacity: 0.8; display: none; 
                                        border: 3px solid white; box-shadow: 0 0 30px rgba(0,0,0,0.6); z-index: 10;"></div>
                            <div id="draping-color-label" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); 
                                       background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; display: none;">
                                ì„ íƒëœ ìƒ‰ìƒ
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="captureAfterFrame()">After ìº¡ì²˜</button>
                        </div>
                    </div>
                </div>
                
                <!-- ë¹„êµ ê²°ê³¼ íŒ¨ë„ -->
                <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: var(--shadow);">
                    <h4>ì‹¤ì‹œê°„ ë¹„êµ ë¶„ì„</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1rem 0;">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="delta-score">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Delta E ì ìˆ˜</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success);" id="harmony-score">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">ì¡°í™”ë„</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--warning);" id="brightness-score">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">ë°ê¸° ê°œì„ </div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--info);" id="overall-score">--</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">ì¢…í•© ì ìˆ˜</div>
                        </div>
                    </div>
                    <div id="comparison-analysis" style="padding: 1rem; background: var(--primary-light); border-radius: 8px; text-align: center;">
                        ìƒ‰ìƒì„ ì„ íƒí•˜ë©´ Before/After ë¹„êµ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤
                    </div>
                </div>
                
                <!-- ë“œë˜ì´í•‘ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>ìƒ‰ìƒ ì„ íƒ (96ê°œ)</h4>
                        <div style="display: flex; gap: 0.3rem;">
                            <button onclick="filterColors('all')" class="season-filter active">ì „ì²´</button>
                            <button onclick="filterColors('spring')" class="season-filter">ë´„</button>
                            <button onclick="filterColors('summer')" class="season-filter">ì—¬ë¦„</button>
                            <button onclick="filterColors('autumn')" class="season-filter">ê°€ì„</button>
                            <button onclick="filterColors('winter')" class="season-filter">ê²¨ìš¸</button>
                        </div>
                    </div>
                    
                    <div id="color-test-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
                             gap: 0.4rem; max-height: 300px; overflow-y: auto;">
                        ${colorGridHTML}
                    </div>
                </div>
                
                <div class="controls-grid">
                    <button class="btn btn-primary" onclick="startDrapingCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                    <button class="btn btn-secondary" onclick="toggleComparisonMode()">ë¹„êµ ëª¨ë“œ ì „í™˜</button>
                    <button class="btn btn-secondary" onclick="exportComparison()">ë¹„êµ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-secondary" onclick="backToMenuFromDraping()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                .test-color {
                    padding: 0.5rem 0.2rem; border-radius: 4px; text-align: center; color: white; 
                    cursor: pointer; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                    transition: all 0.2s; min-height: 50px; display: flex; flex-direction: column;
                    justify-content: center; font-size: 0.65rem; position: relative;
                }
                .test-color:hover { 
                    transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 5;
                }
                .test-color.selected {
                    border: 3px solid #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
                }
                .test-color.hidden { display: none; }
                .color-name { margin-bottom: 0.2rem; font-weight: 700; line-height: 1.1; }
                .color-season { font-size: 0.55rem; opacity: 0.9; }
                .season-filter { 
                    padding: 0.3rem 0.6rem; border: 1px solid #ddd; background: white; 
                    border-radius: 12px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s; 
                }
                .season-filter.active { background: var(--primary); color: white; border-color: var(--primary); }
                .season-filter:hover:not(.active) { background: var(--primary-light); }
                .comparison-container {
                    border: 2px solid var(--border); border-radius: 8px; padding: 1rem; background: white;
                }
            `;
            document.head.appendChild(style);
            
            document.querySelector('.main-content').appendChild(drapingSection);
            
            // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            window.drapingState = {
                beforeFrame: null,
                afterFrame: null,
                selectedColor: null,
                comparisonMode: 'side-by-side'
            };
            
            showToast(`ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ - 96ê°œ ìƒ‰ìƒ + Before/After ë¹„êµ`, 'success');
            
        } catch (error) {
            console.error('ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨:', error);
            showToast('ë“œë˜ì´í•‘ ëª¨ë“œ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function generateAllColors() {
        const allColors = [];
        
        COMPLETE_COLOR_DATABASE.spring.forEach((hex, i) => {
            allColors.push({
                hex: hex,
                name: `ë´„-${i+1}`,
                season: 'spring',
                seasonName: 'ë´„',
                tone: i < 8 ? 'bright' : i < 16 ? 'light' : 'warm',
                description: 'ë´„ ì›œí†¤'
            });
        });
        
        COMPLETE_COLOR_DATABASE.summer.forEach((hex, i) => {
            allColors.push({
                hex: hex,
                name: `ì—¬ë¦„-${i+1}`,
                season: 'summer',
                seasonName: 'ì—¬ë¦„',
                tone: i < 8 ? 'light' : i < 16 ? 'soft' : 'cool',
                description: 'ì—¬ë¦„ ì¿¨í†¤'
            });
        });
        
        COMPLETE_COLOR_DATABASE.autumn.forEach((hex, i) => {
            allColors.push({
                hex: hex,
                name: `ê°€ì„-${i+1}`,
                season: 'autumn',
                seasonName: 'ê°€ì„',
                tone: i < 8 ? 'deep' : i < 16 ? 'warm' : 'soft',
                description: 'ê°€ì„ ì›œí†¤'
            });
        });
        
        COMPLETE_COLOR_DATABASE.winter.forEach((hex, i) => {
            allColors.push({
                hex: hex,
                name: `ê²¨ìš¸-${i+1}`,
                season: 'winter',
                seasonName: 'ê²¨ìš¸',
                tone: i < 8 ? 'deep' : i < 16 ? 'cool' : 'clear',
                description: 'ê²¨ìš¸ ì¿¨í†¤'
            });
        });
        
        return allColors;
    }

    function filterColors(season) {
        const filters = document.querySelectorAll('.season-filter');
        const colors = document.querySelectorAll('.test-color');
        
        filters.forEach(f => f.classList.remove('active'));
        event.target.classList.add('active');
        
        colors.forEach(color => {
            const colorSeason = color.dataset.season;
            if (season === 'all' || colorSeason === season) {
                color.classList.remove('hidden');
            } else {
                color.classList.add('hidden');
            }
        });
        
        const visibleCount = document.querySelectorAll('.test-color:not(.hidden)').length;
        showToast(`${season === 'all' ? 'ì „ì²´' : season} ìƒ‰ìƒ ${visibleCount}ê°œ í‘œì‹œ`, 'info');
    }

    function testDrapingColor(color, colorName, seasonName, description) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.test-color').forEach(c => c.classList.remove('selected'));
        
        // ìƒˆë¡œ ì„ íƒëœ ìƒ‰ìƒ í‘œì‹œ
        event.target.classList.add('selected');
        
        const overlay = document.getElementById('color-overlay');
        const label = document.getElementById('draping-color-label');
        
        if (overlay) {
            overlay.style.backgroundColor = color;
            overlay.style.display = 'block';
        }
        
        if (label) {
            label.textContent = colorName;
            label.style.display = 'block';
        }
        
        // ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
        window.drapingState.selectedColor = { color, colorName, seasonName, description };
        
        // Before/After ë¶„ì„ ìˆ˜í–‰
        performBeforeAfterAnalysis(color, colorName);
    }

    // Before/After ë¶„ì„ ìˆ˜í–‰
    function performBeforeAfterAnalysis(selectedColor, colorName) {
        const currentSkinTone = window.PersonalColorSystem.currentAnalysis.labValues;
        
        if (!currentSkinTone) {
            // AI ë¶„ì„ì´ ì—†ëŠ” ê²½ìš° ì‹œë®¬ë ˆì´ì…˜
            const deltaScore = Math.floor(Math.random() * 30) + 70;
            const harmonyScore = Math.floor(Math.random() * 25) + 75;
            const brightnessScore = Math.floor(Math.random() * 20) + 80;
            const overallScore = Math.round((deltaScore + harmonyScore + brightnessScore) / 3);
            
            updateComparisonScores(deltaScore, harmonyScore, brightnessScore, overallScore);
            updateComparisonAnalysis(colorName, overallScore);
            return;
        }
        
        // ì‹¤ì œ Delta E ê³„ì‚°
        const selectedLab = hexToLab(selectedColor);
        if (selectedLab) {
            const deltaE = calculateDeltaE2000(currentSkinTone, selectedLab);
            const deltaScore = Math.max(0, Math.min(100, 100 - deltaE * 5));
            
            // ì¡°í™”ë„ ê³„ì‚° (ê³„ì ˆ ë§¤ì¹­ ë³´ë„ˆìŠ¤)
            let harmonyScore = deltaScore;
            const currentSeason = window.PersonalColorSystem.currentAnalysis.season;
            if (currentSeason && window.drapingState.selectedColor.seasonName.includes(KOREAN_SKIN_DATABASE.seasons[currentSeason]?.name)) {
                harmonyScore = Math.min(100, harmonyScore + 15);
            }
            
            // ë°ê¸° ê°œì„ ë„ (Lab Lê°’ ê¸°ì¤€)
            const brightnessImprovement = Math.max(0, selectedLab.L - currentSkinTone.L);
            const brightnessScore = Math.min(100, 70 + brightnessImprovement);
            
            const overallScore = Math.round((deltaScore + harmonyScore + brightnessScore) / 3);
            
            updateComparisonScores(Math.round(deltaScore), Math.round(harmonyScore), Math.round(brightnessScore), overallScore);
            updateComparisonAnalysis(colorName, overallScore);
        }
    }

    // ë¹„êµ ì ìˆ˜ ì—…ë°ì´íŠ¸
    function updateComparisonScores(delta, harmony, brightness, overall) {
        const deltaEl = document.getElementById('delta-score');
        const harmonyEl = document.getElementById('harmony-score');
        const brightnessEl = document.getElementById('brightness-score');
        const overallEl = document.getElementById('overall-score');
        
        if (deltaEl) deltaEl.textContent = delta;
        if (harmonyEl) harmonyEl.textContent = harmony;
        if (brightnessEl) brightnessEl.textContent = brightness;
        if (overallEl) overallEl.textContent = overall;
    }

    // ë¹„êµ ë¶„ì„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateComparisonAnalysis(colorName, overallScore) {
        const analysisEl = document.getElementById('comparison-analysis');
        if (!analysisEl) return;
        
        let analysisText = '';
        let recommendation = '';
        
        if (overallScore >= 95) {
            analysisText = `${colorName}ì€ ê³ ê°ì—ê²Œ ì™„ë²½í•˜ê²Œ ì–´ìš¸ë¦½ë‹ˆë‹¤!`;
            recommendation = 'ê°•ë ¥ ì¶”ì²œ - ì¦‰ì‹œ ì‹œìˆ  ê°€ëŠ¥';
        } else if (overallScore >= 90) {
            analysisText = `${colorName}ì€ ë§¤ìš° ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.`;
            recommendation = 'ì¶”ì²œ - ê³ ê° ë§Œì¡±ë„ ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ';
        } else if (overallScore >= 85) {
            analysisText = `${colorName}ì€ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.`;
            recommendation = 'ê¶Œì¥ - ì•ˆì „í•œ ì„ íƒ';
        } else if (overallScore >= 80) {
            analysisText = `${colorName}ì€ ê´œì°®ì€ ì„ íƒì…ë‹ˆë‹¤.`;
            recommendation = 'ë³´í†µ - ë‹¤ë¥¸ ì˜µì…˜ë„ ê³ ë ¤í•´ë³´ì„¸ìš”';
        } else {
            analysisText = `${colorName}ì€ ë‹¤ë¥¸ ìƒ‰ìƒ ëŒ€ë¹„ ì•„ì‰¬ìš´ ë§¤ì¹­ì…ë‹ˆë‹¤.`;
            recommendation = 'ë¹„ì¶”ì²œ - ë‹¤ë¥¸ ê³„ì ˆ ìƒ‰ìƒ ì‹œë„ ê¶Œì¥';
        }
        
        analysisEl.innerHTML = `
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${analysisText}</div>
            <div style="font-size: 0.9rem; color: var(--text-light);">${recommendation}</div>
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 0.8rem;">
                ğŸ’¡ ì „ë¬¸ê°€ íŒ: Beforeì™€ Afterë¥¼ ìº¡ì²˜í•˜ì—¬ ê³ ê°ê³¼ í•¨ê»˜ ë¹„êµí•´ë³´ì„¸ìš”
            </div>
        `;
    }

    // Before í”„ë ˆì„ ìº¡ì²˜
    function captureBeforeFrame() {
        const video = document.getElementById('draping-video-before');
        if (!video || !video.srcObject) {
            showToast('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.scale(-1, 1); // ë¯¸ëŸ¬ íš¨ê³¼ ë³´ì •
        ctx.drawImage(video, -canvas.width, 0);
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        window.drapingState.beforeFrame = dataURL;
        
        // Before í”„ë ˆì„ í‘œì‹œ (ì‘ì€ ë¯¸ë¦¬ë³´ê¸°)
        const beforeContainer = document.querySelector('.comparison-container:first-child');
        if (beforeContainer) {
            const preview = document.createElement('div');
            preview.innerHTML = `
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--success); color: white; border-radius: 6px; text-align: center; font-size: 0.8rem;">
                    âœ… Before ìº¡ì²˜ ì™„ë£Œ (${new Date().toLocaleTimeString()})
                </div>
            `;
            const existing = beforeContainer.querySelector('div[style*="margin-top: 0.5rem"]');
            if (existing) existing.remove();
            beforeContainer.appendChild(preview);
        }
        
        showToast('Before í”„ë ˆì„ì´ ìº¡ì²˜ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // After í”„ë ˆì„ ìº¡ì²˜
    function captureAfterFrame() {
        const video = document.getElementById('draping-video-after');
        if (!video || !video.srcObject) {
            showToast('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }
        
        if (!window.drapingState.selectedColor) {
            showToast('ë¨¼ì € ë“œë˜ì´í•‘ ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.scale(-1, 1); // ë¯¸ëŸ¬ íš¨ê³¼ ë³´ì •
        ctx.drawImage(video, -canvas.width, 0);
        
        // ë“œë˜ì´í•‘ íš¨ê³¼ ì˜¤ë²„ë ˆì´ ì¶”ê°€ (ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜)
        ctx.globalCompositeOperation = 'soft-light';
        ctx.fillStyle = window.drapingState.selectedColor.color;
        ctx.fillRect(canvas.width * 0.3, canvas.height * 0.15, canvas.width * 0.4, canvas.height * 0.7);
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        window.drapingState.afterFrame = dataURL;
        
        // After í”„ë ˆì„ í‘œì‹œ
        const afterContainer = document.querySelector('.comparison-container:last-child');
        if (afterContainer) {
            const preview = document.createElement('div');
            preview.innerHTML = `
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--primary); color: white; border-radius: 6px; text-align: center; font-size: 0.8rem;">
                    âœ… After ìº¡ì²˜ ì™„ë£Œ (${window.drapingState.selectedColor.colorName})
                </div>
            `;
            const existing = afterContainer.querySelector('div[style*="margin-top: 0.5rem"]');
            if (existing) existing.remove();
            afterContainer.appendChild(preview);
        }
        
        showToast(`After í”„ë ˆì„ì´ ìº¡ì²˜ë˜ì—ˆìŠµë‹ˆë‹¤ (${window.drapingState.selectedColor.colorName})`, 'success');
        
        // ì „ì²´ ë¹„êµ ê°€ëŠ¥í•˜ê²Œ ë²„íŠ¼ í™œì„±í™”
        enableComparisonExport();
    }

    // ë¹„êµ ëª¨ë“œ ì „í™˜
    function toggleComparisonMode() {
        const modes = ['side-by-side', 'overlay', 'slider'];
        const currentIndex = modes.indexOf(window.drapingState.comparisonMode);
        const nextIndex = (currentIndex + 1) % modes.length;
        
        window.drapingState.comparisonMode = modes[nextIndex];
        
        const modeNames = { 'side-by-side': 'ë‚˜ë€íˆ', 'overlay': 'ì˜¤ë²„ë ˆì´', 'slider': 'ìŠ¬ë¼ì´ë”' };
        showToast(`ë¹„êµ ëª¨ë“œ: ${modeNames[window.drapingState.comparisonMode]}`, 'info');
    }

    // ë¹„êµ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
    function exportComparison() {
        if (!window.drapingState.beforeFrame || !window.drapingState.afterFrame) {
            showToast('Beforeì™€ After í”„ë ˆì„ì„ ëª¨ë‘ ìº¡ì²˜í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }
        
        // ê°„ë‹¨í•œ ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±
        const report = `
```

# í¼ìŠ¤ë„ì»¬ëŸ¬ ë“œë˜ì´í•‘ ë¹„êµ ë¦¬í¬íŠ¸

ìº¡ì²˜ ì‹œê°„: ${new Date().toLocaleString(â€˜ko-KRâ€™)}
ì„ íƒ ìƒ‰ìƒ: ${window.drapingState.selectedColor?.colorName || â€˜ë¯¸ì„ íƒâ€™}
ê³„ì ˆ ë¶„ë¥˜: ${window.drapingState.selectedColor?.seasonName || â€˜ë¯¸ë¶„ë¥˜â€™}

ë¶„ì„ ê²°ê³¼:

- Delta E ì ìˆ˜: ${document.getElementById(â€˜delta-scoreâ€™)?.textContent || â€˜â€“â€™}
- ì¡°í™”ë„: ${document.getElementById(â€˜harmony-scoreâ€™)?.textContent || â€˜â€“â€™}
- ë°ê¸° ê°œì„ : ${document.getElementById(â€˜brightness-scoreâ€™)?.textContent || â€˜â€“â€™}
- ì¢…í•© ì ìˆ˜: ${document.getElementById(â€˜overall-scoreâ€™)?.textContent || â€˜â€“â€™}

ì „ë¬¸ê°€ ê¶Œì¥ì‚¬í•­:
${document.getElementById(â€˜comparison-analysisâ€™)?.textContent || â€˜ë¶„ì„ ë°ì´í„° ì—†ìŒâ€™}

=======================================
Personal Color AI Pro - í—¤ì–´ìƒµ ì „ìš© ì‹œìŠ¤í…œ
`;

```
        const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ë“œë˜ì´í•‘_ë¹„êµë¶„ì„_${Date.now()}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('Before/After ë¹„êµ ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ë¹„êµ ë‚´ë³´ë‚´ê¸° í™œì„±í™”
    function enableComparisonExport() {
        const exportBtn = document.querySelector('button[onclick="exportComparison()"]');
        if (exportBtn) {
            exportBtn.classList.remove('btn-secondary');
            exportBtn.classList.add('btn-primary');
            exportBtn.style.background = 'var(--success)';
        }
    }

    async function startDrapingCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 1280, height: 720, facingMode: 'user' }
            });
            
            // Beforeì™€ After ë¹„ë””ì˜¤ì— ë™ì¼í•œ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            const beforeVideo = document.getElementById('draping-video-before');
            const afterVideo = document.getElementById('draping-video-after');
            
            if (beforeVideo) beforeVideo.srcObject = stream;
            if (afterVideo) afterVideo.srcObject = stream;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const startBtn = document.querySelector('button[onclick="startDrapingCamera()"]');
            if (startBtn) {
                startBtn.textContent = 'ì¹´ë©”ë¼ í™œì„±í™”ë¨';
                startBtn.disabled = true;
            }
            
            showToast('Before/After ë¹„êµ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            
        } catch (error) {
            showToast('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function backToMenuFromDraping() {
        const drapingSection = document.getElementById('draping-section');
        if (drapingSection) {
            const video = document.getElementById('draping-video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            drapingSection.remove();
        }
        
        document.getElementById('mode-selection').classList.remove('hidden');
        showToast('ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤', 'info');
    }

    // ===== ê¸°íƒ€ í•¨ìˆ˜ë“¤ =====

    function showBrandDatabase() {
        let brandHTML = '<h2>ì „ì²´ ë¸Œëœë“œ ë°ì´í„°ë² ì´ìŠ¤</h2>';
        
        brandHTML += '<h3>í—¤ì–´ì»¬ëŸ¬ ë¸Œëœë“œ</h3>';
        Object.keys(BRAND_DATABASE.hairColor).forEach(brandKey => {
            const brand = BRAND_DATABASE.hairColor[brandKey];
            brandHTML += `<h4>${brand.name}</h4>`;
            Object.keys(brand.products).forEach(season => {
                brandHTML += `<p><strong>${season}:</strong> ${brand.products[season].join(', ')}</p>`;
            });
        });
        
        brandHTML += '<h3>ë©”ì´í¬ì—… ë¸Œëœë“œ</h3>';
        Object.keys(BRAND_DATABASE.makeup).forEach(brandKey => {
            const brand = BRAND_DATABASE.makeup[brandKey];
            brandHTML += `<h4>${brand.name}</h4>`;
            Object.keys(brand.products).forEach(season => {
                brandHTML += `<p><strong>${season}:</strong> ${brand.products[season].join(', ')}</p>`;
            });
        });
        
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; justify-content: center; align-items: center; padding: 2rem;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white; max-width: 800px; max-height: 80vh;
            border-radius: 12px; overflow-y: auto; padding: 2rem;
        `;
        
        content.innerHTML = brandHTML + '<button onclick="this.closest(\'div\').remove()" style="margin-top: 2rem; padding: 0.5rem 2rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>';
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }

    function showReportOptions() {
        const analysis = window.PersonalColorSystem.currentAnalysis;
        
        if (!analysis.season) {
            showToast('ë¨¼ì € í”¼ë¶€í†¤ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }
        
        generateReport();
    }

    function generateReport() {
        try {
            const analysis = window.PersonalColorSystem.currentAnalysis;
            const season = KOREAN_SKIN_DATABASE.seasons[analysis.season];
            
            showToast('ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            
            const reportContent = `í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ë³´ê³ ì„œ\nìƒì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}\nê³„ì ˆ íƒ€ì…: ${season.name}\nì‹ ë¢°ë„: ${analysis.confidence.toFixed(1)}%`;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `í¼ìŠ¤ë„ì»¬ëŸ¬_ì§„ë‹¨ë³´ê³ ì„œ_${Date.now()}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('ì§„ë‹¨ ë³´ê³ ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
        } catch (error) {
            console.error('ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨:', error);
            showToast('ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function resetSystem() {
        if (confirm('ëª¨ë“  ë¶„ì„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.PersonalColorSystem.currentAnalysis = {
                skinTone: null, season: null, confidence: 0,
                labValues: { L: 0, a: 0, b: 0 }, recommendedColors: [], brandMatches: []
            };
            
            document.querySelectorAll('.analysis-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('mode-selection').classList.remove('hidden');
            document.getElementById('results-display').classList.remove('show');
            
            if (window.PersonalColorSystem.engines.camera) {
                window.PersonalColorSystem.engines.camera.stop();
            }
            
            showToast('ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }
    }

    function backToMenu() {
        document.getElementById('face-analysis-section').classList.remove('active');
        document.getElementById('mode-selection').classList.remove('hidden');
        document.getElementById('results-display').classList.remove('show');
        
        if (window.PersonalColorSystem.engines.camera) {
            window.PersonalColorSystem.engines.camera.stop();
        }
        
        const faceGuide = document.getElementById('face-guide');
        if (faceGuide) faceGuide.classList.remove('show');
    }

    function showToast(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
        
        toast.innerHTML = `
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-message">${message}</div>
            </div>
        `;

        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            const systemReady = document.getElementById('system-ready');
            if (systemReady) {
                systemReady.style.display = 'block';
            }
            showToast('Personal Color AI Pro ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }, 1000);

        console.log('=== Personal Color AI Pro Clean v2.0 ===');
        console.log('âœ… HTML + CSS ì™„ì „ ë¶„ë¦¬');
        console.log('âœ… 96ê°œ ìƒ‰ìƒ ë“œë˜ì´í•‘ êµ¬í˜„'); 
        console.log('âœ… MediaPipe 468í¬ì¸íŠ¸ ì–¼êµ´ ê°ì§€');
        console.log('âœ… CIE Lab + Delta E 2000 ìƒ‰ì°¨ ê³„ì‚°');
        console.log('âœ… í•œêµ­ì¸ íŠ¹í™” í”¼ë¶€í†¤ ë°ì´í„°ë² ì´ìŠ¤');
        console.log('âœ… 8ê°œ ì „ë¬¸ ë¸Œëœë“œ ì—°ë™');
    });
</script>
```

</body>
</html>