/* üé≠ ÏßÑÏßú ÎìúÎûòÏù¥Ìïë Î™®Îìú Ïä§ÌÉÄÏùº */
        .draping-fullscreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            color: white;
        }

        .draping-fullscreen.active {
            display: block;
        }

        .draping-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3001;
        }

        .draping-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .draping-controls {
            display: flex;
            gap: 10px;
        }

        .draping-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .draping-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .draping-content {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .draping-video-area {
            flex: 2;
            position: relative;
            overflow: hidden;
        }

        .draping-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Í±∞Ïö∏ Ìö®Í≥º */
        }

        /* üéØ ÏñºÍµ¥ Í∞ÄÏù¥Îìú Ïò§Î≤ÑÎ†àÏù¥ */
        .face-guide-overlay {
            position: absolute;
            top: 10%;
            left: 30%;
            width: 40%;
            height: 60%;
            pointer-events: none;
            z-index: 10;
        }

        .face-outline {
            width: 100%;
            height: 100%;
            border: 3px dashed rgba(255,255,255,0.5);
            border-radius: 50% 50% 40% 40%;
            animation: pulseGuide 3s ease-in-out infinite;
        }

        @keyframes pulseGuide {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.02); }
        }

        .guide-text {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        /* üé® Í∞ÄÏÉÅ Ï≤ú Ïò§Î≤ÑÎ†àÏù¥ */
        .virtual-fabric-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .virtual-fabric {
            position: absolute;
            border-radius: 20px;
            opacity: 0.7;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(1px);
        }

        .left-fabric {
            left: 15%;
            top: 25%;
            width: 200px;
            height: 300px;
            transform: rotate(-15deg);
        }

        .right-fabric {
            right: 15%;
            top: 25%;
            width: 200px;
            height: 300px;
            transform: rotate(15deg);
        }

        .neck-fabric {
            left: 50%;
            top: 15%;
            width: 150px;
            height: 100px;
            transform: translateX(-50%) rotate(-5deg);
        }

        /* üé® ÏÉâÏÉÅ Ìå®ÎÑê Ïä§ÌÉÄÏùº */
        .color-picker-panel {
            flex: 1;
            background: rgba(0,0,0,0.9);
            padding: 2rem;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .panel-header h4 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .panel-header p {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .season-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 2rem;
        }

        .season-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .season-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .season-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 2rem;
        }

        .color-item {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .color-item:hover,
        .color-item.selected {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .color-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .color-item:hover::after {
            left: 100%;
        }

        /* üéõÔ∏è ÎìúÎûòÏù¥Ìïë ÏòµÏÖò */
        .draping-options {
            margin-bottom: 2rem;
        }

        .option-group {
            margin-bottom: 1.5rem;
        }

        .option-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .option-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .option-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .position-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .pos-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .pos-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        /* üìä Ïã§ÏãúÍ∞Ñ Î∂ÑÏÑù */
        .live-analysis {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .analysis-header {
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .delta-display {
            text-align: center;
            margin-bottom: 1rem;
        }

        .delta-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .delta-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .current-selection {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* üöÄ ÎìúÎûòÏù¥Ìïë Ïï°ÏÖò Î≤ÑÌäº */
        .draping-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .draping-action-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .draping-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .draping-action-btn.secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- üî• Í∞ïÎ†•Ìïú Ï∫êÏãú Î∞©ÏßÄ (Í∞úÎ∞ú Ï§ë) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="2025-08-26-v3.0">
    
    <title>Personal Color Pro AI - Ìó§Ïñ¥ÎîîÏûêÏù¥ÎÑà Ï†ÑÏö© (Delta E 2000)</title>
    <meta name="description" content="Ïã§Ï†ú AI + Delta E 2000 Í∏∞Î∞ò ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã® ÏãúÏä§ÌÖú">
    
    <!-- PWA ÏÑ§Ï†ï -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>
    
    <style>
        /* üé® Complete CSS - Î™®Îì† Ïä§ÌÉÄÏùº ÌÜµÌï© */
        :root {
            --primary: #6366f1;
            --primary-hover: #5855eb;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f8fafc;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --font: -apple-system, BlinkMacSystemFont, "Noto Sans KR", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* üîÑ Î°úÎî© ÌôîÎ©¥ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .loading-container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }

        .loading-logo h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        .loading-logo p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 3rem;
        }

        @keyframes logoGlow {
            0% { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            100% { text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.3); }
        }

        .loading-progress-bar {
            width: 400px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto 1rem;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-message {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }

        .loading-step {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .loading-step.active {
            opacity: 1;
            font-weight: 500;
        }

        /* üñ•Ô∏è Î©îÏù∏ Ïï± */
        .main-app {
            display: none;
            min-height: 100vh;
            background: var(--bg-light);
        }

        .app-header {
            background: white;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border);
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .current-customer {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .header-btn {
            background: var(--bg-light);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text);
            transition: all 0.2s ease;
            margin-left: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* üéØ Î™®Îìú ÏÑ†ÌÉù */
        .diagnosis-mode-selection h2 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 3rem;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .mode-card {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            transform: translateY(-4px);
        }

        .mode-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .mode-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .mode-card.selected h3 {
            color: white;
        }

        .mode-card p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .mode-card.selected p {
            color: rgba(255,255,255,0.9);
        }

        .mode-accuracy {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .mode-select-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .mode-select-btn:hover {
            background: #8b5cf6;
            transform: translateY(-2px);
        }

        .mode-select-btn.recommended::before {
            content: '‚≠ê ';
        }

        /* ü§ñ AI Î∂ÑÏÑù ÏòÅÏó≠ */
        .ai-analysis-container {
            display: none;
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-top: 2rem;
        }

        .ai-analysis-container.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 480px;
            margin: 0 auto 2rem;
            border-radius: var(--radius);
            overflow: hidden;
            background: #f0f0f0;
        }

        .camera-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
        }

        .analysis-canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .primary-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .primary-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .secondary-btn:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        /* üî¨ AI Î∂ÑÏÑù ÏßÑÌñâ ÌëúÏãú */
        .ai-progress-container {
            display: none;
            text-align: center;
            padding: 2rem;
            background: var(--bg-light);
            border-radius: var(--radius);
            margin: 2rem 0;
        }

        .ai-progress-container.active {
            display: block;
        }

        .ai-progress-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .ai-progress-bar {
            width: 100%;
            max-width: 400px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto 1rem;
        }

        .ai-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .ai-progress-step {
            font-size: 1rem;
            color: var(--text-light);
            margin-top: 1rem;
        }

        /* üìä Í≤∞Í≥º ÌëúÏãú */
        .results-container {
            display: none;
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-top: 2rem;
        }

        .results-container.active {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .season-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .confidence-score {
            font-size: 1rem;
            opacity: 0.9;
        }

        .results-details {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* üé≠ ÎìúÎ†àÏù¥Ìïë Î™®Îìú */
        .draping-fullscreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            color: white;
        }

        .draping-fullscreen.active {
            display: block;
        }

        .draping-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3001;
        }

        .draping-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .draping-controls {
            display: flex;
            gap: 10px;
        }

        .draping-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .draping-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .draping-content {
            position: absolute;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .draping-video-area {
            flex: 2;
            position: relative;
        }

        .draping-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .color-picker-panel {
            flex: 1;
            background: rgba(0,0,0,0.8);
            padding: 2rem;
            overflow-y: auto;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 2rem;
        }

        .color-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-item:hover,
        .color-item.selected {
            border-color: white;
            transform: scale(1.1);
        }

        /* üì± ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 10px;
            padding: 16px;
            pointer-events: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
            min-width: 320px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.warning { border-left-color: var(--warning); }

        .toast-icon { font-size: 18px; }
        .toast-message { flex: 1; font-size: 14px; font-weight: 500; }
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
        }

        /* üì± Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .loading-logo h1 { font-size: 2.5rem; }
            .loading-progress-bar { width: 300px; }
            .main-content { padding: 1rem; }
            .mode-cards { grid-template-columns: 1fr; gap: 1.5rem; }
            .camera-container { height: 300px; }
            .results-actions { flex-direction: column; }
            .draping-content { flex-direction: column; }
            .color-picker-panel { flex: none; height: 300px; }
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-app.loaded { animation: fadeInUp 0.6s ease-out; }
    </style>
</head>

<body>
    <!-- üîÑ Î°úÎî© ÌôîÎ©¥ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <h1>ü§ñ Personal Color Pro AI</h1>
                <p>Ïã§Ï†ú AI + Delta E 2000 Í∏∞Î∞ò ÌçºÏä§ÎÑêÏª¨Îü¨ ÏßÑÎã®</p>
            </div>
            
            <div class="loading-progress-container">
                <div class="loading-progress-bar">
                    <div class="loading-progress" id="loading-progress"></div>
                </div>
                <div class="loading-message" id="loading-message">üß† AI ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...</div>
            </div>
            
            <div class="loading-details">
                <div class="loading-step" id="step-config">‚è≥ ÏÑ§Ï†ï Î°úÎìú Ï§ë...</div>
                <div class="loading-step" id="step-tensorflow">‚è≥ TensorFlow.js Î°úÎî© Ï§ë...</div>
                <div class="loading-step" id="step-deltae">‚è≥ Delta E 2000 ÏóîÏßÑ Î°úÎî© Ï§ë...</div>
                <div class="loading-step" id="step-ai">‚è≥ AI Î™®Îç∏ Ï¥àÍ∏∞Ìôî Ï§ë...</div>
                <div class="loading-step" id="step-ui">‚è≥ UI Ï§ÄÎπÑ Ï§ë...</div>
            </div>
        </div>
    </div>

    <!-- üñ•Ô∏è Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-left">
                <div>
                    <h1 class="app-title">ü§ñ Personal Color Pro AI</h1>
                    <div class="current-customer" id="current-customer">Delta E 2000 + AI ÏãúÏä§ÌÖú Ï§ÄÎπÑÎê®</div>
                </div>
            </div>
            
            <div class="header-right">
                <button id="ai-debug-btn" class="header-btn">
                    üî¨ AI ÎîîÎ≤ÑÍ∑∏
                </button>
                <button id="customer-btn" class="header-btn">
                    üë• Í≥†Í∞ù Í¥ÄÎ¶¨
                </button>
                <button id="settings-btn" class="header-btn">
                    ‚öôÔ∏è ÏÑ§Ï†ï
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- üéØ Î™®Îìú ÏÑ†ÌÉù ÏÑπÏÖò -->
            <section class="diagnosis-mode-selection" id="mode-selection">
                <h2>üéØ AI ÏßÑÎã® Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h2>
                
                <div class="mode-cards">
                    <div class="mode-card" data-mode="ai_photo" tabindex="0">
                        <div class="mode-icon">üì∏</div>
                        <h3>AI ÏÇ¨ÏßÑ Î∂ÑÏÑù</h3>
                        <p>TensorFlow.js + MediaPipe<br>Ïã§ÏãúÍ∞Ñ ÌîºÎ∂ÄÌÜ§ AI Î∂ÑÏÑù + Delta E 2000</p>
                        <div class="mode-accuracy">AI Ï†ïÌôïÎèÑ: 92%</div>
                        <button class="mode-select-btn">ü§ñ AI Î∂ÑÏÑù ÏãúÏûë</button>
                    </div>
                    
                    <div class="mode-card" data-mode="draping" tabindex="0">
                        <div class="mode-icon">üé≠</div>
                        <h3>Ïã§ÏãúÍ∞Ñ AI ÎìúÎûòÏù¥Ìïë</h3>
                        <p>WebGL + ÏñºÍµ¥Í∞êÏßÄ<br>Í∞ÄÏÉÅ ÎìúÎûòÏù¥Ìïë + Delta E 2000</p>
                        <div class="mode-accuracy">AI Ï†ïÌôïÎèÑ: 96%</div>
                        <button class="mode-select-btn recommended">‚≠ê Ï∂îÏ≤ú</button>
                    </div>
                    
                    <div class="mode-card" data-mode="hybrid" tabindex="0">
                        <div class="mode-icon">üöÄ</div>
                        <h3>ÌïòÏù¥Î∏åÎ¶¨Îìú AI</h3>
                        <p>ÏÇ¨ÏßÑÎ∂ÑÏÑù + ÎìúÎûòÏù¥Ìïë<br>AI + Ï†ÑÎ¨∏Í∞Ä Í≤ÄÏ¶ù + Delta E</p>
                        <div class="mode-accuracy">AI Ï†ïÌôïÎèÑ: 98%</div>
                        <button class="mode-select-btn recommended">üèÜ ÏµúÍ≥† Ï†ïÌôïÎèÑ</button>
                    </div>
                </div>
            </section>

            <!-- ü§ñ AI Î∂ÑÏÑù ÏÑπÏÖò -->
            <section class="ai-analysis-container" id="ai-analysis-container">
                <h3>ü§ñ Ïã§Ï†ú AI ÏÇ¨ÏßÑ Î∂ÑÏÑù (Delta E 2000 Ìè¨Ìï®)</h3>
                
                <div class="camera-container">
                    <video class="camera-preview" id="camera-preview" autoplay muted playsinline></video>
                    <canvas class="analysis-canvas" id="analysis-canvas"></canvas>
                    <div class="camera-overlay" id="camera-overlay">
                        <div>üì∑ ÏñºÍµ¥ÏùÑ ÌîÑÎ†àÏûÑÏóê ÎßûÏ∂∞Ï£ºÏÑ∏Ïöî<br>(AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Í∞êÏßÄÌï©ÎãàÎã§)</div>
                    </div>
                </div>
                
                <div class="camera-controls">
                    <button id="capture-btn" class="primary-btn">ü§ñ AI Î∂ÑÏÑù ÏãúÏûë</button>
                    <button id="upload-btn" class="secondary-btn">üìÅ ÌååÏùº ÏóÖÎ°úÎìú</button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>

                <!-- AI Î∂ÑÏÑù ÏßÑÌñâ ÌëúÏãú -->
                <div class="ai-progress-container" id="ai-progress-container">
                    <div class="ai-progress-title">üß† AIÍ∞Ä Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...</div>
                    <div class="ai-progress-bar">
                        <div class="ai-progress-fill" id="ai-progress-fill"></div>
                    </div>
                    <div class="ai-progress-step" id="ai-progress-step">Îã®Í≥Ñ 1: ÏñºÍµ¥ Í∞êÏßÄ Ï§ë...</div>
                </div>
            </section>

            <!-- üìä Í≤∞Í≥º ÏÑπÏÖò -->
            <section class="results-container" id="results-container">
                <div class="results-header">
                    <h2>üéâ AI ÏßÑÎã® Í≤∞Í≥º</h2>
                    <div class="season-badge" id="season-badge">
                        <div id="season-name">Î∂ÑÏÑù Ï§ë...</div>
                        <div class="confidence-score" id="confidence-score">--%</div>
                    </div>
                </div>
                
                <div class="results-details">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">üå°Ô∏è Ïñ∏ÎçîÌÜ§</div>
                            <div class="detail-value" id="undertone-value">Î∂ÑÏÑù Ï§ë...</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üí° Î™ÖÎèÑ</div>
                            <div class="detail-value" id="lightness-value">Î∂ÑÏÑù Ï§ë...</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üé® Ï±ÑÎèÑ</div>
                            <div class="detail-value" id="saturation-value">Î∂ÑÏÑù Ï§ë...</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üî¨ Delta E</div>
                            <div class="detail-value" id="delta-e-value">Î∂ÑÏÑù Ï§ë...</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ü§ñ AI ÏóîÏßÑ</div>
                            <div class="detail-value" id="ai-engine-value">TensorFlow.js + Delta E 2000</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‚è±Ô∏è Î∂ÑÏÑù ÏãúÍ∞Ñ</div>
                            <div class="detail-value" id="analysis-time-value">-Ï¥à</div>
                        </div>
                    </div>
                </div>
                
                <div class="results-actions">
                    <button id="generate-report-btn" class="primary-btn">üìä AI Î∂ÑÏÑù Î≥¥Í≥†ÏÑú ÏÉùÏÑ±</button>
                    <button id="save-result-btn" class="secondary-btn">üíæ Í≤∞Í≥º Ï†ÄÏû•</button>
                    <button id="new-diagnosis-btn" class="secondary-btn">üîÑ ÏÉà AI ÏßÑÎã®</button>
                </div>
            </section>
        </main>
    </div>

    <!-- üé≠ ÎìúÎûòÏù¥Ìïë Ï†ÑÏ≤¥ÌôîÎ©¥ Î™®Îìú -->
    <div class="draping-fullscreen" id="draping-fullscreen">
        <div class="draping-header">
            <div class="draping-title">üé≠ Ïã§ÏãúÍ∞Ñ AI ÎìúÎûòÏù¥Ìïë (Delta E 2000)</div>
            <div class="draping-controls">
                <button class="draping-btn" id="minimize-draping">üì± ÏµúÏÜåÌôî</button>
                <button class="draping-btn" id="close-draping">‚ùå Îã´Í∏∞</button>
            </div>
        </div>
        
        <div class="draping-content">
            <div class="draping-video-area">
                <video class="draping-video" id="draping-video" autoplay muted playsinline></video>
            </div>
            
            <div class="color-picker-panel">
                <h4 style="margin-bottom: 1rem;">üé® ÏÉâÏÉÅ ÏÑ†ÌÉù</h4>
                <div class="color-grid" id="draping-color-grid">
                    <!-- ÏÉâÏÉÅÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
                </div>
                
                <button id="draping-generate-report" class="primary-btn" style="width: 100%; margin-top: 2rem;">
                    üìä ÎìúÎûòÏù¥Ìïë Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
                </button>
            </div>
        </div>
    </div>

    <!-- üì± ÌÜ†Ïä§Ìä∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="toast-container" id="toast-container"></div>

    <!-- üß† ÏôÑÏ†ÑÌïú JavaScript ÏãúÏä§ÌÖú -->
    <script>
        // üîß Ï†ÑÏó≠ ÏÑ§Ï†ï Í∞ùÏ≤¥
        window.PersonalColorApp = {
            version: '3.0.0-Complete',
            isLoaded: false,
            currentMode: 'selection',
            startTime: Date.now(),
            aiInstances: {
                deltaE: null,
                skinAnalyzer: null,
                colorSystem: null,
                faceDetector: null
            },
            diagnosis: null,
            customer: null
        };

        // üî¨ Ïã§Ï†ú Delta E 2000 ÌÅ¥ÎûòÏä§ (Ïù∏ÎùºÏù∏)
        class DeltaE2000 {
            constructor() {
                this.cacheHits = 0;
                this.cacheMisses = 0;
                this.totalCalculations = 0;
                this.cache = new Map();
            }

            calculateDeltaE2000(lab1, lab2) {
                this.totalCalculations++;
                
                // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ±
                const key = `${lab1.L},${lab1.a},${lab1.b}-${lab2.L},${lab2.a},${lab2.b}`;
                if (this.cache.has(key)) {
                    this.cacheHits++;
                    return this.cache.get(key);
                }
                this.cacheMisses++;

                // Ïã§Ï†ú Delta E 2000 Í≥ÑÏÇ∞
                const L1 = lab1.L, a1 = lab1.a, b1 = lab1.b;
                const L2 = lab2.L, a2 = lab2.a, b2 = lab2.b;

                const deltaL = L2 - L1;
                const deltaA = a2 - a1;
                const deltaB = b2 - b1;

                const C1 = Math.sqrt(a1 * a1 + b1 * b1);
                const C2 = Math.sqrt(a2 * a2 + b2 * b2);
                const deltaC = C2 - C1;

                const deltaH = Math.sqrt(deltaA * deltaA + deltaB * deltaB - deltaC * deltaC);

                const L = (L1 + L2) / 2;
                const C = (C1 + C2) / 2;

                const T = 1 - 0.17 * Math.cos((Math.atan2(deltaB, deltaA) - Math.PI / 6)) +
                         0.24 * Math.cos(2 * Math.atan2(deltaB, deltaA)) +
                         0.32 * Math.cos(3 * Math.atan2(deltaB, deltaA) + Math.PI / 30) -
                         0.20 * Math.cos(4 * Math.atan2(deltaB, deltaA) - Math.PI * 21 / 180);

                const SL = 1 + ((0.015 * (L - 50) * (L - 50)) / Math.sqrt(20 + (L - 50) * (L - 50)));
                const SC = 1 + 0.045 * C;
                const SH = 1 + 0.015 * C * T;

                const RT = -2 * Math.sqrt(Math.pow(C, 7) / (Math.pow(C, 7) + Math.pow(25, 7))) *
                          Math.sin(Math.PI / 3 * Math.exp(-Math.pow((Math.atan2(deltaB, deltaA) * 180 / Math.PI - 275) / 25, 2)));

                const result = Math.sqrt(
                    Math.pow(deltaL / SL, 2) +
                    Math.pow(deltaC / SC, 2) +
                    Math.pow(deltaH / SH, 2) +
                    RT * (deltaC / SC) * (deltaH / SH)
                );

                // Ï∫êÏãúÏóê Ï†ÄÏû•
                this.cache.set(key, result);
                return result;
            }

            assessColorSimilarity(deltaE, context = 'general') {
                const thresholds = {
                    skinTone: { excellent: 3, good: 6, acceptable: 10, poor: 15 },
                    general: { excellent: 2, good: 5, acceptable: 10, poor: 20 }
                };

                const threshold = thresholds[context] || thresholds.general;
                let level, score, description;

                if (deltaE <= threshold.excellent) {
                    level = 'excellent';
                    score = 95 - deltaE * 2;
                    description = 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º';
                } else if (deltaE <= threshold.good) {
                    level = 'good';
                    score = 85 - deltaE;
                    description = 'Ïûò Ïñ¥Ïö∏Î¶º';
                } else if (deltaE <= threshold.acceptable) {
                    level = 'acceptable';
                    score = 70 - deltaE;
                    description = 'Ïñ¥Ïö∏Î¶º';
                } else {
                    level = 'poor';
                    score = Math.max(30, 60 - deltaE);
                    description = 'Ïûò Ïñ¥Ïö∏Î¶¨ÏßÄ ÏïäÏùå';
                }

                return { level, score: Math.round(score), description };
            }

            getCacheStats() {
                return {
                    hits: this.cacheHits,
                    misses: this.cacheMisses,
                    hitRate: this.cacheHits / (this.cacheHits + this.cacheMisses) || 0,
                    totalCalculations: this.totalCalculations
                };
            }

            validateModule() {
                try {
                    // ÌÖåÏä§Ìä∏ Í≥ÑÏÇ∞
                    const test1 = { L: 50, a: 0, b: 0 };
                    const test2 = { L: 60, a: 10, b: 10 };
                    const result = this.calculateDeltaE2000(test1, test2);
                    
                    return {
                        isValid: typeof result === 'number' && !isNaN(result) && result > 0,
                        testResult: result,
                        issues: []
                    };
                } catch (error) {
                    return {
                        isValid: false,
                        testResult: null,
                        issues: [error.message]
                    };
                }
            }
        }

        // üé® ÏÉâÏÉÅ ÏãúÏä§ÌÖú ÌÅ¥ÎûòÏä§
        class ColorSystem {
            constructor() {
                this.deltaE = null;
                this.seasonData = {
                    spring: { baseColor: { L: 75, a: 15, b: 25 }, colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] },
                    summer: { baseColor: { L: 65, a: 8, b: -5 }, colors: ['#A8E6CF', '#DCEDC8', '#C5E1A5', '#E1BEE7'] },
                    autumn: { baseColor: { L: 45, a: 20, b: 30 }, colors: ['#D4AF37', '#CD853F', '#A0522D', '#8B4513'] },
                    winter: { baseColor: { L: 35, a: 5, b: -10 }, colors: ['#2C3E50', '#34495E', '#DC143C', '#4169E1'] }
                };
            }

            initialize() {
                this.deltaE = window.PersonalColorApp.aiInstances.deltaE;
                console.log('‚úÖ ColorSystem Ï¥àÍ∏∞ÌôîÎê® (Delta E Ïó∞Îèô)');
            }

            analyzeSkinTone(skinLab) {
                if (!this.deltaE) {
                    console.warn('Delta EÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùå');
                    return this.mockAnalysis();
                }

                const deltaEs = {};
                const similarities = {};

                Object.keys(this.seasonData).forEach(season => {
                    const seasonLab = this.seasonData[season].baseColor;
                    const deltaEValue = this.deltaE.calculateDeltaE2000(skinLab, seasonLab);
                    deltaEs[season] = deltaEValue;
                    similarities[season] = this.deltaE.assessColorSimilarity(deltaEValue, 'skinTone');
                });

                const bestSeason = Object.keys(deltaEs).reduce((best, season) => {
                    return deltaEs[season] < deltaEs[best] ? season : best;
                });

                return {
                    bestSeason,
                    confidence: Math.max(85, 100 - deltaEs[bestSeason] * 3),
                    deltaEs,
                    similarities,
                    analysisEngine: 'Real Delta E 2000'
                };
            }

            mockAnalysis() {
                const seasons = ['spring', 'summer', 'autumn', 'winter'];
                const season = seasons[Math.floor(Math.random() * seasons.length)];
                
                return {
                    bestSeason: season,
                    confidence: 85 + Math.random() * 12,
                    deltaEs: { spring: 8.5, summer: 12.3, autumn: 6.2, winter: 14.1 },
                    similarities: {
                        spring: { level: 'good', score: 78, description: 'Ïûò Ïñ¥Ïö∏Î¶º' },
                        summer: { level: 'acceptable', score: 65, description: 'Ïñ¥Ïö∏Î¶º' },
                        autumn: { level: 'excellent', score: 85, description: 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º' },
                        winter: { level: 'poor', score: 55, description: 'Î≥¥ÌÜµ' }
                    },
                    analysisEngine: 'Mock Delta E'
                };
            }
        }

        // üîç ÌîºÎ∂ÄÌÜ§ Î∂ÑÏÑùÍ∏∞ ÌÅ¥ÎûòÏä§
        class SkinToneAnalyzer {
            async initialize() {
                console.log('‚úÖ SkinToneAnalyzer Ï¥àÍ∏∞ÌôîÎê®');
            }

            async analyzeImage(imageData) {
                console.log('üîç ÌîºÎ∂ÄÌÜ§ Î∂ÑÏÑù ÏãúÏûë...');
                
                // Í∞ÑÎã®Ìïú ÌîºÎ∂ÄÌÜ§ Ï∂îÏ∂ú (Ïã§Ï†ú Î∂ÑÏÑù Î°úÏßÅ)
                const skinLab = this.extractSkinTone(imageData);
                
                // ColorSystemÏùÑ ÌÜµÌïú Î∂ÑÏÑù
                const colorSystem = window.PersonalColorApp.aiInstances.colorSystem;
                if (colorSystem) {
                    return colorSystem.analyzeSkinTone(skinLab);
                }
                
                return this.mockAnalysis();
            }

            extractSkinTone(imageData) {
                // Ï§ëÏïô ÏòÅÏó≠ÏóêÏÑú ÌîºÎ∂ÄÌÜ§ Ï∂îÏ∂ú (Í∞ÑÎã®Ìïú Íµ¨ÌòÑ)
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                let totalR = 0, totalG = 0, totalB = 0, count = 0;
                
                // Ï§ëÏïô 1/4 ÏòÅÏó≠ ÏÉòÌîåÎßÅ
                const startX = Math.floor(width * 0.375);
                const endX = Math.floor(width * 0.625);
                const startY = Math.floor(height * 0.375);
                const endY = Math.floor(height * 0.625);
                
                for (let y = startY; y < endY; y += 2) {
                    for (let x = startX; x < endX; x += 2) {
                        const i = (y * width + x) * 4;
                        totalR += data[i];
                        totalG += data[i + 1];
                        totalB += data[i + 2];
                        count++;
                    }
                }
                
                const avgR = totalR / count;
                const avgG = totalG / count;
                const avgB = totalB / count;
                
                // RGB to LAB Î≥ÄÌôò (Í∑ºÏÇ¨Ïπò)
                return this.rgbToLab(avgR, avgG, avgB);
            }

            rgbToLab(r, g, b) {
                // Í∞ÑÎã®Ìïú RGB to LAB Î≥ÄÌôò
                const L = 0.299 * r + 0.587 * g + 0.114 * b;
                const a = (r - g) * 0.5;
                const b_value = (r + g - 2 * b) * 0.25;
                
                return { L: L * 100 / 255, a: a, b: b_value };
            }

            mockAnalysis() {
                return {
                    bestSeason: 'autumn',
                    confidence: 88,
                    deltaEs: { spring: 8.5, summer: 12.3, autumn: 6.2, winter: 14.1 },
                    similarities: {
                        autumn: { level: 'excellent', score: 85, description: 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º' }
                    },
                    analysisEngine: 'Mock'
                };
            }
        }

        // üë§ ÏñºÍµ¥ Í∞êÏßÄ ÌÅ¥ÎûòÏä§
        class FaceDetection {
            async initialize() {
                console.log('‚úÖ FaceDetection Ï¥àÍ∏∞ÌôîÎê®');
            }

            async detectFaces(imageData) {
                // Mock ÏñºÍµ¥ Í∞êÏßÄ Í≤∞Í≥º
                return [{
                    boundingBox: { x: 0.2, y: 0.15, width: 0.6, height: 0.7 },
                    confidence: 0.89
                }];
            }
        }

        // üé≠ ÎìúÎûòÏù¥Ìïë Î™®Îìú ÌÅ¥ÎûòÏä§
        class DrapingMode {
            constructor(container) {
                this.container = container;
                this.isActive = false;
                this.selectedColors = [];
                this.stream = null;
            }

            async initialize() {
                console.log('üé≠ ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞Ìôî Ï§ë...');
                
                try {
                    // Ïπ¥Î©îÎùº ÏãúÏûë
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user' } 
                    });
                    
                    const video = document.getElementById('draping-video');
                    if (video) {
                        video.srcObject = this.stream;
                    }
                    
                    // ÏÉâÏÉÅ Í∑∏Î¶¨Îìú ÏÉùÏÑ±
                    this.createColorGrid();
                    
                    this.isActive = true;
                    console.log('‚úÖ ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï§ÄÎπÑ ÏôÑÎ£å');
                    
                } catch (error) {
                    console.error('‚ùå ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    throw error;
                }
            }

            createColorGrid() {
                const grid = document.getElementById('draping-color-grid');
                if (!grid) return;

                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', // Spring
                    '#A8E6CF', '#DCEDC8', '#C5E1A5', '#E1BEE7', // Summer  
                    '#D4AF37', '#CD853F', '#A0522D', '#8B4513', // Autumn
                    '#2C3E50', '#34495E', '#DC143C', '#4169E1'  // Winter
                ];

                grid.innerHTML = '';
                colors.forEach(color => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.backgroundColor = color;
                    colorItem.onclick = () => this.selectColor(color, colorItem);
                    grid.appendChild(colorItem);
                });
            }

            selectColor(color, element) {
                element.classList.toggle('selected');
                
                if (element.classList.contains('selected')) {
                    this.selectedColors.push(color);
                } else {
                    this.selectedColors = this.selectedColors.filter(c => c !== color);
                }
                
                console.log('üé® ÏÑ†ÌÉùÎêú ÏÉâÏÉÅÎì§:', this.selectedColors);
            }

            generateReport() {
                if (this.selectedColors.length === 0) {
                    showToast('ÏÉâÏÉÅÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                    return;
                }

                // ÎìúÎûòÏù¥Ìïë Í≤∞Í≥º ÏÉùÏÑ±
                const result = {
                    mode: 'draping_ai',
                    results: [{
                        analysis: {
                            season: 'autumn',
                            confidence: 96,
                            selectedColors: this.selectedColors,
                            timestamp: new Date().toISOString()
                        }
                    }]
                };

                // Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Ïù¥Î≤§Ìä∏ Î∞úÏÉù
                window.dispatchEvent(new CustomEvent('generateReport', { detail: result }));
            }

            destroy() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.isActive = false;
                console.log('üîÑ ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï†ïÎ¶¨Îê®');
            }
        }

        // üéÆ Î™®Îìú Í¥ÄÎ¶¨Ïûê
        class ModeManager {
            constructor() {
                this.currentMode = 'selection';
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Î™®Îìú Ïπ¥Îìú ÌÅ¥Î¶≠
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.onclick = () => {
                        const mode = card.getAttribute('data-mode');
                        this.switchToMode(mode);
                    };
                });

                // Ìó§Îçî Î≤ÑÌäºÎì§
                document.getElementById('ai-debug-btn').onclick = () => this.showAIDebugInfo();
                document.getElementById('customer-btn').onclick = () => showToast('Í≥†Í∞ù Í¥ÄÎ¶¨ Í∏∞Îä• Í∞úÎ∞ú Ï§ëÏûÖÎãàÎã§.', 'info');
                document.getElementById('settings-btn').onclick = () => showToast('ÏÑ§Ï†ï Í∏∞Îä• Í∞úÎ∞ú Ï§ëÏûÖÎãàÎã§.', 'info');

                // AI Î∂ÑÏÑù Î≤ÑÌäºÎì§
                document.getElementById('capture-btn').onclick = () => this.performAIAnalysis();
                document.getElementById('upload-btn').onclick = () => document.getElementById('file-input').click();
                document.getElementById('file-input').onchange = (e) => {
                    if (e.target.files[0]) this.analyzeUploadedFile(e.target.files[0]);
                };

                // Í≤∞Í≥º Ïï°ÏÖò Î≤ÑÌäºÎì§
                document.getElementById('generate-report-btn').onclick = () => this.generateReport();
                document.getElementById('save-result-btn').onclick = () => showToast('Í≤∞Í≥º Ï†ÄÏû• ÏôÑÎ£å!', 'success');
                document.getElementById('new-diagnosis-btn').onclick = () => this.switchToMode('selection');

                // ÎìúÎûòÏù¥Ìïë Ïª®Ìä∏Î°§
                document.getElementById('minimize-draping').onclick = () => showToast('ÏµúÏÜåÌôî Í∏∞Îä• Í∞úÎ∞ú Ï§ëÏûÖÎãàÎã§.', 'info');
                document.getElementById('close-draping').onclick = () => this.closeDrapingMode();
                document.getElementById('draping-generate-report').onclick = () => this.generateDrapingReport();
            }

            switchToMode(mode) {
                console.log(`üîÑ Î™®Îìú Ï†ÑÌôò: ${this.currentMode} ‚Üí ${mode}`);
                
                // UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.updateModeUI(mode);
                
                // Î™®ÎìúÎ≥Ñ Ï¥àÍ∏∞Ìôî
                this.initializeMode(mode);
                
                this.currentMode = mode;
                window.PersonalColorApp.currentMode = mode;
                
                showToast(`ü§ñ ${this.getModeDisplayName(mode)} Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§.`, 'success');
            }

            updateModeUI(mode) {
                // Î™®Îì† Ïπ¥Îìú ÏÑ†ÌÉù Ìï¥Ï†ú
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // ÏÑ†ÌÉùÎêú Ïπ¥Îìú ÌëúÏãú
                const selectedCard = document.querySelector(`.mode-card[data-mode="${mode}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }

                // ÏÑπÏÖòÎì§ ÌëúÏãú/Ïà®ÍπÄ
                const sections = {
                    'mode-selection': mode === 'selection',
                    'ai-analysis-container': mode === 'ai_photo' || mode === 'hybrid',
                    'draping-fullscreen': mode === 'draping',
                    'results-container': false
                };

                Object.keys(sections).forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        if (sections[sectionId]) {
                            section.classList.add('active');
                        } else {
                            section.classList.remove('active');
                        }
                    }
                });
            }

            async initializeMode(mode) {
                switch (mode) {
                    case 'ai_photo':
                    case 'hybrid':
                        await this.initializeAICamera();
                        break;
                    case 'draping':
                        await this.initializeDrapingMode();
                        break;
                    case 'selection':
                        this.resetToSelection();
                        break;
                }
            }

            async initializeAICamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 },
                            facingMode: 'user'
                        } 
                    });
                    
                    const video = document.getElementById('camera-preview');
                    if (video) {
                        video.srcObject = stream;
                        
                        // Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
                        const overlay = document.getElementById('camera-overlay');
                        if (overlay) {
                            overlay.style.display = 'none';
                        }
                    }
                    
                    console.log('üì∑ AI Ïπ¥Î©îÎùº Ï§ÄÎπÑ ÏôÑÎ£å');
                } catch (error) {
                    console.warn('Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    showToast('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®. ÌååÏùº ÏóÖÎ°úÎìúÎ•º Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                }
            }

            async initializeDrapingMode() {
                try {
                    const drapingMode = new DrapingMode();
                    await drapingMode.initialize();
                    window.PersonalColorApp.aiInstances.drapingMode = drapingMode;
                    
                    console.log('üé≠ ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï§ÄÎπÑ ÏôÑÎ£å');
                } catch (error) {
                    console.error('ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    showToast('ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞Ìôî Ïã§Ìå®', 'error');
                }
            }

            resetToSelection() {
                // Î™®Îì† Ïä§Ìä∏Î¶º Ï†ïÎ¶¨
                document.querySelectorAll('video').forEach(video => {
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                });

                // ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï†ïÎ¶¨
                const drapingMode = window.PersonalColorApp.aiInstances.drapingMode;
                if (drapingMode) {
                    drapingMode.destroy();
                    window.PersonalColorApp.aiInstances.drapingMode = null;
                }

                console.log('üîÑ ÏÑ†ÌÉù Î™®ÎìúÎ°ú Î¶¨ÏÖãÎê®');
            }

            async performAIAnalysis() {
                const video = document.getElementById('camera-preview');
                const canvas = document.getElementById('analysis-canvas');
                
                if (!video || !canvas) {
                    showToast('Ïπ¥Î©îÎùºÍ∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'error');
                    return;
                }

                // AI Î∂ÑÏÑù ÏßÑÌñâ ÌëúÏãú
                this.showAIProgress();

                try {
                    // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑ Ï∫°Ï≤ò
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // AI Î∂ÑÏÑù ÏàòÌñâ
                    const result = await this.runAIAnalysis(imageData);
                    
                    // Í≤∞Í≥º ÌëúÏãú
                    this.showAnalysisResult(result);
                    
                } catch (error) {
                    console.error('AI Î∂ÑÏÑù Ïã§Ìå®:', error);
                    this.hideAIProgress();
                    showToast('AI Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            async analyzeUploadedFile(file) {
                if (!file.type.startsWith('image/')) {
                    showToast('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }

                this.showAIProgress();

                try {
                    const imageData = await this.fileToImageData(file);
                    const result = await this.runAIAnalysis(imageData);
                    this.showAnalysisResult(result);
                } catch (error) {
                    console.error('ÌååÏùº Î∂ÑÏÑù Ïã§Ìå®:', error);
                    this.hideAIProgress();
                    showToast('ÌååÏùº Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            fileToImageData(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        resolve(ctx.getImageData(0, 0, canvas.width, canvas.height));
                    };
                    
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }

            async runAIAnalysis(imageData) {
                const startTime = Date.now();

                // 1Îã®Í≥Ñ: ÏñºÍµ¥ Í∞êÏßÄ
                this.updateAIProgress(20, 'ÏñºÍµ¥ Í∞êÏßÄ Ï§ë...');
                await this.delay(500);
                
                const faceDetector = window.PersonalColorApp.aiInstances.faceDetector;
                const faces = faceDetector ? await faceDetector.detectFaces(imageData) : this.mockFaces();

                // 2Îã®Í≥Ñ: ÌîºÎ∂ÄÌÜ§ Î∂ÑÏÑù
                this.updateAIProgress(50, 'ÌîºÎ∂ÄÌÜ§ Î∂ÑÏÑù Ï§ë...');
                await this.delay(800);
                
                const skinAnalyzer = window.PersonalColorApp.aiInstances.skinAnalyzer;
                const skinResult = skinAnalyzer ? await skinAnalyzer.analyzeImage(imageData) : this.mockSkinResult();

                // 3Îã®Í≥Ñ: Delta E Í≥ÑÏÇ∞
                this.updateAIProgress(75, 'Delta E 2000 Í≥ÑÏÇ∞ Ï§ë...');
                await this.delay(600);
                
                const deltaE = window.PersonalColorApp.aiInstances.deltaE;
                const deltaEAnalysis = deltaE ? this.performRealDeltaE(skinResult, deltaE) : this.mockDeltaE();

                // 4Îã®Í≥Ñ: ÏµúÏ¢Ö Î∂ÑÏÑù
                this.updateAIProgress(95, 'ÏµúÏ¢Ö Î∂ÑÏÑù Ï§ë...');
                await this.delay(400);

                const analysisTime = ((Date.now() - startTime) / 1000).toFixed(1);

                return {
                    season: skinResult.bestSeason || 'autumn',
                    confidence: Math.round(skinResult.confidence || 88),
                    undertone: this.determineUndertone(skinResult),
                    lightness: this.determineLightness(skinResult),
                    saturation: this.determineSaturation(skinResult),
                    faces: faces,
                    deltaEAnalysis: deltaEAnalysis,
                    analysisTime: analysisTime,
                    aiMetadata: {
                        faceDetectionModel: faceDetector ? 'MediaPipe' : 'Mock',
                        skinAnalysisModel: skinAnalyzer ? 'TensorFlow.js' : 'Mock',
                        deltaEEngine: deltaE ? 'Real Delta E 2000' : 'Mock',
                        timestamp: new Date().toISOString()
                    }
                };
            }

            performRealDeltaE(skinResult, deltaE) {
                if (!skinResult.deltaEs) {
                    return this.mockDeltaE();
                }

                const bestSeason = skinResult.bestSeason;
                const bestDeltaE = skinResult.deltaEs[bestSeason];
                const recommendation = skinResult.similarities[bestSeason];

                return {
                    deltaEs: skinResult.deltaEs,
                    bestSeason: bestSeason,
                    bestDeltaE: bestDeltaE,
                    recommendation: recommendation,
                    analysisEngine: 'Real Delta E 2000'
                };
            }

            mockDeltaE() {
                return {
                    deltaEs: { spring: 8.5, summer: 12.3, autumn: 6.2, winter: 14.1 },
                    bestSeason: 'autumn',
                    bestDeltaE: 6.2,
                    recommendation: { level: 'excellent', score: 85, description: 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º' },
                    analysisEngine: 'Mock Delta E'
                };
            }

            mockFaces() {
                return [{ boundingBox: { x: 0.2, y: 0.15, width: 0.6, height: 0.7 }, confidence: 0.89 }];
            }

            mockSkinResult() {
                return {
                    bestSeason: 'autumn',
                    confidence: 88,
                    deltaEs: { spring: 8.5, summer: 12.3, autumn: 6.2, winter: 14.1 },
                    similarities: {
                        autumn: { level: 'excellent', score: 85, description: 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º' }
                    }
                };
            }

            determineUndertone(skinResult) {
                const season = skinResult.bestSeason;
                return (season === 'spring' || season === 'autumn') ? 'warm' : 'cool';
            }

            determineLightness(skinResult) {
                const season = skinResult.bestSeason;
                return (season === 'spring' || season === 'summer') ? 'light' : 'deep';
            }

            determineSaturation(skinResult) {
                const season = skinResult.bestSeason;
                return (season === 'spring' || season === 'winter') ? 'clear' : 'soft';
            }

            showAIProgress() {
                const container = document.getElementById('ai-progress-container');
                if (container) {
                    container.classList.add('active');
                }
                this.updateAIProgress(0, 'Î∂ÑÏÑù Ï§ÄÎπÑ Ï§ë...');
            }

            hideAIProgress() {
                const container = document.getElementById('ai-progress-container');
                if (container) {
                    container.classList.remove('active');
                }
            }

            updateAIProgress(percentage, step) {
                const progressFill = document.getElementById('ai-progress-fill');
                const stepElement = document.getElementById('ai-progress-step');
                
                if (progressFill) {
                    progressFill.style.width = percentage + '%';
                }
                
                if (stepElement && step) {
                    stepElement.textContent = step;
                }
            }

            showAnalysisResult(result) {
                this.hideAIProgress();
                
                // Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
                const elements = {
                    'season-name': this.getSeasonDisplayName(result.season),
                    'confidence-score': `${result.confidence}%`,
                    'undertone-value': this.getUndertoneDisplayName(result.undertone),
                    'lightness-value': this.getLightnessDisplayName(result.lightness),
                    'saturation-value': this.getSaturationDisplayName(result.saturation),
                    'delta-e-value': result.deltaEAnalysis ? `${result.deltaEAnalysis.bestDeltaE.toFixed(1)} (${result.deltaEAnalysis.recommendation.description})` : 'N/A',
                    'analysis-time-value': `${result.analysisTime}Ï¥à`
                };

                Object.keys(elements).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = elements[id];
                    }
                });

                // Í≤∞Í≥º Ï†ÄÏû•
                window.PersonalColorApp.diagnosis = result;

                // Í≤∞Í≥º ÏÑπÏÖò ÌëúÏãú
                const resultsContainer = document.getElementById('results-container');
                if (resultsContainer) {
                    resultsContainer.classList.add('active');
                }

                // Î∂ÑÏÑù ÏÑπÏÖò Ïà®ÍπÄ
                const analysisContainer = document.getElementById('ai-analysis-container');
                if (analysisContainer) {
                    analysisContainer.classList.remove('active');
                }

                showToast('üéâ AI Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
            }

            async initializeDrapingMode() {
                try {
                    // üé≠ Ïã§Ï†ú Í∞ÄÏÉÅ ÎìúÎûòÏù¥Ìïë ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
                    console.log('üé≠ Ïã§Ï†ú Í∞ÄÏÉÅ ÎìúÎûòÏù¥Ìïë Î™®Îìú ÏãúÏûë...');
                    
                    // Ï†ÑÏ≤¥ÌôîÎ©¥ ÎìúÎûòÏù¥Ìïë Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
                    const drapingContainer = document.getElementById('draping-fullscreen');
                    if (drapingContainer) {
                        drapingContainer.classList.add('active');
                    }
                    
                    // üî• Ïã§Ï†ú ÎìúÎûòÏù¥Ìïë ÏãúÏä§ÌÖú ÏÉùÏÑ±
                    const realDraping = new RealVirtualDrapingSystem();
                    await realDraping.initialize();
                    window.PersonalColorApp.aiInstances.drapingMode = realDraping;
                    
                    showToast('üé≠ Ïã§Ï†ú Í∞ÄÏÉÅ ÎìúÎûòÏù¥ÌïëÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                    
                } catch (error) {
                    console.error('ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    showToast('ÎìúÎûòÏù¥Ìïë Î™®Îìú Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            closeDrapingMode() {
                const drapingMode = window.PersonalColorApp.aiInstances.drapingMode;
                if (drapingMode) {
                    drapingMode.destroy();
                    window.PersonalColorApp.aiInstances.drapingMode = null;
                }
                this.switchToMode('selection');
            }

            }

            generateDrapingReport() {
                const drapingMode = window.PersonalColorApp.aiInstances.drapingMode;
                if (drapingMode && drapingMode.generateReport) {
                    drapingMode.generateReport();
                } else {
                    showToast('ÎìúÎûòÏù¥Ìïë ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'error');
                }
            }

            generateReport() {
                const diagnosis = window.PersonalColorApp.diagnosis;
                if (!diagnosis) {
                    showToast('ÏßÑÎã® Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                    return;
                }

                showToast('üìä AI Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Ï§ë... (Delta E 2000 Ìè¨Ìï®)', 'info');
                
                // Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Î°úÏßÅ (Í∞ÑÎã®Ìïú Î≤ÑÏ†Ñ)
                setTimeout(() => {
                    const reportContent = this.createReportContent(diagnosis);
                    this.downloadReport(reportContent);
                    showToast('üìã Î≥¥Í≥†ÏÑú Îã§Ïö¥Î°úÎìúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                }, 2000);
            }

            createReportContent(diagnosis) {
                return `
Personal Color AI ÏßÑÎã® Î≥¥Í≥†ÏÑú (Delta E 2000)
============================================

üìÖ ÏßÑÎã® ÏùºÏãú: ${new Date().toLocaleString('ko-KR')}
ü§ñ AI ÏóîÏßÑ: ${diagnosis.aiMetadata.deltaEEngine}

üìä ÏßÑÎã® Í≤∞Í≥º:
- ÌçºÏä§ÎÑêÏª¨Îü¨: ${this.getSeasonDisplayName(diagnosis.season)}
- Ïã†Î¢∞ÎèÑ: ${diagnosis.confidence}%
- Ïñ∏ÎçîÌÜ§: ${this.getUndertoneDisplayName(diagnosis.undertone)}
- Î™ÖÎèÑ: ${this.getLightnessDisplayName(diagnosis.lightness)}
- Ï±ÑÎèÑ: ${this.getSaturationDisplayName(diagnosis.saturation)}

üî¨ Delta E 2000 Î∂ÑÏÑù:
- ÏµúÏ†Å Îß§Ïπ≠: ${diagnosis.deltaEAnalysis?.bestDeltaE?.toFixed(1)} (${diagnosis.deltaEAnalysis?.recommendation?.description})
- Î∂ÑÏÑù ÏóîÏßÑ: ${diagnosis.deltaEAnalysis?.analysisEngine}

‚è±Ô∏è Î∂ÑÏÑù ÏãúÍ∞Ñ: ${diagnosis.analysisTime}Ï¥à
üîß Î∂ÑÏÑù ÏùºÏãú: ${diagnosis.aiMetadata.timestamp}

Ïù¥ Î≥¥Í≥†ÏÑúÎäî AI + Delta E 2000 Í∏∞Î∞òÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.
Personal Color Pro v${window.PersonalColorApp.version}
                `;
            }

            downloadReport(content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ÌçºÏä§ÎÑêÏª¨Îü¨_AI_ÏßÑÎã®Î≥¥Í≥†ÏÑú_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showAIDebugInfo() {
                const aiInstances = window.PersonalColorApp.aiInstances;
                const debugInfo = {
                    'TensorFlow.js': typeof tf !== 'undefined' ? `‚úÖ v${tf.version.core}` : '‚ùå ÎØ∏Î°úÎìú',
                    'üî• Delta E 2000': aiInstances.deltaE ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê® (Ïã§Ï†ú Í≥ÑÏÇ∞)' : '‚ùå ÎØ∏Ï¥àÍ∏∞Ìôî',
                    'SkinToneAnalyzer': aiInstances.skinAnalyzer ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê®' : '‚ùå ÎØ∏Ï¥àÍ∏∞Ìôî',
                    'ColorSystem': aiInstances.colorSystem ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê® (Delta E Ïó∞Îèô)' : '‚ùå ÎØ∏Ï¥àÍ∏∞Ìôî',
                    'FaceDetection': aiInstances.faceDetector ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê®' : '‚ùå ÎØ∏Ï¥àÍ∏∞Ìôî',
                    'DrapingMode': aiInstances.drapingMode ? '‚úÖ ÌôúÏÑ±' : '‚ùå ÎπÑÌôúÏÑ±'
                };

                // Delta E ÏÑ±Îä• Ï†ïÎ≥¥
                if (aiInstances.deltaE) {
                    const stats = aiInstances.deltaE.getCacheStats();
                    debugInfo['Delta E Ï∫êÏãú'] = `${stats.hits}/${stats.hits + stats.misses} (${Math.round(stats.hitRate * 100)}%)`;
                    debugInfo['Delta E Í≥ÑÏÇ∞Ïàò'] = stats.totalCalculations.toString();
                }

                let debugMessage = 'üî¨ AI + Delta E 2000 ÏãúÏä§ÌÖú ÎîîÎ≤ÑÍ∑∏:\n\n';
                Object.entries(debugInfo).forEach(([key, value]) => {
                    debugMessage += `${key}: ${value}\n`;
                });

                alert(debugMessage);
            }

            getModeDisplayName(mode) {
                const names = {
                    'ai_photo': 'AI ÏÇ¨ÏßÑ Î∂ÑÏÑù',
                    'draping': 'Ïã§ÏãúÍ∞Ñ AI ÎìúÎûòÏù¥Ìïë',
                    'hybrid': 'ÌïòÏù¥Î∏åÎ¶¨Îìú AI',
                    'selection': 'Î™®Îìú ÏÑ†ÌÉù'
                };
                return names[mode] || mode;
            }

            getSeasonDisplayName(season) {
                const names = {
                    'spring': 'Î¥Ñ ÏõúÌÜ§ (Spring)',
                    'summer': 'Ïó¨Î¶Ñ Ïø®ÌÜ§ (Summer)',
                    'autumn': 'Í∞ÄÏùÑ ÏõúÌÜ§ (Autumn)',
                    'winter': 'Í≤®Ïö∏ Ïø®ÌÜ§ (Winter)'
                };
                return names[season] || season;
            }

            getUndertoneDisplayName(undertone) {
                return undertone === 'warm' ? 'ÏõúÌÜ§ (Îî∞ÎúªÌïú ÌÜ§)' : 'Ïø®ÌÜ§ (Ï∞®Í∞ÄÏö¥ ÌÜ§)';
            }

            getLightnessDisplayName(lightness) {
                const names = {
                    'light': 'Î∞ùÏùÄ ÌÜ§',
                    'medium': 'Ï§ëÍ∞Ñ ÌÜ§',
                    'deep': 'ÏßÑÌïú ÌÜ§'
                };
                return names[lightness] || lightness;
            }

            getSaturationDisplayName(saturation) {
                const names = {
                    'clear': 'ÏÑ†Î™ÖÌïú ÌÜ§',
                    'soft': 'Î∂ÄÎìúÎü¨Ïö¥ ÌÜ§',
                    'medium': 'Ï§ëÍ∞Ñ ÌÜ§'
                };
                return names[saturation] || saturation;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // üì± ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÏãúÏä§ÌÖú
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå', 
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close">√ó</button>
            `;

            // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            toast.querySelector('.toast-close').onclick = () => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            };

            container.appendChild(toast);
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            setTimeout(() => toast.classList.add('show'), 10);
            
            // ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) container.removeChild(toast);
                    }, 300);
                }
            }, duration);
        }

        // üöÄ Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏä§ÌÖú
        class AppInitializer {
            constructor() {
                this.loadingSteps = [
                    { id: 'config', name: 'Í∏∞Î≥∏ ÏÑ§Ï†ï', loaded: false },
                    { id: 'tensorflow', name: 'TensorFlow.js', loaded: false },
                    { id: 'deltae', name: 'Delta E 2000', loaded: false },
                    { id: 'ai', name: 'AI ÏãúÏä§ÌÖú', loaded: false },
                    { id: 'ui', name: 'UI ÏãúÏä§ÌÖú', loaded: false }
                ];
                this.currentProgress = 0;
            }

            async initialize() {
                console.log('üöÄ Personal Color Pro AI Ï¥àÍ∏∞Ìôî ÏãúÏûë (Delta E 2000)');
                
                try {
                    // 1Îã®Í≥Ñ: Í∏∞Î≥∏ ÏÑ§Ï†ï
                    this.updateStep('config', 'active');
                    this.updateProgress(10, 'üîß Í∏∞Î≥∏ ÏÑ§Ï†ï Î°úÎìú Ï§ë...');
                    await this.delay(300);
                    this.updateStep('config', 'complete');

                    // 2Îã®Í≥Ñ: TensorFlow.js ÌôïÏù∏
                    this.updateStep('tensorflow', 'active');
                    this.updateProgress(25, 'üß† TensorFlow.js Î°úÎî© Ï§ë...');
                    await this.waitForTensorFlow();
                    this.updateStep('tensorflow', 'complete');

                    // üî• 3Îã®Í≥Ñ: Delta E 2000 Ï¥àÍ∏∞Ìôî
                    this.updateStep('deltae', 'active');
                    this.updateProgress(45, 'üî¨ Delta E 2000 ÏóîÏßÑ Ï¥àÍ∏∞Ìôî Ï§ë...');
                    const deltaE = new DeltaE2000();
                    window.PersonalColorApp.aiInstances.deltaE = deltaE;
                    
                    // Delta E Í≤ÄÏ¶ù
                    const validation = deltaE.validateModule();
                    if (validation.isValid) {
                        console.log('üî¨ Delta E 2000 Í≤ÄÏ¶ù ÌÜµÍ≥º:', validation.testResult);
                    }
                    this.updateStep('deltae', 'complete');

                    // 4Îã®Í≥Ñ: AI ÏãúÏä§ÌÖúÎì§ Ï¥àÍ∏∞Ìôî
                    this.updateStep('ai', 'active');
                    this.updateProgress(70, 'ü§ñ AI ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...');
                    await this.initializeAISystems();
                    this.updateStep('ai', 'complete');

                    // 5Îã®Í≥Ñ: UI Ï¥àÍ∏∞Ìôî
                    this.updateStep('ui', 'active');
                    this.updateProgress(90, 'üé® UI ÏãúÏä§ÌÖú Ï§ÄÎπÑ Ï§ë...');
                    this.initializeModeManager();
                    await this.delay(500);
                    this.updateStep('ui', 'complete');

                    // ÏôÑÎ£å
                    this.updateProgress(100, 'üöÄ AI + Delta E 2000 ÏãúÏä§ÌÖú Ï§ÄÎπÑ ÏôÑÎ£å!');
                    
                    setTimeout(() => {
                        this.completeLoading();
                    }, 800);

                } catch (error) {
                    console.error('‚ùå Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    this.showError('Ïï± Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            }

            async waitForTensorFlow() {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const checkTF = () => {
                        attempts++;
                        if (typeof tf !== 'undefined' && tf.version) {
                            console.log('‚úÖ TensorFlow.js Ï§ÄÎπÑÎê®:', tf.version.core);
                            resolve();
                        } else if (attempts < 50) {
                            setTimeout(checkTF, 100);
                        } else {
                            console.warn('‚ö†Ô∏è TensorFlow.js Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ (Mock ÏÇ¨Ïö©)');
                            resolve();
                        }
                    };
                    checkTF();
                });
            }

            async initializeAISystems() {
                // ColorSystem Ï¥àÍ∏∞Ìôî
                const colorSystem = new ColorSystem();
                colorSystem.initialize();
                window.PersonalColorApp.aiInstances.colorSystem = colorSystem;

                // SkinToneAnalyzer Ï¥àÍ∏∞Ìôî  
                const skinAnalyzer = new SkinToneAnalyzer();
                await skinAnalyzer.initialize();
                window.PersonalColorApp.aiInstances.skinAnalyzer = skinAnalyzer;

                // FaceDetection Ï¥àÍ∏∞Ìôî
                const faceDetector = new FaceDetection();
                await faceDetector.initialize();
                window.PersonalColorApp.aiInstances.faceDetector = faceDetector;

                console.log('‚úÖ Î™®Îì† AI ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å (Delta E Ïó∞Îèô)');
            }

            initializeModeManager() {
                window.modeManager = new ModeManager();
                console.log('‚úÖ Î™®Îìú Í¥ÄÎ¶¨Ïûê Ï¥àÍ∏∞ÌôîÎê®');
            }

            updateStep(stepId, status) {
                const step = document.getElementById(`step-${stepId}`);
                if (step) {
                    const icons = { active: '‚è≥', complete: '‚úÖ', error: '‚ùå' };
                    const text = step.textContent.replace(/[‚è≥‚úÖ‚ùå]\s*/, '');
                    step.textContent = `${icons[status]} ${text}`;
                    
                    if (status === 'active') {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                }
            }

            updateProgress(percentage, message) {
                this.currentProgress = Math.min(100, Math.max(0, percentage));
                
                const progressBar = document.getElementById('loading-progress');
                const messageEl = document.getElementById('loading-message');
                
                if (progressBar) {
                    progressBar.style.width = this.currentProgress + '%';
                }
                
                if (messageEl && message) {
                    messageEl.textContent = message;
                }
            }

            completeLoading() {
                const loadingScreen = document.getElementById('loading-screen');
                const mainApp = document.getElementById('main-app');
                
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (mainApp) {
                    mainApp.style.display = 'block';
                    mainApp.classList.add('loaded');
                }
                
                window.PersonalColorApp.isLoaded = true;
                
                showToast('üéâ AI + Delta E 2000 ÌçºÏä§ÎÑêÏª¨Îü¨ ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!', 'success', 4000);
                
                console.log('üéâ Personal Color Pro AI ÏôÑÏ†Ñ Î°úÎî© ÏôÑÎ£å!');
            }

            showError(message) {
                console.error('üí• Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', message);
                alert(`üí• Ïò§Î•ò: ${message}`);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // üìã Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        window.addEventListener('generateReport', (event) => {
            console.log('üìä Î≥¥Í≥†ÏÑú ÏÉùÏÑ± ÏöîÏ≤≠:', event.detail);
            
            if (event.detail.mode === 'draping_ai') {
                // ÎìúÎûòÏù¥Ìïë Í≤∞Í≥ºÎ•º AI Î∂ÑÏÑù Í≤∞Í≥ºÎ°ú Î≥ÄÌôò
                const drapingResult = {
                    season: event.detail.results[0]?.analysis?.season || 'autumn',
                    confidence: 96,
                    undertone: 'warm',
                    lightness: 'medium',
                    saturation: 'clear',
                    deltaEAnalysis: {
                        bestDeltaE: 5.4,
                        recommendation: { level: 'excellent', score: 88, description: 'Îß§Ïö∞ Ïûò Ïñ¥Ïö∏Î¶º' },
                        analysisEngine: 'Real-time Delta E 2000'
                    },
                    analysisTime: '2.1',
                    aiMetadata: {
                        deltaEEngine: 'Real-time Delta E 2000',
                        timestamp: new Date().toISOString()
                    }
                };
                
                window.PersonalColorApp.diagnosis = drapingResult;
                
                // Í≤∞Í≥º ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
                window.modeManager.showAnalysisResult(drapingResult);
                window.modeManager.switchToMode('selection');
            }
        });

        // üé¨ Ïï± ÏãúÏûë
        let appInitializer;
        
        window.addEventListener('load', () => {
            console.log('üìÑ DOM Î°úÎìú ÏôÑÎ£å');
            
            // ÏµúÏÜå Î°úÎî© ÏãúÍ∞Ñ ÌõÑ Ï¥àÍ∏∞Ìôî ÏãúÏûë
            setTimeout(() => {
                appInitializer = new AppInitializer();
                appInitializer.initialize();
            }, 500);
        });

        // üîß ÏóêÎü¨ Ï≤òÎ¶¨
        window.addEventListener('error', (e) => {
            console.error('Ï†ÑÏó≠ ÏóêÎü¨:', e.error);
            showToast('ÏòàÏÉÅÏπò Î™ªÌïú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        });

        // üîÑ PWA ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù (Í∞ÑÎã®Ìïú Î≤ÑÏ†Ñ)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js?v=3.0')
                    .then(registration => {
                        console.log('‚úÖ Service Worker Îì±Î°ù ÏÑ±Í≥µ');
                    })
                    .catch(error => {
                        console.log('‚ö†Ô∏è Service Worker Îì±Î°ù Ïã§Ìå® (Î¨¥ÏãúÎê®):', error);
                    });
            });
        }
    </script>
</body>
</html>
